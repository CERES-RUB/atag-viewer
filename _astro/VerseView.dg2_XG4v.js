import{j as F}from"./jsx-runtime.D_L90wQp.js";import{R as dn,r as k}from"./index.DL6A1vOd.js";import{u as kn,g as Un,t as Vn,A as Pn,o as Mn,i as Bn,f as Hn,s as Dn,a as jn,L as Yn,b as Xn,c as Fn,d as Gn,e as Nt,K as qn,h as zn,P as Wn,R as Jn,j as Kn}from"./floating-ui.react.Bonvjhkt.js";var un={exports:{}},$e={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var _t;function Qn(){if(_t)return $e;_t=1;var e=dn,t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,r=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function a(s,l,c){var u,h={},m=null,d=null;c!==void 0&&(m=""+c),l.key!==void 0&&(m=""+l.key),l.ref!==void 0&&(d=l.ref);for(u in l)o.call(l,u)&&!i.hasOwnProperty(u)&&(h[u]=l[u]);if(s&&s.defaultProps)for(u in l=s.defaultProps,l)h[u]===void 0&&(h[u]=l[u]);return{$$typeof:t,type:s,key:m,ref:d,props:h,_owner:r.current}}return $e.Fragment=n,$e.jsx=a,$e.jsxs=a,$e}un.exports=Qn();var Zn=un.exports;const eo={namespaces:{tei:"http://www.tei-c.org/ns/1.0",teieg:"http://www.tei-c.org/ns/Examples",rng:"http://relaxng.org/ns/structure/1.0"},tei:{eg:["<pre>","</pre>"],ptr:['<a href="$rw@target">$@target</a>'],ref:[["[target]",['<a href="$rw@target">',"</a>"]]],graphic:function(e){let t=new Image;return t.src=this.rw(e.getAttribute("url")),e.hasAttribute("width")&&t.setAttribute("width",e.getAttribute("width")),e.hasAttribute("height")&&t.setAttribute("height",e.getAttribute("height")),t},list:[["[type=gloss]",function(e){const t=e.ownerDocument;let n=t.createElement("dl");for(let o of Array.from(e.children))if(o.nodeType==1){if(o.localName=="tei-label"){let r=t.createElement("dt");r.innerHTML=o.innerHTML,n.appendChild(r)}if(o.localName=="tei-item"){let r=t.createElement("dd");r.innerHTML=o.innerHTML,n.appendChild(r)}}return n}]],note:[["[place=end]",function(e){const t=e.ownerDocument;this.noteIndex?this.noteIndex++:this.noteIndex=1;let n="_note_"+this.noteIndex,o=t.createElement("a");o.setAttribute("id","src"+n),o.setAttribute("href","#"+n),o.innerHTML=this.noteIndex;let r=t.createElement("sup");r.appendChild(o);let i=t.querySelector("ol.notes");i||(i=t.createElement("ol"),i.setAttribute("class","notes"),this.dom.appendChild(i));let a=t.createElement("li");return a.id=n,a.innerHTML=e.innerHTML,i.appendChild(a),r}],["_",["(",")"]]],teiHeader:function(e){this.hideContent(e,!1)},title:[["tei-titlestmt>tei-title",function(e){const t=e.ownerDocument;let n=t.createElement("title");n.innerHTML=e.innerText,t.querySelector("head").appendChild(n)}]]},teieg:{egXML:function(e){const t=e.ownerDocument;let n=t.createElement("pre"),o=t.createElement("code");n.appendChild(o);let r=this.serialize(e,!0).replace(/</g,"&lt;"),i=r.match(/^[\t ]+/);return i&&(r=r.replace(new RegExp("^"+i[0],"mg"),"")),o.innerHTML=r,n}}};function to(e,t){let n=1,o=e;for(;o&&o.previousElementSibling!==null&&(!t||o.previousElementSibling.localName==t)&&(n++,o=o.previousElementSibling,!!o.previousElementSibling););return n}function fn(e){const t=e.ownerDocument;let n=o=>{let r;switch(o.nodeType){case 1:r=t.createElement(o.nodeName);break;case 9:r=t.implementation.createDocument();break;case 11:r=t.createDocumentFragment();break;default:r=o.cloneNode(!0)}if(o.attributes)for(let i of Array.from(o.attributes))i.name!=="data-processed"&&r.setAttribute(i.name,i.value);for(let i of Array.from(o.childNodes))if(i.nodeType==1)if(i.hasAttribute("data-original")){for(let a of Array.from(i.childNodes)){let s=r.appendChild(n(a));s.nodeType===1&&s.hasAttribute("data-origid")&&(s.setAttribute("id",s.getAttribute("data-origid")),s.removeAttribute("data-origid"))}return r}else i.hasAttribute("data-origname")&&r.appendChild(n(i));else r.appendChild(i.cloneNode());return r};return n(e)}function hn(e){return e.replace(/ .*$/,"")}function pn(e,t=!0){const n=e.ownerDocument;if(e.childNodes.length>0){let o=n.createElement("cetei-original");e.appendChild(o),o.setAttribute("hidden",""),o.setAttribute("data-original","");for(let r of Array.from(e.childNodes))if(r!==o){if(r.nodeType===1){r.setAttribute("data-processed","");for(let i of r.querySelectorAll("*"))i.setAttribute("data-processed","")}o.appendChild(e.removeChild(r))}if(t)for(let r of Array.from(o.querySelectorAll("*")))r.hasAttribute("id")&&(r.setAttribute("data-origid",r.getAttribute("id")),r.removeAttribute("id"))}}function no(e){return this.rw(this.first(e))}function oo(e,t){let n="";for(let o=0;o<t;o++)n+=e;return n}function ro(e){let t=this.prefixDefs[e.substring(0,e.indexOf(":"))];return e.replace(new RegExp(t.matchPattern),t.replacementPattern)}function io(e){return this.prefixDefs[e]}function ao(e){return e.match(/^(?:http|mailto|file|\/|#).*$/)?e:this.base+hn(e)}function so(e,t,n){return Ge(fn(e),t,n)}function Ge(e,t,n){let o="";const r=i=>!/[^\t\n\r ]/.test(i);if((e.nodeType===9||e.nodeType===11)&&(o+=`<?xml version="1.0" encoding="UTF-8"?>
`),!t&&e.nodeType==1){typeof n=="string"&&n!==""?o+=`
`+n+"<":o+="<",o+=e.getAttribute("data-origname");let i=e.hasAttribute("data-origatts")?e.getAttribute("data-origatts").split(" "):[];for(let a of Array.from(e.attributes))!a.name.startsWith("data-")&&!["id","lang","class"].includes(a.name)&&(o+=" "+i.find(function(s){return s.toLowerCase()==a.name})+'="'+a.value+'"'),a.name=="data-xmlns"&&(o+=' xmlns="'+a.value+'"');e.childNodes.length>0?o+=">":o+="/>"}for(let i of Array.from(e.childNodes))switch(i.nodeType){case 1:typeof n=="string"?o+=Ge(i,!1,n+"  "):o+=Ge(i,!1,n);break;case 7:o+=`<?${i.nodeName} ${i.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;case 8:o+=`<!--${i.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;default:if(t&&r(i.nodeValue)&&(o+=i.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&r(i.nodeValue))break;o+=i.nodeValue}return!t&&e.nodeType==1&&e.childNodes.length>0&&(typeof n=="string"?o+=`
`+n+"</":o+="</",o+=e.getAttribute("data-origname")+">"),(e.nodeType===9||e.nodeType===11)&&(o+=`
`),o}function xt(e,t,n){const o=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];let r="";const i=a=>!/[^\t\n\r ]/.test(a);if(!t&&e.nodeType==1){typeof n=="string"&&n!==""?r+=`
`+n+"<":r+="<",r+=e.nodeName;for(let a of Array.from(e.attributes))r+=" "+a.name+'="'+a.value+'"';r+=">"}for(let a of Array.from(e.childNodes))switch(a.nodeType){case 1:typeof n=="string"?r+=xt(a,!1,n+"  "):r+=xt(a,!1,n);break;case 7:r+=`<?${a.nodeName} ${a.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;case 8:r+=`<!--${a.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;default:if(t&&i(a.nodeValue)&&(r+=a.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&i(a.nodeValue))break;r+=a.nodeValue.replace(/</g,"&lt;")}return o.includes(e.nodeName)||!t&&e.nodeType==1&&(typeof n=="string"?r+=`
${n}</`:r+="</",r+=`${e.nodeName}>`),(e.nodeType===9||e.nodeType===11)&&(r+=`
`),r}function lo(e){return e.replace(/&gt;/,">").replace(/&quot;/,'"').replace(/&apos;/,"'").replace(/&amp;/,"&")}function qe(e){return e.includes(":"),e.replace(/:/,"-").toLowerCase()}function gn(e,t=null,n=!1){try{window.customElements.define(qe(e),class extends HTMLElement{constructor(){super(),this.matches(":defined")||t&&(t.call(this),this.setAttribute("data-processed",""))}connectedCallback(){this.hasAttribute("data-processed")||t&&(t.call(this),this.setAttribute("data-processed",""))}})}catch(o){n&&(console.log(qe(e)+" couldn't be registered or is already registered."),console.log(o))}}const ot=Object.freeze(Object.defineProperty({__proto__:null,copyAndReset:fn,defineCustomElement:gn,first:hn,getOrdinality:to,getPrefixDef:io,hideContent:pn,normalizeURI:no,repeat:oo,resetAndSerialize:so,resolveURI:ro,rw:ao,serialize:Ge,serializeHTML:xt,tagName:qe,unEscapeEntities:lo},Symbol.toStringTag,{value:"Module"}));function co(e){if(e.namespaces)for(let t of Object.keys(e.namespaces))!this.namespaces.has(e.namespaces[t])&&!Array.from(this.namespaces.values()).includes(t)&&this.namespaces.set(e.namespaces[t],t);for(let t of this.namespaces.values())if(e[t])for(let n of Object.keys(e[t]))this.behaviors[`${t}:${n}`]=e[t][n];if(e.functions)for(let t of Object.keys(e.functions))this.utilities[t]=e.functions[t].bind(this.utilities);e.handlers&&console.log("Behavior handlers are no longer used."),e.fallbacks&&console.log("Fallback behaviors are no longer used.")}function uo(e,t,n){let o;if(e===Object(e))for(let r of Object.keys(e))this.namespaces.has(e[r])||(this.namespaces.set(e[r],r),o=r);else o=e;this.behaviors[`${o}:${t}`]=n}function fo(e,t){let n;if(e===Object(e))for(let o of Object.keys(e))this.namespaces.has(e[o])||(this.namespaces.set(e[o],o),n=o);else n=e;delete this.behaviors[`${n}:${t}`]}function ho(e,t){const n=e.documentElement;let o=1,r=function(a){return t.has(a.namespaceURI?a.namespaceURI:"")||t.set(a.namespaceURI,"ns"+o++),t.get(a.namespaceURI?a.namespaceURI:"")+":"+a.localName};const i=new Set(Array.from(n.querySelectorAll("*"),r));return i.add(r(n)),i}function po(e){return new Set(Array.from(e.querySelectorAll("*[data-origname]"),t=>t.localName.replace(/(\w+)-.+/,"$1:")+t.getAttribute("data-origname")))}class Re{constructor(t){this.options=t||{},this.document=this.options.documentObject?this.options.documentObject:void 0,this.document===void 0&&(typeof window<"u"&&window.document?this.document=window.document:typeof global<"u"&&global.document&&(this.document=global.document)),this.addBehaviors=co.bind(this),this.addBehavior=uo.bind(this),this.removeBehavior=fo.bind(this),this.utilities={};for(const n of Object.keys(ot))["getPrefixDef","rw","resolveURI"].includes(n)?this.utilities[n]=ot[n].bind(this):this.utilities[n]=ot[n];if(this.els=[],this.namespaces=new Map,this.behaviors={},this.hasStyle=!1,this.prefixDefs=[],this.debug=this.options.debug===!0,this.discardContent=this.options.discardContent===!0,this.options.base)this.base=this.options.base;else try{window&&(this.base=window.location.href.replace(/\/[^\/]*$/,"/"))}catch{this.base=""}this.options.omitDefaultBehaviors||this.addBehaviors(eo),this.options.ignoreFragmentId&&window&&window.removeEventListener("ceteiceanload",Re.restorePosition)}async getHTML5(t,n,o){window&&window.location.href.startsWith(this.base)&&t.indexOf("/")>=0&&(this.base=t.replace(/\/[^\/]*$/,"/"));try{const r=await fetch(t);if(r.ok){const i=await r.text();return this.makeHTML5(i,n,o)}else console.log(`Could not get XML file ${t}.
Server returned ${r.status}: ${r.statusText}`)}catch(r){console.log(r)}}makeHTML5(t,n,o){return this.XML_dom=new DOMParser().parseFromString(t,"text/xml"),this.domToHTML5(this.XML_dom,n,o)}preprocess(t,n,o){this.els=ho(t,this.namespaces);let r=i=>{let a;if(this.namespaces.has(i.namespaceURI?i.namespaceURI:"")){let s=this.namespaces.get(i.namespaceURI?i.namespaceURI:"");a=this.document.createElement(`${s}-${i.localName.toLowerCase()}`)}else a=this.document.importNode(i,!1);for(let s of Array.from(i.attributes))s.name=="xmlns"?a.setAttribute("data-xmlns",s.value):a.setAttribute(s.name,s.value),s.name=="xml:id"&&a.setAttribute("id",s.value),s.name=="xml:lang"&&a.setAttribute("lang",s.value),s.name=="rendition"&&a.setAttribute("class",s.value.replace(/#/g,""));if(a.setAttribute("data-origname",i.localName),i.hasAttributes()&&a.setAttribute("data-origatts",i.getAttributeNames().join(" ")),i.childNodes.length==0&&a.setAttribute("data-empty",""),i.localName=="head"){let s=t.evaluate("count(ancestor::*[tei:head])",i,function(l){if(l=="tei")return"http://www.tei-c.org/ns/1.0"},1,null);a.setAttribute("data-level",s.numberValue)}if(i.localName=="tagsDecl"){let s=this.document.createElement("style");for(let l of Array.from(i.childNodes))if(l.nodeType==1&&l.localName=="rendition"&&l.getAttribute("scheme")=="css"){let c="";l.hasAttribute("selector")?(c+=l.getAttribute("selector").replace(/([^#, >]+\w*)/g,"tei-$1").replace(/#tei-/g,"#")+`{
`,c+=l.textContent):(c+="."+l.getAttribute("xml:id")+`{
`,c+=l.textContent),c+=`
}
`,s.appendChild(this.document.createTextNode(c))}s.childNodes.length>0&&(a.appendChild(s),this.hasStyle=!0)}i.localName=="prefixDef"&&(this.prefixDefs.push(i.getAttribute("ident")),this.prefixDefs[i.getAttribute("ident")]={matchPattern:i.getAttribute("matchPattern"),replacementPattern:i.getAttribute("replacementPattern")});for(let s of Array.from(i.childNodes))s.nodeType==1?a.appendChild(r(s)):a.appendChild(s.cloneNode());return o&&o(a,i),a};this.dom=this.document.createDocumentFragment();for(let i of Array.from(t.childNodes))i.nodeType==1&&this.dom.appendChild(r(i)),i.nodeType==7&&this.dom.appendChild(this.document.importNode(i,!0)),i.nodeType==8&&this.dom.appendChild(this.document.importNode(i,!0));if(this.utilities.dom=this.dom.firstElementChild,n)n(this.dom,this),window&&window.dispatchEvent(Ee);else return typeof window<"u"&&window.dispatchEvent(Ee),this.dom}domToHTML5(t,n,o){if(this.preprocess(t,null,o),this.applyBehaviors(),this.done=!0,n)n(this.dom,this),window&&window.dispatchEvent(Ee);else return typeof window<"u"&&window.dispatchEvent(Ee),this.dom}processPage(){this.els=po(this.document),this.applyBehaviors(),window&&window.dispatchEvent(Ee)}unsetNamespace(t){this.namespaces.delete(t)}setBaseUrl(t){this.base=t}append(t,n){let o=this;if(n&&!n.hasAttribute("data-processed")){let r=t.call(o.utilities,n);r&&o.appendBasic(n,r)}else return function(){if(!this.hasAttribute("data-processed")){let r=t.call(o.utilities,this);r&&o.appendBasic(this,r)}}}appendBasic(t,n){this.discardContent?t.innerHTML="":pn(t,!0),t.appendChild(n)}bName(t){return t.tagName.substring(0,t.tagName.indexOf("-")).toLowerCase()+":"+t.getAttribute("data-origname")}childExists(t,n){return t&&t.nodeName==n?!0:t&&t.nextElementSibling&&this.childExists(t.nextElementSibling,n)}decorator(t){if(Array.isArray(t)&&t.length==0)return function(o){};if(Array.isArray(t)&&!Array.isArray(t[0]))return this.applyDecorator(t);let n=this;return function(o){for(let r of t)if(o.matches(r[0])||r[0]==="_")return Array.isArray(r[1])?n.decorator(r[1]).call(this,o):r[1].call(this,o)}}applyDecorator(t){let n=this;return function(o){let r=[];for(let i=0;i<t.length;i++)r.push(n.template(t[i],o));return n.insert(o,r)}}getFallback(t,n){if(t[n])return t[n]instanceof Function?t[n]:this.decorator(t[n])}getHandler(t,n){if(t[n])return t[n]instanceof Function?this.append(t[n]):this.append(this.decorator(t[n]))}insert(t,n){let o=this.document.createElement("cetei-content");for(let r of Array.from(t.childNodes))r.nodeType===1&&!r.hasAttribute("data-processed")&&this.processElement(r);if(n[0].match("<[^>]+>")&&n[1]&&n[1].match("<[^>]+>"))o.innerHTML=n[0]+t.innerHTML+(n[1]?n[1]:"");else{o.innerHTML=n[0],o.setAttribute("data-before",n[0].replace(/<[^>]+>/g,"").length);for(let r of Array.from(t.childNodes))o.appendChild(r.cloneNode(!0));n.length>1&&(o.innerHTML+=n[1],o.setAttribute("data-after",n[1].replace(/<[^>]+>/g,"").length))}return o.childNodes.length<2?o.firstChild:o}processElement(t){if(t.hasAttribute("data-origname")&&!t.hasAttribute("data-processed")){let n=this.getFallback(this.bName(t));n&&(this.append(n,t),t.setAttribute("data-processed",""))}for(let n of Array.from(t.childNodes))n.nodeType===1&&this.processElement(n)}template(t,n){let o=t;if(t.search(/\$(\w*)(@([a-zA-Z:]+))/)){let r=/\$(\w*)@([a-zA-Z:]+)/g,i;for(;i=r.exec(t);)n.hasAttribute(i[2])?i[1]&&this.utilities[i[1]]?o=o.replace(i[0],this.utilities[i[1]](n.getAttribute(i[2]))):o=o.replace(i[0],n.getAttribute(i[2])):o=o.replace(i[0],"")}return o}applyBehaviors(){typeof window<"u"&&window.customElements?this.define.call(this,this.els):this.fallback.call(this,this.els)}define(t){for(let n of t){const o=this.getHandler(this.behaviors,n);gn(n,o,this.debug)}}fallback(t){for(let n of t){let o=this.getFallback(this.behaviors,n);if(o)for(let r of Array.from((this.dom&&!this.done?this.dom:this.document).querySelectorAll(qe(n))))r.hasAttribute("data-processed")||(this.append(o,r),r.setAttribute("data-processed",""))}}static savePosition(){window.sessionStorage.setItem(window.location+"-scroll",window.scrollY)}static restorePosition(){if(window.location.hash)setTimeout(function(){let t=this.document.querySelector(window.decodeURI(window.location.hash));t&&t.scrollIntoView()},100);else{let t;(t=window.sessionStorage.getItem(window.location+"-scroll"))&&(window.sessionStorage.removeItem(window.location+"-scroll"),setTimeout(function(){window.scrollTo(0,t)},100))}}}try{if(typeof window<"u"){window.CETEI=Re,window.addEventListener("beforeunload",Re.savePosition);var Ee=new Event("ceteiceanload");window.addEventListener("ceteiceanload",Re.restorePosition)}}catch(e){console.log(e)}var mn={exports:{}},Se={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var kt;function go(){if(kt)return Se;kt=1;var e=dn,t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,r=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function a(s,l,c){var u,h={},m=null,d=null;c!==void 0&&(m=""+c),l.key!==void 0&&(m=""+l.key),l.ref!==void 0&&(d=l.ref);for(u in l)o.call(l,u)&&!i.hasOwnProperty(u)&&(h[u]=l[u]);if(s&&s.defaultProps)for(u in l=s.defaultProps,l)h[u]===void 0&&(h[u]=l[u]);return{$$typeof:t,type:s,key:m,ref:d,props:h,_owner:r.current}}return Se.Fragment=n,Se.jsx=a,Se.jsxs=a,Se}mn.exports=go();var mo=mn.exports,yo=[];for(var rt=0;rt<256;++rt)yo.push((rt+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const bo="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let vo=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=bo[n[e]&63];return t};vo();const yn=k.createContext({anno:void 0,setAnno:void 0,annotations:[],selection:{selected:[]}});k.forwardRef((e,t)=>{const[n,o]=k.useState(null),[r,i]=k.useState([]),[a,s]=k.useState({selected:[]});return k.useImperativeHandle(t,()=>n),k.useEffect(()=>{if(n){const{selection:l,store:c}=n.state;c.all().length>0&&i(c.all());const u=()=>i(()=>c.all());c.observe(u);let h;const m=l.subscribe(({selected:d,...b})=>{h&&c.unobserve(h);const p=(d||[]).map(({id:y,editable:f})=>({annotation:c.getAnnotation(y),editable:f}));s({selected:p,...b}),h=y=>{const{updated:f}=y.changes;s(g=>({...g,selected:g.selected.map(({annotation:v,editable:w})=>{const T=f.find(N=>N.oldValue.id===v.id);return T?{annotation:T.newValue,editable:w}:{annotation:v,editable:w}})}))},c.observe(h,{annotations:d.map(({id:y})=>y)})});return()=>{c.unobserve(u),m()}}},[n]),mo.jsx(yn.Provider,{value:{anno:n,setAnno:o,annotations:r,selection:a},children:e.children})});var wo=Object.defineProperty,xo=(e,t,n)=>t in e?wo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,Ut=(e,t,n)=>xo(e,typeof t!="symbol"?t+"":t,n);function _e(){}function At(e,t){for(const n in t)e[n]=t[n];return e}function bn(e){return e()}function Vt(){return Object.create(null)}function re(e){e.forEach(bn)}function G(e){return typeof e=="function"}function Ke(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}function Ao(e){return Object.keys(e).length===0}function $o(e,t,n,o){if(e){const r=vn(e,t,n,o);return e[0](r)}}function vn(e,t,n,o){return e[1]&&o?At(n.ctx.slice(),e[1](o(t))):n.ctx}function Eo(e,t,n,o){if(e[2]&&o){const r=e[2](o(n));if(t.dirty===void 0)return r;if(typeof r=="object"){const i=[],a=Math.max(t.dirty.length,r.length);for(let s=0;s<a;s+=1)i[s]=t.dirty[s]|r[s];return i}return t.dirty|r}return t.dirty}function So(e,t,n,o,r,i){if(r){const a=vn(t,n,o,i);e.p(a,r)}}function To(e){if(e.ctx.length>32){const t=[],n=e.ctx.length/32;for(let o=0;o<n;o++)t[o]=-1;return t}return-1}function Pt(e){const t={};for(const n in e)n[0]!=="$"&&(t[n]=e[n]);return t}function ze(e){return e??""}function Mt(e,t){e.appendChild(t)}function B(e,t,n){e.insertBefore(t,n||null)}function M(e){e.parentNode&&e.parentNode.removeChild(e)}function Co(e,t){for(let n=0;n<e.length;n+=1)e[n]&&e[n].d(t)}function q(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function wn(e){return document.createTextNode(e)}function J(){return wn(" ")}function xn(){return wn("")}function X(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function x(e,t,n){n==null?e.removeAttribute(t):e.getAttribute(t)!==n&&e.setAttribute(t,n)}function Oo(e){return Array.from(e.childNodes)}function Bt(e,t,n){e.classList.toggle(t,!!n)}function Lo(e,t,{bubbles:n=!1,cancelable:o=!1}={}){return new CustomEvent(e,{detail:t,bubbles:n,cancelable:o})}let ke;function Ie(e){ke=e}function Ro(){if(!ke)throw new Error("Function called outside component initialization");return ke}function Io(){const e=Ro();return(t,n,{cancelable:o=!1}={})=>{const r=e.$$.callbacks[t];if(r){const i=Lo(t,n,{cancelable:o});return r.slice().forEach(a=>{a.call(e,i)}),!i.defaultPrevented}return!0}}function ne(e,t){const n=e.$$.callbacks[t.type];n&&n.slice().forEach(o=>o.call(this,t))}const be=[],Ht=[];let we=[];const Dt=[],No=Promise.resolve();let $t=!1;function _o(){$t||($t=!0,No.then(An))}function Et(e){we.push(e)}const it=new Set;let ge=0;function An(){if(ge!==0)return;const e=ke;do{try{for(;ge<be.length;){const t=be[ge];ge++,Ie(t),ko(t.$$)}}catch(t){throw be.length=0,ge=0,t}for(Ie(null),be.length=0,ge=0;Ht.length;)Ht.pop()();for(let t=0;t<we.length;t+=1){const n=we[t];it.has(n)||(it.add(n),n())}we.length=0}while(be.length);for(;Dt.length;)Dt.pop()();$t=!1,it.clear(),Ie(e)}function ko(e){if(e.fragment!==null){e.update(),re(e.before_update);const t=e.dirty;e.dirty=[-1],e.fragment&&e.fragment.p(e.ctx,t),e.after_update.forEach(Et)}}function Uo(e){const t=[],n=[];we.forEach(o=>e.indexOf(o)===-1?t.push(o):n.push(o)),n.forEach(o=>o()),we=t}const Fe=new Set;let fe;function Vo(){fe={r:0,c:[],p:fe}}function Po(){fe.r||re(fe.c),fe=fe.p}function z(e,t){e&&e.i&&(Fe.delete(e),e.i(t))}function Z(e,t,n,o){if(e&&e.o){if(Fe.has(e))return;Fe.add(e),fe.c.push(()=>{Fe.delete(e),o&&(n&&e.d(1),o())}),e.o(t)}else o&&o()}function jt(e){return e?.length!==void 0?e:Array.from(e)}function he(e){e&&e.c()}function ce(e,t,n){const{fragment:o,after_update:r}=e.$$;o&&o.m(t,n),Et(()=>{const i=e.$$.on_mount.map(bn).filter(G);e.$$.on_destroy?e.$$.on_destroy.push(...i):re(i),e.$$.on_mount=[]}),r.forEach(Et)}function de(e,t){const n=e.$$;n.fragment!==null&&(Uo(n.after_update),re(n.on_destroy),n.fragment&&n.fragment.d(t),n.on_destroy=n.fragment=null,n.ctx=[])}function Mo(e,t){e.$$.dirty[0]===-1&&(be.push(e),_o(),e.$$.dirty.fill(0)),e.$$.dirty[t/31|0]|=1<<t%31}function Qe(e,t,n,o,r,i,a=null,s=[-1]){const l=ke;Ie(e);const c=e.$$={fragment:null,ctx:[],props:i,update:_e,not_equal:r,bound:Vt(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(t.context||(l?l.$$.context:[])),callbacks:Vt(),dirty:s,skip_bound:!1,root:t.target||l.$$.root};a&&a(c.root);let u=!1;if(c.ctx=n?n(e,t.props||{},(h,m,...d)=>{const b=d.length?d[0]:m;return c.ctx&&r(c.ctx[h],c.ctx[h]=b)&&(!c.skip_bound&&c.bound[h]&&c.bound[h](b),u&&Mo(e,h)),m}):[],c.update(),u=!0,re(c.before_update),c.fragment=o?o(c.ctx):!1,t.target){if(t.hydrate){const h=Oo(t.target);c.fragment&&c.fragment.l(h),h.forEach(M)}else c.fragment&&c.fragment.c();t.intro&&z(e.$$.fragment),ce(e,t.target,t.anchor),An()}Ie(l)}let Ze=class{constructor(){Ut(this,"$$"),Ut(this,"$$set")}$destroy(){de(this,1),this.$destroy=_e}$on(t,n){if(!G(n))return _e;const o=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return o.push(n),()=>{const r=o.indexOf(n);r!==-1&&o.splice(r,1)}}$set(t){this.$$set&&!Ao(t)&&(this.$$.skip_bound=!0,this.$$set(t),this.$$.skip_bound=!1)}};const Bo="4";typeof window<"u"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Bo);var xe=(e=>(e.ELLIPSE="ELLIPSE",e.POLYGON="POLYGON",e.RECTANGLE="RECTANGLE",e))(xe||{});const Ct=(e,t)=>t,Ho=e=>{let t=1/0,n=1/0,o=-1/0,r=-1/0;return e.forEach(([i,a])=>{t=Math.min(t,i),n=Math.min(n,a),o=Math.max(o,i),r=Math.max(r,a)}),{minX:t,minY:n,maxX:o,maxY:r}},Do={area:e=>Math.PI*e.geometry.rx*e.geometry.ry,intersects:(e,t,n)=>{const{cx:o,cy:r,rx:i,ry:a}=e.geometry,s=0,l=Math.cos(s),c=Math.sin(s),u=t-o,h=n-r,m=l*u+c*h,d=c*u-l*h;return m*m/(i*i)+d*d/(a*a)<=1}};Ct(xe.ELLIPSE,Do);const jo={area:e=>{const{points:t}=e.geometry;let n=0,o=t.length-1;for(let r=0;r<t.length;r++)n+=(t[o][0]+t[r][0])*(t[o][1]-t[r][1]),o=r;return Math.abs(.5*n)},intersects:(e,t,n)=>{const{points:o}=e.geometry;let r=!1;for(let i=0,a=o.length-1;i<o.length;a=i++){const s=o[i][0],l=o[i][1],c=o[a][0],u=o[a][1];l>n!=u>n&&t<(c-s)*(n-l)/(u-l)+s&&(r=!r)}return r}};Ct(xe.POLYGON,jo);const Yo={area:e=>e.geometry.w*e.geometry.h,intersects:(e,t,n)=>t>=e.geometry.x&&t<=e.geometry.x+e.geometry.w&&n>=e.geometry.y&&n<=e.geometry.y+e.geometry.h};Ct(xe.RECTANGLE,Yo);var Xo=[];for(var at=0;at<256;++at)Xo.push((at+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var Fo=[];for(var st=0;st<256;++st)Fo.push((st+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Go="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let qo=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=Go[n[e]&63];return t};qo();function Yt(e,t,n){const o=e.slice();return o[10]=t[n],o[12]=n,o}function Xt(e){let t,n;return t=new Ce({props:{x:e[10][0],y:e[10][1],scale:e[3]}}),t.$on("pointerdown",function(){G(e[9](`HANDLE-${e[12]}`))&&e[9](`HANDLE-${e[12]}`).apply(this,arguments)}),{c(){he(t.$$.fragment)},m(o,r){ce(t,o,r),n=!0},p(o,r){e=o;const i={};r&16&&(i.x=e[10][0]),r&16&&(i.y=e[10][1]),r&8&&(i.scale=e[3]),t.$set(i)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){Z(t.$$.fragment,o),n=!1},d(o){de(t,o)}}}function zo(e){let t,n,o,r,i,a,s,l,c,u,h,m=jt(e[4].points),d=[];for(let p=0;p<m.length;p+=1)d[p]=Xt(Yt(e,m,p));const b=p=>Z(d[p],1,1,()=>{d[p]=null});return{c(){t=q("polygon"),r=J(),i=q("polygon"),s=J();for(let p=0;p<d.length;p+=1)d[p].c();l=xn(),x(t,"class","a9s-outer"),x(t,"style",n=e[1]?"display:none;":void 0),x(t,"points",o=e[4].points.map(Ft).join(" ")),x(i,"class","a9s-inner a9s-shape-handle"),x(i,"style",e[1]),x(i,"points",a=e[4].points.map(Gt).join(" "))},m(p,y){B(p,t,y),B(p,r,y),B(p,i,y),B(p,s,y);for(let f=0;f<d.length;f+=1)d[f]&&d[f].m(p,y);B(p,l,y),c=!0,u||(h=[X(t,"pointerdown",function(){G(e[9]("SHAPE"))&&e[9]("SHAPE").apply(this,arguments)}),X(i,"pointerdown",function(){G(e[9]("SHAPE"))&&e[9]("SHAPE").apply(this,arguments)})],u=!0)},p(p,y){if(e=p,(!c||y&2&&n!==(n=e[1]?"display:none;":void 0))&&x(t,"style",n),(!c||y&16&&o!==(o=e[4].points.map(Ft).join(" ")))&&x(t,"points",o),(!c||y&2)&&x(i,"style",e[1]),(!c||y&16&&a!==(a=e[4].points.map(Gt).join(" ")))&&x(i,"points",a),y&536){m=jt(e[4].points);let f;for(f=0;f<m.length;f+=1){const g=Yt(e,m,f);d[f]?(d[f].p(g,y),z(d[f],1)):(d[f]=Xt(g),d[f].c(),z(d[f],1),d[f].m(l.parentNode,l))}for(Vo(),f=m.length;f<d.length;f+=1)b(f);Po()}},i(p){if(!c){for(let y=0;y<m.length;y+=1)z(d[y]);c=!0}},o(p){d=d.filter(Boolean);for(let y=0;y<d.length;y+=1)Z(d[y]);c=!1},d(p){p&&(M(t),M(r),M(i),M(s),M(l)),Co(d,p),u=!1,re(h)}}}function Wo(e){let t,n;return t=new $n({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[zo,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("change",e[6]),t.$on("grab",e[7]),t.$on("release",e[8]),{c(){he(t.$$.fragment)},m(o,r){ce(t,o,r),n=!0},p(o,[r]){const i={};r&1&&(i.shape=o[0]),r&4&&(i.transform=o[2]),r&8730&&(i.$$scope={dirty:r,ctx:o}),t.$set(i)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){Z(t.$$.fragment,o),n=!1},d(o){de(t,o)}}}const Ft=e=>e.join(","),Gt=e=>e.join(",");function Jo(e,t,n){let o,{shape:r}=t,{computedStyle:i}=t,{transform:a}=t,{viewportScale:s=1}=t;const l=(m,d,b)=>{let p;const y=m.geometry;d==="SHAPE"?p=y.points.map(([g,v])=>[g+b[0],v+b[1]]):p=y.points.map(([g,v],w)=>d===`HANDLE-${w}`?[g+b[0],v+b[1]]:[g,v]);const f=Ho(p);return{...m,geometry:{points:p,bounds:f}}};function c(m){ne.call(this,e,m)}function u(m){ne.call(this,e,m)}function h(m){ne.call(this,e,m)}return e.$$set=m=>{"shape"in m&&n(0,r=m.shape),"computedStyle"in m&&n(1,i=m.computedStyle),"transform"in m&&n(2,a=m.transform),"viewportScale"in m&&n(3,s=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry)},[r,i,a,s,o,l,c,u,h]}class Ko extends Ze{constructor(t){super(),Qe(this,t,Jo,Wo,Ke,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}const Qo=typeof window>"u"||typeof navigator>"u"?!1:"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;function Zo(e){let t,n,o,r,i,a;return{c(){t=q("rect"),x(t,"class",n=ze(`a9s-handle ${e[8].class||""}`.trim())+" svelte-1sgkh33"),x(t,"x",o=e[0]-e[5]/2),x(t,"y",r=e[1]-e[5]/2),x(t,"width",e[5]),x(t,"height",e[5])},m(s,l){B(s,t,l),i||(a=X(t,"pointerdown",e[11]),i=!0)},p(s,l){l&256&&n!==(n=ze(`a9s-handle ${s[8].class||""}`.trim())+" svelte-1sgkh33")&&x(t,"class",n),l&33&&o!==(o=s[0]-s[5]/2)&&x(t,"x",o),l&34&&r!==(r=s[1]-s[5]/2)&&x(t,"y",r),l&32&&x(t,"width",s[5]),l&32&&x(t,"height",s[5])},d(s){s&&M(t),i=!1,a()}}}function er(e){let t,n,o,r,i,a,s,l,c;return{c(){t=q("g"),n=q("circle"),r=q("rect"),x(n,"cx",e[0]),x(n,"cy",e[1]),x(n,"r",o=e[3]/e[2]),x(n,"class","a9s-touch-halo svelte-1sgkh33"),Bt(n,"touched",e[4]),x(r,"class",i=ze(`a9s-handle ${e[8].class||""}`.trim())+" svelte-1sgkh33"),x(r,"x",a=e[0]-e[5]/2),x(r,"y",s=e[1]-e[5]/2),x(r,"width",e[5]),x(r,"height",e[5]),x(t,"class","a9s-touch-handle")},m(u,h){B(u,t,h),Mt(t,n),Mt(t,r),l||(c=[X(n,"pointerdown",e[10]),X(n,"pointerdown",e[6]),X(n,"pointerup",e[7]),X(r,"pointerdown",e[9]),X(r,"pointerdown",e[6]),X(r,"pointerup",e[7])],l=!0)},p(u,h){h&1&&x(n,"cx",u[0]),h&2&&x(n,"cy",u[1]),h&12&&o!==(o=u[3]/u[2])&&x(n,"r",o),h&16&&Bt(n,"touched",u[4]),h&256&&i!==(i=ze(`a9s-handle ${u[8].class||""}`.trim())+" svelte-1sgkh33")&&x(r,"class",i),h&33&&a!==(a=u[0]-u[5]/2)&&x(r,"x",a),h&34&&s!==(s=u[1]-u[5]/2)&&x(r,"y",s),h&32&&x(r,"width",u[5]),h&32&&x(r,"height",u[5])},d(u){u&&M(t),l=!1,re(c)}}}function tr(e){let t;function n(r,i){return Qo?er:Zo}let o=n()(e);return{c(){o.c(),t=xn()},m(r,i){o.m(r,i),B(r,t,i)},p(r,[i]){o.p(r,i)},i:_e,o:_e,d(r){r&&M(t),o.d(r)}}}function nr(e,t,n){let o,{x:r}=t,{y:i}=t,{scale:a}=t,{radius:s=30}=t,l=!1;const c=b=>{b.pointerType==="touch"&&n(4,l=!0)},u=()=>n(4,l=!1);function h(b){ne.call(this,e,b)}function m(b){ne.call(this,e,b)}function d(b){ne.call(this,e,b)}return e.$$set=b=>{n(8,t=At(At({},t),Pt(b))),"x"in b&&n(0,r=b.x),"y"in b&&n(1,i=b.y),"scale"in b&&n(2,a=b.scale),"radius"in b&&n(3,s=b.radius)},e.$$.update=()=>{e.$$.dirty&4&&n(5,o=10/a)},t=Pt(t),[r,i,a,s,l,o,c,u,t,h,m,d]}let Ce=class extends Ze{constructor(t){super(),Qe(this,t,nr,tr,Ke,{x:0,y:1,scale:2,radius:3})}};function or(e){let t,n,o,r,i,a,s,l,c,u,h,m,d,b,p,y,f,g,v,w,T,N,I,L,H,A,E,$,S,U,R,P,ie,Q,Ae,ae,et,se,tt,le,V,nt,It;return Q=new Ce({props:{class:"a9s-corner-handle-topleft",x:e[4].x,y:e[4].y,scale:e[3]}}),Q.$on("pointerdown",function(){G(e[9]("TOP_LEFT"))&&e[9]("TOP_LEFT").apply(this,arguments)}),ae=new Ce({props:{class:"a9s-corner-handle-topright",x:e[4].x+e[4].w,y:e[4].y,scale:e[3]}}),ae.$on("pointerdown",function(){G(e[9]("TOP_RIGHT"))&&e[9]("TOP_RIGHT").apply(this,arguments)}),se=new Ce({props:{class:"a9s-corner-handle-bottomright",x:e[4].x+e[4].w,y:e[4].y+e[4].h,scale:e[3]}}),se.$on("pointerdown",function(){G(e[9]("BOTTOM_RIGHT"))&&e[9]("BOTTOM_RIGHT").apply(this,arguments)}),le=new Ce({props:{class:"a9s-corner-handle-bottomleft",x:e[4].x,y:e[4].y+e[4].h,scale:e[3]}}),le.$on("pointerdown",function(){G(e[9]("BOTTOM_LEFT"))&&e[9]("BOTTOM_LEFT").apply(this,arguments)}),{c(){t=q("rect"),s=J(),l=q("rect"),d=J(),b=q("rect"),g=J(),v=q("rect"),I=J(),L=q("rect"),$=J(),S=q("rect"),ie=J(),he(Q.$$.fragment),Ae=J(),he(ae.$$.fragment),et=J(),he(se.$$.fragment),tt=J(),he(le.$$.fragment),x(t,"class","a9s-outer"),x(t,"style",n=e[1]?"display:none;":void 0),x(t,"x",o=e[4].x),x(t,"y",r=e[4].y),x(t,"width",i=e[4].w),x(t,"height",a=e[4].h),x(l,"class","a9s-inner a9s-shape-handle"),x(l,"style",e[1]),x(l,"x",c=e[4].x),x(l,"y",u=e[4].y),x(l,"width",h=e[4].w),x(l,"height",m=e[4].h),x(b,"class","a9s-edge-handle a9s-edge-handle-top"),x(b,"x",p=e[4].x),x(b,"y",y=e[4].y),x(b,"height",1),x(b,"width",f=e[4].w),x(v,"class","a9s-edge-handle a9s-edge-handle-right"),x(v,"x",w=e[4].x+e[4].w),x(v,"y",T=e[4].y),x(v,"height",N=e[4].h),x(v,"width",1),x(L,"class","a9s-edge-handle a9s-edge-handle-bottom"),x(L,"x",H=e[4].x),x(L,"y",A=e[4].y+e[4].h),x(L,"height",1),x(L,"width",E=e[4].w),x(S,"class","a9s-edge-handle a9s-edge-handle-left"),x(S,"x",U=e[4].x),x(S,"y",R=e[4].y),x(S,"height",P=e[4].h),x(S,"width",1)},m(O,C){B(O,t,C),B(O,s,C),B(O,l,C),B(O,d,C),B(O,b,C),B(O,g,C),B(O,v,C),B(O,I,C),B(O,L,C),B(O,$,C),B(O,S,C),B(O,ie,C),ce(Q,O,C),B(O,Ae,C),ce(ae,O,C),B(O,et,C),ce(se,O,C),B(O,tt,C),ce(le,O,C),V=!0,nt||(It=[X(t,"pointerdown",function(){G(e[9]("SHAPE"))&&e[9]("SHAPE").apply(this,arguments)}),X(l,"pointerdown",function(){G(e[9]("SHAPE"))&&e[9]("SHAPE").apply(this,arguments)}),X(b,"pointerdown",function(){G(e[9]("TOP"))&&e[9]("TOP").apply(this,arguments)}),X(v,"pointerdown",function(){G(e[9]("RIGHT"))&&e[9]("RIGHT").apply(this,arguments)}),X(L,"pointerdown",function(){G(e[9]("BOTTOM"))&&e[9]("BOTTOM").apply(this,arguments)}),X(S,"pointerdown",function(){G(e[9]("LEFT"))&&e[9]("LEFT").apply(this,arguments)})],nt=!0)},p(O,C){e=O,(!V||C&2&&n!==(n=e[1]?"display:none;":void 0))&&x(t,"style",n),(!V||C&16&&o!==(o=e[4].x))&&x(t,"x",o),(!V||C&16&&r!==(r=e[4].y))&&x(t,"y",r),(!V||C&16&&i!==(i=e[4].w))&&x(t,"width",i),(!V||C&16&&a!==(a=e[4].h))&&x(t,"height",a),(!V||C&2)&&x(l,"style",e[1]),(!V||C&16&&c!==(c=e[4].x))&&x(l,"x",c),(!V||C&16&&u!==(u=e[4].y))&&x(l,"y",u),(!V||C&16&&h!==(h=e[4].w))&&x(l,"width",h),(!V||C&16&&m!==(m=e[4].h))&&x(l,"height",m),(!V||C&16&&p!==(p=e[4].x))&&x(b,"x",p),(!V||C&16&&y!==(y=e[4].y))&&x(b,"y",y),(!V||C&16&&f!==(f=e[4].w))&&x(b,"width",f),(!V||C&16&&w!==(w=e[4].x+e[4].w))&&x(v,"x",w),(!V||C&16&&T!==(T=e[4].y))&&x(v,"y",T),(!V||C&16&&N!==(N=e[4].h))&&x(v,"height",N),(!V||C&16&&H!==(H=e[4].x))&&x(L,"x",H),(!V||C&16&&A!==(A=e[4].y+e[4].h))&&x(L,"y",A),(!V||C&16&&E!==(E=e[4].w))&&x(L,"width",E),(!V||C&16&&U!==(U=e[4].x))&&x(S,"x",U),(!V||C&16&&R!==(R=e[4].y))&&x(S,"y",R),(!V||C&16&&P!==(P=e[4].h))&&x(S,"height",P);const Ue={};C&16&&(Ue.x=e[4].x),C&16&&(Ue.y=e[4].y),C&8&&(Ue.scale=e[3]),Q.$set(Ue);const Ve={};C&16&&(Ve.x=e[4].x+e[4].w),C&16&&(Ve.y=e[4].y),C&8&&(Ve.scale=e[3]),ae.$set(Ve);const Pe={};C&16&&(Pe.x=e[4].x+e[4].w),C&16&&(Pe.y=e[4].y+e[4].h),C&8&&(Pe.scale=e[3]),se.$set(Pe);const Me={};C&16&&(Me.x=e[4].x),C&16&&(Me.y=e[4].y+e[4].h),C&8&&(Me.scale=e[3]),le.$set(Me)},i(O){V||(z(Q.$$.fragment,O),z(ae.$$.fragment,O),z(se.$$.fragment,O),z(le.$$.fragment,O),V=!0)},o(O){Z(Q.$$.fragment,O),Z(ae.$$.fragment,O),Z(se.$$.fragment,O),Z(le.$$.fragment,O),V=!1},d(O){O&&(M(t),M(s),M(l),M(d),M(b),M(g),M(v),M(I),M(L),M($),M(S),M(ie),M(Ae),M(et),M(tt)),de(Q,O),de(ae,O),de(se,O),de(le,O),nt=!1,re(It)}}}function rr(e){let t,n;return t=new $n({props:{shape:e[0],transform:e[2],editor:e[5],$$slots:{default:[or,({grab:o})=>({9:o}),({grab:o})=>o?512:0]},$$scope:{ctx:e}}}),t.$on("grab",e[6]),t.$on("change",e[7]),t.$on("release",e[8]),{c(){he(t.$$.fragment)},m(o,r){ce(t,o,r),n=!0},p(o,[r]){const i={};r&1&&(i.shape=o[0]),r&4&&(i.transform=o[2]),r&1562&&(i.$$scope={dirty:r,ctx:o}),t.$set(i)},i(o){n||(z(t.$$.fragment,o),n=!0)},o(o){Z(t.$$.fragment,o),n=!1},d(o){de(t,o)}}}function ir(e,t,n){let o,{shape:r}=t,{computedStyle:i}=t,{transform:a}=t,{viewportScale:s=1}=t;const l=(m,d,b)=>{const p=m.geometry.bounds;let[y,f]=[p.minX,p.minY],[g,v]=[p.maxX,p.maxY];const[w,T]=b;if(d==="SHAPE")y+=w,g+=w,f+=T,v+=T;else{switch(d){case"TOP":case"TOP_LEFT":case"TOP_RIGHT":{f+=T;break}case"BOTTOM":case"BOTTOM_LEFT":case"BOTTOM_RIGHT":{v+=T;break}}switch(d){case"LEFT":case"TOP_LEFT":case"BOTTOM_LEFT":{y+=w;break}case"RIGHT":case"TOP_RIGHT":case"BOTTOM_RIGHT":{g+=w;break}}}const N=Math.min(y,g),I=Math.min(f,v),L=Math.abs(g-y),H=Math.abs(v-f);return{...m,geometry:{x:N,y:I,w:L,h:H,bounds:{minX:N,minY:I,maxX:N+L,maxY:I+H}}}};function c(m){ne.call(this,e,m)}function u(m){ne.call(this,e,m)}function h(m){ne.call(this,e,m)}return e.$$set=m=>{"shape"in m&&n(0,r=m.shape),"computedStyle"in m&&n(1,i=m.computedStyle),"transform"in m&&n(2,a=m.transform),"viewportScale"in m&&n(3,s=m.viewportScale)},e.$$.update=()=>{e.$$.dirty&1&&n(4,o=r.geometry)},[r,i,a,s,o,l,c,u,h]}class ar extends Ze{constructor(t){super(),Qe(this,t,ir,rr,Ke,{shape:0,computedStyle:1,transform:2,viewportScale:3})}}xe.RECTANGLE,xe.POLYGON;const sr=e=>({}),qt=e=>({grab:e[0]});function lr(e){let t,n,o,r;const i=e[7].default,a=$o(i,e,e[6],qt);return{c(){t=q("g"),a&&a.c(),x(t,"class","a9s-annotation selected")},m(s,l){B(s,t,l),a&&a.m(t,null),n=!0,o||(r=[X(t,"pointerup",e[2]),X(t,"pointermove",e[1])],o=!0)},p(s,[l]){a&&a.p&&(!n||l&64)&&So(a,i,s,s[6],n?Eo(i,s[6],l,sr):To(s[6]),qt)},i(s){n||(z(a,s),n=!0)},o(s){Z(a,s),n=!1},d(s){s&&M(t),a&&a.d(s),o=!1,re(r)}}}function cr(e,t,n){let{$$slots:o={},$$scope:r}=t;const i=Io();let{shape:a}=t,{editor:s}=t,{transform:l}=t,c,u,h;const m=p=>y=>{c=p,u=l.elementToImage(y.offsetX,y.offsetY),h=a,y.target.setPointerCapture(y.pointerId),i("grab",y)},d=p=>{if(c){const[y,f]=l.elementToImage(p.offsetX,p.offsetY),g=[y-u[0],f-u[1]];n(3,a=s(h,c,g)),i("change",a)}},b=p=>{p.target.releasePointerCapture(p.pointerId),c=void 0,h=a,i("release",p)};return e.$$set=p=>{"shape"in p&&n(3,a=p.shape),"editor"in p&&n(4,s=p.editor),"transform"in p&&n(5,l=p.transform),"$$scope"in p&&n(6,r=p.$$scope)},[m,d,b,a,s,l,r,o]}let $n=class extends Ze{constructor(t){super(),Qe(this,t,cr,lr,Ke,{shape:3,editor:4,transform:5})}};typeof navigator>"u"||navigator.userAgent.indexOf("Mac OS X");var dr=[];for(var lt=0;lt<256;++lt)dr.push((lt+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var ur=[];for(var ct=0;ct<256;++ct)ur.push((ct+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const fr="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let hr=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=fr[n[e]&63];return t};hr();const En="not-annotatable",oe=`.${En}`,pr=e=>{var t;const n=e.commonAncestorContainer;return n instanceof HTMLElement?!n.closest(oe):!((t=n.parentElement)!=null&&t.closest(oe))},gr=function*(e){const t=document.createNodeIterator(e.commonAncestorContainer,NodeFilter.SHOW_ELEMENT,o=>o instanceof HTMLElement&&o.classList.contains(En)&&!o.parentElement.closest(oe)&&e.intersectsNode(o)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);let n;for(;n=t.nextNode();)n instanceof HTMLElement&&(yield n)},mr=e=>{if(!pr(e))return[];const t=[];let n=null;for(const o of gr(e)){let r;n?(r=document.createRange(),r.setStartAfter(n),r.setEndBefore(o)):(r=e.cloneRange(),r.setEndBefore(o)),r.collapsed||t.push(r),n=o}if(n){const o=e.cloneRange();o.setStartAfter(n),o.collapsed||t.push(o)}return t.length>0?t:[e]},St=e=>{const t=e.cloneContents();return t.querySelectorAll(oe).forEach(n=>n.remove()),t},yr=e=>{e.addEventListener("click",t=>{!t.target.closest(oe)&&!t.target.closest("a")&&t.preventDefault()})},Ot=(e,t=10)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(void 0,o),t)}},br=(e,t,n=10,o)=>{const r=t,i=document.createRange();i.setStart(r,0),i.setEnd(e.startContainer,e.startOffset);const a=St(i).textContent,s=document.createRange();s.setStart(e.endContainer,e.endOffset),r===document.body?s.setEnd(r,r.childNodes.length):s.setEndAfter(r);const l=St(s).textContent;return{prefix:a.substring(a.length-n),suffix:l.substring(0,n)}},vr=/^\s*$/,wr=e=>vr.test(e.toString()),te=e=>e.every(t=>t.range instanceof Range&&!t.range.collapsed),xr=(e,t)=>{const n=i=>Math.round(i*10)/10,o={top:n(e.top),bottom:n(e.bottom),left:n(e.left),right:n(e.right)},r={top:n(t.top),bottom:n(t.bottom),left:n(t.left),right:n(t.right)};if(Math.abs(o.top-r.top)<.5&&Math.abs(o.bottom-r.bottom)<.5){if(Math.abs(o.left-r.right)<.5||Math.abs(o.right-r.left)<.5)return"inline-adjacent";if(o.left>=r.left&&o.right<=r.right)return"inline-is-contained";if(o.left<=r.left&&o.right>=r.right)return"inline-contains"}else if(o.top<=r.top&&o.bottom>=r.bottom){if(o.left<=r.left&&o.right>=r.right)return"block-contains"}else if(o.top>=r.top&&o.bottom<=r.bottom&&o.left>=r.left&&o.right<=r.right)return"block-is-contained"},Ar=(e,t)=>{const n=Math.min(e.left,t.left),o=Math.max(e.right,t.right),r=Math.min(e.top,t.top),i=Math.max(e.bottom,t.bottom);return new DOMRect(n,r,o-n,i-r)},$r=e=>e.reduce((t,n)=>{if(n.width===0||n.height===0)return t;let o=[...t],r=!1;for(const i of t){const a=xr(n,i);if(a==="inline-adjacent"){o=o.map(s=>s===i?Ar(n,i):s),r=!0;break}else if(a==="inline-contains"){o=o.map(s=>s===i?n:s),r=!0;break}else if(a==="inline-is-contained"){r=!0;break}else if(a==="block-contains"||a==="block-is-contained"){n.width<i.width&&(o=o.map(s=>s===i?n:s)),r=!0;break}}return r?o:[...o,n]},[]),Er=(e,t,n)=>{const o=document.createRange(),r=n?e.startContainer.parentElement.closest(n):t;o.setStart(r,0),o.setEnd(e.startContainer,e.startOffset);const i=St(o).textContent,a=e.toString(),s=i.length||0,l=s+a.length;return n?{quote:a,start:s,end:l,range:e,offsetReference:r}:{quote:a,start:s,end:l,range:e}},Sn=(e,t)=>{var n,o;const{start:r,end:i}=e,a=e.offsetReference||t,s=document.createNodeIterator(t,NodeFilter.SHOW_TEXT,m=>{var d;return(d=m.parentElement)!=null&&d.closest(oe)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let l=0;const c=document.createRange();let u=s.nextNode();u===null&&console.error("Could not revive annotation target. Content missing.");let h=!a;for(;u!==null;){if(h||(h=a?.contains(u)),h){const m=((n=u.textContent)==null?void 0:n.length)||0;if(l+m>r){c.setStart(u,r-l);break}l+=m}u=s.nextNode()}for(;u!==null;){const m=((o=u.textContent)==null?void 0:o.length)||0;if(l+m>=i){c.setEnd(u,i-l);break}l+=m,u=s.nextNode()}return{...e,range:c}},We=(e,t)=>te(e.selector)?e:{...e,selector:e.selector.map(n=>n.range instanceof Range&&!n.range.collapsed?n:Sn(n,t))},dt=(e,t)=>te(e.target.selector)?e:{...e,target:We(e.target,t)},Sr=(e,t)=>{const n=e.cloneRange();return t.contains(n.startContainer)||n.setStart(t,0),t.contains(n.endContainer)||n.setEnd(t,t.childNodes.length),n},Tn=e=>{if(e===null)return document.scrollingElement;const{overflowY:t}=window.getComputedStyle(e);return t!=="visible"&&t!=="hidden"&&e.scrollHeight>e.clientHeight?e:Tn(e.parentElement)},Tr=(e,t)=>n=>{const o=typeof n=="string"?n:n.id,r=a=>{const s=i.getBoundingClientRect(),l=i.clientHeight,c=i.clientWidth,u=a.selector[0].range.getBoundingClientRect(),{width:h,height:m}=t.getAnnotationBounds(o),d=u.top-s.top,b=u.left-s.left,p=i.parentElement?i.scrollTop:0,y=i.parentElement?i.scrollLeft:0,f=d+p-(l-m)/2,g=b+y-(c-h)/2;i.scroll({top:f,left:g,behavior:"smooth"})},i=Tn(e);if(i){const a=t.getAnnotation(o),{range:s}=a.target.selector[0];if(s&&!s.collapsed)return r(a.target),!0;{const l=We(a.target,e),{range:c}=l.selector[0];if(c&&!c.collapsed)return r(l),!0}}return!1},ue={fill:"rgb(0, 128, 255)",fillOpacity:.18},Je={fill:"rgb(0, 128, 255)",fillOpacity:.45},Cr=(e,t,n,o,r)=>{var i,a;const s=n?typeof n=="function"?n(e.annotation,e.state,r)||((i=e.state)!=null&&i.selected?Je:ue):n:(a=e.state)!=null&&a.selected?Je:ue;return o&&o.paint(e,t)||s},Or=e=>{const{top:t,left:n}=e.getBoundingClientRect(),{innerWidth:o,innerHeight:r}=window,i=-n,a=-t,s=o-n,l=r-t;return{top:t,left:n,minX:i,minY:a,maxX:s,maxY:l}},Lr=e=>{let t=new Set;return n=>{const o=n.map(r=>r.id);(t.size!==o.length||o.some(r=>!t.has(r)))&&e.set(o),t=new Set(o)}},Lt=(e,t,n,o)=>{const{store:r,selection:i,hover:a}=t;let s,l,c;const u=Lr(n),h=I=>{const{x:L,y:H}=e.getBoundingClientRect(),A=r.getAt(I.clientX-L,I.clientY-H,l);A?a.current!==A.id&&(e.classList.add("hovered"),a.set(A.id)):a.current&&(e.classList.remove("hovered"),a.set(null))};e.addEventListener("pointermove",h);const m=(I=!1)=>{c&&c.clear();const L=Or(e),{minX:H,minY:A,maxX:E,maxY:$}=L,S=l?r.getIntersecting(H,A,E,$).filter(({annotation:P})=>l(P)):r.getIntersecting(H,A,E,$),U=i.selected.map(({id:P})=>P),R=S.map(({annotation:P,rects:ie})=>{const Q=U.includes(P.id),Ae=P.id===a.current;return{annotation:P,rects:ie,state:{selected:Q,hover:Ae}}});o.redraw(R,L,s,c,I),setTimeout(()=>u(S.map(({annotation:P})=>P)),1)},d=I=>{c=I,m()},b=I=>{s=I,m()},p=I=>{l=I,m(!1)},y=()=>m();r.observe(y);const f=i.subscribe(()=>m()),g=()=>m(!0);document.addEventListener("scroll",g,{capture:!0,passive:!0});const v=Ot(()=>{r.recalculatePositions(),c&&c.reset(),m()});window.addEventListener("resize",v);const w=new ResizeObserver(v);w.observe(e);const T={attributes:!0,childList:!0,subtree:!0},N=new MutationObserver(I=>{I.every(L=>L.target===e||e.contains(L.target))||m(!0)});return N.observe(document.body,T),{destroy:()=>{e.removeEventListener("pointermove",h),o.destroy(),r.unobserve(y),f(),document.removeEventListener("scroll",g),window.removeEventListener("resize",v),w.disconnect(),N.disconnect()},redraw:m,setStyle:b,setFilter:p,setPainter:d,setVisible:o.setVisible}},Rr=()=>{const e=document.createElement("canvas");return e.width=window.innerWidth,e.height=window.innerHeight,e.className="r6o-canvas-highlight-layer bg",e},Ir=(e,t)=>{e.width=window.innerWidth,e.height=window.innerHeight},Nr=e=>{e.classList.add("r6o-annotatable");const t=Rr(),n=t.getContext("2d");document.body.appendChild(t);const o=(i,a,s,l)=>requestAnimationFrame(()=>{const{width:c,height:u}=t;n.clearRect(-.5,-.5,c+1,u+1),l&&l.clear();const{top:h,left:m}=a;[...i].sort((d,b)=>{const{annotation:{target:{created:p}}}=d,{annotation:{target:{created:y}}}=b;return p.getTime()-y.getTime()}).forEach(d=>{var b;const p=s?typeof s=="function"?s(d.annotation,d.state):s:(b=d.state)!=null&&b.selected?Je:ue,y=l&&l.paint(d,a)||p,f=d.rects.map(({x:g,y:v,width:w,height:T})=>({x:g+m,y:v+h,width:w,height:T}));if(n.fillStyle=y.fill,n.globalAlpha=y.fillOpacity||1,f.forEach(({x:g,y:v,width:w,height:T})=>n.fillRect(g,v,w,T)),y.underlineColor){n.globalAlpha=1,n.strokeStyle=y.underlineColor,n.lineWidth=y.underlineThickness??1;const g=y.underlineOffset??0;f.forEach(({x:v,y:w,width:T,height:N})=>{n.beginPath(),n.moveTo(v,w+N+g),n.lineTo(v+T,w+N+g),n.stroke()})}})}),r=Ot(()=>{Ir(t)});return window.addEventListener("resize",r),{destroy:()=>{t.remove(),window.removeEventListener("resize",r)},setVisible:i=>{console.log("setVisible not implemented on Canvas renderer")},redraw:o}},_r=(e,t,n)=>Lt(e,t,n,Nr(e));var kr={grad:.9,turn:360,rad:360/(2*Math.PI)},ee=function(e){return typeof e=="string"?e.length>0:typeof e=="number"},D=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=Math.pow(10,t)),Math.round(n*e)/n+0},W=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=1),e>n?n:e>t?e:t},Cn=function(e){return(e=isFinite(e)?e%360:0)>0?e:e+360},zt=function(e){return{r:W(e.r,0,255),g:W(e.g,0,255),b:W(e.b,0,255),a:W(e.a)}},ut=function(e){return{r:D(e.r),g:D(e.g),b:D(e.b),a:D(e.a,3)}},Ur=/^#([0-9a-f]{3,8})$/i,Be=function(e){var t=e.toString(16);return t.length<2?"0"+t:t},On=function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=Math.max(t,n,o),a=i-Math.min(t,n,o),s=a?i===t?(n-o)/a:i===n?2+(o-t)/a:4+(t-n)/a:0;return{h:60*(s<0?s+6:s),s:i?a/i*100:0,v:i/255*100,a:r}},Ln=function(e){var t=e.h,n=e.s,o=e.v,r=e.a;t=t/360*6,n/=100,o/=100;var i=Math.floor(t),a=o*(1-n),s=o*(1-(t-i)*n),l=o*(1-(1-t+i)*n),c=i%6;return{r:255*[o,s,a,a,l,o][c],g:255*[l,o,o,s,a,a][c],b:255*[a,a,l,o,o,s][c],a:r}},Wt=function(e){return{h:Cn(e.h),s:W(e.s,0,100),l:W(e.l,0,100),a:W(e.a)}},Jt=function(e){return{h:D(e.h),s:D(e.s),l:D(e.l),a:D(e.a,3)}},Kt=function(e){return Ln((n=(t=e).s,{h:t.h,s:(n*=((o=t.l)<50?o:100-o)/100)>0?2*n/(o+n)*100:0,v:o+n,a:t.a}));var t,n,o},Ne=function(e){return{h:(t=On(e)).h,s:(r=(200-(n=t.s))*(o=t.v)/100)>0&&r<200?n*o/100/(r<=100?r:200-r)*100:0,l:r/2,a:t.a};var t,n,o,r},Vr=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Pr=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Mr=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Br=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Qt={string:[[function(e){var t=Ur.exec(e);return t?(e=t[1]).length<=4?{r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:e.length===4?D(parseInt(e[3]+e[3],16)/255,2):1}:e.length===6||e.length===8?{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:e.length===8?D(parseInt(e.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(e){var t=Mr.exec(e)||Br.exec(e);return t?t[2]!==t[4]||t[4]!==t[6]?null:zt({r:Number(t[1])/(t[2]?100/255:1),g:Number(t[3])/(t[4]?100/255:1),b:Number(t[5])/(t[6]?100/255:1),a:t[7]===void 0?1:Number(t[7])/(t[8]?100:1)}):null},"rgb"],[function(e){var t=Vr.exec(e)||Pr.exec(e);if(!t)return null;var n,o,r=Wt({h:(n=t[1],o=t[2],o===void 0&&(o="deg"),Number(n)*(kr[o]||1)),s:Number(t[3]),l:Number(t[4]),a:t[5]===void 0?1:Number(t[5])/(t[6]?100:1)});return Kt(r)},"hsl"]],object:[[function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=r===void 0?1:r;return ee(t)&&ee(n)&&ee(o)?zt({r:Number(t),g:Number(n),b:Number(o),a:Number(i)}):null},"rgb"],[function(e){var t=e.h,n=e.s,o=e.l,r=e.a,i=r===void 0?1:r;if(!ee(t)||!ee(n)||!ee(o))return null;var a=Wt({h:Number(t),s:Number(n),l:Number(o),a:Number(i)});return Kt(a)},"hsl"],[function(e){var t=e.h,n=e.s,o=e.v,r=e.a,i=r===void 0?1:r;if(!ee(t)||!ee(n)||!ee(o))return null;var a=function(s){return{h:Cn(s.h),s:W(s.s,0,100),v:W(s.v,0,100),a:W(s.a)}}({h:Number(t),s:Number(n),v:Number(o),a:Number(i)});return Ln(a)},"hsv"]]},Zt=function(e,t){for(var n=0;n<t.length;n++){var o=t[n][0](e);if(o)return[o,t[n][1]]}return[null,void 0]},Hr=function(e){return typeof e=="string"?Zt(e.trim(),Qt.string):typeof e=="object"&&e!==null?Zt(e,Qt.object):[null,void 0]},ft=function(e,t){var n=Ne(e);return{h:n.h,s:W(n.s+100*t,0,100),l:n.l,a:n.a}},ht=function(e){return(299*e.r+587*e.g+114*e.b)/1e3/255},en=function(e,t){var n=Ne(e);return{h:n.h,s:n.s,l:W(n.l+100*t,0,100),a:n.a}},tn=function(){function e(t){this.parsed=Hr(t)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return e.prototype.isValid=function(){return this.parsed!==null},e.prototype.brightness=function(){return D(ht(this.rgba),2)},e.prototype.isDark=function(){return ht(this.rgba)<.5},e.prototype.isLight=function(){return ht(this.rgba)>=.5},e.prototype.toHex=function(){return t=ut(this.rgba),n=t.r,o=t.g,r=t.b,a=(i=t.a)<1?Be(D(255*i)):"","#"+Be(n)+Be(o)+Be(r)+a;var t,n,o,r,i,a},e.prototype.toRgb=function(){return ut(this.rgba)},e.prototype.toRgbString=function(){return t=ut(this.rgba),n=t.r,o=t.g,r=t.b,(i=t.a)<1?"rgba("+n+", "+o+", "+r+", "+i+")":"rgb("+n+", "+o+", "+r+")";var t,n,o,r,i},e.prototype.toHsl=function(){return Jt(Ne(this.rgba))},e.prototype.toHslString=function(){return t=Jt(Ne(this.rgba)),n=t.h,o=t.s,r=t.l,(i=t.a)<1?"hsla("+n+", "+o+"%, "+r+"%, "+i+")":"hsl("+n+", "+o+"%, "+r+"%)";var t,n,o,r,i},e.prototype.toHsv=function(){return t=On(this.rgba),{h:D(t.h),s:D(t.s),v:D(t.v),a:D(t.a,3)};var t},e.prototype.invert=function(){return K({r:255-(t=this.rgba).r,g:255-t.g,b:255-t.b,a:t.a});var t},e.prototype.saturate=function(t){return t===void 0&&(t=.1),K(ft(this.rgba,t))},e.prototype.desaturate=function(t){return t===void 0&&(t=.1),K(ft(this.rgba,-t))},e.prototype.grayscale=function(){return K(ft(this.rgba,-1))},e.prototype.lighten=function(t){return t===void 0&&(t=.1),K(en(this.rgba,t))},e.prototype.darken=function(t){return t===void 0&&(t=.1),K(en(this.rgba,-t))},e.prototype.rotate=function(t){return t===void 0&&(t=15),this.hue(this.hue()+t)},e.prototype.alpha=function(t){return typeof t=="number"?K({r:(n=this.rgba).r,g:n.g,b:n.b,a:t}):D(this.rgba.a,3);var n},e.prototype.hue=function(t){var n=Ne(this.rgba);return typeof t=="number"?K({h:t,s:n.s,l:n.l,a:n.a}):D(n.h)},e.prototype.isEqual=function(t){return this.toHex()===K(t).toHex()},e}(),K=function(e){return e instanceof tn?e:new tn(e)};const Dr=e=>[`background-color:${K(e?.fill||ue.fill).alpha(e?.fillOpacity===void 0?ue.fillOpacity:e.fillOpacity).toHex()}`,e!=null&&e.underlineThickness?"text-decoration:underline":void 0,e!=null&&e.underlineColor?`text-decoration-color:${e.underlineColor}`:void 0,e!=null&&e.underlineOffset?`text-underline-offset:${e.underlineOffset}px`:void 0,e!=null&&e.underlineThickness?`text-decoration-thickness:${e.underlineThickness}px`:void 0].filter(Boolean).join(";"),jr=()=>{const e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e);let t=new Set;return{destroy:()=>{CSS.highlights.clear(),e.remove()},setVisible:n=>{console.log("setVisible not implemented on CSS Custom Highlights renderer")},redraw:(n,o,r,i)=>{i&&i.clear();const a=new Set(n.map(l=>l.annotation.id));Array.from(t).filter(l=>!a.has(l));const s=n.map(l=>{var c;const u=r?typeof r=="function"?r(l.annotation,l.state):r:(c=l.state)!=null&&c.selected?Je:ue,h=i&&i.paint(l,o)||u;return`::highlight(_${l.annotation.id}) { ${Dr(h)} }`});e.innerHTML=s.join(`
`),CSS.highlights.clear(),n.forEach(({annotation:l})=>{const c=l.target.selector.map(h=>h.range),u=new Highlight(...c);CSS.highlights.set(`_${l.id}`,u)}),t=a}}},Yr=(e,t,n)=>Lt(e,t,n,jr());var nn=Object.prototype.hasOwnProperty;function Tt(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&Tt(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(nn.call(e,n)&&++o&&!nn.call(t,n)||!(n in t)||!Tt(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}const Xr=(e,t)=>{const n=(i,a)=>i.x<=a.x+a.width&&i.x+i.width>=a.x&&i.y<=a.y+a.height&&i.y+i.height>=a.y,o=i=>i.rects.reduce((a,s)=>a+s.width,0),r=t.filter(({rects:i})=>i.some(a=>n(e,a)));return r.sort((i,a)=>o(a)-o(i)),r.findIndex(i=>i.rects.includes(e))},Fr=e=>{e.classList.add("r6o-annotatable");const t=document.createElement("div");t.className="r6o-span-highlight-layer",e.insertBefore(t,e.firstChild);let n=[];return{destroy:()=>{t.remove()},redraw:(o,r,i,a,s)=>{const l=!(Tt(n,o)&&s);!a&&!l||(l&&(t.innerHTML=""),[...o].sort((c,u)=>{const{annotation:{target:{created:h}}}=c,{annotation:{target:{created:m}}}=u;return h&&m?h.getTime()-m.getTime():0}).forEach(c=>{c.rects.map(u=>{const h=Xr(u,o),m=Cr(c,r,i,a,h);if(l){const d=document.createElement("span");d.className="r6o-annotation",d.dataset.annotation=c.annotation.id,d.style.left=`${u.x}px`,d.style.top=`${u.y}px`,d.style.width=`${u.width}px`,d.style.height=`${u.height}px`,d.style.backgroundColor=K(m?.fill||ue.fill).alpha(m?.fillOpacity===void 0?ue.fillOpacity:m.fillOpacity).toHex(),m.underlineStyle&&(d.style.borderStyle=m.underlineStyle),m.underlineColor&&(d.style.borderColor=m.underlineColor),m.underlineThickness&&(d.style.borderBottomWidth=`${m.underlineThickness}px`),m.underlineOffset&&(d.style.paddingBottom=`${m.underlineOffset}px`),t.appendChild(d)}})}),n=o)},setVisible:o=>{o?t.classList.remove("hidden"):t.classList.add("hidden")}}},Gr=(e,t,n)=>Lt(e,t,n,Fr(e));var j=[];for(var pt=0;pt<256;++pt)j.push((pt+256).toString(16).slice(1));function qr(e,t=0){return(j[e[t+0]]+j[e[t+1]]+j[e[t+2]]+j[e[t+3]]+"-"+j[e[t+4]]+j[e[t+5]]+"-"+j[e[t+6]]+j[e[t+7]]+"-"+j[e[t+8]]+j[e[t+9]]+"-"+j[e[t+10]]+j[e[t+11]]+j[e[t+12]]+j[e[t+13]]+j[e[t+14]]+j[e[t+15]]).toLowerCase()}var He,zr=new Uint8Array(16);function Wr(){if(!He&&(He=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!He))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return He(zr)}var Jr=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const on={randomUUID:Jr};function Rn(e,t,n){if(on.randomUUID&&!t&&!e)return on.randomUUID();e=e||{};var o=e.random||(e.rng||Wr)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,qr(o)}var rn=Object.prototype.hasOwnProperty;function pe(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&pe(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(rn.call(e,n)&&++o&&!rn.call(t,n)||!(n in t)||!pe(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function gt(){}function Kr(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const me=[];function Rt(e,t=gt){let n;const o=new Set;function r(s){if(Kr(e,s)&&(e=s,n)){const l=!me.length;for(const c of o)c[1](),me.push(c,e);if(l){for(let c=0;c<me.length;c+=2)me[c][0](me[c+1]);me.length=0}}}function i(s){r(s(e))}function a(s,l=gt){const c=[s,l];return o.add(c),o.size===1&&(n=t(r,i)||gt),s(e),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:r,update:i,subscribe:a}}const Qr=e=>{const{subscribe:t,set:n}=Rt();let o;return t(r=>o=r),e.observe(({changes:r})=>{if(o){(r.deleted||[]).some(a=>a.id===o)&&n(void 0);const i=(r.updated||[]).find(({oldValue:a})=>a.id===o);i&&n(i.newValue.id)}}),{get current(){return o},subscribe:t,set:n}},De={selected:[]},Zr=(e,t)=>{const{subscribe:n,set:o}=Rt(De);let r=t,i=De;n(d=>i=d);const a=()=>{pe(i,De)||o(De)},s=()=>{var d;return((d=i.selected)==null?void 0:d.length)===0},l=d=>{if(s())return!1;const b=typeof d=="string"?d:d.id;return i.selected.some(p=>p.id===b)},c=(d,b)=>{const p=e.getAnnotation(d);if(!p){console.warn("Invalid selection: "+d);return}switch(an(p,r)){case"EDIT":o({selected:[{id:d,editable:!0}],event:b});break;case"SELECT":o({selected:[{id:d}],event:b});break;default:o({selected:[],event:b})}},u=(d,b)=>{const p=Array.isArray(d)?d:[d],y=p.map(f=>e.getAnnotation(f)).filter(f=>!!f);o({selected:y.map(f=>{const g=b===void 0?an(f,r)==="EDIT":b;return{id:f.id,editable:g}})}),y.length!==p.length&&console.warn("Invalid selection",d)},h=d=>{if(s())return!1;const{selected:b}=i;b.some(({id:p})=>d.includes(p))&&o({selected:b.filter(({id:p})=>!d.includes(p))})},m=d=>r=d;return e.observe(({changes:d})=>h((d.deleted||[]).map(b=>b.id))),{get event(){return i?i.event:null},get selected(){return i?[...i.selected]:null},get userSelectAction(){return r},clear:a,isEmpty:s,isSelected:l,setSelected:u,setUserSelectAction:m,subscribe:n,userSelect:c}},an=(e,t)=>typeof t=="function"?t(e):t||"EDIT";var Y=[];for(var mt=0;mt<256;++mt)Y.push((mt+256).toString(16).slice(1));function ei(e,t=0){return(Y[e[t+0]]+Y[e[t+1]]+Y[e[t+2]]+Y[e[t+3]]+"-"+Y[e[t+4]]+Y[e[t+5]]+"-"+Y[e[t+6]]+Y[e[t+7]]+"-"+Y[e[t+8]]+Y[e[t+9]]+"-"+Y[e[t+10]]+Y[e[t+11]]+Y[e[t+12]]+Y[e[t+13]]+Y[e[t+14]]+Y[e[t+15]]).toLowerCase()}var je,ti=new Uint8Array(16);function ni(){if(!je&&(je=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!je))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return je(ti)}var oi=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const sn={randomUUID:oi};function ri(e,t,n){if(sn.randomUUID&&!t&&!e)return sn.randomUUID();e=e||{};var o=e.random||(e.rng||ni)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,ei(o)}const yt=e=>{const t=n=>{const o={...n};return n.created&&typeof n.created=="string"&&(o.created=new Date(n.created)),n.updated&&typeof n.updated=="string"&&(o.updated=new Date(n.updated)),o};return{...e,bodies:(e.bodies||[]).map(t),target:t(e.target)}},ii=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},ai=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},si=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(r=>r.id===n.id);return{newBody:n,oldBody:o&&!pe(o,n)?o:void 0}}).filter(({oldBody:n})=>n).map(({oldBody:n,newBody:o})=>({oldBody:n,newBody:o})),li=(e,t)=>!pe(e.target,t.target),In=(e,t)=>{const n=ii(e,t),o=ai(e,t),r=si(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:r.length>0?r:void 0,targetUpdated:li(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var _=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e.SILENT="SILENT",e))(_||{});const ci=(e,t)=>{var n,o;const{changes:r,origin:i}=t;if(!(e.options.origin?e.options.origin===i:i!=="SILENT"))return!1;if(e.options.ignore){const{ignore:a}=e.options,s=l=>l&&l.length>0;if(!(s(r.created)||s(r.deleted))){const l=(n=r.updated)==null?void 0:n.some(u=>s(u.bodiesCreated)||s(u.bodiesDeleted)||s(u.bodiesUpdated)),c=(o=r.updated)==null?void 0:o.some(u=>u.targetUpdated);if(a==="BODY_ONLY"&&l&&!c||a==="TARGET_ONLY"&&c&&!l)return!1}}if(e.options.annotations){const a=new Set([...(r.created||[]).map(s=>s.id),...(r.deleted||[]).map(s=>s.id),...(r.updated||[]).map(({oldValue:s})=>s.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(s=>a.has(s))}else return!0},di=(e,t)=>{const n=new Set((e.created||[]).map(h=>h.id)),o=new Set((e.updated||[]).map(({newValue:h})=>h.id)),r=new Set((t.created||[]).map(h=>h.id)),i=new Set((t.deleted||[]).map(h=>h.id)),a=new Set((t.updated||[]).map(({oldValue:h})=>h.id)),s=new Set((t.updated||[]).filter(({oldValue:h})=>n.has(h.id)||o.has(h.id)).map(({oldValue:h})=>h.id)),l=[...(e.created||[]).filter(h=>!i.has(h.id)).map(h=>a.has(h.id)?t.updated.find(({oldValue:m})=>m.id===h.id).newValue:h),...t.created||[]],c=[...(e.deleted||[]).filter(h=>!r.has(h.id)),...(t.deleted||[]).filter(h=>!n.has(h.id))],u=[...(e.updated||[]).filter(({newValue:h})=>!i.has(h.id)).map(h=>{const{oldValue:m,newValue:d}=h;if(a.has(d.id)){const b=t.updated.find(p=>p.oldValue.id===d.id).newValue;return In(m,b)}else return h}),...(t.updated||[]).filter(({oldValue:h})=>!s.has(h.id))];return{created:l,deleted:c,updated:u}},bt=e=>{const t=e.id===void 0?ri():e.id;return{...e,id:t,bodies:e.bodies===void 0?[]:e.bodies.map(n=>({...n,annotation:t})),target:{...e.target,annotation:t}}},ui=e=>e.id!==void 0,fi=()=>{const e=new Map,t=new Map,n=[],o=(A,E={})=>{n.push({onChange:A,options:E})},r=A=>{const E=n.findIndex($=>$.onChange==A);E>-1&&n.splice(E,1)},i=(A,E)=>{const $={origin:A,changes:{created:E.created||[],updated:E.updated||[],deleted:E.deleted||[]},state:[...e.values()]};n.forEach(S=>{ci(S,$)&&S.onChange($)})},a=(A,E=_.LOCAL)=>{if(A.id&&e.get(A.id))throw Error(`Cannot add annotation ${A.id} - exists already`);{const $=bt(A);e.set($.id,$),$.bodies.forEach(S=>t.set(S.id,$.id)),i(E,{created:[$]})}},s=(A,E)=>{const $=bt(typeof A=="string"?E:A),S=typeof A=="string"?A:A.id,U=S&&e.get(S);if(U){const R=In(U,$);return S===$.id?e.set(S,$):(e.delete(S),e.set($.id,$)),U.bodies.forEach(P=>t.delete(P.id)),$.bodies.forEach(P=>t.set(P.id,$.id)),R}else console.warn(`Cannot update annotation ${S} - does not exist`)},l=(A,E=_.LOCAL,$=_.LOCAL)=>{const S=ui(E)?$:E,U=s(A,E);U&&i(S,{updated:[U]})},c=(A,E=_.LOCAL)=>{const $=A.reduce((S,U)=>{const R=s(U);return R?[...S,R]:S},[]);$.length>0&&i(E,{updated:$})},u=(A,E=_.LOCAL)=>{const $=e.get(A.annotation);if($){const S={...$,bodies:[...$.bodies,A]};e.set($.id,S),t.set(A.id,S.id),i(E,{updated:[{oldValue:$,newValue:S,bodiesCreated:[A]}]})}else console.warn(`Attempt to add body to missing annotation: ${A.annotation}`)},h=()=>[...e.values()],m=(A=_.LOCAL)=>{const E=[...e.values()];e.clear(),t.clear(),i(A,{deleted:E})},d=(A,E=!0,$=_.LOCAL)=>{const S=A.map(bt);if(E){const U=[...e.values()];e.clear(),t.clear(),S.forEach(R=>{e.set(R.id,R),R.bodies.forEach(P=>t.set(P.id,R.id))}),i($,{created:S,deleted:U})}else{const U=A.reduce((R,P)=>{const ie=P.id&&e.get(P.id);return ie?[...R,ie]:R},[]);if(U.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${U.map(R=>R.id).join(", ")}`);S.forEach(R=>{e.set(R.id,R),R.bodies.forEach(P=>t.set(P.id,R.id))}),i($,{created:S})}},b=A=>{const E=typeof A=="string"?A:A.id,$=e.get(E);if($)return e.delete(E),$.bodies.forEach(S=>t.delete(S.id)),$;console.warn(`Attempt to delete missing annotation: ${E}`)},p=(A,E=_.LOCAL)=>{const $=b(A);$&&i(E,{deleted:[$]})},y=(A,E=_.LOCAL)=>{const $=A.reduce((S,U)=>{const R=b(U);return R?[...S,R]:S},[]);$.length>0&&i(E,{deleted:$})},f=A=>{const E=e.get(A.annotation);if(E){const $=E.bodies.find(S=>S.id===A.id);if($){t.delete($.id);const S={...E,bodies:E.bodies.filter(U=>U.id!==A.id)};return e.set(E.id,S),{oldValue:E,newValue:S,bodiesDeleted:[$]}}else console.warn(`Attempt to delete missing body ${A.id} from annotation ${A.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${A.annotation}`)},g=(A,E=_.LOCAL)=>{const $=f(A);$&&i(E,{updated:[$]})},v=(A,E=_.LOCAL)=>{const $=A.map(S=>f(S)).filter(Boolean);$.length>0&&i(E,{updated:$})},w=A=>{const E=e.get(A);return E?{...E}:void 0},T=A=>{const E=t.get(A);if(E){const $=w(E).bodies.find(S=>S.id===A);if($)return $;console.error(`Store integrity error: body ${A} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${A}`)},N=(A,E)=>{if(A.annotation!==E.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const $=e.get(A.annotation);if($){const S=$.bodies.find(R=>R.id===A.id),U={...$,bodies:$.bodies.map(R=>R.id===S.id?E:R)};return e.set($.id,U),S.id!==E.id&&(t.delete(S.id),t.set(E.id,U.id)),{oldValue:$,newValue:U,bodiesUpdated:[{oldBody:S,newBody:E}]}}else console.warn(`Attempt to add body to missing annotation ${A.annotation}`)},I=(A,E,$=_.LOCAL)=>{const S=N(A,E);S&&i($,{updated:[S]})},L=(A,E=_.LOCAL)=>{const $=A.map(S=>N({id:S.id,annotation:S.annotation},S)).filter(Boolean);i(E,{updated:$})},H=A=>{const E=e.get(A.annotation);if(E){const $={...E,target:{...E.target,...A}};return e.set(E.id,$),{oldValue:E,newValue:$,targetUpdated:{oldTarget:E.target,newTarget:A}}}else console.warn(`Attempt to update target on missing annotation: ${A.annotation}`)};return{addAnnotation:a,addBody:u,all:h,bulkAddAnnotation:d,bulkDeleteAnnotation:y,bulkDeleteBodies:v,bulkUpdateAnnotation:c,bulkUpdateBodies:L,bulkUpdateTargets:(A,E=_.LOCAL)=>{const $=A.map(S=>H(S)).filter(Boolean);$.length>0&&i(E,{updated:$})},clear:m,deleteAnnotation:p,deleteBody:g,getAnnotation:w,getBody:T,observe:o,unobserve:r,updateAnnotation:l,updateBody:I,updateTarget:(A,E=_.LOCAL)=>{const $=H(A);$&&i(E,{updated:[$]})}}};let hi=()=>({emit(e,...t){for(let n=0,o=this.events[e]||[],r=o.length;n<r;n++)o[n](...t)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(r=>t!==r)}}});const pi=250,gi=e=>{const t=hi(),n=[];let o=-1,r=!1,i=0;const a=d=>{if(!r){const{changes:b}=d,p=performance.now();if(p-i>pi)n.splice(o+1),n.push(b),o=n.length-1;else{const y=n.length-1;n[y]=di(n[y],b)}i=p}r=!1};e.observe(a,{origin:_.LOCAL});const s=d=>d&&d.length>0&&e.bulkDeleteAnnotation(d),l=d=>d&&d.length>0&&e.bulkAddAnnotation(d,!1),c=d=>d&&d.length>0&&e.bulkUpdateAnnotation(d.map(({oldValue:b})=>b)),u=d=>d&&d.length>0&&e.bulkUpdateAnnotation(d.map(({newValue:b})=>b)),h=d=>d&&d.length>0&&e.bulkAddAnnotation(d,!1),m=d=>d&&d.length>0&&e.bulkDeleteAnnotation(d);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(a),on:(d,b)=>t.on(d,b),redo:()=>{if(n.length-1>o){r=!0;const{created:d,updated:b,deleted:p}=n[o+1];l(d),u(b),m(p),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){r=!0;const{created:d,updated:b,deleted:p}=n[o];s(d),c(b),h(p),t.emit("undo",n[o]),o-=1}}}},mi=()=>{const{subscribe:e,set:t}=Rt([]);return{subscribe:e,set:t}},yi=(e,t,n,o)=>{const{store:r,selection:i,hover:a,viewport:s}=e,l=new Map;let c=[],u;const h=(p,y)=>{l.has(p)?l.get(p).push(y):l.set(p,[y])},m=(p,y)=>{const f=l.get(p);if(f){const g=f.indexOf(y);g!==-1&&f.splice(g,1)}},d=(p,y,f)=>{l.has(p)&&setTimeout(()=>{l.get(p).forEach(g=>{if(n){const v=Array.isArray(y)?y.map(T=>n.serialize(T)):n.serialize(y),w=f?f instanceof PointerEvent?f:n.serialize(f):void 0;g(v,w)}else g(y,f)})},1)};i.subscribe(({selected:p})=>{if(!(c.length===0&&p.length===0)){if(c.length===0&&p.length>0)c=p.map(({id:y})=>r.getAnnotation(y));else if(c.length>0&&p.length===0)c.forEach(y=>{const f=r.getAnnotation(y.id);f&&!pe(f,y)&&d("updateAnnotation",f,y)}),c=[];else{const y=new Set(c.map(g=>g.id)),f=new Set(p.map(({id:g})=>g));c.filter(g=>!f.has(g.id)).forEach(g=>{const v=r.getAnnotation(g.id);v&&!pe(v,g)&&d("updateAnnotation",v,g)}),c=[...c.filter(g=>f.has(g.id)),...p.filter(({id:g})=>!y.has(g)).map(({id:g})=>r.getAnnotation(g))]}d("selectionChanged",c)}}),a.subscribe(p=>{!u&&p?d("mouseEnterAnnotation",r.getAnnotation(p)):u&&!p?d("mouseLeaveAnnotation",r.getAnnotation(u)):u&&p&&(d("mouseLeaveAnnotation",r.getAnnotation(u)),d("mouseEnterAnnotation",r.getAnnotation(p))),u=p}),s?.subscribe(p=>d("viewportIntersect",p.map(y=>r.getAnnotation(y)))),r.observe(p=>{const{created:y,deleted:f}=p.changes;(y||[]).forEach(g=>d("createAnnotation",g)),(f||[]).forEach(g=>d("deleteAnnotation",g)),(p.changes.updated||[]).filter(g=>[...g.bodiesCreated||[],...g.bodiesDeleted||[],...g.bodiesUpdated||[]].length>0).forEach(({oldValue:g,newValue:v})=>{const w=c.find(T=>T.id===g.id)||g;c=c.map(T=>T.id===g.id?v:T),d("updateAnnotation",v,w)})},{origin:_.LOCAL}),r.observe(p=>{if(c){const y=new Set(c.map(g=>g.id)),f=(p.changes.updated||[]).filter(({newValue:g})=>y.has(g.id)).map(({newValue:g})=>g);f.length>0&&(c=c.map(g=>f.find(v=>v.id===g.id)||g))}},{origin:_.REMOTE});const b=p=>y=>{const{updated:f}=y;p?(f||[]).forEach(g=>d("updateAnnotation",g.oldValue,g.newValue)):(f||[]).forEach(g=>d("updateAnnotation",g.newValue,g.oldValue))};return t.on("undo",b(!0)),t.on("redo",b(!1)),{on:h,off:m,emit:d}},bi=e=>t=>t.reduce((n,o)=>{const{parsed:r,error:i}=e.parse(o);return i?{parsed:n.parsed,failed:[...n.failed,o]}:r?{parsed:[...n.parsed,r],failed:n.failed}:{...n}},{parsed:[],failed:[]}),vi=(e,t,n)=>{const{store:o,selection:r}=e,i=f=>{if(n){const{parsed:g,error:v}=n.parse(f);g?o.addAnnotation(g,_.REMOTE):console.error(v)}else o.addAnnotation(yt(f),_.REMOTE)},a=()=>r.clear(),s=()=>o.clear(),l=f=>{const g=o.getAnnotation(f);return n&&g?n.serialize(g):g},c=()=>n?o.all().map(n.serialize):o.all(),u=()=>{var f;const g=(((f=r.selected)==null?void 0:f.map(v=>v.id))||[]).map(v=>o.getAnnotation(v)).filter(Boolean);return n?g.map(n.serialize):g},h=(f,g=!0)=>fetch(f).then(v=>v.json()).then(v=>(d(v,g),v)),m=f=>{if(typeof f=="string"){const g=o.getAnnotation(f);if(o.deleteAnnotation(f),g)return n?n.serialize(g):g}else{const g=n?n.parse(f).parsed:f;if(g)return o.deleteAnnotation(g),f}},d=(f,g=!0)=>{if(n){const v=n.parseAll||bi(n),{parsed:w,failed:T}=v(f);T.length>0&&console.warn(`Discarded ${T.length} invalid annotations`,T),o.bulkAddAnnotation(w,g,_.REMOTE)}else o.bulkAddAnnotation(f.map(yt),g,_.REMOTE)},b=(f,g)=>{f?r.setSelected(f,g):r.clear()},p=f=>{r.clear(),r.setUserSelectAction(f)},y=f=>{if(n){const g=n.parse(f).parsed,v=n.serialize(o.getAnnotation(g.id));return o.updateAnnotation(g),v}else{const g=o.getAnnotation(f.id);return o.updateAnnotation(yt(f)),g}};return{addAnnotation:i,cancelSelected:a,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:s,getAnnotationById:l,getAnnotations:c,getSelected:u,loadAnnotations:h,redo:t.redo,removeAnnotation:m,setAnnotations:d,setSelected:b,setUserSelectAction:p,undo:t.undo,updateAnnotation:y}},wi="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let xi=e=>crypto.getRandomValues(new Uint8Array(e)),Ai=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*o*t/e.length);return(i=t)=>{let a="";for(;;){let s=n(r),l=r;for(;l--;)if(a+=e[s[l]&o]||"",a.length===i)return a}}},$i=(e,t=21)=>Ai(e,t,xi),Ei=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=wi[n[e]&63];return t};const Si=()=>({isGuest:!0,id:$i("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),Ti=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,r=t.length;o<r;o++){let i=t.charCodeAt(o);n=(n<<5)-n+i,n|=0}return`${n}`},Nn=e=>e?typeof e=="object"?{...e}:e:void 0,Ci=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:r,purpose:i,value:a,created:s,modified:l,creator:c,...u}=n;return{id:o||`temp-${Ti(n)}`,annotation:t,type:r,purpose:i,value:a,creator:Nn(c),created:s?new Date(s):void 0,updated:l?new Date(l):void 0,...u}}),Oi=e=>e.map(t=>{var n;const{annotation:o,created:r,updated:i,...a}=t,s={...a,created:r?.toISOString(),modified:i?.toISOString()};return(n=s.id)!=null&&n.startsWith("temp-")&&delete s.id,s});Ei();const Li=(e,t)=>({parse:n=>Ni(n),serialize:n=>_i(n,e,t)}),Ri=e=>e.quote!==void 0&&e.start!==void 0&&e.end!==void 0,Ii=e=>{const{id:t,creator:n,created:o,modified:r,target:i}=e,a=Array.isArray(i)?i:[i],s={creator:Nn(n),created:o?new Date(o):void 0,updated:r?new Date(r):void 0,annotation:t,selector:[]};for(const l of a){const c=(Array.isArray(l.selector)?l.selector:[l.selector]).reduce((u,h)=>{switch(h.type){case"TextQuoteSelector":u.quote=h.exact;break;case"TextPositionSelector":u.start=h.start,u.end=h.end;break}return u},{});if(Ri(c))s.selector.push({id:l.id,...c});else{const u=[c.start?void 0:"TextPositionSelector",c.quote?void 0:"TextQuoteSelector"].filter(Boolean);return{error:Error(`Missing selector types: ${u.join(" and ")} for annotation: ${e.id}`)}}}return{parsed:s}},Ni=e=>{const t=e.id||Rn(),{creator:n,created:o,modified:r,body:i,...a}=e,s=Ci(i,t),l=Ii(e);return"error"in l?{error:l.error}:{parsed:{...a,id:t,bodies:s,target:l.parsed}}},_i=(e,t,n)=>{const{bodies:o,target:r,...i}=e,{selector:a,creator:s,created:l,updated:c,...u}=r,h=a.map(m=>{const{quote:d,start:b,end:p,range:y}=m,{prefix:f,suffix:g}=br(y,n),v=[{type:"TextQuoteSelector",exact:d,prefix:f,suffix:g},{type:"TextPositionSelector",start:b,end:p}];return{...u,id:m.id,source:t,selector:v}});return{...i,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:Oi(e.bodies),creator:s,created:l?.toISOString(),modified:c?.toISOString(),target:h}};function _n(e,t,n=0,o=e.length-1,r=ki){for(;o>n;){if(o-n>600){const l=o-n+1,c=t-n+1,u=Math.log(l),h=.5*Math.exp(2*u/3),m=.5*Math.sqrt(u*h*(l-h)/l)*(c-l/2<0?-1:1),d=Math.max(n,Math.floor(t-c*h/l+m)),b=Math.min(o,Math.floor(t+(l-c)*h/l+m));_n(e,t,d,b,r)}const i=e[t];let a=n,s=o;for(Te(e,n,t),r(e[o],i)>0&&Te(e,n,o);a<s;){for(Te(e,a,s),a++,s--;r(e[a],i)<0;)a++;for(;r(e[s],i)>0;)s--}r(e[n],i)===0?Te(e,n,s):(s++,Te(e,s,o)),s<=t&&(n=s+1),t<=s&&(o=s-1)}}function Te(e,t,n){const o=e[t];e[t]=e[n],e[n]=o}function ki(e,t){return e<t?-1:e>t?1:0}class Ui{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!Xe(t,n))return o;const r=this.toBBox,i=[];for(;n;){for(let a=0;a<n.children.length;a++){const s=n.children[a],l=n.leaf?r(s):s;Xe(t,l)&&(n.leaf?o.push(s):wt(t,l)?this._all(s,o):i.push(s))}n=i.pop()}return o}collides(t){let n=this.data;if(!Xe(t,n))return!1;const o=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],a=n.leaf?this.toBBox(i):i;if(Xe(t,a)){if(n.leaf||wt(t,a))return!0;o.push(i)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=ve([]),this}remove(t,n){if(!t)return this;let o=this.data;const r=this.toBBox(t),i=[],a=[];let s,l,c;for(;o||i.length;){if(o||(o=i.pop(),l=i[i.length-1],s=a.pop(),c=!0),o.leaf){const u=Vi(t,o.children,n);if(u!==-1)return o.children.splice(u,1),i.push(o),this._condense(i),this}!c&&!o.leaf&&wt(o,r)?(i.push(o),a.push(s),s=0,l=o,o=o.children[0]):l?(s++,o=l.children[s],c=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,r){const i=o-n+1;let a=this._maxEntries,s;if(i<=a)return s=ve(t.slice(n,o+1)),ye(s,this.toBBox),s;r||(r=Math.ceil(Math.log(i)/Math.log(a)),a=Math.ceil(i/Math.pow(a,r-1))),s=ve([]),s.leaf=!1,s.height=r;const l=Math.ceil(i/a),c=l*Math.ceil(Math.sqrt(a));ln(t,n,o,c,this.compareMinX);for(let u=n;u<=o;u+=c){const h=Math.min(u+c-1,o);ln(t,u,h,l,this.compareMinY);for(let m=u;m<=h;m+=l){const d=Math.min(m+l-1,h);s.children.push(this._build(t,m,d,r-1))}}return ye(s,this.toBBox),s}_chooseSubtree(t,n,o,r){for(;r.push(n),!(n.leaf||r.length-1===o);){let i=1/0,a=1/0,s;for(let l=0;l<n.children.length;l++){const c=n.children[l],u=vt(c),h=Bi(t,c)-u;h<a?(a=h,i=u<i?u:i,s=c):h===a&&u<i&&(i=u,s=c)}n=s||n.children[0]}return n}_insert(t,n,o){const r=o?t:this.toBBox(t),i=[],a=this._chooseSubtree(r,this.data,n,i);for(a.children.push(t),Le(a,r);n>=0&&i[n].children.length>this._maxEntries;)this._split(i,n),n--;this._adjustParentBBoxes(r,i,n)}_split(t,n){const o=t[n],r=o.children.length,i=this._minEntries;this._chooseSplitAxis(o,i,r);const a=this._chooseSplitIndex(o,i,r),s=ve(o.children.splice(a,o.children.length-a));s.height=o.height,s.leaf=o.leaf,ye(o,this.toBBox),ye(s,this.toBBox),n?t[n-1].children.push(s):this._splitRoot(o,s)}_splitRoot(t,n){this.data=ve([t,n]),this.data.height=t.height+1,this.data.leaf=!1,ye(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let r,i=1/0,a=1/0;for(let s=n;s<=o-n;s++){const l=Oe(t,0,s,this.toBBox),c=Oe(t,s,o,this.toBBox),u=Hi(l,c),h=vt(l)+vt(c);u<i?(i=u,r=s,a=h<a?h:a):u===i&&h<a&&(a=h,r=s)}return r||o-n}_chooseSplitAxis(t,n,o){const r=t.leaf?this.compareMinX:Pi,i=t.leaf?this.compareMinY:Mi,a=this._allDistMargin(t,n,o,r),s=this._allDistMargin(t,n,o,i);a<s&&t.children.sort(r)}_allDistMargin(t,n,o,r){t.children.sort(r);const i=this.toBBox,a=Oe(t,0,n,i),s=Oe(t,o-n,o,i);let l=Ye(a)+Ye(s);for(let c=n;c<o-n;c++){const u=t.children[c];Le(a,t.leaf?i(u):u),l+=Ye(a)}for(let c=o-n-1;c>=n;c--){const u=t.children[c];Le(s,t.leaf?i(u):u),l+=Ye(s)}return l}_adjustParentBBoxes(t,n,o){for(let r=o;r>=0;r--)Le(n[r],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():ye(t[n],this.toBBox)}}function Vi(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function ye(e,t){Oe(e,0,e.children.length,t,e)}function Oe(e,t,n,o,r){r||(r=ve(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let i=t;i<n;i++){const a=e.children[i];Le(r,e.leaf?o(a):a)}return r}function Le(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function Pi(e,t){return e.minX-t.minX}function Mi(e,t){return e.minY-t.minY}function vt(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function Ye(e){return e.maxX-e.minX+(e.maxY-e.minY)}function Bi(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function Hi(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),r=Math.min(e.maxX,t.maxX),i=Math.min(e.maxY,t.maxY);return Math.max(0,r-n)*Math.max(0,i-o)}function wt(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function Xe(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function ve(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function ln(e,t,n,o,r){const i=[t,n];for(;i.length;){if(n=i.pop(),t=i.pop(),n-t<=o)continue;const a=t+Math.ceil((n-t)/o/2)*o;_n(e,a,t,n,r),i.push(t,a,a,n)}}const Di=(e,t)=>{const n=new Ui,o=new Map,r=(b,p)=>{const y=b.selector.flatMap(g=>{const v=te([g])?g.range:Sn(g,t).range;return Array.from(v.getClientRects())}),f=$r(y).map(({left:g,top:v,right:w,bottom:T})=>new DOMRect(g-p.left,v-p.top,w-g,T-v));return f.map(g=>{const{x:v,y:w,width:T,height:N}=g;return{minX:v,minY:w,maxX:v+T,maxY:w+N,annotation:{id:b.annotation,rects:f}}})},i=()=>[...o.values()],a=()=>{n.clear(),o.clear()},s=b=>{const p=r(b,t.getBoundingClientRect());p.forEach(y=>n.insert(y)),o.set(b.annotation,p)},l=b=>{const p=o.get(b.annotation);p&&(p.forEach(y=>n.remove(y)),o.delete(b.annotation))},c=b=>{l(b),s(b)},u=(b,p=!0)=>{p&&a();const y=t.getBoundingClientRect(),f=b.map(v=>({target:v,rects:r(v,y)}));f.forEach(({target:v,rects:w})=>o.set(v.annotation,w));const g=f.flatMap(({rects:v})=>v);n.load(g)},h=(b,p,y=!1)=>{const f=n.search({minX:b,minY:p,maxX:b,maxY:p}),g=v=>v.annotation.rects.reduce((w,T)=>w+T.width*T.height,0);return f.length>0?(f.sort((v,w)=>g(v)-g(w)),y?f.map(v=>v.annotation.id):[f[0].annotation.id]):[]},m=b=>{const p=d(b);if(p.length===0)return;let y=p[0].left,f=p[0].top,g=p[0].right,v=p[0].bottom;for(let w=1;w<p.length;w++){const T=p[w];y=Math.min(y,T.left),f=Math.min(f,T.top),g=Math.max(g,T.right),v=Math.max(v,T.bottom)}return new DOMRect(y,f,g-y,v-f)},d=b=>{const p=o.get(b);return p?p[0].annotation.rects:[]};return{all:i,clear:a,getAt:h,getAnnotationBounds:m,getAnnotationRects:d,getIntersecting:(b,p,y,f)=>{const g=n.search({minX:b,minY:p,maxX:y,maxY:f}),v=new Set(g.map(w=>w.annotation.id));return Array.from(v).map(w=>({annotation:e.getAnnotation(w),rects:d(w)})).filter(w=>!!w.annotation)},insert:s,recalculate:()=>u(e.all().map(b=>b.target),!0),remove:l,set:u,size:()=>n.all().length,update:c}},ji=(e,t)=>{const n=fi(),o=Di(n,e),r=Zr(n);r.setUserSelectAction(t);const i=Qr(n),a=mi(),s=(y,f=_.LOCAL)=>{const g=dt(y,e),v=te(g.target.selector);return v&&n.addAnnotation(g,f),v},l=(y,f=!0,g=_.LOCAL)=>{const v=y.map(T=>dt(T,e)),w=v.filter(T=>!te(T.target.selector));return w.length>0?(console.warn("Could not revive all targets for these annotations:",w),n.bulkAddAnnotation(v,f,g),w):(n.bulkAddAnnotation(v,f,g),[])},c=(y,f=_.LOCAL)=>{const g=y.map(w=>dt(w,e)),v=g.filter(w=>!te(w.target.selector));return v.length>0&&console.warn("Could not revive all targets for these annotations:",v),g.forEach(w=>{n.getAnnotation(w.id)?n.updateAnnotation(w,f):n.addAnnotation(w,f)}),v},u=(y,f=_.LOCAL)=>{const g=We(y,e);n.updateTarget(g,f)},h=(y,f=_.LOCAL)=>{const g=y.map(v=>We(v,e));n.bulkUpdateTargets(g,f)},m=(y,f,g)=>{const v=o.getAt(y,f,!!g).map(T=>n.getAnnotation(T)),w=g?v.filter(g):v;return w.length>0?w[0]:void 0},d=(y,f,g,v=5)=>{const w=o.getAnnotationRects(y);if(w.length!==0){if(f&&g){const T=w.find(({top:N,right:I,bottom:L,left:H})=>f>=H-v&&f<=I+v&&g>=N-v&&g<=L+v);if(T)return T}return o.getAnnotationBounds(y)}},b=y=>o.getAnnotationRects(y),p=()=>o.recalculate();return n.observe(({changes:y})=>{const f=(y.deleted||[]).filter(w=>te(w.target.selector)),g=(y.created||[]).filter(w=>te(w.target.selector)),v=(y.updated||[]).filter(w=>te(w.newValue.target.selector));f?.length>0&&f.forEach(w=>o.remove(w.target)),g.length>0&&o.set(g.map(w=>w.target),!1),v?.length>0&&v.forEach(({newValue:w})=>o.update(w.target))}),{store:{...n,addAnnotation:s,bulkAddAnnotation:l,bulkUpdateTargets:h,bulkUpsertAnnotations:c,getAnnotationBounds:d,getAnnotationRects:b,getAt:m,getIntersecting:o.getIntersecting,recalculatePositions:p,updateTarget:u},selection:r,hover:i,viewport:a}},Yi=()=>{const e=document.createElement("canvas");e.width=2*window.innerWidth,e.height=2*window.innerHeight,e.className="r6o-presence-layer";const t=e.getContext("2d");return t.scale(2,2),t.translate(.5,.5),e},Xi=(e,t={})=>{const n=Yi(),o=n.getContext("2d");document.body.appendChild(n);const r=new Map,i=a=>Array.from(r.entries()).filter(([s,l])=>l.presenceKey===a.presenceKey).map(([s,l])=>s);return e.on("selectionChange",(a,s)=>{i(a).forEach(l=>r.delete(l)),s&&s.forEach(l=>r.set(l,a))}),{clear:()=>{const{width:a,height:s}=n;o.clearRect(-.5,-.5,a+1,s+1)},destroy:()=>{n.remove()},paint:(a,s,l)=>{t.font&&(o.font=t.font);const c=r.get(a.annotation.id);if(c){const{height:u}=a.rects[0],h=a.rects[0].x+s.left,m=a.rects[0].y+s.top;o.fillStyle=c.appearance.color,o.fillRect(h-2,m-2.5,2,u+5);const d=o.measureText(c.appearance.label),b=d.width+6,p=d.actualBoundingBoxAscent+d.actualBoundingBoxDescent+8,y=d.fontBoundingBoxAscent?8:6.5;return o.fillRect(h-2,m-2.5-p,b,p),o.fillStyle="#fff",o.fillText(c.appearance.label,h+1,m-y),{fill:c.appearance.color,fillOpacity:l?.45:.18}}},reset:()=>{n.width=2*window.innerWidth,n.height=2*window.innerHeight;const a=n.getContext("2d");a.scale(2,2),a.translate(.5,.5)}}},Fi=(e,t,n,o)=>{let r;const i=f=>r=f;let a;const s=f=>a=f,{store:l,selection:c}=t;let u,h=!1,m;const d=f=>{var g;h&&((g=f.target.parentElement)!=null&&g.closest(oe)?u=void 0:u={annotation:Rn(),selector:[],creator:r,created:new Date})},b=Ot(f=>{var g,v;const w=document.getSelection();if((v=(g=w.anchorNode)==null?void 0:g.parentElement)!=null&&v.closest(oe)){u=void 0;return}if(f.timeStamp-(m?.timeStamp||f.timeStamp)<1e3&&!u&&d(m),w.isCollapsed||!h||!u)return;const T=w.getRangeAt(0),N=Sr(T,e);if(wr(N))return;const I=mr(N.cloneRange());(I.length!==u.selector.length||I.some((L,H)=>{var A;return L.toString()!==((A=u.selector[H])==null?void 0:A.quote)}))&&(u={...u,selector:I.map(L=>Er(L,e,o)),updated:new Date},l.getAnnotation(u.annotation)?l.updateTarget(u,_.LOCAL):(c.clear(),l.addAnnotation({id:u.annotation,bodies:[],target:u}),c.userSelect(u.annotation,m)))}),p=f=>{const{target:g,timeStamp:v,offsetX:w,offsetY:T,type:N}=f;m={...f,target:g,timeStamp:v,offsetX:w,offsetY:T,type:N},h=f.button===0},y=f=>{var g;if((g=f.target.parentElement)!=null&&g.closest(oe)||!h)return;const v=()=>{const{x:T,y:N}=e.getBoundingClientRect(),I=f.target instanceof Node&&e.contains(f.target)&&l.getAt(f.clientX-T,f.clientY-N,a);if(I){const{selected:L}=c;(L.length!==1||L[0].id!==I.id)&&c.userSelect(I.id,f)}else c.isEmpty()||c.clear()},w=f.timeStamp-m.timeStamp;setTimeout(()=>{const T=document.getSelection();T!=null&&T.isCollapsed&&w<300?(u=void 0,v()):u&&c.userSelect(u.annotation,f)})};return e.addEventListener("pointerdown",p),document.addEventListener("pointerup",y),n&&(e.addEventListener("selectstart",d),document.addEventListener("selectionchange",b)),{destroy:()=>{e.removeEventListener("pointerdown",p),document.removeEventListener("pointerup",y),e.removeEventListener("selectstart",d),document.removeEventListener("selectionchange",b)},setFilter:s,setUser:i}},Gi=(e,t)=>({...e,annotatingEnabled:e.annotatingEnabled??t.annotatingEnabled,user:e.user||t.user}),cn="SPANS",qi=(e,t={})=>{yr(e);const n=Gi(t,{annotatingEnabled:!0,user:Si()}),o=ji(e,n.userSelectAction),{selection:r,viewport:i}=o,a=o.store,s=gi(a),l=yi(o,s,n.adapter);let c=n.user;const u=n.renderer==="CSS_HIGHLIGHTS"?CSS.highlights?"CSS_HIGHLIGHTS":cn:n.renderer||cn,h=u==="SPANS"?Gr(e,o,i):u==="CSS_HIGHLIGHTS"?Yr(e,o,i):u==="CANVAS"?_r(e,o,i):void 0;if(!h)throw`Unknown renderer implementation: ${u}`;console.debug(`Using ${u} renderer`),n.style&&h.setStyle(n.style);const m=Fi(e,o,n.annotatingEnabled,n.offsetReferenceSelector);return m.setUser(c),{...vi(o,s,n.adapter),destroy:()=>{h.destroy(),m.destroy(),s.destroy()},element:e,getUser:()=>c,setFilter:d=>{h.setFilter(d),m.setFilter(d)},setStyle:d=>h.setStyle(d),setUser:d=>{c=d,m.setUser(d)},setSelected:d=>{d?r.setSelected(d):r.clear()},setPresenceProvider:d=>{d&&(h.setPainter(Xi(d,n.presence)),d.on("selectionChange",()=>h.redraw()))},setVisible:d=>h.setVisible(d),on:l.on,off:l.off,scrollIntoView:Tr(e,a),state:o}},zi=e=>{const t=k.useRef(null),{className:n,children:o,...r}=e,{style:i,filter:a,user:s}=r,{anno:l,setAnno:c}=k.useContext(yn);return k.useEffect(()=>{if(!c)return;const u=typeof r.adapter=="function"?r.adapter(t.current):r.adapter,h=qi(t.current,{...r,adapter:u});return c(h),()=>h.destroy()},[c]),k.useEffect(()=>l?.setStyle(i),[l,i]),k.useEffect(()=>l?.setFilter(a),[l,a]),k.useEffect(()=>l?.setUser(s),[l,s]),Zn.jsx("div",{ref:t,className:n,children:o})},Wi=()=>{const[e,t]=k.useState();return k.useEffect(()=>{fetch("../../thesaurus/narratives.json").then(n=>n.json()).then(n=>{const o=n.map(r=>r.prefLabel?.trim()).filter(Boolean);t(new Set(o))})},[]),e},Ji=["#0fb5ae","#4046ca","#f68511","#de3d82","#7e84fa","#72e06a"],Ki=e=>{const[t,n]=k.useState(),[o,r]=k.useState(!1),{refs:i,floatingStyles:a}=kn({placement:"bottom",open:o,onOpenChange:r,middleware:[Mn(4),Bn(),Hn(),Dn({crossAxis:!0,padding:{top:5,bottom:5}})],whileElementsMounted:jn});return k.useEffect(()=>{if(e.annotation){const s=e.annotation.target.selector,l=Array.isArray(s)?s[0].range:s.range;l&&!l.collapsed&&(i.setReference({getBoundingClientRect:()=>l.getBoundingClientRect(),getClientRects:()=>{const c=t?Un(l.getClientRects(),t):l.getClientRects()[0];return Vn(c)}}),r(!0))}else r(!1)},[e.annotation,t]),k.useEffect(()=>{const s=l=>{const{clientX:c,clientY:u}=l;n({x:c,y:u})};return window.document.addEventListener("pointerup",s),()=>{window.document.removeEventListener("pointerup",s)}},[]),e.annotation&&o&&F.jsx("div",{className:"text-annotation-popup not-annotatable",ref:i.setFloating,style:a,children:F.jsx(Pn,{type:"VERSE",annotation:e.annotation,relatedImages:e.relatedImages||[],relatedVerses:e.relatedVerses||[],onClickImages:e.onClickImages,onClickVerses:e.onClickVerses})})},Qi=e=>({fill:"#000",fillOpacity:.05,underlineThickness:1.5,underlineColor:Ji[e||0],underlineOffset:3*(e||0)+1}),Zi=e=>({fill:"#ff5e5e",fillOpacity:.4,underlineThickness:2,underlineColor:"#e05252",underlineOffset:3*(e||0)+1}),ea=e=>{const{searchResults:t,highlightedSearchResult:n}=e,o=Yn(),r=Xn(),{images:i,verses:a}=Fn(r),s=Wi(),l=k.useCallback((c,u,h)=>{const d=c.bodies.find(b=>b.value&&s.has(b.value))?Qi(h):Zi(h);return t.length===0?d:new Set(t.map(p=>p.id)).has(c.id)?{...d,fill:"#fff800",underlineColor:"#caca2b"}:d},[s,t,n]);return k.useEffect(()=>{o&&o.setAnnotations(e.annotations)},[o,e.annotations]),k.useEffect(()=>{e.highlightedSearchResult&&(o.setSelected(e.highlightedSearchResult.id),o.scrollIntoView(e.highlightedSearchResult))},[e.highlightedSearchResult]),k.useEffect(()=>{e.onSelect({annotation:r,relatedImages:i,relatedVerses:a})},[r,i,a]),s&&F.jsxs(zi,{adapter:c=>Li("5db80aa5-8a27-4539-aeb3-bddf3abc0098",c),annotatingEnabled:!1,style:l,children:[F.jsx("div",{className:"annotated-text",children:e.verse}),F.jsx(Ki,{annotation:r,relatedImages:i,relatedVerses:a,onClickImages:e.onOpenRelatedImages,onClickVerses:e.onOpenRelatedVerses})]})},sa=e=>{const[t,n]=k.useState(),o=Gn(`annotations/verse/${e.verse.slug}.json`),[r,i]=k.useState(),[a,s]=Nt("diga.images.open",!1),[l,c]=Nt("diga.verses.open",!1),[u,h]=k.useState([]),[m,d]=k.useState();k.useEffect(()=>{fetch(`../../verses/${e.verse.slug}.txt`).then(p=>p.text()).then(n)},[]);const b=k.useCallback((p,y)=>{const f=p.target.selector[0].start,g=y.target.selector[0].start;return f-g},[]);return F.jsxs(qn,{children:[F.jsx(zn,{loaded:!!o}),F.jsx(Wn,{backToTab:"verses",isRelatedImagesOpen:a,isRelatedVersesOpen:l,searchSorter:b,onToggleRelatedImages:()=>s(p=>!p),onToggleRelatedVerses:()=>c(p=>!p),onClearSearch:()=>h([]),onHighlightSearchResult:p=>d(p),onSearch:h}),F.jsxs("div",{className:"flex-wrapper",children:[F.jsx("main",{children:F.jsxs("div",{className:"page",children:[F.jsx("h1",{children:e.verse.title}),t&&o&&F.jsx(ea,{annotations:o,verse:t,searchResults:u,highlightedSearchResult:m,onSelect:i,onOpenRelatedImages:()=>s(!0),onOpenRelatedVerses:()=>c(!0)})]})}),F.jsx(Jn,{annotation:r?.annotation,currentSlug:e.verse.slug,open:l,related:r?.relatedVerses,onClose:()=>c(!1)}),F.jsx(Kn,{annotation:r?.annotation,currentSlug:e.verse.slug,open:a,related:r?.relatedImages,onClose:()=>s(!1)})]})]})};export{sa as VerseView};

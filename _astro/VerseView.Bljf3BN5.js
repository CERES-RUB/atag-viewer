import{j as _}from"./jsx-runtime.D_L90wQp.js";import{R as ft,r as N}from"./index.DL6A1vOd.js";import{c as pt,u as gt,g as mt,t as bt,A as vt,o as yt,i as wt,f as At,s as xt,a as St,L as Et,b as Ct,d as Tt,e as Lt,h as Be,K as Rt,j as Ot,P as Nt,R as Mt,k as It}from"./floating-ui.react.BkMyFjtl.js";var Je={exports:{}},G={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ke;function Bt(){if(ke)return G;ke=1;var e=ft,t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,r=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function a(s,l,d){var h,p={},v=null,c=null;d!==void 0&&(v=""+d),l.key!==void 0&&(v=""+l.key),l.ref!==void 0&&(c=l.ref);for(h in l)o.call(l,h)&&!i.hasOwnProperty(h)&&(p[h]=l[h]);if(s&&s.defaultProps)for(h in l=s.defaultProps,l)p[h]===void 0&&(p[h]=l[h]);return{$$typeof:t,type:s,key:v,ref:c,props:p,_owner:r.current}}return G.Fragment=n,G.jsx=a,G.jsxs=a,G}Je.exports=Bt();var kt=Je.exports;const Vt={namespaces:{tei:"http://www.tei-c.org/ns/1.0",teieg:"http://www.tei-c.org/ns/Examples",rng:"http://relaxng.org/ns/structure/1.0"},tei:{eg:["<pre>","</pre>"],ptr:['<a href="$rw@target">$@target</a>'],ref:[["[target]",['<a href="$rw@target">',"</a>"]]],graphic:function(e){let t=new Image;return t.src=this.rw(e.getAttribute("url")),e.hasAttribute("width")&&t.setAttribute("width",e.getAttribute("width")),e.hasAttribute("height")&&t.setAttribute("height",e.getAttribute("height")),t},list:[["[type=gloss]",function(e){const t=e.ownerDocument;let n=t.createElement("dl");for(let o of Array.from(e.children))if(o.nodeType==1){if(o.localName=="tei-label"){let r=t.createElement("dt");r.innerHTML=o.innerHTML,n.appendChild(r)}if(o.localName=="tei-item"){let r=t.createElement("dd");r.innerHTML=o.innerHTML,n.appendChild(r)}}return n}]],note:[["[place=end]",function(e){const t=e.ownerDocument;this.noteIndex?this.noteIndex++:this.noteIndex=1;let n="_note_"+this.noteIndex,o=t.createElement("a");o.setAttribute("id","src"+n),o.setAttribute("href","#"+n),o.innerHTML=this.noteIndex;let r=t.createElement("sup");r.appendChild(o);let i=t.querySelector("ol.notes");i||(i=t.createElement("ol"),i.setAttribute("class","notes"),this.dom.appendChild(i));let a=t.createElement("li");return a.id=n,a.innerHTML=e.innerHTML,i.appendChild(a),r}],["_",["(",")"]]],teiHeader:function(e){this.hideContent(e,!1)},title:[["tei-titlestmt>tei-title",function(e){const t=e.ownerDocument;let n=t.createElement("title");n.innerHTML=e.innerText,t.querySelector("head").appendChild(n)}]]},teieg:{egXML:function(e){const t=e.ownerDocument;let n=t.createElement("pre"),o=t.createElement("code");n.appendChild(o);let r=this.serialize(e,!0).replace(/</g,"&lt;"),i=r.match(/^[\t ]+/);return i&&(r=r.replace(new RegExp("^"+i[0],"mg"),"")),o.innerHTML=r,n}}};function Ut(e,t){let n=1,o=e;for(;o&&o.previousElementSibling!==null&&(!t||o.previousElementSibling.localName==t)&&(n++,o=o.previousElementSibling,!!o.previousElementSibling););return n}function Ke(e){const t=e.ownerDocument;let n=o=>{let r;switch(o.nodeType){case 1:r=t.createElement(o.nodeName);break;case 9:r=t.implementation.createDocument();break;case 11:r=t.createDocumentFragment();break;default:r=o.cloneNode(!0)}if(o.attributes)for(let i of Array.from(o.attributes))i.name!=="data-processed"&&r.setAttribute(i.name,i.value);for(let i of Array.from(o.childNodes))if(i.nodeType==1)if(i.hasAttribute("data-original")){for(let a of Array.from(i.childNodes)){let s=r.appendChild(n(a));s.nodeType===1&&s.hasAttribute("data-origid")&&(s.setAttribute("id",s.getAttribute("data-origid")),s.removeAttribute("data-origid"))}return r}else i.hasAttribute("data-origname")&&r.appendChild(n(i));else r.appendChild(i.cloneNode());return r};return n(e)}function Qe(e){return e.replace(/ .*$/,"")}function Ze(e,t=!0){const n=e.ownerDocument;if(e.childNodes.length>0){let o=n.createElement("cetei-original");e.appendChild(o),o.setAttribute("hidden",""),o.setAttribute("data-original","");for(let r of Array.from(e.childNodes))if(r!==o){if(r.nodeType===1){r.setAttribute("data-processed","");for(let i of r.querySelectorAll("*"))i.setAttribute("data-processed","")}o.appendChild(e.removeChild(r))}if(t)for(let r of Array.from(o.querySelectorAll("*")))r.hasAttribute("id")&&(r.setAttribute("data-origid",r.getAttribute("id")),r.removeAttribute("id"))}}function _t(e){return this.rw(this.first(e))}function $t(e,t){let n="";for(let o=0;o<t;o++)n+=e;return n}function Dt(e){let t=this.prefixDefs[e.substring(0,e.indexOf(":"))];return e.replace(new RegExp(t.matchPattern),t.replacementPattern)}function jt(e){return this.prefixDefs[e]}function Ht(e){return e.match(/^(?:http|mailto|file|\/|#).*$/)?e:this.base+Qe(e)}function Yt(e,t,n){return de(Ke(e),t,n)}function de(e,t,n){let o="";const r=i=>!/[^\t\n\r ]/.test(i);if((e.nodeType===9||e.nodeType===11)&&(o+=`<?xml version="1.0" encoding="UTF-8"?>
`),!t&&e.nodeType==1){typeof n=="string"&&n!==""?o+=`
`+n+"<":o+="<",o+=e.getAttribute("data-origname");let i=e.hasAttribute("data-origatts")?e.getAttribute("data-origatts").split(" "):[];for(let a of Array.from(e.attributes))!a.name.startsWith("data-")&&!["id","lang","class"].includes(a.name)&&(o+=" "+i.find(function(s){return s.toLowerCase()==a.name})+'="'+a.value+'"'),a.name=="data-xmlns"&&(o+=' xmlns="'+a.value+'"');e.childNodes.length>0?o+=">":o+="/>"}for(let i of Array.from(e.childNodes))switch(i.nodeType){case 1:typeof n=="string"?o+=de(i,!1,n+"  "):o+=de(i,!1,n);break;case 7:o+=`<?${i.nodeName} ${i.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;case 8:o+=`<!--${i.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;default:if(t&&r(i.nodeValue)&&(o+=i.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&r(i.nodeValue))break;o+=i.nodeValue}return!t&&e.nodeType==1&&e.childNodes.length>0&&(typeof n=="string"?o+=`
`+n+"</":o+="</",o+=e.getAttribute("data-origname")+">"),(e.nodeType===9||e.nodeType===11)&&(o+=`
`),o}function Le(e,t,n){const o=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];let r="";const i=a=>!/[^\t\n\r ]/.test(a);if(!t&&e.nodeType==1){typeof n=="string"&&n!==""?r+=`
`+n+"<":r+="<",r+=e.nodeName;for(let a of Array.from(e.attributes))r+=" "+a.name+'="'+a.value+'"';r+=">"}for(let a of Array.from(e.childNodes))switch(a.nodeType){case 1:typeof n=="string"?r+=Le(a,!1,n+"  "):r+=Le(a,!1,n);break;case 7:r+=`<?${a.nodeName} ${a.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;case 8:r+=`<!--${a.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;default:if(t&&i(a.nodeValue)&&(r+=a.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&i(a.nodeValue))break;r+=a.nodeValue.replace(/</g,"&lt;")}return o.includes(e.nodeName)||!t&&e.nodeType==1&&(typeof n=="string"?r+=`
${n}</`:r+="</",r+=`${e.nodeName}>`),(e.nodeType===9||e.nodeType===11)&&(r+=`
`),r}function Pt(e){return e.replace(/&gt;/,">").replace(/&quot;/,'"').replace(/&apos;/,"'").replace(/&amp;/,"&")}function ce(e){return e.includes(":"),e.replace(/:/,"-").toLowerCase()}function et(e,t=null,n=!1){try{window.customElements.define(ce(e),class extends HTMLElement{constructor(){super(),this.matches(":defined")||t&&(t.call(this),this.setAttribute("data-processed",""))}connectedCallback(){this.hasAttribute("data-processed")||t&&(t.call(this),this.setAttribute("data-processed",""))}})}catch(o){n&&(console.log(ce(e)+" couldn't be registered or is already registered."),console.log(o))}}const fe=Object.freeze(Object.defineProperty({__proto__:null,copyAndReset:Ke,defineCustomElement:et,first:Qe,getOrdinality:Ut,getPrefixDef:jt,hideContent:Ze,normalizeURI:_t,repeat:$t,resetAndSerialize:Yt,resolveURI:Dt,rw:Ht,serialize:de,serializeHTML:Le,tagName:ce,unEscapeEntities:Pt},Symbol.toStringTag,{value:"Module"}));function Xt(e){if(e.namespaces)for(let t of Object.keys(e.namespaces))!this.namespaces.has(e.namespaces[t])&&!Array.from(this.namespaces.values()).includes(t)&&this.namespaces.set(e.namespaces[t],t);for(let t of this.namespaces.values())if(e[t])for(let n of Object.keys(e[t]))this.behaviors[`${t}:${n}`]=e[t][n];if(e.functions)for(let t of Object.keys(e.functions))this.utilities[t]=e.functions[t].bind(this.utilities);e.handlers&&console.log("Behavior handlers are no longer used."),e.fallbacks&&console.log("Fallback behaviors are no longer used.")}function Ft(e,t,n){let o;if(e===Object(e))for(let r of Object.keys(e))this.namespaces.has(e[r])||(this.namespaces.set(e[r],r),o=r);else o=e;this.behaviors[`${o}:${t}`]=n}function qt(e,t){let n;if(e===Object(e))for(let o of Object.keys(e))this.namespaces.has(e[o])||(this.namespaces.set(e[o],o),n=o);else n=e;delete this.behaviors[`${n}:${t}`]}function zt(e,t){const n=e.documentElement;let o=1,r=function(a){return t.has(a.namespaceURI?a.namespaceURI:"")||t.set(a.namespaceURI,"ns"+o++),t.get(a.namespaceURI?a.namespaceURI:"")+":"+a.localName};const i=new Set(Array.from(n.querySelectorAll("*"),r));return i.add(r(n)),i}function Wt(e){return new Set(Array.from(e.querySelectorAll("*[data-origname]"),t=>t.localName.replace(/(\w+)-.+/,"$1:")+t.getAttribute("data-origname")))}class ee{constructor(t){this.options=t||{},this.document=this.options.documentObject?this.options.documentObject:void 0,this.document===void 0&&(typeof window<"u"&&window.document?this.document=window.document:typeof global<"u"&&global.document&&(this.document=global.document)),this.addBehaviors=Xt.bind(this),this.addBehavior=Ft.bind(this),this.removeBehavior=qt.bind(this),this.utilities={};for(const n of Object.keys(fe))["getPrefixDef","rw","resolveURI"].includes(n)?this.utilities[n]=fe[n].bind(this):this.utilities[n]=fe[n];if(this.els=[],this.namespaces=new Map,this.behaviors={},this.hasStyle=!1,this.prefixDefs=[],this.debug=this.options.debug===!0,this.discardContent=this.options.discardContent===!0,this.options.base)this.base=this.options.base;else try{window&&(this.base=window.location.href.replace(/\/[^\/]*$/,"/"))}catch{this.base=""}this.options.omitDefaultBehaviors||this.addBehaviors(Vt),this.options.ignoreFragmentId&&window&&window.removeEventListener("ceteiceanload",ee.restorePosition)}async getHTML5(t,n,o){window&&window.location.href.startsWith(this.base)&&t.indexOf("/")>=0&&(this.base=t.replace(/\/[^\/]*$/,"/"));try{const r=await fetch(t);if(r.ok){const i=await r.text();return this.makeHTML5(i,n,o)}else console.log(`Could not get XML file ${t}.
Server returned ${r.status}: ${r.statusText}`)}catch(r){console.log(r)}}makeHTML5(t,n,o){return this.XML_dom=new DOMParser().parseFromString(t,"text/xml"),this.domToHTML5(this.XML_dom,n,o)}preprocess(t,n,o){this.els=zt(t,this.namespaces);let r=i=>{let a;if(this.namespaces.has(i.namespaceURI?i.namespaceURI:"")){let s=this.namespaces.get(i.namespaceURI?i.namespaceURI:"");a=this.document.createElement(`${s}-${i.localName.toLowerCase()}`)}else a=this.document.importNode(i,!1);for(let s of Array.from(i.attributes))s.name=="xmlns"?a.setAttribute("data-xmlns",s.value):a.setAttribute(s.name,s.value),s.name=="xml:id"&&a.setAttribute("id",s.value),s.name=="xml:lang"&&a.setAttribute("lang",s.value),s.name=="rendition"&&a.setAttribute("class",s.value.replace(/#/g,""));if(a.setAttribute("data-origname",i.localName),i.hasAttributes()&&a.setAttribute("data-origatts",i.getAttributeNames().join(" ")),i.childNodes.length==0&&a.setAttribute("data-empty",""),i.localName=="head"){let s=t.evaluate("count(ancestor::*[tei:head])",i,function(l){if(l=="tei")return"http://www.tei-c.org/ns/1.0"},1,null);a.setAttribute("data-level",s.numberValue)}if(i.localName=="tagsDecl"){let s=this.document.createElement("style");for(let l of Array.from(i.childNodes))if(l.nodeType==1&&l.localName=="rendition"&&l.getAttribute("scheme")=="css"){let d="";l.hasAttribute("selector")?(d+=l.getAttribute("selector").replace(/([^#, >]+\w*)/g,"tei-$1").replace(/#tei-/g,"#")+`{
`,d+=l.textContent):(d+="."+l.getAttribute("xml:id")+`{
`,d+=l.textContent),d+=`
}
`,s.appendChild(this.document.createTextNode(d))}s.childNodes.length>0&&(a.appendChild(s),this.hasStyle=!0)}i.localName=="prefixDef"&&(this.prefixDefs.push(i.getAttribute("ident")),this.prefixDefs[i.getAttribute("ident")]={matchPattern:i.getAttribute("matchPattern"),replacementPattern:i.getAttribute("replacementPattern")});for(let s of Array.from(i.childNodes))s.nodeType==1?a.appendChild(r(s)):a.appendChild(s.cloneNode());return o&&o(a,i),a};this.dom=this.document.createDocumentFragment();for(let i of Array.from(t.childNodes))i.nodeType==1&&this.dom.appendChild(r(i)),i.nodeType==7&&this.dom.appendChild(this.document.importNode(i,!0)),i.nodeType==8&&this.dom.appendChild(this.document.importNode(i,!0));if(this.utilities.dom=this.dom.firstElementChild,n)n(this.dom,this),window&&window.dispatchEvent(J);else return typeof window<"u"&&window.dispatchEvent(J),this.dom}domToHTML5(t,n,o){if(this.preprocess(t,null,o),this.applyBehaviors(),this.done=!0,n)n(this.dom,this),window&&window.dispatchEvent(J);else return typeof window<"u"&&window.dispatchEvent(J),this.dom}processPage(){this.els=Wt(this.document),this.applyBehaviors(),window&&window.dispatchEvent(J)}unsetNamespace(t){this.namespaces.delete(t)}setBaseUrl(t){this.base=t}append(t,n){let o=this;if(n&&!n.hasAttribute("data-processed")){let r=t.call(o.utilities,n);r&&o.appendBasic(n,r)}else return function(){if(!this.hasAttribute("data-processed")){let r=t.call(o.utilities,this);r&&o.appendBasic(this,r)}}}appendBasic(t,n){this.discardContent?t.innerHTML="":Ze(t,!0),t.appendChild(n)}bName(t){return t.tagName.substring(0,t.tagName.indexOf("-")).toLowerCase()+":"+t.getAttribute("data-origname")}childExists(t,n){return t&&t.nodeName==n?!0:t&&t.nextElementSibling&&this.childExists(t.nextElementSibling,n)}decorator(t){if(Array.isArray(t)&&t.length==0)return function(o){};if(Array.isArray(t)&&!Array.isArray(t[0]))return this.applyDecorator(t);let n=this;return function(o){for(let r of t)if(o.matches(r[0])||r[0]==="_")return Array.isArray(r[1])?n.decorator(r[1]).call(this,o):r[1].call(this,o)}}applyDecorator(t){let n=this;return function(o){let r=[];for(let i=0;i<t.length;i++)r.push(n.template(t[i],o));return n.insert(o,r)}}getFallback(t,n){if(t[n])return t[n]instanceof Function?t[n]:this.decorator(t[n])}getHandler(t,n){if(t[n])return t[n]instanceof Function?this.append(t[n]):this.append(this.decorator(t[n]))}insert(t,n){let o=this.document.createElement("cetei-content");for(let r of Array.from(t.childNodes))r.nodeType===1&&!r.hasAttribute("data-processed")&&this.processElement(r);if(n[0].match("<[^>]+>")&&n[1]&&n[1].match("<[^>]+>"))o.innerHTML=n[0]+t.innerHTML+(n[1]?n[1]:"");else{o.innerHTML=n[0],o.setAttribute("data-before",n[0].replace(/<[^>]+>/g,"").length);for(let r of Array.from(t.childNodes))o.appendChild(r.cloneNode(!0));n.length>1&&(o.innerHTML+=n[1],o.setAttribute("data-after",n[1].replace(/<[^>]+>/g,"").length))}return o.childNodes.length<2?o.firstChild:o}processElement(t){if(t.hasAttribute("data-origname")&&!t.hasAttribute("data-processed")){let n=this.getFallback(this.bName(t));n&&(this.append(n,t),t.setAttribute("data-processed",""))}for(let n of Array.from(t.childNodes))n.nodeType===1&&this.processElement(n)}template(t,n){let o=t;if(t.search(/\$(\w*)(@([a-zA-Z:]+))/)){let r=/\$(\w*)@([a-zA-Z:]+)/g,i;for(;i=r.exec(t);)n.hasAttribute(i[2])?i[1]&&this.utilities[i[1]]?o=o.replace(i[0],this.utilities[i[1]](n.getAttribute(i[2]))):o=o.replace(i[0],n.getAttribute(i[2])):o=o.replace(i[0],"")}return o}applyBehaviors(){typeof window<"u"&&window.customElements?this.define.call(this,this.els):this.fallback.call(this,this.els)}define(t){for(let n of t){const o=this.getHandler(this.behaviors,n);et(n,o,this.debug)}}fallback(t){for(let n of t){let o=this.getFallback(this.behaviors,n);if(o)for(let r of Array.from((this.dom&&!this.done?this.dom:this.document).querySelectorAll(ce(n))))r.hasAttribute("data-processed")||(this.append(o,r),r.setAttribute("data-processed",""))}}static savePosition(){window.sessionStorage.setItem(window.location+"-scroll",window.scrollY)}static restorePosition(){if(window.location.hash)setTimeout(function(){let t=this.document.querySelector(window.decodeURI(window.location.hash));t&&t.scrollIntoView()},100);else{let t;(t=window.sessionStorage.getItem(window.location+"-scroll"))&&(window.sessionStorage.removeItem(window.location+"-scroll"),setTimeout(function(){window.scrollTo(0,t)},100))}}}try{if(typeof window<"u"){window.CETEI=ee,window.addEventListener("beforeunload",ee.savePosition);var J=new Event("ceteiceanload");window.addEventListener("ceteiceanload",ee.restorePosition)}}catch(e){console.log(e)}var Gt=[];for(var pe=0;pe<256;++pe)Gt.push((pe+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var Jt=[];for(var ge=0;ge<256;++ge)Jt.push((ge+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Kt="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let Qt=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=Kt[n[e]&63];return t};Qt();const tt="not-annotatable",P=`.${tt}`,Zt=e=>{var t;const n=e.commonAncestorContainer;return n instanceof HTMLElement?!n.closest(P):!((t=n.parentElement)!=null&&t.closest(P))},en=function*(e){const t=document.createNodeIterator(e.commonAncestorContainer,NodeFilter.SHOW_ELEMENT,o=>o instanceof HTMLElement&&o.classList.contains(tt)&&!o.parentElement.closest(P)&&e.intersectsNode(o)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);let n;for(;n=t.nextNode();)n instanceof HTMLElement&&(yield n)},tn=e=>{if(!Zt(e))return[];const t=[];let n=null;for(const o of en(e)){let r;n?(r=document.createRange(),r.setStartAfter(n),r.setEndBefore(o)):(r=e.cloneRange(),r.setEndBefore(o)),r.collapsed||t.push(r),n=o}if(n){const o=e.cloneRange();o.setStartAfter(n),o.collapsed||t.push(o)}return t.length>0?t:[e]},Re=e=>{const t=e.cloneContents();return t.querySelectorAll(P).forEach(n=>n.remove()),t},nn=e=>{e.addEventListener("click",t=>{!t.target.closest(P)&&!t.target.closest("a")&&t.preventDefault()})},Ne=(e,t=10)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(void 0,o),t)}},on=(e,t,n=10,o)=>{const r=t,i=document.createRange();i.setStart(r,0),i.setEnd(e.startContainer,e.startOffset);const a=Re(i).textContent,s=document.createRange();s.setStart(e.endContainer,e.endOffset),r===document.body?s.setEnd(r,r.childNodes.length):s.setEndAfter(r);const l=Re(s).textContent;return{prefix:a.substring(a.length-n),suffix:l.substring(0,n)}},rn=/^\s*$/,an=e=>rn.test(e.toString()),Y=e=>e.every(t=>t.range instanceof Range&&!t.range.collapsed),sn=(e,t)=>{const n=i=>Math.round(i*10)/10,o={top:n(e.top),bottom:n(e.bottom),left:n(e.left),right:n(e.right)},r={top:n(t.top),bottom:n(t.bottom),left:n(t.left),right:n(t.right)};if(Math.abs(o.top-r.top)<.5&&Math.abs(o.bottom-r.bottom)<.5){if(Math.abs(o.left-r.right)<.5||Math.abs(o.right-r.left)<.5)return"inline-adjacent";if(o.left>=r.left&&o.right<=r.right)return"inline-is-contained";if(o.left<=r.left&&o.right>=r.right)return"inline-contains"}else if(o.top<=r.top&&o.bottom>=r.bottom){if(o.left<=r.left&&o.right>=r.right)return"block-contains"}else if(o.top>=r.top&&o.bottom<=r.bottom&&o.left>=r.left&&o.right<=r.right)return"block-is-contained"},ln=(e,t)=>{const n=Math.min(e.left,t.left),o=Math.max(e.right,t.right),r=Math.min(e.top,t.top),i=Math.max(e.bottom,t.bottom);return new DOMRect(n,r,o-n,i-r)},dn=e=>e.reduce((t,n)=>{if(n.width===0||n.height===0)return t;let o=[...t],r=!1;for(const i of t){const a=sn(n,i);if(a==="inline-adjacent"){o=o.map(s=>s===i?ln(n,i):s),r=!0;break}else if(a==="inline-contains"){o=o.map(s=>s===i?n:s),r=!0;break}else if(a==="inline-is-contained"){r=!0;break}else if(a==="block-contains"||a==="block-is-contained"){n.width<i.width&&(o=o.map(s=>s===i?n:s)),r=!0;break}}return r?o:[...o,n]},[]),cn=(e,t,n)=>{const o=document.createRange(),r=n?e.startContainer.parentElement.closest(n):t;o.setStart(r,0),o.setEnd(e.startContainer,e.startOffset);const i=Re(o).textContent,a=e.toString(),s=i.length||0,l=s+a.length;return n?{quote:a,start:s,end:l,range:e,offsetReference:r}:{quote:a,start:s,end:l,range:e}},nt=(e,t)=>{var n,o;const{start:r,end:i}=e,a=e.offsetReference||t,s=document.createNodeIterator(t,NodeFilter.SHOW_TEXT,v=>{var c;return(c=v.parentElement)!=null&&c.closest(P)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let l=0;const d=document.createRange();let h=s.nextNode();h===null&&console.error("Could not revive annotation target. Content missing.");let p=!a;for(;h!==null;){if(p||(p=a?.contains(h)),p){const v=((n=h.textContent)==null?void 0:n.length)||0;if(l+v>r){d.setStart(h,r-l);break}l+=v}h=s.nextNode()}for(;h!==null;){const v=((o=h.textContent)==null?void 0:o.length)||0;if(l+v>=i){d.setEnd(h,i-l);break}l+=v,h=s.nextNode()}return{...e,range:d}},ue=(e,t)=>Y(e.selector)?e:{...e,selector:e.selector.map(n=>n.range instanceof Range&&!n.range.collapsed?n:nt(n,t))},me=(e,t)=>Y(e.target.selector)?e:{...e,target:ue(e.target,t)},un=(e,t)=>{const n=e.cloneRange();return t.contains(n.startContainer)||n.setStart(t,0),t.contains(n.endContainer)||n.setEnd(t,t.childNodes.length),n},ot=e=>{if(e===null)return document.scrollingElement;const{overflowY:t}=window.getComputedStyle(e);return t!=="visible"&&t!=="hidden"&&e.scrollHeight>e.clientHeight?e:ot(e.parentElement)},hn=(e,t)=>n=>{const o=typeof n=="string"?n:n.id,r=a=>{const s=i.getBoundingClientRect(),l=i.clientHeight,d=i.clientWidth,h=a.selector[0].range.getBoundingClientRect(),{width:p,height:v}=t.getAnnotationBounds(o),c=h.top-s.top,y=h.left-s.left,g=i.parentElement?i.scrollTop:0,b=i.parentElement?i.scrollLeft:0,f=c+g-(l-v)/2,u=y+b-(d-p)/2;i.scroll({top:f,left:u,behavior:"smooth"})},i=ot(e);if(i){const a=t.getAnnotation(o),{range:s}=a.target.selector[0];if(s&&!s.collapsed)return r(a.target),!0;{const l=ue(a.target,e),{range:d}=l.selector[0];if(d&&!d.collapsed)return r(l),!0}}return!1},X={fill:"rgb(0, 128, 255)",fillOpacity:.18},he={fill:"rgb(0, 128, 255)",fillOpacity:.45},fn=(e,t,n,o,r)=>{var i,a;const s=n?typeof n=="function"?n(e.annotation,e.state,r)||((i=e.state)!=null&&i.selected?he:X):n:(a=e.state)!=null&&a.selected?he:X;return o&&o.paint(e,t)||s},pn=e=>{const{top:t,left:n}=e.getBoundingClientRect(),{innerWidth:o,innerHeight:r}=window,i=-n,a=-t,s=o-n,l=r-t;return{top:t,left:n,minX:i,minY:a,maxX:s,maxY:l}},gn=e=>{let t=new Set;return n=>{const o=n.map(r=>r.id);(t.size!==o.length||o.some(r=>!t.has(r)))&&e.set(o),t=new Set(o)}},Me=(e,t,n,o)=>{const{store:r,selection:i,hover:a}=t;let s,l,d;const h=gn(n),p=R=>{const{x:B,y:D}=e.getBoundingClientRect(),w=r.getAt(R.clientX-B,R.clientY-D,l);w?a.current!==w.id&&(e.classList.add("hovered"),a.set(w.id)):a.current&&(e.classList.remove("hovered"),a.set(null))};e.addEventListener("pointermove",p);const v=(R=!1)=>{d&&d.clear();const B=pn(e),{minX:D,minY:w,maxX:S,maxY:x}=B,E=l?r.getIntersecting(D,w,S,x).filter(({annotation:M})=>l(M)):r.getIntersecting(D,w,S,x),O=i.selected.map(({id:M})=>M),T=E.map(({annotation:M,rects:ne})=>{const ut=O.includes(M.id),ht=M.id===a.current;return{annotation:M,rects:ne,state:{selected:ut,hover:ht}}});o.redraw(T,B,s,d,R),setTimeout(()=>h(E.map(({annotation:M})=>M)),1)},c=R=>{d=R,v()},y=R=>{s=R,v()},g=R=>{l=R,v(!1)},b=()=>v();r.observe(b);const f=i.subscribe(()=>v()),u=()=>v(!0);document.addEventListener("scroll",u,{capture:!0,passive:!0});const m=Ne(()=>{r.recalculatePositions(),d&&d.reset(),v()});window.addEventListener("resize",m);const A=new ResizeObserver(m);A.observe(e);const C={attributes:!0,childList:!0,subtree:!0},I=new MutationObserver(R=>{R.every(B=>B.target===e||e.contains(B.target))||v(!0)});return I.observe(document.body,C),{destroy:()=>{e.removeEventListener("pointermove",p),o.destroy(),r.unobserve(b),f(),document.removeEventListener("scroll",u),window.removeEventListener("resize",m),A.disconnect(),I.disconnect()},redraw:v,setStyle:y,setFilter:g,setPainter:c,setVisible:o.setVisible}},mn=()=>{const e=document.createElement("canvas");return e.width=window.innerWidth,e.height=window.innerHeight,e.className="r6o-canvas-highlight-layer bg",e},bn=(e,t)=>{e.width=window.innerWidth,e.height=window.innerHeight},vn=e=>{e.classList.add("r6o-annotatable");const t=mn(),n=t.getContext("2d");document.body.appendChild(t);const o=(i,a,s,l)=>requestAnimationFrame(()=>{const{width:d,height:h}=t;n.clearRect(-.5,-.5,d+1,h+1),l&&l.clear();const{top:p,left:v}=a;[...i].sort((c,y)=>{const{annotation:{target:{created:g}}}=c,{annotation:{target:{created:b}}}=y;return g.getTime()-b.getTime()}).forEach(c=>{var y;const g=s?typeof s=="function"?s(c.annotation,c.state):s:(y=c.state)!=null&&y.selected?he:X,b=l&&l.paint(c,a)||g,f=c.rects.map(({x:u,y:m,width:A,height:C})=>({x:u+v,y:m+p,width:A,height:C}));if(n.fillStyle=b.fill,n.globalAlpha=b.fillOpacity||1,f.forEach(({x:u,y:m,width:A,height:C})=>n.fillRect(u,m,A,C)),b.underlineColor){n.globalAlpha=1,n.strokeStyle=b.underlineColor,n.lineWidth=b.underlineThickness??1;const u=b.underlineOffset??0;f.forEach(({x:m,y:A,width:C,height:I})=>{n.beginPath(),n.moveTo(m,A+I+u),n.lineTo(m+C,A+I+u),n.stroke()})}})}),r=Ne(()=>{bn(t)});return window.addEventListener("resize",r),{destroy:()=>{t.remove(),window.removeEventListener("resize",r)},setVisible:i=>{console.log("setVisible not implemented on Canvas renderer")},redraw:o}},yn=(e,t,n)=>Me(e,t,n,vn(e));var wn={grad:.9,turn:360,rad:360/(2*Math.PI)},H=function(e){return typeof e=="string"?e.length>0:typeof e=="number"},k=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=Math.pow(10,t)),Math.round(n*e)/n+0},$=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=1),e>n?n:e>t?e:t},rt=function(e){return(e=isFinite(e)?e%360:0)>0?e:e+360},Ve=function(e){return{r:$(e.r,0,255),g:$(e.g,0,255),b:$(e.b,0,255),a:$(e.a)}},be=function(e){return{r:k(e.r),g:k(e.g),b:k(e.b),a:k(e.a,3)}},An=/^#([0-9a-f]{3,8})$/i,oe=function(e){var t=e.toString(16);return t.length<2?"0"+t:t},it=function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=Math.max(t,n,o),a=i-Math.min(t,n,o),s=a?i===t?(n-o)/a:i===n?2+(o-t)/a:4+(t-n)/a:0;return{h:60*(s<0?s+6:s),s:i?a/i*100:0,v:i/255*100,a:r}},at=function(e){var t=e.h,n=e.s,o=e.v,r=e.a;t=t/360*6,n/=100,o/=100;var i=Math.floor(t),a=o*(1-n),s=o*(1-(t-i)*n),l=o*(1-(1-t+i)*n),d=i%6;return{r:255*[o,s,a,a,l,o][d],g:255*[l,o,o,s,a,a][d],b:255*[a,a,l,o,o,s][d],a:r}},Ue=function(e){return{h:rt(e.h),s:$(e.s,0,100),l:$(e.l,0,100),a:$(e.a)}},_e=function(e){return{h:k(e.h),s:k(e.s),l:k(e.l),a:k(e.a,3)}},$e=function(e){return at((n=(t=e).s,{h:t.h,s:(n*=((o=t.l)<50?o:100-o)/100)>0?2*n/(o+n)*100:0,v:o+n,a:t.a}));var t,n,o},te=function(e){return{h:(t=it(e)).h,s:(r=(200-(n=t.s))*(o=t.v)/100)>0&&r<200?n*o/100/(r<=100?r:200-r)*100:0,l:r/2,a:t.a};var t,n,o,r},xn=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Sn=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,En=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Cn=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,De={string:[[function(e){var t=An.exec(e);return t?(e=t[1]).length<=4?{r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:e.length===4?k(parseInt(e[3]+e[3],16)/255,2):1}:e.length===6||e.length===8?{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:e.length===8?k(parseInt(e.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(e){var t=En.exec(e)||Cn.exec(e);return t?t[2]!==t[4]||t[4]!==t[6]?null:Ve({r:Number(t[1])/(t[2]?100/255:1),g:Number(t[3])/(t[4]?100/255:1),b:Number(t[5])/(t[6]?100/255:1),a:t[7]===void 0?1:Number(t[7])/(t[8]?100:1)}):null},"rgb"],[function(e){var t=xn.exec(e)||Sn.exec(e);if(!t)return null;var n,o,r=Ue({h:(n=t[1],o=t[2],o===void 0&&(o="deg"),Number(n)*(wn[o]||1)),s:Number(t[3]),l:Number(t[4]),a:t[5]===void 0?1:Number(t[5])/(t[6]?100:1)});return $e(r)},"hsl"]],object:[[function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=r===void 0?1:r;return H(t)&&H(n)&&H(o)?Ve({r:Number(t),g:Number(n),b:Number(o),a:Number(i)}):null},"rgb"],[function(e){var t=e.h,n=e.s,o=e.l,r=e.a,i=r===void 0?1:r;if(!H(t)||!H(n)||!H(o))return null;var a=Ue({h:Number(t),s:Number(n),l:Number(o),a:Number(i)});return $e(a)},"hsl"],[function(e){var t=e.h,n=e.s,o=e.v,r=e.a,i=r===void 0?1:r;if(!H(t)||!H(n)||!H(o))return null;var a=function(s){return{h:rt(s.h),s:$(s.s,0,100),v:$(s.v,0,100),a:$(s.a)}}({h:Number(t),s:Number(n),v:Number(o),a:Number(i)});return at(a)},"hsv"]]},je=function(e,t){for(var n=0;n<t.length;n++){var o=t[n][0](e);if(o)return[o,t[n][1]]}return[null,void 0]},Tn=function(e){return typeof e=="string"?je(e.trim(),De.string):typeof e=="object"&&e!==null?je(e,De.object):[null,void 0]},ve=function(e,t){var n=te(e);return{h:n.h,s:$(n.s+100*t,0,100),l:n.l,a:n.a}},ye=function(e){return(299*e.r+587*e.g+114*e.b)/1e3/255},He=function(e,t){var n=te(e);return{h:n.h,s:n.s,l:$(n.l+100*t,0,100),a:n.a}},Ye=function(){function e(t){this.parsed=Tn(t)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return e.prototype.isValid=function(){return this.parsed!==null},e.prototype.brightness=function(){return k(ye(this.rgba),2)},e.prototype.isDark=function(){return ye(this.rgba)<.5},e.prototype.isLight=function(){return ye(this.rgba)>=.5},e.prototype.toHex=function(){return t=be(this.rgba),n=t.r,o=t.g,r=t.b,a=(i=t.a)<1?oe(k(255*i)):"","#"+oe(n)+oe(o)+oe(r)+a;var t,n,o,r,i,a},e.prototype.toRgb=function(){return be(this.rgba)},e.prototype.toRgbString=function(){return t=be(this.rgba),n=t.r,o=t.g,r=t.b,(i=t.a)<1?"rgba("+n+", "+o+", "+r+", "+i+")":"rgb("+n+", "+o+", "+r+")";var t,n,o,r,i},e.prototype.toHsl=function(){return _e(te(this.rgba))},e.prototype.toHslString=function(){return t=_e(te(this.rgba)),n=t.h,o=t.s,r=t.l,(i=t.a)<1?"hsla("+n+", "+o+"%, "+r+"%, "+i+")":"hsl("+n+", "+o+"%, "+r+"%)";var t,n,o,r,i},e.prototype.toHsv=function(){return t=it(this.rgba),{h:k(t.h),s:k(t.s),v:k(t.v),a:k(t.a,3)};var t},e.prototype.invert=function(){return j({r:255-(t=this.rgba).r,g:255-t.g,b:255-t.b,a:t.a});var t},e.prototype.saturate=function(t){return t===void 0&&(t=.1),j(ve(this.rgba,t))},e.prototype.desaturate=function(t){return t===void 0&&(t=.1),j(ve(this.rgba,-t))},e.prototype.grayscale=function(){return j(ve(this.rgba,-1))},e.prototype.lighten=function(t){return t===void 0&&(t=.1),j(He(this.rgba,t))},e.prototype.darken=function(t){return t===void 0&&(t=.1),j(He(this.rgba,-t))},e.prototype.rotate=function(t){return t===void 0&&(t=15),this.hue(this.hue()+t)},e.prototype.alpha=function(t){return typeof t=="number"?j({r:(n=this.rgba).r,g:n.g,b:n.b,a:t}):k(this.rgba.a,3);var n},e.prototype.hue=function(t){var n=te(this.rgba);return typeof t=="number"?j({h:t,s:n.s,l:n.l,a:n.a}):k(n.h)},e.prototype.isEqual=function(t){return this.toHex()===j(t).toHex()},e}(),j=function(e){return e instanceof Ye?e:new Ye(e)};const Ln=e=>[`background-color:${j(e?.fill||X.fill).alpha(e?.fillOpacity===void 0?X.fillOpacity:e.fillOpacity).toHex()}`,e!=null&&e.underlineThickness?"text-decoration:underline":void 0,e!=null&&e.underlineColor?`text-decoration-color:${e.underlineColor}`:void 0,e!=null&&e.underlineOffset?`text-underline-offset:${e.underlineOffset}px`:void 0,e!=null&&e.underlineThickness?`text-decoration-thickness:${e.underlineThickness}px`:void 0].filter(Boolean).join(";"),Rn=()=>{const e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e);let t=new Set;return{destroy:()=>{CSS.highlights.clear(),e.remove()},setVisible:n=>{console.log("setVisible not implemented on CSS Custom Highlights renderer")},redraw:(n,o,r,i)=>{i&&i.clear();const a=new Set(n.map(l=>l.annotation.id));Array.from(t).filter(l=>!a.has(l));const s=n.map(l=>{var d;const h=r?typeof r=="function"?r(l.annotation,l.state):r:(d=l.state)!=null&&d.selected?he:X,p=i&&i.paint(l,o)||h;return`::highlight(_${l.annotation.id}) { ${Ln(p)} }`});e.innerHTML=s.join(`
`),CSS.highlights.clear(),n.forEach(({annotation:l})=>{const d=l.target.selector.map(p=>p.range),h=new Highlight(...d);CSS.highlights.set(`_${l.id}`,h)}),t=a}}},On=(e,t,n)=>Me(e,t,n,Rn());var Pe=Object.prototype.hasOwnProperty;function Oe(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&Oe(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Pe.call(e,n)&&++o&&!Pe.call(t,n)||!(n in t)||!Oe(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}const Nn=(e,t)=>{const n=(i,a)=>i.x<=a.x+a.width&&i.x+i.width>=a.x&&i.y<=a.y+a.height&&i.y+i.height>=a.y,o=i=>i.rects.reduce((a,s)=>a+s.width,0),r=t.filter(({rects:i})=>i.some(a=>n(e,a)));return r.sort((i,a)=>o(a)-o(i)),r.findIndex(i=>i.rects.includes(e))},Mn=e=>{e.classList.add("r6o-annotatable");const t=document.createElement("div");t.className="r6o-span-highlight-layer",e.insertBefore(t,e.firstChild);let n=[];return{destroy:()=>{t.remove()},redraw:(o,r,i,a,s)=>{const l=!(Oe(n,o)&&s);!a&&!l||(l&&(t.innerHTML=""),[...o].sort((d,h)=>{const{annotation:{target:{created:p}}}=d,{annotation:{target:{created:v}}}=h;return p&&v?p.getTime()-v.getTime():0}).forEach(d=>{d.rects.map(h=>{const p=Nn(h,o),v=fn(d,r,i,a,p);if(l){const c=document.createElement("span");c.className="r6o-annotation",c.dataset.annotation=d.annotation.id,c.style.left=`${h.x}px`,c.style.top=`${h.y}px`,c.style.width=`${h.width}px`,c.style.height=`${h.height}px`,c.style.backgroundColor=j(v?.fill||X.fill).alpha(v?.fillOpacity===void 0?X.fillOpacity:v.fillOpacity).toHex(),v.underlineStyle&&(c.style.borderStyle=v.underlineStyle),v.underlineColor&&(c.style.borderColor=v.underlineColor),v.underlineThickness&&(c.style.borderBottomWidth=`${v.underlineThickness}px`),v.underlineOffset&&(c.style.paddingBottom=`${v.underlineOffset}px`),t.appendChild(c)}})}),n=o)},setVisible:o=>{o?t.classList.remove("hidden"):t.classList.add("hidden")}}},In=(e,t,n)=>Me(e,t,n,Mn(e));var V=[];for(var we=0;we<256;++we)V.push((we+256).toString(16).slice(1));function Bn(e,t=0){return(V[e[t+0]]+V[e[t+1]]+V[e[t+2]]+V[e[t+3]]+"-"+V[e[t+4]]+V[e[t+5]]+"-"+V[e[t+6]]+V[e[t+7]]+"-"+V[e[t+8]]+V[e[t+9]]+"-"+V[e[t+10]]+V[e[t+11]]+V[e[t+12]]+V[e[t+13]]+V[e[t+14]]+V[e[t+15]]).toLowerCase()}var re,kn=new Uint8Array(16);function Vn(){if(!re&&(re=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!re))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return re(kn)}var Un=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Xe={randomUUID:Un};function st(e,t,n){if(Xe.randomUUID&&!t&&!e)return Xe.randomUUID();e=e||{};var o=e.random||(e.rng||Vn)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Bn(o)}var Fe=Object.prototype.hasOwnProperty;function F(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&F(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Fe.call(e,n)&&++o&&!Fe.call(t,n)||!(n in t)||!F(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function Ae(){}function _n(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const q=[];function Ie(e,t=Ae){let n;const o=new Set;function r(s){if(_n(e,s)&&(e=s,n)){const l=!q.length;for(const d of o)d[1](),q.push(d,e);if(l){for(let d=0;d<q.length;d+=2)q[d][0](q[d+1]);q.length=0}}}function i(s){r(s(e))}function a(s,l=Ae){const d=[s,l];return o.add(d),o.size===1&&(n=t(r,i)||Ae),s(e),()=>{o.delete(d),o.size===0&&n&&(n(),n=null)}}return{set:r,update:i,subscribe:a}}const $n=e=>{const{subscribe:t,set:n}=Ie();let o;return t(r=>o=r),e.observe(({changes:r})=>{if(o){(r.deleted||[]).some(a=>a.id===o)&&n(void 0);const i=(r.updated||[]).find(({oldValue:a})=>a.id===o);i&&n(i.newValue.id)}}),{get current(){return o},subscribe:t,set:n}},ie={selected:[]},Dn=(e,t)=>{const{subscribe:n,set:o}=Ie(ie);let r=t,i=ie;n(c=>i=c);const a=()=>{F(i,ie)||o(ie)},s=()=>{var c;return((c=i.selected)==null?void 0:c.length)===0},l=c=>{if(s())return!1;const y=typeof c=="string"?c:c.id;return i.selected.some(g=>g.id===y)},d=(c,y)=>{const g=e.getAnnotation(c);if(!g){console.warn("Invalid selection: "+c);return}switch(qe(g,r)){case"EDIT":o({selected:[{id:c,editable:!0}],event:y});break;case"SELECT":o({selected:[{id:c}],event:y});break;default:o({selected:[],event:y})}},h=(c,y)=>{const g=Array.isArray(c)?c:[c],b=g.map(f=>e.getAnnotation(f)).filter(f=>!!f);o({selected:b.map(f=>{const u=y===void 0?qe(f,r)==="EDIT":y;return{id:f.id,editable:u}})}),b.length!==g.length&&console.warn("Invalid selection",c)},p=c=>{if(s())return!1;const{selected:y}=i;y.some(({id:g})=>c.includes(g))&&o({selected:y.filter(({id:g})=>!c.includes(g))})},v=c=>r=c;return e.observe(({changes:c})=>p((c.deleted||[]).map(y=>y.id))),{get event(){return i?i.event:null},get selected(){return i?[...i.selected]:null},get userSelectAction(){return r},clear:a,isEmpty:s,isSelected:l,setSelected:h,setUserSelectAction:v,subscribe:n,userSelect:d}},qe=(e,t)=>typeof t=="function"?t(e):t||"EDIT";var U=[];for(var xe=0;xe<256;++xe)U.push((xe+256).toString(16).slice(1));function jn(e,t=0){return(U[e[t+0]]+U[e[t+1]]+U[e[t+2]]+U[e[t+3]]+"-"+U[e[t+4]]+U[e[t+5]]+"-"+U[e[t+6]]+U[e[t+7]]+"-"+U[e[t+8]]+U[e[t+9]]+"-"+U[e[t+10]]+U[e[t+11]]+U[e[t+12]]+U[e[t+13]]+U[e[t+14]]+U[e[t+15]]).toLowerCase()}var ae,Hn=new Uint8Array(16);function Yn(){if(!ae&&(ae=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ae))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ae(Hn)}var Pn=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const ze={randomUUID:Pn};function Xn(e,t,n){if(ze.randomUUID&&!t&&!e)return ze.randomUUID();e=e||{};var o=e.random||(e.rng||Yn)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,jn(o)}const Se=e=>{const t=n=>{const o={...n};return n.created&&typeof n.created=="string"&&(o.created=new Date(n.created)),n.updated&&typeof n.updated=="string"&&(o.updated=new Date(n.updated)),o};return{...e,bodies:(e.bodies||[]).map(t),target:t(e.target)}},Fn=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},qn=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},zn=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(r=>r.id===n.id);return{newBody:n,oldBody:o&&!F(o,n)?o:void 0}}).filter(({oldBody:n})=>n).map(({oldBody:n,newBody:o})=>({oldBody:n,newBody:o})),Wn=(e,t)=>!F(e.target,t.target),lt=(e,t)=>{const n=Fn(e,t),o=qn(e,t),r=zn(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:r.length>0?r:void 0,targetUpdated:Wn(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var L=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e.SILENT="SILENT",e))(L||{});const Gn=(e,t)=>{var n,o;const{changes:r,origin:i}=t;if(!(e.options.origin?e.options.origin===i:i!=="SILENT"))return!1;if(e.options.ignore){const{ignore:a}=e.options,s=l=>l&&l.length>0;if(!(s(r.created)||s(r.deleted))){const l=(n=r.updated)==null?void 0:n.some(h=>s(h.bodiesCreated)||s(h.bodiesDeleted)||s(h.bodiesUpdated)),d=(o=r.updated)==null?void 0:o.some(h=>h.targetUpdated);if(a==="BODY_ONLY"&&l&&!d||a==="TARGET_ONLY"&&d&&!l)return!1}}if(e.options.annotations){const a=new Set([...(r.created||[]).map(s=>s.id),...(r.deleted||[]).map(s=>s.id),...(r.updated||[]).map(({oldValue:s})=>s.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(s=>a.has(s))}else return!0},Jn=(e,t)=>{const n=new Set((e.created||[]).map(p=>p.id)),o=new Set((e.updated||[]).map(({newValue:p})=>p.id)),r=new Set((t.created||[]).map(p=>p.id)),i=new Set((t.deleted||[]).map(p=>p.id)),a=new Set((t.updated||[]).map(({oldValue:p})=>p.id)),s=new Set((t.updated||[]).filter(({oldValue:p})=>n.has(p.id)||o.has(p.id)).map(({oldValue:p})=>p.id)),l=[...(e.created||[]).filter(p=>!i.has(p.id)).map(p=>a.has(p.id)?t.updated.find(({oldValue:v})=>v.id===p.id).newValue:p),...t.created||[]],d=[...(e.deleted||[]).filter(p=>!r.has(p.id)),...(t.deleted||[]).filter(p=>!n.has(p.id))],h=[...(e.updated||[]).filter(({newValue:p})=>!i.has(p.id)).map(p=>{const{oldValue:v,newValue:c}=p;if(a.has(c.id)){const y=t.updated.find(g=>g.oldValue.id===c.id).newValue;return lt(v,y)}else return p}),...(t.updated||[]).filter(({oldValue:p})=>!s.has(p.id))];return{created:l,deleted:d,updated:h}},Ee=e=>{const t=e.id===void 0?Xn():e.id;return{...e,id:t,bodies:e.bodies===void 0?[]:e.bodies.map(n=>({...n,annotation:t})),target:{...e.target,annotation:t}}},Kn=e=>e.id!==void 0,Qn=()=>{const e=new Map,t=new Map,n=[],o=(w,S={})=>{n.push({onChange:w,options:S})},r=w=>{const S=n.findIndex(x=>x.onChange==w);S>-1&&n.splice(S,1)},i=(w,S)=>{const x={origin:w,changes:{created:S.created||[],updated:S.updated||[],deleted:S.deleted||[]},state:[...e.values()]};n.forEach(E=>{Gn(E,x)&&E.onChange(x)})},a=(w,S=L.LOCAL)=>{if(w.id&&e.get(w.id))throw Error(`Cannot add annotation ${w.id} - exists already`);{const x=Ee(w);e.set(x.id,x),x.bodies.forEach(E=>t.set(E.id,x.id)),i(S,{created:[x]})}},s=(w,S)=>{const x=Ee(typeof w=="string"?S:w),E=typeof w=="string"?w:w.id,O=E&&e.get(E);if(O){const T=lt(O,x);return E===x.id?e.set(E,x):(e.delete(E),e.set(x.id,x)),O.bodies.forEach(M=>t.delete(M.id)),x.bodies.forEach(M=>t.set(M.id,x.id)),T}else console.warn(`Cannot update annotation ${E} - does not exist`)},l=(w,S=L.LOCAL,x=L.LOCAL)=>{const E=Kn(S)?x:S,O=s(w,S);O&&i(E,{updated:[O]})},d=(w,S=L.LOCAL)=>{const x=w.reduce((E,O)=>{const T=s(O);return T?[...E,T]:E},[]);x.length>0&&i(S,{updated:x})},h=(w,S=L.LOCAL)=>{const x=e.get(w.annotation);if(x){const E={...x,bodies:[...x.bodies,w]};e.set(x.id,E),t.set(w.id,E.id),i(S,{updated:[{oldValue:x,newValue:E,bodiesCreated:[w]}]})}else console.warn(`Attempt to add body to missing annotation: ${w.annotation}`)},p=()=>[...e.values()],v=(w=L.LOCAL)=>{const S=[...e.values()];e.clear(),t.clear(),i(w,{deleted:S})},c=(w,S=!0,x=L.LOCAL)=>{const E=w.map(Ee);if(S){const O=[...e.values()];e.clear(),t.clear(),E.forEach(T=>{e.set(T.id,T),T.bodies.forEach(M=>t.set(M.id,T.id))}),i(x,{created:E,deleted:O})}else{const O=w.reduce((T,M)=>{const ne=M.id&&e.get(M.id);return ne?[...T,ne]:T},[]);if(O.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${O.map(T=>T.id).join(", ")}`);E.forEach(T=>{e.set(T.id,T),T.bodies.forEach(M=>t.set(M.id,T.id))}),i(x,{created:E})}},y=w=>{const S=typeof w=="string"?w:w.id,x=e.get(S);if(x)return e.delete(S),x.bodies.forEach(E=>t.delete(E.id)),x;console.warn(`Attempt to delete missing annotation: ${S}`)},g=(w,S=L.LOCAL)=>{const x=y(w);x&&i(S,{deleted:[x]})},b=(w,S=L.LOCAL)=>{const x=w.reduce((E,O)=>{const T=y(O);return T?[...E,T]:E},[]);x.length>0&&i(S,{deleted:x})},f=w=>{const S=e.get(w.annotation);if(S){const x=S.bodies.find(E=>E.id===w.id);if(x){t.delete(x.id);const E={...S,bodies:S.bodies.filter(O=>O.id!==w.id)};return e.set(S.id,E),{oldValue:S,newValue:E,bodiesDeleted:[x]}}else console.warn(`Attempt to delete missing body ${w.id} from annotation ${w.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${w.annotation}`)},u=(w,S=L.LOCAL)=>{const x=f(w);x&&i(S,{updated:[x]})},m=(w,S=L.LOCAL)=>{const x=w.map(E=>f(E)).filter(Boolean);x.length>0&&i(S,{updated:x})},A=w=>{const S=e.get(w);return S?{...S}:void 0},C=w=>{const S=t.get(w);if(S){const x=A(S).bodies.find(E=>E.id===w);if(x)return x;console.error(`Store integrity error: body ${w} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${w}`)},I=(w,S)=>{if(w.annotation!==S.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const x=e.get(w.annotation);if(x){const E=x.bodies.find(T=>T.id===w.id),O={...x,bodies:x.bodies.map(T=>T.id===E.id?S:T)};return e.set(x.id,O),E.id!==S.id&&(t.delete(E.id),t.set(S.id,O.id)),{oldValue:x,newValue:O,bodiesUpdated:[{oldBody:E,newBody:S}]}}else console.warn(`Attempt to add body to missing annotation ${w.annotation}`)},R=(w,S,x=L.LOCAL)=>{const E=I(w,S);E&&i(x,{updated:[E]})},B=(w,S=L.LOCAL)=>{const x=w.map(E=>I({id:E.id,annotation:E.annotation},E)).filter(Boolean);i(S,{updated:x})},D=w=>{const S=e.get(w.annotation);if(S){const x={...S,target:{...S.target,...w}};return e.set(S.id,x),{oldValue:S,newValue:x,targetUpdated:{oldTarget:S.target,newTarget:w}}}else console.warn(`Attempt to update target on missing annotation: ${w.annotation}`)};return{addAnnotation:a,addBody:h,all:p,bulkAddAnnotation:c,bulkDeleteAnnotation:b,bulkDeleteBodies:m,bulkUpdateAnnotation:d,bulkUpdateBodies:B,bulkUpdateTargets:(w,S=L.LOCAL)=>{const x=w.map(E=>D(E)).filter(Boolean);x.length>0&&i(S,{updated:x})},clear:v,deleteAnnotation:g,deleteBody:u,getAnnotation:A,getBody:C,observe:o,unobserve:r,updateAnnotation:l,updateBody:R,updateTarget:(w,S=L.LOCAL)=>{const x=D(w);x&&i(S,{updated:[x]})}}};let Zn=()=>({emit(e,...t){for(let n=0,o=this.events[e]||[],r=o.length;n<r;n++)o[n](...t)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(r=>t!==r)}}});const eo=250,to=e=>{const t=Zn(),n=[];let o=-1,r=!1,i=0;const a=c=>{if(!r){const{changes:y}=c,g=performance.now();if(g-i>eo)n.splice(o+1),n.push(y),o=n.length-1;else{const b=n.length-1;n[b]=Jn(n[b],y)}i=g}r=!1};e.observe(a,{origin:L.LOCAL});const s=c=>c&&c.length>0&&e.bulkDeleteAnnotation(c),l=c=>c&&c.length>0&&e.bulkAddAnnotation(c,!1),d=c=>c&&c.length>0&&e.bulkUpdateAnnotation(c.map(({oldValue:y})=>y)),h=c=>c&&c.length>0&&e.bulkUpdateAnnotation(c.map(({newValue:y})=>y)),p=c=>c&&c.length>0&&e.bulkAddAnnotation(c,!1),v=c=>c&&c.length>0&&e.bulkDeleteAnnotation(c);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(a),on:(c,y)=>t.on(c,y),redo:()=>{if(n.length-1>o){r=!0;const{created:c,updated:y,deleted:g}=n[o+1];l(c),h(y),v(g),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){r=!0;const{created:c,updated:y,deleted:g}=n[o];s(c),d(y),p(g),t.emit("undo",n[o]),o-=1}}}},no=()=>{const{subscribe:e,set:t}=Ie([]);return{subscribe:e,set:t}},oo=(e,t,n,o)=>{const{store:r,selection:i,hover:a,viewport:s}=e,l=new Map;let d=[],h;const p=(g,b)=>{l.has(g)?l.get(g).push(b):l.set(g,[b])},v=(g,b)=>{const f=l.get(g);if(f){const u=f.indexOf(b);u!==-1&&f.splice(u,1)}},c=(g,b,f)=>{l.has(g)&&setTimeout(()=>{l.get(g).forEach(u=>{if(n){const m=Array.isArray(b)?b.map(C=>n.serialize(C)):n.serialize(b),A=f?f instanceof PointerEvent?f:n.serialize(f):void 0;u(m,A)}else u(b,f)})},1)};i.subscribe(({selected:g})=>{if(!(d.length===0&&g.length===0)){if(d.length===0&&g.length>0)d=g.map(({id:b})=>r.getAnnotation(b));else if(d.length>0&&g.length===0)d.forEach(b=>{const f=r.getAnnotation(b.id);f&&!F(f,b)&&c("updateAnnotation",f,b)}),d=[];else{const b=new Set(d.map(u=>u.id)),f=new Set(g.map(({id:u})=>u));d.filter(u=>!f.has(u.id)).forEach(u=>{const m=r.getAnnotation(u.id);m&&!F(m,u)&&c("updateAnnotation",m,u)}),d=[...d.filter(u=>f.has(u.id)),...g.filter(({id:u})=>!b.has(u)).map(({id:u})=>r.getAnnotation(u))]}c("selectionChanged",d)}}),a.subscribe(g=>{!h&&g?c("mouseEnterAnnotation",r.getAnnotation(g)):h&&!g?c("mouseLeaveAnnotation",r.getAnnotation(h)):h&&g&&(c("mouseLeaveAnnotation",r.getAnnotation(h)),c("mouseEnterAnnotation",r.getAnnotation(g))),h=g}),s?.subscribe(g=>c("viewportIntersect",g.map(b=>r.getAnnotation(b)))),r.observe(g=>{const{created:b,deleted:f}=g.changes;(b||[]).forEach(u=>c("createAnnotation",u)),(f||[]).forEach(u=>c("deleteAnnotation",u)),(g.changes.updated||[]).filter(u=>[...u.bodiesCreated||[],...u.bodiesDeleted||[],...u.bodiesUpdated||[]].length>0).forEach(({oldValue:u,newValue:m})=>{const A=d.find(C=>C.id===u.id)||u;d=d.map(C=>C.id===u.id?m:C),c("updateAnnotation",m,A)})},{origin:L.LOCAL}),r.observe(g=>{if(d){const b=new Set(d.map(u=>u.id)),f=(g.changes.updated||[]).filter(({newValue:u})=>b.has(u.id)).map(({newValue:u})=>u);f.length>0&&(d=d.map(u=>f.find(m=>m.id===u.id)||u))}},{origin:L.REMOTE});const y=g=>b=>{const{updated:f}=b;g?(f||[]).forEach(u=>c("updateAnnotation",u.oldValue,u.newValue)):(f||[]).forEach(u=>c("updateAnnotation",u.newValue,u.oldValue))};return t.on("undo",y(!0)),t.on("redo",y(!1)),{on:p,off:v,emit:c}},ro=e=>t=>t.reduce((n,o)=>{const{parsed:r,error:i}=e.parse(o);return i?{parsed:n.parsed,failed:[...n.failed,o]}:r?{parsed:[...n.parsed,r],failed:n.failed}:{...n}},{parsed:[],failed:[]}),io=(e,t,n)=>{const{store:o,selection:r}=e,i=f=>{if(n){const{parsed:u,error:m}=n.parse(f);u?o.addAnnotation(u,L.REMOTE):console.error(m)}else o.addAnnotation(Se(f),L.REMOTE)},a=()=>r.clear(),s=()=>o.clear(),l=f=>{const u=o.getAnnotation(f);return n&&u?n.serialize(u):u},d=()=>n?o.all().map(n.serialize):o.all(),h=()=>{var f;const u=(((f=r.selected)==null?void 0:f.map(m=>m.id))||[]).map(m=>o.getAnnotation(m)).filter(Boolean);return n?u.map(n.serialize):u},p=(f,u=!0)=>fetch(f).then(m=>m.json()).then(m=>(c(m,u),m)),v=f=>{if(typeof f=="string"){const u=o.getAnnotation(f);if(o.deleteAnnotation(f),u)return n?n.serialize(u):u}else{const u=n?n.parse(f).parsed:f;if(u)return o.deleteAnnotation(u),f}},c=(f,u=!0)=>{if(n){const m=n.parseAll||ro(n),{parsed:A,failed:C}=m(f);C.length>0&&console.warn(`Discarded ${C.length} invalid annotations`,C),o.bulkAddAnnotation(A,u,L.REMOTE)}else o.bulkAddAnnotation(f.map(Se),u,L.REMOTE)},y=(f,u)=>{f?r.setSelected(f,u):r.clear()},g=f=>{r.clear(),r.setUserSelectAction(f)},b=f=>{if(n){const u=n.parse(f).parsed,m=n.serialize(o.getAnnotation(u.id));return o.updateAnnotation(u),m}else{const u=o.getAnnotation(f.id);return o.updateAnnotation(Se(f)),u}};return{addAnnotation:i,cancelSelected:a,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:s,getAnnotationById:l,getAnnotations:d,getSelected:h,loadAnnotations:p,redo:t.redo,removeAnnotation:v,setAnnotations:c,setSelected:y,setUserSelectAction:g,undo:t.undo,updateAnnotation:b}},ao="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let so=e=>crypto.getRandomValues(new Uint8Array(e)),lo=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*o*t/e.length);return(i=t)=>{let a="";for(;;){let s=n(r),l=r;for(;l--;)if(a+=e[s[l]&o]||"",a.length===i)return a}}},co=(e,t=21)=>lo(e,t,so),uo=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=ao[n[e]&63];return t};const ho=()=>({isGuest:!0,id:co("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),fo=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,r=t.length;o<r;o++){let i=t.charCodeAt(o);n=(n<<5)-n+i,n|=0}return`${n}`},dt=e=>e?typeof e=="object"?{...e}:e:void 0,po=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:r,purpose:i,value:a,created:s,modified:l,creator:d,...h}=n;return{id:o||`temp-${fo(n)}`,annotation:t,type:r,purpose:i,value:a,creator:dt(d),created:s?new Date(s):void 0,updated:l?new Date(l):void 0,...h}}),go=e=>e.map(t=>{var n;const{annotation:o,created:r,updated:i,...a}=t,s={...a,created:r?.toISOString(),modified:i?.toISOString()};return(n=s.id)!=null&&n.startsWith("temp-")&&delete s.id,s});uo();const mo=(e,t)=>({parse:n=>yo(n),serialize:n=>wo(n,e,t)}),bo=e=>e.quote!==void 0&&e.start!==void 0&&e.end!==void 0,vo=e=>{const{id:t,creator:n,created:o,modified:r,target:i}=e,a=Array.isArray(i)?i:[i],s={creator:dt(n),created:o?new Date(o):void 0,updated:r?new Date(r):void 0,annotation:t,selector:[]};for(const l of a){const d=(Array.isArray(l.selector)?l.selector:[l.selector]).reduce((h,p)=>{switch(p.type){case"TextQuoteSelector":h.quote=p.exact;break;case"TextPositionSelector":h.start=p.start,h.end=p.end;break}return h},{});if(bo(d))s.selector.push({id:l.id,...d});else{const h=[d.start?void 0:"TextPositionSelector",d.quote?void 0:"TextQuoteSelector"].filter(Boolean);return{error:Error(`Missing selector types: ${h.join(" and ")} for annotation: ${e.id}`)}}}return{parsed:s}},yo=e=>{const t=e.id||st(),{creator:n,created:o,modified:r,body:i,...a}=e,s=po(i,t),l=vo(e);return"error"in l?{error:l.error}:{parsed:{...a,id:t,bodies:s,target:l.parsed}}},wo=(e,t,n)=>{const{bodies:o,target:r,...i}=e,{selector:a,creator:s,created:l,updated:d,...h}=r,p=a.map(v=>{const{quote:c,start:y,end:g,range:b}=v,{prefix:f,suffix:u}=on(b,n),m=[{type:"TextQuoteSelector",exact:c,prefix:f,suffix:u},{type:"TextPositionSelector",start:y,end:g}];return{...h,id:v.id,source:t,selector:m}});return{...i,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:go(e.bodies),creator:s,created:l?.toISOString(),modified:d?.toISOString(),target:p}};function ct(e,t,n=0,o=e.length-1,r=Ao){for(;o>n;){if(o-n>600){const l=o-n+1,d=t-n+1,h=Math.log(l),p=.5*Math.exp(2*h/3),v=.5*Math.sqrt(h*p*(l-p)/l)*(d-l/2<0?-1:1),c=Math.max(n,Math.floor(t-d*p/l+v)),y=Math.min(o,Math.floor(t+(l-d)*p/l+v));ct(e,t,c,y,r)}const i=e[t];let a=n,s=o;for(K(e,n,t),r(e[o],i)>0&&K(e,n,o);a<s;){for(K(e,a,s),a++,s--;r(e[a],i)<0;)a++;for(;r(e[s],i)>0;)s--}r(e[n],i)===0?K(e,n,s):(s++,K(e,s,o)),s<=t&&(n=s+1),t<=s&&(o=s-1)}}function K(e,t,n){const o=e[t];e[t]=e[n],e[n]=o}function Ao(e,t){return e<t?-1:e>t?1:0}class xo{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!le(t,n))return o;const r=this.toBBox,i=[];for(;n;){for(let a=0;a<n.children.length;a++){const s=n.children[a],l=n.leaf?r(s):s;le(t,l)&&(n.leaf?o.push(s):Te(t,l)?this._all(s,o):i.push(s))}n=i.pop()}return o}collides(t){let n=this.data;if(!le(t,n))return!1;const o=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],a=n.leaf?this.toBBox(i):i;if(le(t,a)){if(n.leaf||Te(t,a))return!0;o.push(i)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=W([]),this}remove(t,n){if(!t)return this;let o=this.data;const r=this.toBBox(t),i=[],a=[];let s,l,d;for(;o||i.length;){if(o||(o=i.pop(),l=i[i.length-1],s=a.pop(),d=!0),o.leaf){const h=So(t,o.children,n);if(h!==-1)return o.children.splice(h,1),i.push(o),this._condense(i),this}!d&&!o.leaf&&Te(o,r)?(i.push(o),a.push(s),s=0,l=o,o=o.children[0]):l?(s++,o=l.children[s],d=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,r){const i=o-n+1;let a=this._maxEntries,s;if(i<=a)return s=W(t.slice(n,o+1)),z(s,this.toBBox),s;r||(r=Math.ceil(Math.log(i)/Math.log(a)),a=Math.ceil(i/Math.pow(a,r-1))),s=W([]),s.leaf=!1,s.height=r;const l=Math.ceil(i/a),d=l*Math.ceil(Math.sqrt(a));We(t,n,o,d,this.compareMinX);for(let h=n;h<=o;h+=d){const p=Math.min(h+d-1,o);We(t,h,p,l,this.compareMinY);for(let v=h;v<=p;v+=l){const c=Math.min(v+l-1,p);s.children.push(this._build(t,v,c,r-1))}}return z(s,this.toBBox),s}_chooseSubtree(t,n,o,r){for(;r.push(n),!(n.leaf||r.length-1===o);){let i=1/0,a=1/0,s;for(let l=0;l<n.children.length;l++){const d=n.children[l],h=Ce(d),p=To(t,d)-h;p<a?(a=p,i=h<i?h:i,s=d):p===a&&h<i&&(i=h,s=d)}n=s||n.children[0]}return n}_insert(t,n,o){const r=o?t:this.toBBox(t),i=[],a=this._chooseSubtree(r,this.data,n,i);for(a.children.push(t),Z(a,r);n>=0&&i[n].children.length>this._maxEntries;)this._split(i,n),n--;this._adjustParentBBoxes(r,i,n)}_split(t,n){const o=t[n],r=o.children.length,i=this._minEntries;this._chooseSplitAxis(o,i,r);const a=this._chooseSplitIndex(o,i,r),s=W(o.children.splice(a,o.children.length-a));s.height=o.height,s.leaf=o.leaf,z(o,this.toBBox),z(s,this.toBBox),n?t[n-1].children.push(s):this._splitRoot(o,s)}_splitRoot(t,n){this.data=W([t,n]),this.data.height=t.height+1,this.data.leaf=!1,z(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let r,i=1/0,a=1/0;for(let s=n;s<=o-n;s++){const l=Q(t,0,s,this.toBBox),d=Q(t,s,o,this.toBBox),h=Lo(l,d),p=Ce(l)+Ce(d);h<i?(i=h,r=s,a=p<a?p:a):h===i&&p<a&&(a=p,r=s)}return r||o-n}_chooseSplitAxis(t,n,o){const r=t.leaf?this.compareMinX:Eo,i=t.leaf?this.compareMinY:Co,a=this._allDistMargin(t,n,o,r),s=this._allDistMargin(t,n,o,i);a<s&&t.children.sort(r)}_allDistMargin(t,n,o,r){t.children.sort(r);const i=this.toBBox,a=Q(t,0,n,i),s=Q(t,o-n,o,i);let l=se(a)+se(s);for(let d=n;d<o-n;d++){const h=t.children[d];Z(a,t.leaf?i(h):h),l+=se(a)}for(let d=o-n-1;d>=n;d--){const h=t.children[d];Z(s,t.leaf?i(h):h),l+=se(s)}return l}_adjustParentBBoxes(t,n,o){for(let r=o;r>=0;r--)Z(n[r],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():z(t[n],this.toBBox)}}function So(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function z(e,t){Q(e,0,e.children.length,t,e)}function Q(e,t,n,o,r){r||(r=W(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let i=t;i<n;i++){const a=e.children[i];Z(r,e.leaf?o(a):a)}return r}function Z(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function Eo(e,t){return e.minX-t.minX}function Co(e,t){return e.minY-t.minY}function Ce(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function se(e){return e.maxX-e.minX+(e.maxY-e.minY)}function To(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function Lo(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),r=Math.min(e.maxX,t.maxX),i=Math.min(e.maxY,t.maxY);return Math.max(0,r-n)*Math.max(0,i-o)}function Te(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function le(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function W(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function We(e,t,n,o,r){const i=[t,n];for(;i.length;){if(n=i.pop(),t=i.pop(),n-t<=o)continue;const a=t+Math.ceil((n-t)/o/2)*o;ct(e,a,t,n,r),i.push(t,a,a,n)}}const Ro=(e,t)=>{const n=new xo,o=new Map,r=(y,g)=>{const b=y.selector.flatMap(u=>{const m=Y([u])?u.range:nt(u,t).range;return Array.from(m.getClientRects())}),f=dn(b).map(({left:u,top:m,right:A,bottom:C})=>new DOMRect(u-g.left,m-g.top,A-u,C-m));return f.map(u=>{const{x:m,y:A,width:C,height:I}=u;return{minX:m,minY:A,maxX:m+C,maxY:A+I,annotation:{id:y.annotation,rects:f}}})},i=()=>[...o.values()],a=()=>{n.clear(),o.clear()},s=y=>{const g=r(y,t.getBoundingClientRect());g.forEach(b=>n.insert(b)),o.set(y.annotation,g)},l=y=>{const g=o.get(y.annotation);g&&(g.forEach(b=>n.remove(b)),o.delete(y.annotation))},d=y=>{l(y),s(y)},h=(y,g=!0)=>{g&&a();const b=t.getBoundingClientRect(),f=y.map(m=>({target:m,rects:r(m,b)}));f.forEach(({target:m,rects:A})=>o.set(m.annotation,A));const u=f.flatMap(({rects:m})=>m);n.load(u)},p=(y,g,b=!1)=>{const f=n.search({minX:y,minY:g,maxX:y,maxY:g}),u=m=>m.annotation.rects.reduce((A,C)=>A+C.width*C.height,0);return f.length>0?(f.sort((m,A)=>u(m)-u(A)),b?f.map(m=>m.annotation.id):[f[0].annotation.id]):[]},v=y=>{const g=c(y);if(g.length===0)return;let b=g[0].left,f=g[0].top,u=g[0].right,m=g[0].bottom;for(let A=1;A<g.length;A++){const C=g[A];b=Math.min(b,C.left),f=Math.min(f,C.top),u=Math.max(u,C.right),m=Math.max(m,C.bottom)}return new DOMRect(b,f,u-b,m-f)},c=y=>{const g=o.get(y);return g?g[0].annotation.rects:[]};return{all:i,clear:a,getAt:p,getAnnotationBounds:v,getAnnotationRects:c,getIntersecting:(y,g,b,f)=>{const u=n.search({minX:y,minY:g,maxX:b,maxY:f}),m=new Set(u.map(A=>A.annotation.id));return Array.from(m).map(A=>({annotation:e.getAnnotation(A),rects:c(A)})).filter(A=>!!A.annotation)},insert:s,recalculate:()=>h(e.all().map(y=>y.target),!0),remove:l,set:h,size:()=>n.all().length,update:d}},Oo=(e,t)=>{const n=Qn(),o=Ro(n,e),r=Dn(n);r.setUserSelectAction(t);const i=$n(n),a=no(),s=(b,f=L.LOCAL)=>{const u=me(b,e),m=Y(u.target.selector);return m&&n.addAnnotation(u,f),m},l=(b,f=!0,u=L.LOCAL)=>{const m=b.map(C=>me(C,e)),A=m.filter(C=>!Y(C.target.selector));return A.length>0?(console.warn("Could not revive all targets for these annotations:",A),n.bulkAddAnnotation(m,f,u),A):(n.bulkAddAnnotation(m,f,u),[])},d=(b,f=L.LOCAL)=>{const u=b.map(A=>me(A,e)),m=u.filter(A=>!Y(A.target.selector));return m.length>0&&console.warn("Could not revive all targets for these annotations:",m),u.forEach(A=>{n.getAnnotation(A.id)?n.updateAnnotation(A,f):n.addAnnotation(A,f)}),m},h=(b,f=L.LOCAL)=>{const u=ue(b,e);n.updateTarget(u,f)},p=(b,f=L.LOCAL)=>{const u=b.map(m=>ue(m,e));n.bulkUpdateTargets(u,f)},v=(b,f,u)=>{const m=o.getAt(b,f,!!u).map(C=>n.getAnnotation(C)),A=u?m.filter(u):m;return A.length>0?A[0]:void 0},c=(b,f,u,m=5)=>{const A=o.getAnnotationRects(b);if(A.length!==0){if(f&&u){const C=A.find(({top:I,right:R,bottom:B,left:D})=>f>=D-m&&f<=R+m&&u>=I-m&&u<=B+m);if(C)return C}return o.getAnnotationBounds(b)}},y=b=>o.getAnnotationRects(b),g=()=>o.recalculate();return n.observe(({changes:b})=>{const f=(b.deleted||[]).filter(A=>Y(A.target.selector)),u=(b.created||[]).filter(A=>Y(A.target.selector)),m=(b.updated||[]).filter(A=>Y(A.newValue.target.selector));f?.length>0&&f.forEach(A=>o.remove(A.target)),u.length>0&&o.set(u.map(A=>A.target),!1),m?.length>0&&m.forEach(({newValue:A})=>o.update(A.target))}),{store:{...n,addAnnotation:s,bulkAddAnnotation:l,bulkUpdateTargets:p,bulkUpsertAnnotations:d,getAnnotationBounds:c,getAnnotationRects:y,getAt:v,getIntersecting:o.getIntersecting,recalculatePositions:g,updateTarget:h},selection:r,hover:i,viewport:a}},No=()=>{const e=document.createElement("canvas");e.width=2*window.innerWidth,e.height=2*window.innerHeight,e.className="r6o-presence-layer";const t=e.getContext("2d");return t.scale(2,2),t.translate(.5,.5),e},Mo=(e,t={})=>{const n=No(),o=n.getContext("2d");document.body.appendChild(n);const r=new Map,i=a=>Array.from(r.entries()).filter(([s,l])=>l.presenceKey===a.presenceKey).map(([s,l])=>s);return e.on("selectionChange",(a,s)=>{i(a).forEach(l=>r.delete(l)),s&&s.forEach(l=>r.set(l,a))}),{clear:()=>{const{width:a,height:s}=n;o.clearRect(-.5,-.5,a+1,s+1)},destroy:()=>{n.remove()},paint:(a,s,l)=>{t.font&&(o.font=t.font);const d=r.get(a.annotation.id);if(d){const{height:h}=a.rects[0],p=a.rects[0].x+s.left,v=a.rects[0].y+s.top;o.fillStyle=d.appearance.color,o.fillRect(p-2,v-2.5,2,h+5);const c=o.measureText(d.appearance.label),y=c.width+6,g=c.actualBoundingBoxAscent+c.actualBoundingBoxDescent+8,b=c.fontBoundingBoxAscent?8:6.5;return o.fillRect(p-2,v-2.5-g,y,g),o.fillStyle="#fff",o.fillText(d.appearance.label,p+1,v-b),{fill:d.appearance.color,fillOpacity:l?.45:.18}}},reset:()=>{n.width=2*window.innerWidth,n.height=2*window.innerHeight;const a=n.getContext("2d");a.scale(2,2),a.translate(.5,.5)}}},Io=(e,t,n,o)=>{let r;const i=f=>r=f;let a;const s=f=>a=f,{store:l,selection:d}=t;let h,p=!1,v;const c=f=>{var u;p&&((u=f.target.parentElement)!=null&&u.closest(P)?h=void 0:h={annotation:st(),selector:[],creator:r,created:new Date})},y=Ne(f=>{var u,m;const A=document.getSelection();if((m=(u=A.anchorNode)==null?void 0:u.parentElement)!=null&&m.closest(P)){h=void 0;return}if(f.timeStamp-(v?.timeStamp||f.timeStamp)<1e3&&!h&&c(v),A.isCollapsed||!p||!h)return;const C=A.getRangeAt(0),I=un(C,e);if(an(I))return;const R=tn(I.cloneRange());(R.length!==h.selector.length||R.some((B,D)=>{var w;return B.toString()!==((w=h.selector[D])==null?void 0:w.quote)}))&&(h={...h,selector:R.map(B=>cn(B,e,o)),updated:new Date},l.getAnnotation(h.annotation)?l.updateTarget(h,L.LOCAL):(d.clear(),l.addAnnotation({id:h.annotation,bodies:[],target:h}),d.userSelect(h.annotation,v)))}),g=f=>{const{target:u,timeStamp:m,offsetX:A,offsetY:C,type:I}=f;v={...f,target:u,timeStamp:m,offsetX:A,offsetY:C,type:I},p=f.button===0},b=f=>{var u;if((u=f.target.parentElement)!=null&&u.closest(P)||!p)return;const m=()=>{const{x:C,y:I}=e.getBoundingClientRect(),R=f.target instanceof Node&&e.contains(f.target)&&l.getAt(f.clientX-C,f.clientY-I,a);if(R){const{selected:B}=d;(B.length!==1||B[0].id!==R.id)&&d.userSelect(R.id,f)}else d.isEmpty()||d.clear()},A=f.timeStamp-v.timeStamp;setTimeout(()=>{const C=document.getSelection();C!=null&&C.isCollapsed&&A<300?(h=void 0,m()):h&&d.userSelect(h.annotation,f)})};return e.addEventListener("pointerdown",g),document.addEventListener("pointerup",b),n&&(e.addEventListener("selectstart",c),document.addEventListener("selectionchange",y)),{destroy:()=>{e.removeEventListener("pointerdown",g),document.removeEventListener("pointerup",b),e.removeEventListener("selectstart",c),document.removeEventListener("selectionchange",y)},setFilter:s,setUser:i}},Bo=(e,t)=>({...e,annotatingEnabled:e.annotatingEnabled??t.annotatingEnabled,user:e.user||t.user}),Ge="SPANS",ko=(e,t={})=>{nn(e);const n=Bo(t,{annotatingEnabled:!0,user:ho()}),o=Oo(e,n.userSelectAction),{selection:r,viewport:i}=o,a=o.store,s=to(a),l=oo(o,s,n.adapter);let d=n.user;const h=n.renderer==="CSS_HIGHLIGHTS"?CSS.highlights?"CSS_HIGHLIGHTS":Ge:n.renderer||Ge,p=h==="SPANS"?In(e,o,i):h==="CSS_HIGHLIGHTS"?On(e,o,i):h==="CANVAS"?yn(e,o,i):void 0;if(!p)throw`Unknown renderer implementation: ${h}`;console.debug(`Using ${h} renderer`),n.style&&p.setStyle(n.style);const v=Io(e,o,n.annotatingEnabled,n.offsetReferenceSelector);return v.setUser(d),{...io(o,s,n.adapter),destroy:()=>{p.destroy(),v.destroy(),s.destroy()},element:e,getUser:()=>d,setFilter:c=>{p.setFilter(c),v.setFilter(c)},setStyle:c=>p.setStyle(c),setUser:c=>{d=c,v.setUser(c)},setSelected:c=>{c?r.setSelected(c):r.clear()},setPresenceProvider:c=>{c&&(p.setPainter(Mo(c,n.presence)),c.on("selectionChange",()=>p.redraw()))},setVisible:c=>p.setVisible(c),on:l.on,off:l.off,scrollIntoView:hn(e,a),state:o}},Vo=e=>{const t=N.useRef(null),{className:n,children:o,...r}=e,{style:i,filter:a,user:s}=r,{anno:l,setAnno:d}=N.useContext(pt);return N.useEffect(()=>{if(!d)return;const h=typeof r.adapter=="function"?r.adapter(t.current):r.adapter,p=ko(t.current,{...r,adapter:h});return d(p),()=>p.destroy()},[d]),N.useEffect(()=>l?.setStyle(i),[l,i]),N.useEffect(()=>l?.setFilter(a),[l,a]),N.useEffect(()=>l?.setUser(s),[l,s]),kt.jsx("div",{ref:t,className:n,children:o})},Uo=()=>{const[e,t]=N.useState();return N.useEffect(()=>{fetch("../../thesaurus/narratives.json").then(n=>n.json()).then(n=>{const o=n.map(r=>r.prefLabel?.trim()).filter(Boolean);t(new Set(o))})},[]),e},_o=["#0fb5ae","#4046ca","#f68511","#de3d82","#7e84fa","#72e06a"],$o=e=>{const[t,n]=N.useState(),[o,r]=N.useState(!1),{refs:i,floatingStyles:a}=gt({placement:"bottom",open:o,onOpenChange:r,middleware:[yt(4),wt(),At(),xt({crossAxis:!0,padding:{top:5,bottom:5}})],whileElementsMounted:St});return N.useEffect(()=>{if(e.annotation){const s=e.annotation.target.selector,l=Array.isArray(s)?s[0].range:s.range;l&&!l.collapsed&&(i.setReference({getBoundingClientRect:()=>l.getBoundingClientRect(),getClientRects:()=>{const d=t?mt(l.getClientRects(),t):l.getClientRects()[0];return bt(d)}}),r(!0))}else r(!1)},[e.annotation,t]),N.useEffect(()=>{const s=l=>{const{clientX:d,clientY:h}=l;n({x:d,y:h})};return window.document.addEventListener("pointerup",s),()=>{window.document.removeEventListener("pointerup",s)}},[]),e.annotation&&o&&_.jsx("div",{className:"text-annotation-popup not-annotatable",ref:i.setFloating,style:a,children:_.jsx(vt,{type:"VERSE",annotation:e.annotation,relatedImages:e.relatedImages||[],relatedVerses:e.relatedVerses||[],onClickImages:e.onClickImages,onClickVerses:e.onClickVerses})})},Do=e=>({fill:"#000",fillOpacity:.05,underlineThickness:1.5,underlineColor:_o[e||0],underlineOffset:3*(e||0)+1}),jo=e=>({fill:"#ff5e5e",fillOpacity:.4,underlineThickness:2,underlineColor:"#e05252",underlineOffset:3*(e||0)+1}),Ho=e=>{const{searchResults:t,highlightedSearchResult:n}=e,o=Et(),r=Ct(),{images:i,verses:a}=Tt(r),s=Uo(),l=N.useCallback((d,h,p)=>{const c=d.bodies.find(y=>y.value&&s.has(y.value))?Do(p):jo(p);return t.length===0?c:new Set(t.map(g=>g.id)).has(d.id)?{...c,fill:"#fff800",underlineColor:"#caca2b"}:c},[s,t,n]);return N.useEffect(()=>{o&&(o.setAnnotations(e.annotations),console.log("anotations set"))},[o,e.annotations]),N.useEffect(()=>{e.highlightedSearchResult&&(o.setSelected(e.highlightedSearchResult.id),o.scrollIntoView(e.highlightedSearchResult))},[e.highlightedSearchResult]),N.useEffect(()=>{e.onSelect({annotation:r,relatedImages:i,relatedVerses:a})},[r,i,a]),s&&_.jsxs(Vo,{adapter:d=>mo("5db80aa5-8a27-4539-aeb3-bddf3abc0098",d),annotatingEnabled:!1,style:l,children:[_.jsx("div",{className:"annotated-text",children:e.verse}),_.jsx($o,{annotation:r,relatedImages:i,relatedVerses:a,onClickImages:e.onOpenRelatedImages,onClickVerses:e.onOpenRelatedVerses})]})},Fo=e=>{const[t,n]=N.useState(),o=Lt(`annotations/verse/${e.verse.slug}.json`),[r,i]=N.useState(),[a,s]=Be("diga.images.open",!1),[l,d]=Be("diga.verses.open",!1),[h,p]=N.useState([]),[v,c]=N.useState();N.useEffect(()=>{console.log("fetching verse"),fetch(`../../verses/${e.verse.slug}.txt`).then(g=>g.text()).then(n)},[]);const y=N.useCallback((g,b)=>{const f=g.target.selector[0].start,u=b.target.selector[0].start;return f-u},[]);return _.jsxs(Rt,{children:[_.jsx(Ot,{loaded:!!o}),_.jsx(Nt,{backToTab:"verses",isRelatedImagesOpen:a,isRelatedVersesOpen:l,searchSorter:y,onToggleRelatedImages:()=>s(g=>!g),onToggleRelatedVerses:()=>d(g=>!g),onClearSearch:()=>p([]),onHighlightSearchResult:g=>c(g),onSearch:p}),_.jsxs("div",{className:"flex-wrapper",children:[_.jsx("main",{children:_.jsxs("div",{className:"page",children:[_.jsx("h1",{children:e.verse.title}),t&&o&&_.jsx(Ho,{annotations:o,verse:t,searchResults:h,highlightedSearchResult:v,onSelect:i,onOpenRelatedImages:()=>s(!0),onOpenRelatedVerses:()=>d(!0)})]})}),_.jsx(Mt,{annotation:r?.annotation,currentSlug:e.verse.slug,open:l,related:r?.relatedVerses,onClose:()=>d(!1)}),_.jsx(It,{annotation:r?.annotation,currentSlug:e.verse.slug,open:a,related:r?.relatedImages,onClose:()=>s(!1)})]})]})};export{Fo as VerseView};

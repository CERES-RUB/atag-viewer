import{j as H}from"./createLucideIcon.DdhzAxAu.js";import{R as dn,r as V}from"./index.CfXgGp1H.js";import{i as un,u as fn,r as hn,t as pn,A as gn,o as mn,a as yn,f as bn,s as wn,c as vn,M as An,d as xn,e as En,k as Sn,l as ft,L as kn,n as Cn,P as On,R as Ln,p as Tn}from"./floating-ui.react.Cpq44MH-.js";var Bt={exports:{}},le={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var ht;function Rn(){if(ht)return le;ht=1;var e=dn,t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,r=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function s(a,l,c){var f,d={},p=null,h=null;c!==void 0&&(p=""+c),l.key!==void 0&&(p=""+l.key),l.ref!==void 0&&(h=l.ref);for(f in l)o.call(l,f)&&!i.hasOwnProperty(f)&&(d[f]=l[f]);if(a&&a.defaultProps)for(f in l=a.defaultProps,l)d[f]===void 0&&(d[f]=l[f]);return{$$typeof:t,type:a,key:p,ref:h,props:d,_owner:r.current}}return le.Fragment=n,le.jsx=s,le.jsxs=s,le}Bt.exports=Rn();var Mn=Bt.exports;const Nn={namespaces:{tei:"http://www.tei-c.org/ns/1.0",teieg:"http://www.tei-c.org/ns/Examples",rng:"http://relaxng.org/ns/structure/1.0"},tei:{eg:["<pre>","</pre>"],ptr:['<a href="$rw@target">$@target</a>'],ref:[["[target]",['<a href="$rw@target">',"</a>"]]],graphic:function(e){let t=new Image;return t.src=this.rw(e.getAttribute("url")),e.hasAttribute("width")&&t.setAttribute("width",e.getAttribute("width")),e.hasAttribute("height")&&t.setAttribute("height",e.getAttribute("height")),t},list:[["[type=gloss]",function(e){const t=e.ownerDocument;let n=t.createElement("dl");for(let o of Array.from(e.children))if(o.nodeType==1){if(o.localName=="tei-label"){let r=t.createElement("dt");r.innerHTML=o.innerHTML,n.appendChild(r)}if(o.localName=="tei-item"){let r=t.createElement("dd");r.innerHTML=o.innerHTML,n.appendChild(r)}}return n}]],note:[["[place=end]",function(e){const t=e.ownerDocument;this.noteIndex?this.noteIndex++:this.noteIndex=1;let n="_note_"+this.noteIndex,o=t.createElement("a");o.setAttribute("id","src"+n),o.setAttribute("href","#"+n),o.innerHTML=this.noteIndex;let r=t.createElement("sup");r.appendChild(o);let i=t.querySelector("ol.notes");i||(i=t.createElement("ol"),i.setAttribute("class","notes"),this.dom.appendChild(i));let s=t.createElement("li");return s.id=n,s.innerHTML=e.innerHTML,i.appendChild(s),r}],["_",["(",")"]]],teiHeader:function(e){this.hideContent(e,!1)},title:[["tei-titlestmt>tei-title",function(e){const t=e.ownerDocument;let n=t.createElement("title");n.innerHTML=e.innerText,t.querySelector("head").appendChild(n)}]]},teieg:{egXML:function(e){const t=e.ownerDocument;let n=t.createElement("pre"),o=t.createElement("code");n.appendChild(o);let r=this.serialize(e,!0).replace(/</g,"&lt;"),i=r.match(/^[\t ]+/);return i&&(r=r.replace(new RegExp("^"+i[0],"mg"),"")),o.innerHTML=r,n}}};function In(e,t){let n=1,o=e;for(;o&&o.previousElementSibling!==null&&(!t||o.previousElementSibling.localName==t)&&(n++,o=o.previousElementSibling,!!o.previousElementSibling););return n}function _t(e){const t=e.ownerDocument;let n=o=>{let r;switch(o.nodeType){case 1:r=t.createElement(o.nodeName);break;case 9:r=t.implementation.createDocument();break;case 11:r=t.createDocumentFragment();break;default:r=o.cloneNode(!0)}if(o.attributes)for(let i of Array.from(o.attributes))i.name!=="data-processed"&&r.setAttribute(i.name,i.value);for(let i of Array.from(o.childNodes))if(i.nodeType==1)if(i.hasAttribute("data-original")){for(let s of Array.from(i.childNodes)){let a=r.appendChild(n(s));a.nodeType===1&&a.hasAttribute("data-origid")&&(a.setAttribute("id",a.getAttribute("data-origid")),a.removeAttribute("data-origid"))}return r}else i.hasAttribute("data-origname")&&r.appendChild(n(i));else r.appendChild(i.cloneNode());return r};return n(e)}function jt(e){return e.replace(/ .*$/,"")}function Vt(e,t=!0){const n=e.ownerDocument;if(e.childNodes.length>0){let o=n.createElement("cetei-original");e.appendChild(o),o.setAttribute("hidden",""),o.setAttribute("data-original","");for(let r of Array.from(e.childNodes))if(r!==o){if(r.nodeType===1){r.setAttribute("data-processed","");for(let i of r.querySelectorAll("*"))i.setAttribute("data-processed","")}o.appendChild(e.removeChild(r))}if(t)for(let r of Array.from(o.querySelectorAll("*")))r.hasAttribute("id")&&(r.setAttribute("data-origid",r.getAttribute("id")),r.removeAttribute("id"))}}function Bn(e){return this.rw(this.first(e))}function _n(e,t){let n="";for(let o=0;o<t;o++)n+=e;return n}function jn(e){let t=this.prefixDefs[e.substring(0,e.indexOf(":"))];return e.replace(new RegExp(t.matchPattern),t.replacementPattern)}function Vn(e){return this.prefixDefs[e]}function $n(e){return e.match(/^(?:http|mailto|file|\/|#).*$/)?e:this.base+jt(e)}function Un(e,t,n){return Ie(_t(e),t,n)}function Ie(e,t,n){let o="";const r=i=>!/[^\t\n\r ]/.test(i);if((e.nodeType===9||e.nodeType===11)&&(o+=`<?xml version="1.0" encoding="UTF-8"?>
`),!t&&e.nodeType==1){typeof n=="string"&&n!==""?o+=`
`+n+"<":o+="<",o+=e.getAttribute("data-origname");let i=e.hasAttribute("data-origatts")?e.getAttribute("data-origatts").split(" "):[];for(let s of Array.from(e.attributes))!s.name.startsWith("data-")&&!["id","lang","class"].includes(s.name)&&(o+=" "+i.find(function(a){return a.toLowerCase()==s.name})+'="'+s.value+'"'),s.name=="data-xmlns"&&(o+=' xmlns="'+s.value+'"');e.childNodes.length>0?o+=">":o+="/>"}for(let i of Array.from(e.childNodes))switch(i.nodeType){case 1:typeof n=="string"?o+=Ie(i,!1,n+"  "):o+=Ie(i,!1,n);break;case 7:o+=`<?${i.nodeName} ${i.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;case 8:o+=`<!--${i.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;default:if(t&&r(i.nodeValue)&&(o+=i.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&r(i.nodeValue))break;o+=i.nodeValue}return!t&&e.nodeType==1&&e.childNodes.length>0&&(typeof n=="string"?o+=`
`+n+"</":o+="</",o+=e.getAttribute("data-origname")+">"),(e.nodeType===9||e.nodeType===11)&&(o+=`
`),o}function nt(e,t,n){const o=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];let r="";const i=s=>!/[^\t\n\r ]/.test(s);if(!t&&e.nodeType==1){typeof n=="string"&&n!==""?r+=`
`+n+"<":r+="<",r+=e.nodeName;for(let s of Array.from(e.attributes))r+=" "+s.name+'="'+s.value+'"';r+=">"}for(let s of Array.from(e.childNodes))switch(s.nodeType){case 1:typeof n=="string"?r+=nt(s,!1,n+"  "):r+=nt(s,!1,n);break;case 7:r+=`<?${s.nodeName} ${s.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;case 8:r+=`<!--${s.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;default:if(t&&i(s.nodeValue)&&(r+=s.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&i(s.nodeValue))break;r+=s.nodeValue.replace(/</g,"&lt;")}return o.includes(e.nodeName)||!t&&e.nodeType==1&&(typeof n=="string"?r+=`
${n}</`:r+="</",r+=`${e.nodeName}>`),(e.nodeType===9||e.nodeType===11)&&(r+=`
`),r}function Pn(e){return e.replace(/&gt;/,">").replace(/&quot;/,'"').replace(/&apos;/,"'").replace(/&amp;/,"&")}function Be(e){return e.includes(":"),e.replace(/:/,"-").toLowerCase()}function $t(e,t=null,n=!1){try{window.customElements.define(Be(e),class extends HTMLElement{constructor(){super(),this.matches(":defined")||t&&(t.call(this),this.setAttribute("data-processed",""))}connectedCallback(){this.hasAttribute("data-processed")||t&&(t.call(this),this.setAttribute("data-processed",""))}})}catch(o){n&&(console.log(Be(e)+" couldn't be registered or is already registered."),console.log(o))}}const Ve=Object.freeze(Object.defineProperty({__proto__:null,copyAndReset:_t,defineCustomElement:$t,first:jt,getOrdinality:In,getPrefixDef:Vn,hideContent:Vt,normalizeURI:Bn,repeat:_n,resetAndSerialize:Un,resolveURI:jn,rw:$n,serialize:Ie,serializeHTML:nt,tagName:Be,unEscapeEntities:Pn},Symbol.toStringTag,{value:"Module"}));function Dn(e){if(e.namespaces)for(let t of Object.keys(e.namespaces))!this.namespaces.has(e.namespaces[t])&&!Array.from(this.namespaces.values()).includes(t)&&this.namespaces.set(e.namespaces[t],t);for(let t of this.namespaces.values())if(e[t])for(let n of Object.keys(e[t]))this.behaviors[`${t}:${n}`]=e[t][n];if(e.functions)for(let t of Object.keys(e.functions))this.utilities[t]=e.functions[t].bind(this.utilities);e.handlers&&console.log("Behavior handlers are no longer used."),e.fallbacks&&console.log("Fallback behaviors are no longer used.")}function Kn(e,t,n){let o;if(e===Object(e))for(let r of Object.keys(e))this.namespaces.has(e[r])||(this.namespaces.set(e[r],r),o=r);else o=e;this.behaviors[`${o}:${t}`]=n}function Yn(e,t){let n;if(e===Object(e))for(let o of Object.keys(e))this.namespaces.has(e[o])||(this.namespaces.set(e[o],o),n=o);else n=e;delete this.behaviors[`${n}:${t}`]}function Hn(e,t){const n=e.documentElement;let o=1,r=function(s){return t.has(s.namespaceURI?s.namespaceURI:"")||t.set(s.namespaceURI,"ns"+o++),t.get(s.namespaceURI?s.namespaceURI:"")+":"+s.localName};const i=new Set(Array.from(n.querySelectorAll("*"),r));return i.add(r(n)),i}function Xn(e){return new Set(Array.from(e.querySelectorAll("*[data-origname]"),t=>t.localName.replace(/(\w+)-.+/,"$1:")+t.getAttribute("data-origname")))}class me{constructor(t){this.options=t||{},this.document=this.options.documentObject?this.options.documentObject:void 0,this.document===void 0&&(typeof window<"u"&&window.document?this.document=window.document:typeof global<"u"&&global.document&&(this.document=global.document)),this.addBehaviors=Dn.bind(this),this.addBehavior=Kn.bind(this),this.removeBehavior=Yn.bind(this),this.utilities={};for(const n of Object.keys(Ve))["getPrefixDef","rw","resolveURI"].includes(n)?this.utilities[n]=Ve[n].bind(this):this.utilities[n]=Ve[n];if(this.els=[],this.namespaces=new Map,this.behaviors={},this.hasStyle=!1,this.prefixDefs=[],this.debug=this.options.debug===!0,this.discardContent=this.options.discardContent===!0,this.options.base)this.base=this.options.base;else try{window&&(this.base=window.location.href.replace(/\/[^\/]*$/,"/"))}catch{this.base=""}this.options.omitDefaultBehaviors||this.addBehaviors(Nn),this.options.ignoreFragmentId&&window&&window.removeEventListener("ceteiceanload",me.restorePosition)}async getHTML5(t,n,o){window&&window.location.href.startsWith(this.base)&&t.indexOf("/")>=0&&(this.base=t.replace(/\/[^\/]*$/,"/"));try{const r=await fetch(t);if(r.ok){const i=await r.text();return this.makeHTML5(i,n,o)}else console.log(`Could not get XML file ${t}.
Server returned ${r.status}: ${r.statusText}`)}catch(r){console.log(r)}}makeHTML5(t,n,o){return this.XML_dom=new DOMParser().parseFromString(t,"text/xml"),this.domToHTML5(this.XML_dom,n,o)}preprocess(t,n,o){this.els=Hn(t,this.namespaces);let r=i=>{let s;if(this.namespaces.has(i.namespaceURI?i.namespaceURI:"")){let a=this.namespaces.get(i.namespaceURI?i.namespaceURI:"");s=this.document.createElement(`${a}-${i.localName.toLowerCase()}`)}else s=this.document.importNode(i,!1);for(let a of Array.from(i.attributes))a.name=="xmlns"?s.setAttribute("data-xmlns",a.value):s.setAttribute(a.name,a.value),a.name=="xml:id"&&s.setAttribute("id",a.value),a.name=="xml:lang"&&s.setAttribute("lang",a.value),a.name=="rendition"&&s.setAttribute("class",a.value.replace(/#/g,""));if(s.setAttribute("data-origname",i.localName),i.hasAttributes()&&s.setAttribute("data-origatts",i.getAttributeNames().join(" ")),i.childNodes.length==0&&s.setAttribute("data-empty",""),i.localName=="head"){let a=t.evaluate("count(ancestor::*[tei:head])",i,function(l){if(l=="tei")return"http://www.tei-c.org/ns/1.0"},1,null);s.setAttribute("data-level",a.numberValue)}if(i.localName=="tagsDecl"){let a=this.document.createElement("style");for(let l of Array.from(i.childNodes))if(l.nodeType==1&&l.localName=="rendition"&&l.getAttribute("scheme")=="css"){let c="";l.hasAttribute("selector")?(c+=l.getAttribute("selector").replace(/([^#, >]+\w*)/g,"tei-$1").replace(/#tei-/g,"#")+`{
`,c+=l.textContent):(c+="."+l.getAttribute("xml:id")+`{
`,c+=l.textContent),c+=`
}
`,a.appendChild(this.document.createTextNode(c))}a.childNodes.length>0&&(s.appendChild(a),this.hasStyle=!0)}i.localName=="prefixDef"&&(this.prefixDefs.push(i.getAttribute("ident")),this.prefixDefs[i.getAttribute("ident")]={matchPattern:i.getAttribute("matchPattern"),replacementPattern:i.getAttribute("replacementPattern")});for(let a of Array.from(i.childNodes))a.nodeType==1?s.appendChild(r(a)):s.appendChild(a.cloneNode());return o&&o(s,i),s};this.dom=this.document.createDocumentFragment();for(let i of Array.from(t.childNodes))i.nodeType==1&&this.dom.appendChild(r(i)),i.nodeType==7&&this.dom.appendChild(this.document.importNode(i,!0)),i.nodeType==8&&this.dom.appendChild(this.document.importNode(i,!0));if(this.utilities.dom=this.dom.firstElementChild,n)n(this.dom,this),window&&window.dispatchEvent(ce);else return typeof window<"u"&&window.dispatchEvent(ce),this.dom}domToHTML5(t,n,o){if(this.preprocess(t,null,o),this.applyBehaviors(),this.done=!0,n)n(this.dom,this),window&&window.dispatchEvent(ce);else return typeof window<"u"&&window.dispatchEvent(ce),this.dom}processPage(){this.els=Xn(this.document),this.applyBehaviors(),window&&window.dispatchEvent(ce)}unsetNamespace(t){this.namespaces.delete(t)}setBaseUrl(t){this.base=t}append(t,n){let o=this;if(n&&!n.hasAttribute("data-processed")){let r=t.call(o.utilities,n);r&&o.appendBasic(n,r)}else return function(){if(!this.hasAttribute("data-processed")){let r=t.call(o.utilities,this);r&&o.appendBasic(this,r)}}}appendBasic(t,n){this.discardContent?t.innerHTML="":Vt(t,!0),t.appendChild(n)}bName(t){return t.tagName.substring(0,t.tagName.indexOf("-")).toLowerCase()+":"+t.getAttribute("data-origname")}childExists(t,n){return t&&t.nodeName==n?!0:t&&t.nextElementSibling&&this.childExists(t.nextElementSibling,n)}decorator(t){if(Array.isArray(t)&&t.length==0)return function(o){};if(Array.isArray(t)&&!Array.isArray(t[0]))return this.applyDecorator(t);let n=this;return function(o){for(let r of t)if(o.matches(r[0])||r[0]==="_")return Array.isArray(r[1])?n.decorator(r[1]).call(this,o):r[1].call(this,o)}}applyDecorator(t){let n=this;return function(o){let r=[];for(let i=0;i<t.length;i++)r.push(n.template(t[i],o));return n.insert(o,r)}}getFallback(t,n){if(t[n])return t[n]instanceof Function?t[n]:this.decorator(t[n])}getHandler(t,n){if(t[n])return t[n]instanceof Function?this.append(t[n]):this.append(this.decorator(t[n]))}insert(t,n){let o=this.document.createElement("cetei-content");for(let r of Array.from(t.childNodes))r.nodeType===1&&!r.hasAttribute("data-processed")&&this.processElement(r);if(n[0].match("<[^>]+>")&&n[1]&&n[1].match("<[^>]+>"))o.innerHTML=n[0]+t.innerHTML+(n[1]?n[1]:"");else{o.innerHTML=n[0],o.setAttribute("data-before",n[0].replace(/<[^>]+>/g,"").length);for(let r of Array.from(t.childNodes))o.appendChild(r.cloneNode(!0));n.length>1&&(o.innerHTML+=n[1],o.setAttribute("data-after",n[1].replace(/<[^>]+>/g,"").length))}return o.childNodes.length<2?o.firstChild:o}processElement(t){if(t.hasAttribute("data-origname")&&!t.hasAttribute("data-processed")){let n=this.getFallback(this.bName(t));n&&(this.append(n,t),t.setAttribute("data-processed",""))}for(let n of Array.from(t.childNodes))n.nodeType===1&&this.processElement(n)}template(t,n){let o=t;if(t.search(/\$(\w*)(@([a-zA-Z:]+))/)){let r=/\$(\w*)@([a-zA-Z:]+)/g,i;for(;i=r.exec(t);)n.hasAttribute(i[2])?i[1]&&this.utilities[i[1]]?o=o.replace(i[0],this.utilities[i[1]](n.getAttribute(i[2]))):o=o.replace(i[0],n.getAttribute(i[2])):o=o.replace(i[0],"")}return o}applyBehaviors(){typeof window<"u"&&window.customElements?this.define.call(this,this.els):this.fallback.call(this,this.els)}define(t){for(let n of t){const o=this.getHandler(this.behaviors,n);$t(n,o,this.debug)}}fallback(t){for(let n of t){let o=this.getFallback(this.behaviors,n);if(o)for(let r of Array.from((this.dom&&!this.done?this.dom:this.document).querySelectorAll(Be(n))))r.hasAttribute("data-processed")||(this.append(o,r),r.setAttribute("data-processed",""))}}static savePosition(){window.sessionStorage.setItem(window.location+"-scroll",window.scrollY)}static restorePosition(){if(window.location.hash)setTimeout(function(){let t=this.document.querySelector(window.decodeURI(window.location.hash));t&&t.scrollIntoView()},100);else{let t;(t=window.sessionStorage.getItem(window.location+"-scroll"))&&(window.sessionStorage.removeItem(window.location+"-scroll"),setTimeout(function(){window.scrollTo(0,t)},100))}}}try{if(typeof window<"u"){window.CETEI=me,window.addEventListener("beforeunload",me.savePosition);var ce=new Event("ceteiceanload");window.addEventListener("ceteiceanload",me.restorePosition)}}catch(e){console.log(e)}/mac/i.test(navigator.userAgentData?navigator.userAgentData.platform:navigator.platform);const Fn=[];for(let e=0;e<256;++e)Fn.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const zn=[];for(let e=0;e<256;++e)zn.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const qn="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let Wn=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=qn[n[e]&63];return t};Wn();const $e=typeof navigator<"u"?navigator.userAgent.toLowerCase().indexOf("firefox")>0:!1;function Ue(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent&&e.attachEvent("on".concat(t),n)}function de(e,t,n,o){e.removeEventListener?e.removeEventListener(t,n,o):e.detachEvent&&e.detachEvent("on".concat(t),n)}function Ut(e,t){const n=t.slice(0,t.length-1);for(let o=0;o<n.length;o++)n[o]=e[n[o].toLowerCase()];return n}function Pt(e){typeof e!="string"&&(e=""),e=e.replace(/\s/g,"");const t=e.split(",");let n=t.lastIndexOf("");for(;n>=0;)t[n-1]+=",",t.splice(n,1),n=t.lastIndexOf("");return t}function Gn(e,t){const n=e.length>=t.length?e:t,o=e.length>=t.length?t:e;let r=!0;for(let i=0;i<n.length;i++)o.indexOf(n[i])===-1&&(r=!1);return r}const ve={backspace:8,"⌫":8,tab:9,clear:12,enter:13,"↩":13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,num_0:96,num_1:97,num_2:98,num_3:99,num_4:100,num_5:101,num_6:102,num_7:103,num_8:104,num_9:105,num_multiply:106,num_add:107,num_enter:108,num_subtract:109,num_decimal:110,num_divide:111,"⇪":20,",":188,".":190,"/":191,"`":192,"-":$e?173:189,"=":$e?61:187,";":$e?59:186,"'":222,"[":219,"]":221,"\\":220},W={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},ot={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},K={16:!1,18:!1,17:!1,91:!1},B={};for(let e=1;e<20;e++)ve["f".concat(e)]=111+e;let M=[],ye=null,Dt="all";const Q=new Map,Se=e=>ve[e.toLowerCase()]||W[e.toLowerCase()]||e.toUpperCase().charCodeAt(0),Jn=e=>Object.keys(ve).find(t=>ve[t]===e),Qn=e=>Object.keys(W).find(t=>W[t]===e);function Kt(e){Dt=e||"all"}function Ae(){return Dt||"all"}function Zn(){return M.slice(0)}function eo(){return M.map(e=>Jn(e)||Qn(e)||String.fromCharCode(e))}function to(){const e=[];return Object.keys(B).forEach(t=>{B[t].forEach(n=>{let{key:o,scope:r,mods:i,shortcut:s}=n;e.push({scope:r,shortcut:s,mods:i,keys:o.split("+").map(a=>Se(a))})})}),e}function no(e){const t=e.target||e.srcElement,{tagName:n}=t;let o=!0;const r=n==="INPUT"&&!["checkbox","radio","range","button","file","reset","submit","color"].includes(t.type);return(t.isContentEditable||(r||n==="TEXTAREA"||n==="SELECT")&&!t.readOnly)&&(o=!1),o}function oo(e){return typeof e=="string"&&(e=Se(e)),M.indexOf(e)!==-1}function ro(e,t){let n,o;e||(e=Ae());for(const r in B)if(Object.prototype.hasOwnProperty.call(B,r))for(n=B[r],o=0;o<n.length;)n[o].scope===e?n.splice(o,1).forEach(i=>{let{element:s}=i;return at(s)}):o++;Ae()===e&&Kt(t||"all")}function io(e){let t=e.keyCode||e.which||e.charCode;const n=M.indexOf(t);if(n>=0&&M.splice(n,1),e.key&&e.key.toLowerCase()==="meta"&&M.splice(0,M.length),(t===93||t===224)&&(t=91),t in K){K[t]=!1;for(const o in W)W[o]===t&&(te[o]=!1)}}function Yt(e){if(typeof e>"u")Object.keys(B).forEach(r=>{Array.isArray(B[r])&&B[r].forEach(i=>Ce(i)),delete B[r]}),at(null);else if(Array.isArray(e))e.forEach(r=>{r.key&&Ce(r)});else if(typeof e=="object")e.key&&Ce(e);else if(typeof e=="string"){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];let[r,i]=n;typeof r=="function"&&(i=r,r=""),Ce({key:e,scope:r,method:i,splitKey:"+"})}}const Ce=e=>{let{key:t,scope:n,method:o,splitKey:r="+"}=e;Pt(t).forEach(i=>{const s=i.split(r),a=s.length,l=s[a-1],c=l==="*"?"*":Se(l);if(!B[c])return;n||(n=Ae());const f=a>1?Ut(W,s):[],d=[];B[c]=B[c].filter(p=>{const h=(o?p.method===o:!0)&&p.scope===n&&Gn(p.mods,f);return h&&d.push(p.element),!h}),d.forEach(p=>at(p))})};function pt(e,t,n,o){if(t.element!==o)return;let r;if(t.scope===n||t.scope==="all"){r=t.mods.length>0;for(const i in K)Object.prototype.hasOwnProperty.call(K,i)&&(!K[i]&&t.mods.indexOf(+i)>-1||K[i]&&t.mods.indexOf(+i)===-1)&&(r=!1);(t.mods.length===0&&!K[16]&&!K[18]&&!K[17]&&!K[91]||r||t.shortcut==="*")&&(t.keys=[],t.keys=t.keys.concat(M),t.method(e,t)===!1&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0)))}}function gt(e,t){const n=B["*"];let o=e.keyCode||e.which||e.charCode;if(!te.filter.call(this,e))return;if((o===93||o===224)&&(o=91),M.indexOf(o)===-1&&o!==229&&M.push(o),["ctrlKey","altKey","shiftKey","metaKey"].forEach(a=>{const l=ot[a];e[a]&&M.indexOf(l)===-1?M.push(l):!e[a]&&M.indexOf(l)>-1?M.splice(M.indexOf(l),1):a==="metaKey"&&e[a]&&M.length===3&&(e.ctrlKey||e.shiftKey||e.altKey||(M=M.slice(M.indexOf(l))))}),o in K){K[o]=!0;for(const a in W)W[a]===o&&(te[a]=!0);if(!n)return}for(const a in K)Object.prototype.hasOwnProperty.call(K,a)&&(K[a]=e[ot[a]]);e.getModifierState&&!(e.altKey&&!e.ctrlKey)&&e.getModifierState("AltGraph")&&(M.indexOf(17)===-1&&M.push(17),M.indexOf(18)===-1&&M.push(18),K[17]=!0,K[18]=!0);const r=Ae();if(n)for(let a=0;a<n.length;a++)n[a].scope===r&&(e.type==="keydown"&&n[a].keydown||e.type==="keyup"&&n[a].keyup)&&pt(e,n[a],r,t);if(!(o in B))return;const i=B[o],s=i.length;for(let a=0;a<s;a++)if((e.type==="keydown"&&i[a].keydown||e.type==="keyup"&&i[a].keyup)&&i[a].key){const l=i[a],{splitKey:c}=l,f=l.key.split(c),d=[];for(let p=0;p<f.length;p++)d.push(Se(f[p]));d.sort().join("")===M.sort().join("")&&pt(e,l,r,t)}}function te(e,t,n){M=[];const o=Pt(e);let r=[],i="all",s=document,a=0,l=!1,c=!0,f="+",d=!1,p=!1;for(n===void 0&&typeof t=="function"&&(n=t),Object.prototype.toString.call(t)==="[object Object]"&&(t.scope&&(i=t.scope),t.element&&(s=t.element),t.keyup&&(l=t.keyup),t.keydown!==void 0&&(c=t.keydown),t.capture!==void 0&&(d=t.capture),typeof t.splitKey=="string"&&(f=t.splitKey),t.single===!0&&(p=!0)),typeof t=="string"&&(i=t),p&&Yt(e,i);a<o.length;a++)e=o[a].split(f),r=[],e.length>1&&(r=Ut(W,e)),e=e[e.length-1],e=e==="*"?"*":Se(e),e in B||(B[e]=[]),B[e].push({keyup:l,keydown:c,scope:i,mods:r,shortcut:o[a],method:n,key:o[a],splitKey:f,element:s});if(typeof s<"u"&&window){if(!Q.has(s)){const h=function(){let g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;return gt(g,s)},y=function(){let g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;gt(g,s),io(g)};Q.set(s,{keydownListener:h,keyupListenr:y,capture:d}),Ue(s,"keydown",h,d),Ue(s,"keyup",y,d)}if(!ye){const h=()=>{M=[]};ye={listener:h,capture:d},Ue(window,"focus",h,d)}}}function so(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"all";Object.keys(B).forEach(n=>{B[n].filter(o=>o.scope===t&&o.shortcut===e).forEach(o=>{o&&o.method&&o.method()})})}function at(e){const t=Object.values(B).flat();if(t.findIndex(n=>{let{element:o}=n;return o===e})<0){const{keydownListener:n,keyupListenr:o,capture:r}=Q.get(e)||{};n&&o&&(de(e,"keyup",o,r),de(e,"keydown",n,r),Q.delete(e))}if((t.length<=0||Q.size<=0)&&(Object.keys(Q).forEach(n=>{const{keydownListener:o,keyupListenr:r,capture:i}=Q.get(n)||{};o&&r&&(de(n,"keyup",r,i),de(n,"keydown",o,i),Q.delete(n))}),Q.clear(),Object.keys(B).forEach(n=>delete B[n]),ye)){const{listener:n,capture:o}=ye;de(window,"focus",n,o),ye=null}}const Pe={getPressedKeyString:eo,setScope:Kt,getScope:Ae,deleteScope:ro,getPressedKeyCodes:Zn,getAllKeyCodes:to,isPressed:oo,filter:no,trigger:so,unbind:Yt,keyMap:ve,modifier:W,modifierMap:ot};for(const e in Pe)Object.prototype.hasOwnProperty.call(Pe,e)&&(te[e]=Pe[e]);if(typeof window<"u"){const e=window.hotkeys;te.noConflict=t=>(t&&window.hotkeys===te&&(window.hotkeys=e),te),window.hotkeys=te}const Ht="not-annotatable",ae=`.${Ht}`,he=e=>{var t;return!!(e instanceof HTMLElement?e.closest(ae):(t=e.parentElement)!=null&&t.closest(ae))},ao=e=>{const t=e.commonAncestorContainer;return!he(t)},lo=e=>e.addEventListener("click",t=>{!t.target.closest(ae)&&!t.target.closest("a")&&t.preventDefault()}),De=e=>({...e,type:e.type,x:e.x,y:e.y,clientX:e.clientX,clientY:e.clientY,offsetX:e.offsetX,offsetY:e.offsetY,screenX:e.screenX,screenY:e.screenY,isPrimary:e.isPrimary,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,button:e.button,buttons:e.buttons,currentTarget:e.currentTarget,target:e.target,defaultPrevented:e.defaultPrevented,detail:e.detail,eventPhase:e.eventPhase,pointerId:e.pointerId,pointerType:e.pointerType,timeStamp:e.timeStamp}),Oe=e=>({...e,type:e.type,key:e.key,code:e.code,location:e.location,repeat:e.repeat,altKey:e.altKey,ctrlKey:e.ctrlKey,metaKey:e.metaKey,shiftKey:e.shiftKey,currentTarget:e.currentTarget,target:e.target,defaultPrevented:e.defaultPrevented,detail:e.detail,timeStamp:e.timeStamp}),co=/mac/i.test(navigator.userAgentData?navigator.userAgentData.platform:navigator.platform),uo=e=>{!e.hasAttribute("tabindex")&&e.tabIndex<0&&e.setAttribute("tabindex","-1"),e.classList.add("no-focus-outline")},lt=(e,t=10)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(void 0,o),t)}},fo=function*(e){const t=document.createNodeIterator(e.commonAncestorContainer,NodeFilter.SHOW_ELEMENT,o=>o instanceof HTMLElement&&o.classList.contains(Ht)&&!o.parentElement.closest(ae)&&e.intersectsNode(o)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);let n;for(;n=t.nextNode();)n instanceof HTMLElement&&(yield n)},ho=e=>{if(!ao(e))return[];const t=[];let n=null;for(const o of fo(e)){let r;n?(r=document.createRange(),r.setStartAfter(n),r.setEndBefore(o)):(r=e.cloneRange(),r.setEndBefore(o)),r.collapsed||t.push(r),n=o}if(n){const o=e.cloneRange();o.setStartAfter(n),o.collapsed||t.push(o)}return t.length>0?t:[e]},rt=e=>{const t=e.cloneContents();return t.querySelectorAll(ae).forEach(n=>n.remove()),t},po=(e,t,n=10,o)=>{const r=t,i=document.createRange();i.setStart(r,0),i.setEnd(e.startContainer,e.startOffset);const s=rt(i).textContent,a=document.createRange();a.setStart(e.endContainer,e.endOffset),r===document.body?a.setEnd(r,r.childNodes.length):a.setEndAfter(r);const l=rt(a).textContent;return{prefix:s.substring(s.length-n),suffix:l.substring(0,n)}},ee=e=>e.every(t=>t.range instanceof Range&&!t.range.collapsed),go=/^\s*$/,mo=e=>go.test(e.toString()),yo=(e,t)=>{const n=i=>Math.round(i*10)/10,o={top:n(e.top),bottom:n(e.bottom),left:n(e.left),right:n(e.right)},r={top:n(t.top),bottom:n(t.bottom),left:n(t.left),right:n(t.right)};if(Math.abs(o.top-r.top)<.5&&Math.abs(o.bottom-r.bottom)<.5){if(Math.abs(o.left-r.right)<.5||Math.abs(o.right-r.left)<.5)return"inline-adjacent";if(o.left>=r.left&&o.right<=r.right)return"inline-is-contained";if(o.left<=r.left&&o.right>=r.right)return"inline-contains"}else if(o.top<=r.top&&o.bottom>=r.bottom){if(o.left<=r.left&&o.right>=r.right)return"block-contains"}else if(o.top>=r.top&&o.bottom<=r.bottom&&o.left>=r.left&&o.right<=r.right)return"block-is-contained"},bo=(e,t)=>{const n=Math.min(e.left,t.left),o=Math.max(e.right,t.right),r=Math.min(e.top,t.top),i=Math.max(e.bottom,t.bottom);return new DOMRect(n,r,o-n,i-r)},wo=e=>e.reduce((t,n)=>{if(n.width===0||n.height===0)return t;let o=[...t],r=!1;for(const i of t){const s=yo(n,i);if(s==="inline-adjacent"){o=o.map(a=>a===i?bo(n,i):a),r=!0;break}else if(s==="inline-contains"){o=o.map(a=>a===i?n:a),r=!0;break}else if(s==="inline-is-contained"){r=!0;break}else if(s==="block-contains"||s==="block-is-contained"){n.width<i.width&&(o=o.map(a=>a===i?n:a)),r=!0;break}}return r?o:[...o,n]},[]),vo=(e,t,n)=>{const o=document.createRange(),r=n?e.startContainer.parentElement.closest(n):t;o.setStart(r,0),o.setEnd(e.startContainer,e.startOffset);const i=rt(o).textContent,s=e.toString(),a=i.length||0,l=a+s.length;return n?{quote:s,start:a,end:l,range:e,offsetReference:r}:{quote:s,start:a,end:l,range:e}},Xt=(e,t)=>{var n,o;const{start:r,end:i}=e,s=e.offsetReference||t,a=document.createNodeIterator(t,NodeFilter.SHOW_TEXT,p=>{var h;return(h=p.parentElement)!=null&&h.closest(ae)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let l=0;const c=document.createRange();let f=a.nextNode();f===null&&console.error("Could not revive annotation target. Content missing.");let d=!s;for(;f!==null;){if(d||(d=s?.contains(f)),d){const p=((n=f.textContent)==null?void 0:n.length)||0;if(l+p>r){c.setStart(f,r-l);break}l+=p}f=a.nextNode()}for(;f!==null;){const p=((o=f.textContent)==null?void 0:o.length)||0;if(l+p>=i){c.setEnd(f,i-l);break}l+=p,f=a.nextNode()}return{...e,range:c}},_e=(e,t)=>ee(e.selector)?e:{...e,selector:e.selector.map(n=>n.range instanceof Range&&!n.range.collapsed?n:Xt(n,t))},Ke=(e,t)=>ee(e.target.selector)?e:{...e,target:_e(e.target,t)},Ao=(e,t)=>{const n=e.cloneRange();return t.contains(n.startContainer)||n.setStart(t,0),t.contains(n.endContainer)||n.setEnd(t,t.childNodes.length),n},Ft=e=>{if(e===null)return document.scrollingElement;const{overflowY:t}=window.getComputedStyle(e);return t!=="visible"&&t!=="hidden"&&e.scrollHeight>e.clientHeight?e:Ft(e.parentElement)},xo=(e,t)=>n=>{const o=typeof n=="string"?n:n.id,r=s=>{const a=i.getBoundingClientRect(),l=i.clientHeight,c=i.clientWidth,f=s.selector[0].range.getBoundingClientRect(),{width:d,height:p}=t.getAnnotationBounds(o),h=f.top-a.top,y=f.left-a.left,g=i.parentElement?i.scrollTop:0,w=i.parentElement?i.scrollLeft:0,m=h+g-(l-p)/2,u=y+w-(c-d)/2;i.scroll({top:m,left:u,behavior:"smooth"})},i=Ft(e);if(i){const s=t.getAnnotation(o),{range:a}=s.target.selector[0];if(a&&!a.collapsed)return r(s.target),!0;{const l=_e(s.target,e),{range:c}=l.selector[0];if(c&&!c.collapsed)return r(l),!0}}return!1},ne={fill:"rgb(0, 128, 255)",fillOpacity:.18},je={fill:"rgb(0, 128, 255)",fillOpacity:.45},Eo=(e,t,n,o,r)=>{var i,s;const a=n?typeof n=="function"?n(e.annotation,e.state,r)||((i=e.state)!=null&&i.selected?je:ne):n:(s=e.state)!=null&&s.selected?je:ne;return o&&o.paint(e,t)||a},So=e=>{const{top:t,left:n}=e.getBoundingClientRect(),{innerWidth:o,innerHeight:r}=window,i=-n,s=-t,a=o-n,l=r-t;return{top:t,left:n,minX:i,minY:s,maxX:a,maxY:l}},ko=e=>{let t=new Set;return n=>{const o=n.map(r=>r.id);(t.size!==o.length||o.some(r=>!t.has(r)))&&e.set(o),t=new Set(o)}},ct=(e,t,n,o)=>{const{store:r,selection:i,hover:s}=t;let a,l,c;const f=ko(n),d=j=>{const{x:C,y:I}=e.getBoundingClientRect(),v=r.getAt(j.clientX-C,j.clientY-I,!1,l);v?s.current!==v.id&&(e.classList.add("hovered"),s.set(v.id)):s.current&&(e.classList.remove("hovered"),s.set(null))};e.addEventListener("pointermove",d);const p=(j=!1)=>{c&&c.clear();const C=So(e),{minX:I,minY:v,maxX:x,maxY:A}=C,S=l?r.getIntersecting(I,v,x,A).filter(({annotation:R})=>l(R)):r.getIntersecting(I,v,x,A),L=i.selected.map(({id:R})=>R),O=S.map(({annotation:R,rects:q})=>{const ln=L.includes(R.id),cn=R.id===s.current;return{annotation:R,rects:q,state:{selected:ln,hover:cn}}});o.redraw(O,C,a,c,j),setTimeout(()=>f(S.map(({annotation:R})=>R)),1)},h=j=>{c=j,p()},y=j=>{a=j,p()},g=j=>{l=j,p(!1)},w=()=>p();r.observe(w);const m=i.subscribe(()=>p()),u=()=>p(!0);document.addEventListener("scroll",u,{capture:!0,passive:!0});const b=lt(()=>{r.recalculatePositions(),c&&c.reset(),p()});window.addEventListener("resize",b);const E=new ResizeObserver(b);E.observe(e);const k={attributes:!0,childList:!0,subtree:!0},$=new MutationObserver(j=>{j.every(C=>C.target===e||e.contains(C.target))||p(!0)});return $.observe(document.body,k),{destroy:()=>{e.removeEventListener("pointermove",d),o.destroy(),r.unobserve(w),m(),document.removeEventListener("scroll",u),window.removeEventListener("resize",b),E.disconnect(),$.disconnect()},redraw:p,setStyle:y,setFilter:g,setPainter:h,setVisible:o.setVisible}},Co=()=>{const e=document.createElement("canvas");return e.width=window.innerWidth,e.height=window.innerHeight,e.className="r6o-canvas-highlight-layer bg",e},Oo=(e,t)=>{e.width=window.innerWidth,e.height=window.innerHeight},Lo=e=>{e.classList.add("r6o-annotatable");const t=Co(),n=t.getContext("2d");document.body.appendChild(t);const o=(i,s,a,l)=>requestAnimationFrame(()=>{const{width:c,height:f}=t;n.clearRect(-.5,-.5,c+1,f+1),l&&l.clear();const{top:d,left:p}=s;[...i].sort((h,y)=>{const{annotation:{target:{created:g}}}=h,{annotation:{target:{created:w}}}=y;return g.getTime()-w.getTime()}).forEach(h=>{var y;const g=a?typeof a=="function"?a(h.annotation,h.state):a:(y=h.state)!=null&&y.selected?je:ne,w=l&&l.paint(h,s)||g,m=h.rects.map(({x:u,y:b,width:E,height:k})=>({x:u+p,y:b+d,width:E,height:k}));if(n.fillStyle=w.fill,n.globalAlpha=w.fillOpacity||1,m.forEach(({x:u,y:b,width:E,height:k})=>n.fillRect(u,b,E,k)),w.underlineColor){n.globalAlpha=1,n.strokeStyle=w.underlineColor,n.lineWidth=w.underlineThickness??1;const u=w.underlineOffset??0;m.forEach(({x:b,y:E,width:k,height:$})=>{n.beginPath(),n.moveTo(b,E+$+u),n.lineTo(b+k,E+$+u),n.stroke()})}})}),r=lt(()=>{Oo(t)});return window.addEventListener("resize",r),{destroy:()=>{t.remove(),window.removeEventListener("resize",r)},setVisible:i=>{console.log("setVisible not implemented on Canvas renderer")},redraw:o}},To=(e,t,n)=>ct(e,t,n,Lo(e));var Ro={grad:.9,turn:360,rad:360/(2*Math.PI)},J=function(e){return typeof e=="string"?e.length>0:typeof e=="number"},U=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=Math.pow(10,t)),Math.round(n*e)/n+0},X=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=1),e>n?n:e>t?e:t},zt=function(e){return(e=isFinite(e)?e%360:0)>0?e:e+360},mt=function(e){return{r:X(e.r,0,255),g:X(e.g,0,255),b:X(e.b,0,255),a:X(e.a)}},Ye=function(e){return{r:U(e.r),g:U(e.g),b:U(e.b),a:U(e.a,3)}},Mo=/^#([0-9a-f]{3,8})$/i,Le=function(e){var t=e.toString(16);return t.length<2?"0"+t:t},qt=function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=Math.max(t,n,o),s=i-Math.min(t,n,o),a=s?i===t?(n-o)/s:i===n?2+(o-t)/s:4+(t-n)/s:0;return{h:60*(a<0?a+6:a),s:i?s/i*100:0,v:i/255*100,a:r}},Wt=function(e){var t=e.h,n=e.s,o=e.v,r=e.a;t=t/360*6,n/=100,o/=100;var i=Math.floor(t),s=o*(1-n),a=o*(1-(t-i)*n),l=o*(1-(1-t+i)*n),c=i%6;return{r:255*[o,a,s,s,l,o][c],g:255*[l,o,o,a,s,s][c],b:255*[s,s,l,o,o,a][c],a:r}},yt=function(e){return{h:zt(e.h),s:X(e.s,0,100),l:X(e.l,0,100),a:X(e.a)}},bt=function(e){return{h:U(e.h),s:U(e.s),l:U(e.l),a:U(e.a,3)}},wt=function(e){return Wt((n=(t=e).s,{h:t.h,s:(n*=((o=t.l)<50?o:100-o)/100)>0?2*n/(o+n)*100:0,v:o+n,a:t.a}));var t,n,o},be=function(e){return{h:(t=qt(e)).h,s:(r=(200-(n=t.s))*(o=t.v)/100)>0&&r<200?n*o/100/(r<=100?r:200-r)*100:0,l:r/2,a:t.a};var t,n,o,r},No=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Io=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,Bo=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,_o=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,vt={string:[[function(e){var t=Mo.exec(e);return t?(e=t[1]).length<=4?{r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:e.length===4?U(parseInt(e[3]+e[3],16)/255,2):1}:e.length===6||e.length===8?{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:e.length===8?U(parseInt(e.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(e){var t=Bo.exec(e)||_o.exec(e);return t?t[2]!==t[4]||t[4]!==t[6]?null:mt({r:Number(t[1])/(t[2]?100/255:1),g:Number(t[3])/(t[4]?100/255:1),b:Number(t[5])/(t[6]?100/255:1),a:t[7]===void 0?1:Number(t[7])/(t[8]?100:1)}):null},"rgb"],[function(e){var t=No.exec(e)||Io.exec(e);if(!t)return null;var n,o,r=yt({h:(n=t[1],o=t[2],o===void 0&&(o="deg"),Number(n)*(Ro[o]||1)),s:Number(t[3]),l:Number(t[4]),a:t[5]===void 0?1:Number(t[5])/(t[6]?100:1)});return wt(r)},"hsl"]],object:[[function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=r===void 0?1:r;return J(t)&&J(n)&&J(o)?mt({r:Number(t),g:Number(n),b:Number(o),a:Number(i)}):null},"rgb"],[function(e){var t=e.h,n=e.s,o=e.l,r=e.a,i=r===void 0?1:r;if(!J(t)||!J(n)||!J(o))return null;var s=yt({h:Number(t),s:Number(n),l:Number(o),a:Number(i)});return wt(s)},"hsl"],[function(e){var t=e.h,n=e.s,o=e.v,r=e.a,i=r===void 0?1:r;if(!J(t)||!J(n)||!J(o))return null;var s=function(a){return{h:zt(a.h),s:X(a.s,0,100),v:X(a.v,0,100),a:X(a.a)}}({h:Number(t),s:Number(n),v:Number(o),a:Number(i)});return Wt(s)},"hsv"]]},At=function(e,t){for(var n=0;n<t.length;n++){var o=t[n][0](e);if(o)return[o,t[n][1]]}return[null,void 0]},jo=function(e){return typeof e=="string"?At(e.trim(),vt.string):typeof e=="object"&&e!==null?At(e,vt.object):[null,void 0]},He=function(e,t){var n=be(e);return{h:n.h,s:X(n.s+100*t,0,100),l:n.l,a:n.a}},Xe=function(e){return(299*e.r+587*e.g+114*e.b)/1e3/255},xt=function(e,t){var n=be(e);return{h:n.h,s:n.s,l:X(n.l+100*t,0,100),a:n.a}},Et=function(){function e(t){this.parsed=jo(t)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return e.prototype.isValid=function(){return this.parsed!==null},e.prototype.brightness=function(){return U(Xe(this.rgba),2)},e.prototype.isDark=function(){return Xe(this.rgba)<.5},e.prototype.isLight=function(){return Xe(this.rgba)>=.5},e.prototype.toHex=function(){return t=Ye(this.rgba),n=t.r,o=t.g,r=t.b,s=(i=t.a)<1?Le(U(255*i)):"","#"+Le(n)+Le(o)+Le(r)+s;var t,n,o,r,i,s},e.prototype.toRgb=function(){return Ye(this.rgba)},e.prototype.toRgbString=function(){return t=Ye(this.rgba),n=t.r,o=t.g,r=t.b,(i=t.a)<1?"rgba("+n+", "+o+", "+r+", "+i+")":"rgb("+n+", "+o+", "+r+")";var t,n,o,r,i},e.prototype.toHsl=function(){return bt(be(this.rgba))},e.prototype.toHslString=function(){return t=bt(be(this.rgba)),n=t.h,o=t.s,r=t.l,(i=t.a)<1?"hsla("+n+", "+o+"%, "+r+"%, "+i+")":"hsl("+n+", "+o+"%, "+r+"%)";var t,n,o,r,i},e.prototype.toHsv=function(){return t=qt(this.rgba),{h:U(t.h),s:U(t.s),v:U(t.v),a:U(t.a,3)};var t},e.prototype.invert=function(){return z({r:255-(t=this.rgba).r,g:255-t.g,b:255-t.b,a:t.a});var t},e.prototype.saturate=function(t){return t===void 0&&(t=.1),z(He(this.rgba,t))},e.prototype.desaturate=function(t){return t===void 0&&(t=.1),z(He(this.rgba,-t))},e.prototype.grayscale=function(){return z(He(this.rgba,-1))},e.prototype.lighten=function(t){return t===void 0&&(t=.1),z(xt(this.rgba,t))},e.prototype.darken=function(t){return t===void 0&&(t=.1),z(xt(this.rgba,-t))},e.prototype.rotate=function(t){return t===void 0&&(t=15),this.hue(this.hue()+t)},e.prototype.alpha=function(t){return typeof t=="number"?z({r:(n=this.rgba).r,g:n.g,b:n.b,a:t}):U(this.rgba.a,3);var n},e.prototype.hue=function(t){var n=be(this.rgba);return typeof t=="number"?z({h:t,s:n.s,l:n.l,a:n.a}):U(n.h)},e.prototype.isEqual=function(t){return this.toHex()===z(t).toHex()},e}(),z=function(e){return e instanceof Et?e:new Et(e)};const Vo=e=>[`background-color:${z(e?.fill||ne.fill).alpha(e?.fillOpacity===void 0?ne.fillOpacity:e.fillOpacity).toHex()}`,e!=null&&e.underlineThickness?"text-decoration:underline":void 0,e!=null&&e.underlineColor?`text-decoration-color:${e.underlineColor}`:void 0,e!=null&&e.underlineOffset?`text-underline-offset:${e.underlineOffset}px`:void 0,e!=null&&e.underlineThickness?`text-decoration-thickness:${e.underlineThickness}px`:void 0].filter(Boolean).join(";"),$o=()=>{const e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e);let t=new Set;return{destroy:()=>{CSS.highlights.clear(),e.remove()},setVisible:n=>{console.log("setVisible not implemented on CSS Custom Highlights renderer")},redraw:(n,o,r,i)=>{i&&i.clear();const s=new Set(n.map(l=>l.annotation.id));Array.from(t).filter(l=>!s.has(l));const a=n.map(l=>{var c;const f=r?typeof r=="function"?r(l.annotation,l.state):r:(c=l.state)!=null&&c.selected?je:ne,d=i&&i.paint(l,o)||f;return`::highlight(_${l.annotation.id}) { ${Vo(d)} }`});e.innerHTML=a.join(`
`),CSS.highlights.clear(),n.forEach(({annotation:l})=>{const c=l.target.selector.map(d=>d.range),f=new Highlight(...c);CSS.highlights.set(`_${l.id}`,f)}),t=s}}},Uo=(e,t,n)=>ct(e,t,n,$o());var St=Object.prototype.hasOwnProperty;function it(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&it(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(St.call(e,n)&&++o&&!St.call(t,n)||!(n in t)||!it(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}const Po=(e,t)=>{const n=(i,s)=>i.x<=s.x+s.width&&i.x+i.width>=s.x&&i.y<=s.y+s.height&&i.y+i.height>=s.y,o=i=>i.rects.reduce((s,a)=>s+a.width,0),r=t.filter(({rects:i})=>i.some(s=>n(e,s)));return r.sort((i,s)=>o(s)-o(i)),r.findIndex(i=>i.rects.includes(e))},Do=e=>{e.classList.add("r6o-annotatable");const t=document.createElement("div");t.className="r6o-span-highlight-layer",e.insertBefore(t,e.firstChild);let n=[];return{destroy:()=>{t.remove()},redraw:(o,r,i,s,a)=>{const l=!(it(n,o)&&a);!s&&!l||(l&&(t.innerHTML=""),[...o].sort((c,f)=>{const{annotation:{target:{created:d}}}=c,{annotation:{target:{created:p}}}=f;return d&&p?d.getTime()-p.getTime():0}).forEach(c=>{c.rects.map(f=>{const d=Po(f,o),p=Eo(c,r,i,s,d);if(l){const h=document.createElement("span");h.className="r6o-annotation",h.dataset.annotation=c.annotation.id,h.style.left=`${f.x}px`,h.style.top=`${f.y}px`,h.style.width=`${f.width}px`,h.style.height=`${f.height}px`,h.style.backgroundColor=z(p?.fill||ne.fill).alpha(p?.fillOpacity===void 0?ne.fillOpacity:p.fillOpacity).toHex(),p.underlineStyle&&(h.style.borderStyle=p.underlineStyle),p.underlineColor&&(h.style.borderColor=p.underlineColor),p.underlineThickness&&(h.style.borderBottomWidth=`${p.underlineThickness}px`),p.underlineOffset&&(h.style.paddingBottom=`${p.underlineOffset}px`),t.appendChild(h)}})}),n=o)},setVisible:o=>{o?t.classList.remove("hidden"):t.classList.add("hidden")}}},Ko=(e,t,n)=>ct(e,t,n,Do(e)),P=[];for(let e=0;e<256;++e)P.push((e+256).toString(16).slice(1));function Yo(e,t=0){return(P[e[t+0]]+P[e[t+1]]+P[e[t+2]]+P[e[t+3]]+"-"+P[e[t+4]]+P[e[t+5]]+"-"+P[e[t+6]]+P[e[t+7]]+"-"+P[e[t+8]]+P[e[t+9]]+"-"+P[e[t+10]]+P[e[t+11]]+P[e[t+12]]+P[e[t+13]]+P[e[t+14]]+P[e[t+15]]).toLowerCase()}let Fe;const Ho=new Uint8Array(16);function Xo(){if(!Fe){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Fe=crypto.getRandomValues.bind(crypto)}return Fe(Ho)}const Fo=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),kt={randomUUID:Fo};function Gt(e,t,n){if(kt.randomUUID&&!t&&!e)return kt.randomUUID();e=e||{};const o=e.random||(e.rng||Xo)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Yo(o)}var Ct=Object.prototype.hasOwnProperty;function oe(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&oe(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(Ct.call(e,n)&&++o&&!Ct.call(t,n)||!(n in t)||!oe(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function ze(){}function zo(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const re=[];function dt(e,t=ze){let n;const o=new Set;function r(a){if(zo(e,a)&&(e=a,n)){const l=!re.length;for(const c of o)c[1](),re.push(c,e);if(l){for(let c=0;c<re.length;c+=2)re[c][0](re[c+1]);re.length=0}}}function i(a){r(a(e))}function s(a,l=ze){const c=[a,l];return o.add(c),o.size===1&&(n=t(r,i)||ze),a(e),()=>{o.delete(c),o.size===0&&n&&(n(),n=null)}}return{set:r,update:i,subscribe:s}}const qo=e=>{const{subscribe:t,set:n}=dt();let o;return t(r=>o=r),e.observe(({changes:r})=>{if(o){(r.deleted||[]).some(s=>s.id===o)&&n(void 0);const i=(r.updated||[]).find(({oldValue:s})=>s.id===o);i&&n(i.newValue.id)}}),{get current(){return o},subscribe:t,set:n}},Te={selected:[]},Wo=(e,t,n)=>{const{subscribe:o,set:r}=dt(Te);let i=t,s=Te;o(y=>s=y);const a=()=>{oe(s,Te)||r(Te)},l=()=>{var y;return((y=s.selected)==null?void 0:y.length)===0},c=y=>{if(l())return!1;const g=typeof y=="string"?y:y.id;return s.selected.some(w=>w.id===g)},f=(y,g)=>{let w;if(Array.isArray(y)){if(w=y.map(u=>e.getAnnotation(u)).filter(Boolean),w.length<y.length){console.warn("Invalid selection: "+y.filter(u=>!w.some(b=>b.id===u)));return}}else{const u=e.getAnnotation(y);if(!u){console.warn("Invalid selection: "+y);return}w=[u]}const m=w.reduce((u,b)=>{const E=Ot(b,i);return E==="EDIT"?[...u,{id:b.id,editable:!0}]:E==="SELECT"?[...u,{id:b.id}]:u},[]);r({selected:m,event:g})},d=(y,g)=>{const w=Array.isArray(y)?y:[y],m=w.map(u=>e.getAnnotation(u)).filter(u=>!!u);r({selected:m.map(u=>{const b=g===void 0?Ot(u,i)==="EDIT":g;return{id:u.id,editable:b}})}),m.length!==w.length&&console.warn("Invalid selection",y)},p=y=>{if(l())return!1;const{selected:g}=s;g.some(({id:w})=>y.includes(w))&&r({selected:g.filter(({id:w})=>!y.includes(w))})},h=y=>i=y;return e.observe(({changes:y})=>p((y.deleted||[]).map(g=>g.id))),{get event(){return s?s.event:null},get selected(){return s?[...s.selected]:null},get userSelectAction(){return i},clear:a,isEmpty:l,isSelected:c,setSelected:d,setUserSelectAction:h,subscribe:o,userSelect:f}},Ot=(e,t,n)=>typeof t=="function"?t(e):t||"EDIT",D=[];for(let e=0;e<256;++e)D.push((e+256).toString(16).slice(1));function Go(e,t=0){return(D[e[t+0]]+D[e[t+1]]+D[e[t+2]]+D[e[t+3]]+"-"+D[e[t+4]]+D[e[t+5]]+"-"+D[e[t+6]]+D[e[t+7]]+"-"+D[e[t+8]]+D[e[t+9]]+"-"+D[e[t+10]]+D[e[t+11]]+D[e[t+12]]+D[e[t+13]]+D[e[t+14]]+D[e[t+15]]).toLowerCase()}let qe;const Jo=new Uint8Array(16);function Qo(){if(!qe){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");qe=crypto.getRandomValues.bind(crypto)}return qe(Jo)}const Zo=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Lt={randomUUID:Zo};function er(e,t,n){if(Lt.randomUUID&&!t&&!e)return Lt.randomUUID();e=e||{};const o=e.random||(e.rng||Qo)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Go(o)}const We=e=>{const t=n=>{const o={...n};return n.created&&typeof n.created=="string"&&(o.created=new Date(n.created)),n.updated&&typeof n.updated=="string"&&(o.updated=new Date(n.updated)),o};return{...e,bodies:(e.bodies||[]).map(t),target:t(e.target)}},tr=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},nr=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},or=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(r=>r.id===n.id);return{newBody:n,oldBody:o&&!oe(o,n)?o:void 0}}).filter(({oldBody:n})=>n).map(({oldBody:n,newBody:o})=>({oldBody:n,newBody:o})),rr=(e,t)=>!oe(e.target,t.target),Jt=(e,t)=>{const n=tr(e,t),o=nr(e,t),r=or(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:r.length>0?r:void 0,targetUpdated:rr(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var T=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e.SILENT="SILENT",e))(T||{});const ir=(e,t)=>{var n,o;const{changes:r,origin:i}=t;if(!(e.options.origin?e.options.origin===i:i!=="SILENT"))return!1;if(e.options.ignore){const{ignore:s}=e.options,a=l=>l&&l.length>0;if(!(a(r.created)||a(r.deleted))){const l=(n=r.updated)==null?void 0:n.some(f=>a(f.bodiesCreated)||a(f.bodiesDeleted)||a(f.bodiesUpdated)),c=(o=r.updated)==null?void 0:o.some(f=>f.targetUpdated);if(s==="BODY_ONLY"&&l&&!c||s==="TARGET_ONLY"&&c&&!l)return!1}}if(e.options.annotations){const s=new Set([...(r.created||[]).map(a=>a.id),...(r.deleted||[]).map(a=>a.id),...(r.updated||[]).map(({oldValue:a})=>a.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(a=>s.has(a))}else return!0},sr=(e,t)=>{const n=new Set((e.created||[]).map(d=>d.id)),o=new Set((e.updated||[]).map(({newValue:d})=>d.id)),r=new Set((t.created||[]).map(d=>d.id)),i=new Set((t.deleted||[]).map(d=>d.id)),s=new Set((t.updated||[]).map(({oldValue:d})=>d.id)),a=new Set((t.updated||[]).filter(({oldValue:d})=>n.has(d.id)||o.has(d.id)).map(({oldValue:d})=>d.id)),l=[...(e.created||[]).filter(d=>!i.has(d.id)).map(d=>s.has(d.id)?t.updated.find(({oldValue:p})=>p.id===d.id).newValue:d),...t.created||[]],c=[...(e.deleted||[]).filter(d=>!r.has(d.id)),...(t.deleted||[]).filter(d=>!n.has(d.id))],f=[...(e.updated||[]).filter(({newValue:d})=>!i.has(d.id)).map(d=>{const{oldValue:p,newValue:h}=d;if(s.has(h.id)){const y=t.updated.find(g=>g.oldValue.id===h.id).newValue;return Jt(p,y)}else return d}),...(t.updated||[]).filter(({oldValue:d})=>!a.has(d.id))];return{created:l,deleted:c,updated:f}},Ge=e=>{const t=e.id===void 0?er():e.id;return{...e,id:t,bodies:e.bodies===void 0?[]:e.bodies.map(n=>({...n,annotation:t})),target:{...e.target,annotation:t}}},ar=e=>e.id!==void 0,lr=()=>{const e=new Map,t=new Map,n=[],o=(v,x={})=>{n.push({onChange:v,options:x})},r=v=>{const x=n.findIndex(A=>A.onChange==v);x>-1&&n.splice(x,1)},i=(v,x)=>{const A={origin:v,changes:{created:x.created||[],updated:x.updated||[],deleted:x.deleted||[]},state:[...e.values()]};n.forEach(S=>{ir(S,A)&&S.onChange(A)})},s=(v,x=T.LOCAL)=>{if(v.id&&e.get(v.id))throw Error(`Cannot add annotation ${v.id} - exists already`);{const A=Ge(v);e.set(A.id,A),A.bodies.forEach(S=>t.set(S.id,A.id)),i(x,{created:[A]})}},a=(v,x)=>{const A=Ge(typeof v=="string"?x:v),S=typeof v=="string"?v:v.id,L=S&&e.get(S);if(L){const O=Jt(L,A);return S===A.id?e.set(S,A):(e.delete(S),e.set(A.id,A)),L.bodies.forEach(R=>t.delete(R.id)),A.bodies.forEach(R=>t.set(R.id,A.id)),O}else console.warn(`Cannot update annotation ${S} - does not exist`)},l=(v,x=T.LOCAL,A=T.LOCAL)=>{const S=ar(x)?A:x,L=a(v,x);L&&i(S,{updated:[L]})},c=(v,x=T.LOCAL)=>{const A=v.reduce((S,L)=>{const O=a(L);return O?[...S,O]:S},[]);A.length>0&&i(x,{updated:A})},f=(v,x=T.LOCAL)=>{const A=e.get(v.annotation);if(A){const S={...A,bodies:[...A.bodies,v]};e.set(A.id,S),t.set(v.id,S.id),i(x,{updated:[{oldValue:A,newValue:S,bodiesCreated:[v]}]})}else console.warn(`Attempt to add body to missing annotation: ${v.annotation}`)},d=()=>[...e.values()],p=(v=T.LOCAL)=>{const x=[...e.values()];e.clear(),t.clear(),i(v,{deleted:x})},h=(v,x=!0,A=T.LOCAL)=>{const S=v.map(Ge);if(x){const L=[...e.values()];e.clear(),t.clear(),S.forEach(O=>{e.set(O.id,O),O.bodies.forEach(R=>t.set(R.id,O.id))}),i(A,{created:S,deleted:L})}else{const L=v.reduce((O,R)=>{const q=R.id&&e.get(R.id);return q?[...O,q]:O},[]);if(L.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${L.map(O=>O.id).join(", ")}`);S.forEach(O=>{e.set(O.id,O),O.bodies.forEach(R=>t.set(R.id,O.id))}),i(A,{created:S})}},y=v=>{const x=typeof v=="string"?v:v.id,A=e.get(x);if(A)return e.delete(x),A.bodies.forEach(S=>t.delete(S.id)),A;console.warn(`Attempt to delete missing annotation: ${x}`)},g=(v,x=T.LOCAL)=>{const A=y(v);A&&i(x,{deleted:[A]})},w=(v,x=T.LOCAL)=>{const A=v.reduce((S,L)=>{const O=y(L);return O?[...S,O]:S},[]);A.length>0&&i(x,{deleted:A})},m=v=>{const x=e.get(v.annotation);if(x){const A=x.bodies.find(S=>S.id===v.id);if(A){t.delete(A.id);const S={...x,bodies:x.bodies.filter(L=>L.id!==v.id)};return e.set(x.id,S),{oldValue:x,newValue:S,bodiesDeleted:[A]}}else console.warn(`Attempt to delete missing body ${v.id} from annotation ${v.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${v.annotation}`)},u=(v,x=T.LOCAL)=>{const A=m(v);A&&i(x,{updated:[A]})},b=(v,x=T.LOCAL)=>{const A=v.map(S=>m(S)).filter(Boolean);A.length>0&&i(x,{updated:A})},E=v=>{const x=e.get(v);return x?{...x}:void 0},k=v=>{const x=t.get(v);if(x){const A=E(x).bodies.find(S=>S.id===v);if(A)return A;console.error(`Store integrity error: body ${v} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${v}`)},$=(v,x)=>{if(v.annotation!==x.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const A=e.get(v.annotation);if(A){const S=A.bodies.find(O=>O.id===v.id),L={...A,bodies:A.bodies.map(O=>O.id===S.id?x:O)};return e.set(A.id,L),S.id!==x.id&&(t.delete(S.id),t.set(x.id,L.id)),{oldValue:A,newValue:L,bodiesUpdated:[{oldBody:S,newBody:x}]}}else console.warn(`Attempt to add body to missing annotation ${v.annotation}`)},j=(v,x,A=T.LOCAL)=>{const S=$(v,x);S&&i(A,{updated:[S]})},C=(v,x=T.LOCAL)=>{const A=v.map(S=>$({id:S.id,annotation:S.annotation},S)).filter(Boolean);i(x,{updated:A})},I=v=>{const x=e.get(v.annotation);if(x){const A={...x,target:{...x.target,...v}};return e.set(x.id,A),{oldValue:x,newValue:A,targetUpdated:{oldTarget:x.target,newTarget:v}}}else console.warn(`Attempt to update target on missing annotation: ${v.annotation}`)};return{addAnnotation:s,addBody:f,all:d,bulkAddAnnotation:h,bulkDeleteAnnotation:w,bulkDeleteBodies:b,bulkUpdateAnnotation:c,bulkUpdateBodies:C,bulkUpdateTargets:(v,x=T.LOCAL)=>{const A=v.map(S=>I(S)).filter(Boolean);A.length>0&&i(x,{updated:A})},clear:p,deleteAnnotation:g,deleteBody:u,getAnnotation:E,getBody:k,observe:o,unobserve:r,updateAnnotation:l,updateBody:j,updateTarget:(v,x=T.LOCAL)=>{const A=I(v);A&&i(x,{updated:[A]})}}};let cr=()=>({emit(e,...t){for(let n=this.events[e]||[],o=0,r=n.length;o<r;o++)n[o](...t)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(r=>t!==r)}}});const dr=250,ur=e=>{const t=cr(),n=[];let o=-1,r=!1,i=0;const s=h=>{if(!r){const{changes:y}=h,g=performance.now();if(g-i>dr)n.splice(o+1),n.push(y),o=n.length-1;else{const w=n.length-1;n[w]=sr(n[w],y)}i=g}r=!1};e.observe(s,{origin:T.LOCAL});const a=h=>h&&h.length>0&&e.bulkDeleteAnnotation(h),l=h=>h&&h.length>0&&e.bulkAddAnnotation(h,!1),c=h=>h&&h.length>0&&e.bulkUpdateAnnotation(h.map(({oldValue:y})=>y)),f=h=>h&&h.length>0&&e.bulkUpdateAnnotation(h.map(({newValue:y})=>y)),d=h=>h&&h.length>0&&e.bulkAddAnnotation(h,!1),p=h=>h&&h.length>0&&e.bulkDeleteAnnotation(h);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(s),on:(h,y)=>t.on(h,y),redo:()=>{if(n.length-1>o){r=!0;const{created:h,updated:y,deleted:g}=n[o+1];l(h),f(y),p(g),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){r=!0;const{created:h,updated:y,deleted:g}=n[o];a(h),c(y),d(g),t.emit("undo",n[o]),o-=1}}}},fr=()=>{const{subscribe:e,set:t}=dt([]);return{subscribe:e,set:t}},hr=(e,t,n,o)=>{const{hover:r,selection:i,store:s,viewport:a}=e,l=new Map;let c=[],f;const d=(g,w)=>{l.has(g)?l.get(g).push(w):l.set(g,[w])},p=(g,w)=>{const m=l.get(g);if(m){const u=m.indexOf(w);u!==-1&&m.splice(u,1)}},h=(g,w,m)=>{l.has(g)&&setTimeout(()=>{l.get(g).forEach(u=>{if(n){const b=Array.isArray(w)?w.map(k=>n.serialize(k)):n.serialize(w),E=m?m instanceof PointerEvent?m:n.serialize(m):void 0;u(b,E)}else u(w,m)})},1)};i.subscribe(({selected:g})=>{if(!(c.length===0&&g.length===0)){if(c.length===0&&g.length>0)c=g.map(({id:w})=>s.getAnnotation(w));else if(c.length>0&&g.length===0)c.forEach(w=>{const m=s.getAnnotation(w.id);m&&!oe(m,w)&&h("updateAnnotation",m,w)}),c=[];else{const w=new Set(c.map(u=>u.id)),m=new Set(g.map(({id:u})=>u));c.filter(u=>!m.has(u.id)).forEach(u=>{const b=s.getAnnotation(u.id);b&&!oe(b,u)&&h("updateAnnotation",b,u)}),c=[...c.filter(u=>m.has(u.id)),...g.filter(({id:u})=>!w.has(u)).map(({id:u})=>s.getAnnotation(u))]}h("selectionChanged",c)}}),r.subscribe(g=>{!f&&g?h("mouseEnterAnnotation",s.getAnnotation(g)):f&&!g?h("mouseLeaveAnnotation",s.getAnnotation(f)):f&&g&&(h("mouseLeaveAnnotation",s.getAnnotation(f)),h("mouseEnterAnnotation",s.getAnnotation(g))),f=g}),a?.subscribe(g=>h("viewportIntersect",g.map(w=>s.getAnnotation(w)))),s.observe(g=>{const{created:w,deleted:m}=g.changes;(w||[]).forEach(u=>h("createAnnotation",u)),(m||[]).forEach(u=>h("deleteAnnotation",u)),(g.changes.updated||[]).filter(u=>[...u.bodiesCreated||[],...u.bodiesDeleted||[],...u.bodiesUpdated||[]].length>0).forEach(({oldValue:u,newValue:b})=>{const E=c.find(k=>k.id===u.id)||u;c=c.map(k=>k.id===u.id?b:k),h("updateAnnotation",b,E)})},{origin:T.LOCAL}),s.observe(g=>{if(c){const w=new Set(c.map(u=>u.id)),m=(g.changes.updated||[]).filter(({newValue:u})=>w.has(u.id)).map(({newValue:u})=>u);m.length>0&&(c=c.map(u=>m.find(b=>b.id===u.id)||u))}},{origin:T.REMOTE});const y=g=>w=>{const{updated:m}=w;g?(m||[]).forEach(u=>h("updateAnnotation",u.oldValue,u.newValue)):(m||[]).forEach(u=>h("updateAnnotation",u.newValue,u.oldValue))};return t.on("undo",y(!0)),t.on("redo",y(!1)),{on:d,off:p,emit:h}},pr=e=>t=>t.reduce((n,o)=>{const{parsed:r,error:i}=e.parse(o);return i?{parsed:n.parsed,failed:[...n.failed,o]}:r?{parsed:[...n.parsed,r],failed:n.failed}:{...n}},{parsed:[],failed:[]}),gr=(e,t,n)=>{const{store:o,selection:r}=e,i=m=>{if(n){const{parsed:u,error:b}=n.parse(m);u?o.addAnnotation(u,T.REMOTE):console.error(b)}else o.addAnnotation(We(m),T.REMOTE)},s=()=>r.clear(),a=()=>o.clear(),l=m=>{const u=o.getAnnotation(m);return n&&u?n.serialize(u):u},c=()=>n?o.all().map(n.serialize):o.all(),f=()=>{var m;const u=(((m=r.selected)==null?void 0:m.map(b=>b.id))||[]).map(b=>o.getAnnotation(b)).filter(Boolean);return n?u.map(n.serialize):u},d=(m,u=!0)=>fetch(m).then(b=>b.json()).then(b=>(h(b,u),b)),p=m=>{if(typeof m=="string"){const u=o.getAnnotation(m);if(o.deleteAnnotation(m),u)return n?n.serialize(u):u}else{const u=n?n.parse(m).parsed:m;if(u)return o.deleteAnnotation(u),m}},h=(m,u=!0)=>{if(n){const b=n.parseAll||pr(n),{parsed:E,failed:k}=b(m);k.length>0&&console.warn(`Discarded ${k.length} invalid annotations`,k),o.bulkAddAnnotation(E,u,T.REMOTE)}else o.bulkAddAnnotation(m.map(We),u,T.REMOTE)},y=(m,u)=>{m?r.setSelected(m,u):r.clear()},g=m=>{r.clear(),r.setUserSelectAction(m)},w=m=>{if(n){const u=n.parse(m).parsed,b=n.serialize(o.getAnnotation(u.id));return o.updateAnnotation(u),b}else{const u=o.getAnnotation(m.id);return o.updateAnnotation(We(m)),u}};return{addAnnotation:i,cancelSelected:s,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:c,getSelected:f,loadAnnotations:d,redo:t.redo,removeAnnotation:p,setAnnotations:h,setSelected:y,setUserSelectAction:g,undo:t.undo,updateAnnotation:w}},mr="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let yr=e=>crypto.getRandomValues(new Uint8Array(e)),br=(e,t,n)=>{let o=(2<<Math.log2(e.length-1))-1,r=-~(1.6*o*t/e.length);return(i=t)=>{let s="";for(;;){let a=n(r),l=r;for(;l--;)if(s+=e[a[l]&o]||"",s.length===i)return s}}},wr=(e,t=21)=>br(e,t,yr),vr=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=mr[n[e]&63];return t};const Ar=()=>({isGuest:!0,id:wr("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),xr=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,r=t.length;o<r;o++){let i=t.charCodeAt(o);n=(n<<5)-n+i,n|=0}return`${n}`},Qt=e=>e?typeof e=="object"?{...e}:e:void 0,Er=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:r,purpose:i,value:s,created:a,modified:l,creator:c,...f}=n;return{id:o||`temp-${xr(n)}`,annotation:t,type:r,purpose:i,value:s,creator:Qt(c),created:a?new Date(a):void 0,updated:l?new Date(l):void 0,...f}}),Sr=e=>e.map(t=>{var n;const{annotation:o,created:r,updated:i,...s}=t,a={...s,created:r?.toISOString(),modified:i?.toISOString()};return(n=a.id)!=null&&n.startsWith("temp-")&&delete a.id,a});vr();const kr=(e,t)=>({parse:n=>Lr(n),serialize:n=>Tr(n,e,t)}),Cr=e=>e.quote!==void 0&&e.start!==void 0&&e.end!==void 0,Or=e=>{const{id:t,creator:n,created:o,modified:r,target:i}=e,s=Array.isArray(i)?i:[i];if(s.length===0)return{error:Error(`No targets found for annotation: ${e.id}`)};const a={creator:Qt(n),created:o?new Date(o):void 0,updated:r?new Date(r):void 0,annotation:t,selector:[],styleClass:"styleClass"in s[0]?s[0].styleClass:void 0};for(const l of s){const c=(Array.isArray(l.selector)?l.selector:[l.selector]).reduce((f,d)=>{switch(d.type){case"TextQuoteSelector":f.quote=d.exact;break;case"TextPositionSelector":f.start=d.start,f.end=d.end;break}return f},{});if(Cr(c))a.selector.push({...c,id:l.id,scope:l.scope});else{const f=[c.start?void 0:"TextPositionSelector",c.quote?void 0:"TextQuoteSelector"].filter(Boolean);return{error:Error(`Missing selector types: ${f.join(" and ")} for annotation: ${e.id}`)}}}return{parsed:a}},Lr=e=>{const t=e.id||Gt(),{creator:n,created:o,modified:r,body:i,...s}=e,a=Er(i,t),l=Or(e);return"error"in l?{error:l.error}:{parsed:{...s,id:t,bodies:a,target:l.parsed}}},Tr=(e,t,n)=>{const{bodies:o,target:r,...i}=e,{selector:s,creator:a,created:l,updated:c,...f}=r,d=s.map(p=>{const{id:h,quote:y,start:g,end:w,range:m}=p,{prefix:u,suffix:b}=po(m,n),E=[{type:"TextQuoteSelector",exact:y,prefix:u,suffix:b},{type:"TextPositionSelector",start:g,end:w}];return{...f,id:h,scope:"scope"in p?p.scope:void 0,source:t,selector:E}});return{...i,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:Sr(e.bodies),creator:a,created:l?.toISOString(),modified:c?.toISOString(),target:d}};function Zt(e,t,n=0,o=e.length-1,r=Rr){for(;o>n;){if(o-n>600){const l=o-n+1,c=t-n+1,f=Math.log(l),d=.5*Math.exp(2*f/3),p=.5*Math.sqrt(f*d*(l-d)/l)*(c-l/2<0?-1:1),h=Math.max(n,Math.floor(t-c*d/l+p)),y=Math.min(o,Math.floor(t+(l-c)*d/l+p));Zt(e,t,h,y,r)}const i=e[t];let s=n,a=o;for(ue(e,n,t),r(e[o],i)>0&&ue(e,n,o);s<a;){for(ue(e,s,a),s++,a--;r(e[s],i)<0;)s++;for(;r(e[a],i)>0;)a--}r(e[n],i)===0?ue(e,n,a):(a++,ue(e,a,o)),a<=t&&(n=a+1),t<=a&&(o=a-1)}}function ue(e,t,n){const o=e[t];e[t]=e[n],e[n]=o}function Rr(e,t){return e<t?-1:e>t?1:0}class Mr{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!Me(t,n))return o;const r=this.toBBox,i=[];for(;n;){for(let s=0;s<n.children.length;s++){const a=n.children[s],l=n.leaf?r(a):a;Me(t,l)&&(n.leaf?o.push(a):Qe(t,l)?this._all(a,o):i.push(a))}n=i.pop()}return o}collides(t){let n=this.data;if(!Me(t,n))return!1;const o=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],s=n.leaf?this.toBBox(i):i;if(Me(t,s)){if(n.leaf||Qe(t,s))return!0;o.push(i)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=se([]),this}remove(t,n){if(!t)return this;let o=this.data;const r=this.toBBox(t),i=[],s=[];let a,l,c;for(;o||i.length;){if(o||(o=i.pop(),l=i[i.length-1],a=s.pop(),c=!0),o.leaf){const f=Nr(t,o.children,n);if(f!==-1)return o.children.splice(f,1),i.push(o),this._condense(i),this}!c&&!o.leaf&&Qe(o,r)?(i.push(o),s.push(a),a=0,l=o,o=o.children[0]):l?(a++,o=l.children[a],c=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,r){const i=o-n+1;let s=this._maxEntries,a;if(i<=s)return a=se(t.slice(n,o+1)),ie(a,this.toBBox),a;r||(r=Math.ceil(Math.log(i)/Math.log(s)),s=Math.ceil(i/Math.pow(s,r-1))),a=se([]),a.leaf=!1,a.height=r;const l=Math.ceil(i/s),c=l*Math.ceil(Math.sqrt(s));Tt(t,n,o,c,this.compareMinX);for(let f=n;f<=o;f+=c){const d=Math.min(f+c-1,o);Tt(t,f,d,l,this.compareMinY);for(let p=f;p<=d;p+=l){const h=Math.min(p+l-1,d);a.children.push(this._build(t,p,h,r-1))}}return ie(a,this.toBBox),a}_chooseSubtree(t,n,o,r){for(;r.push(n),!(n.leaf||r.length-1===o);){let i=1/0,s=1/0,a;for(let l=0;l<n.children.length;l++){const c=n.children[l],f=Je(c),d=_r(t,c)-f;d<s?(s=d,i=f<i?f:i,a=c):d===s&&f<i&&(i=f,a=c)}n=a||n.children[0]}return n}_insert(t,n,o){const r=o?t:this.toBBox(t),i=[],s=this._chooseSubtree(r,this.data,n,i);for(s.children.push(t),ge(s,r);n>=0&&i[n].children.length>this._maxEntries;)this._split(i,n),n--;this._adjustParentBBoxes(r,i,n)}_split(t,n){const o=t[n],r=o.children.length,i=this._minEntries;this._chooseSplitAxis(o,i,r);const s=this._chooseSplitIndex(o,i,r),a=se(o.children.splice(s,o.children.length-s));a.height=o.height,a.leaf=o.leaf,ie(o,this.toBBox),ie(a,this.toBBox),n?t[n-1].children.push(a):this._splitRoot(o,a)}_splitRoot(t,n){this.data=se([t,n]),this.data.height=t.height+1,this.data.leaf=!1,ie(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let r,i=1/0,s=1/0;for(let a=n;a<=o-n;a++){const l=pe(t,0,a,this.toBBox),c=pe(t,a,o,this.toBBox),f=jr(l,c),d=Je(l)+Je(c);f<i?(i=f,r=a,s=d<s?d:s):f===i&&d<s&&(s=d,r=a)}return r||o-n}_chooseSplitAxis(t,n,o){const r=t.leaf?this.compareMinX:Ir,i=t.leaf?this.compareMinY:Br,s=this._allDistMargin(t,n,o,r),a=this._allDistMargin(t,n,o,i);s<a&&t.children.sort(r)}_allDistMargin(t,n,o,r){t.children.sort(r);const i=this.toBBox,s=pe(t,0,n,i),a=pe(t,o-n,o,i);let l=Re(s)+Re(a);for(let c=n;c<o-n;c++){const f=t.children[c];ge(s,t.leaf?i(f):f),l+=Re(s)}for(let c=o-n-1;c>=n;c--){const f=t.children[c];ge(a,t.leaf?i(f):f),l+=Re(a)}return l}_adjustParentBBoxes(t,n,o){for(let r=o;r>=0;r--)ge(n[r],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():ie(t[n],this.toBBox)}}function Nr(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function ie(e,t){pe(e,0,e.children.length,t,e)}function pe(e,t,n,o,r){r||(r=se(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let i=t;i<n;i++){const s=e.children[i];ge(r,e.leaf?o(s):s)}return r}function ge(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function Ir(e,t){return e.minX-t.minX}function Br(e,t){return e.minY-t.minY}function Je(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function Re(e){return e.maxX-e.minX+(e.maxY-e.minY)}function _r(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function jr(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),r=Math.min(e.maxX,t.maxX),i=Math.min(e.maxY,t.maxY);return Math.max(0,r-n)*Math.max(0,i-o)}function Qe(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function Me(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function se(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Tt(e,t,n,o,r){const i=[t,n];for(;i.length;){if(n=i.pop(),t=i.pop(),n-t<=o)continue;const s=t+Math.ceil((n-t)/o/2)*o;Zt(e,s,t,n,r),i.push(t,s,s,n)}}const Vr=(e,t)=>{const n=new Mr,o=new Map,r=(y,g)=>{const w=y.selector.flatMap(u=>{const b=ee([u])?u.range:Xt(u,t).range;return Array.from(b.getClientRects())}),m=wo(w).map(({left:u,top:b,right:E,bottom:k})=>new DOMRect(u-g.left,b-g.top,E-u,k-b));return m.map(u=>{const{x:b,y:E,width:k,height:$}=u;return{minX:b,minY:E,maxX:b+k,maxY:E+$,annotation:{id:y.annotation,rects:m}}})},i=()=>[...o.values()],s=()=>{n.clear(),o.clear()},a=y=>{const g=r(y,t.getBoundingClientRect());g.length!==0&&(g.forEach(w=>n.insert(w)),o.set(y.annotation,g))},l=y=>{const g=o.get(y.annotation);g&&(g.forEach(w=>n.remove(w)),o.delete(y.annotation))},c=y=>{l(y),a(y)},f=(y,g=!0)=>{g&&s();const w=t.getBoundingClientRect(),m=y.map(b=>({target:b,rects:r(b,w)}));m.forEach(({target:b,rects:E})=>{E.length>0&&o.set(b.annotation,E)});const u=m.flatMap(({rects:b})=>b);n.load(u)},d=(y,g,w=!1)=>{const m=n.search({minX:y,minY:g,maxX:y,maxY:g}),u=b=>b.annotation.rects.reduce((E,k)=>E+k.width*k.height,0);return m.length>0?(m.sort((b,E)=>u(b)-u(E)),w?m.map(b=>b.annotation.id):[m[0].annotation.id]):[]},p=y=>{const g=h(y);if(g.length===0)return;let w=g[0].left,m=g[0].top,u=g[0].right,b=g[0].bottom;for(let E=1;E<g.length;E++){const k=g[E];w=Math.min(w,k.left),m=Math.min(m,k.top),u=Math.max(u,k.right),b=Math.max(b,k.bottom)}return new DOMRect(w,m,u-w,b-m)},h=y=>{const g=o.get(y);return g?g[0].annotation.rects:[]};return{all:i,clear:s,getAt:d,getAnnotationBounds:p,getAnnotationRects:h,getIntersecting:(y,g,w,m)=>{const u=n.search({minX:y,minY:g,maxX:w,maxY:m}),b=new Set(u.map(E=>E.annotation.id));return Array.from(b).map(E=>({annotation:e.getAnnotation(E),rects:h(E)})).filter(E=>!!E.annotation)},insert:a,recalculate:()=>f(e.all().map(y=>y.target),!0),remove:l,set:f,size:()=>n.all().length,update:c}},$r=(e,t)=>{const n=lr(),o=Vr(n,e),r=Wo(n);r.setUserSelectAction(t);const i=qo(n),s=fr(),a=(m,u=T.LOCAL)=>{const b=Ke(m,e),E=ee(b.target.selector);return E&&n.addAnnotation(b,u),E},l=(m,u=!0,b=T.LOCAL)=>{const E=m.map($=>Ke($,e)),k=E.filter($=>!ee($.target.selector));return n.bulkAddAnnotation(E,u,b),k},c=(m,u=T.LOCAL)=>{const b=m.map(k=>Ke(k,e)),E=b.filter(k=>!ee(k.target.selector));return b.forEach(k=>{n.getAnnotation(k.id)?n.updateAnnotation(k,u):n.addAnnotation(k,u)}),E},f=(m,u=T.LOCAL)=>{const b=_e(m,e);n.updateTarget(b,u)},d=(m,u=T.LOCAL)=>{const b=m.map(E=>_e(E,e));n.bulkUpdateTargets(b,u)};function p(m,u,b,E){const k=b||!!E,$=o.getAt(m,u,k).map(C=>n.getAnnotation(C)),j=E?$.filter(E):$;if(j.length!==0)return b?j:j[0]}const h=m=>{if(o.getAnnotationRects(m).length!==0)return o.getAnnotationBounds(m)},y=(m,u,b,E)=>o.getIntersecting(m,u,b,E),g=m=>o.getAnnotationRects(m),w=()=>o.recalculate();return n.observe(({changes:m})=>{const u=(m.deleted||[]).filter(k=>ee(k.target.selector)),b=(m.created||[]).filter(k=>ee(k.target.selector)),E=(m.updated||[]).filter(k=>ee(k.newValue.target.selector));u?.length>0&&u.forEach(k=>o.remove(k.target)),b.length>0&&o.set(b.map(k=>k.target),!1),E?.length>0&&E.forEach(({newValue:k})=>o.update(k.target))}),{store:{...n,addAnnotation:a,bulkAddAnnotation:l,bulkUpdateTargets:d,bulkUpsertAnnotations:c,getAnnotationBounds:h,getAnnotationRects:g,getIntersecting:y,getAt:p,recalculatePositions:w,updateTarget:f},selection:r,hover:i,viewport:s}},Ur=()=>{const e=document.createElement("canvas");e.width=2*window.innerWidth,e.height=2*window.innerHeight,e.className="r6o-presence-layer";const t=e.getContext("2d");return t.scale(2,2),t.translate(.5,.5),e},Pr=(e,t={})=>{const n=Ur(),o=n.getContext("2d");document.body.appendChild(n);const r=new Map,i=s=>Array.from(r.entries()).filter(([a,l])=>l.presenceKey===s.presenceKey).map(([a,l])=>a);return e.on("selectionChange",(s,a)=>{i(s).forEach(l=>r.delete(l)),a&&a.forEach(l=>r.set(l,s))}),{clear:()=>{const{width:s,height:a}=n;o.clearRect(-.5,-.5,s+1,a+1)},destroy:()=>{n.remove()},paint:(s,a,l)=>{t.font&&(o.font=t.font);const c=r.get(s.annotation.id);if(c){const{height:f}=s.rects[0],d=s.rects[0].x+a.left,p=s.rects[0].y+a.top;o.fillStyle=c.appearance.color,o.fillRect(d-2,p-2.5,2,f+5);const h=o.measureText(c.appearance.label),y=h.width+6,g=h.actualBoundingBoxAscent+h.actualBoundingBoxDescent+8,w=h.fontBoundingBoxAscent?8:6.5;return o.fillRect(d-2,p-2.5-g,y,g),o.fillStyle="#fff",o.fillText(c.appearance.label,d+1,p-w),{fill:c.appearance.color,fillOpacity:l?.45:.18}}},reset:()=>{n.width=2*window.innerWidth,n.height=2*window.innerHeight;const s=n.getContext("2d");s.scale(2,2),s.translate(.5,.5)}}},Ze=typeof navigator<"u"?navigator.userAgent.toLowerCase().indexOf("firefox")>0:!1;function et(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent&&e.attachEvent("on".concat(t),n)}function fe(e,t,n,o){e.removeEventListener?e.removeEventListener(t,n,o):e.detachEvent&&e.detachEvent("on".concat(t),n)}function en(e,t){const n=t.slice(0,t.length-1);for(let o=0;o<n.length;o++)n[o]=e[n[o].toLowerCase()];return n}function tn(e){typeof e!="string"&&(e=""),e=e.replace(/\s/g,"");const t=e.split(",");let n=t.lastIndexOf("");for(;n>=0;)t[n-1]+=",",t.splice(n,1),n=t.lastIndexOf("");return t}function Dr(e,t){const n=e.length>=t.length?e:t,o=e.length>=t.length?t:e;let r=!0;for(let i=0;i<n.length;i++)o.indexOf(n[i])===-1&&(r=!1);return r}const xe={backspace:8,"⌫":8,tab:9,clear:12,enter:13,"↩":13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,num_0:96,num_1:97,num_2:98,num_3:99,num_4:100,num_5:101,num_6:102,num_7:103,num_8:104,num_9:105,num_multiply:106,num_add:107,num_enter:108,num_subtract:109,num_decimal:110,num_divide:111,"⇪":20,",":188,".":190,"/":191,"`":192,"-":Ze?173:189,"=":Ze?61:187,";":Ze?59:186,"'":222,"[":219,"]":221,"\\":220},G={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},st={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},Y={16:!1,18:!1,17:!1,91:!1},_={};for(let e=1;e<20;e++)xe["f".concat(e)]=111+e;let N=[],we=null,nn="all";const Z=new Map,ke=e=>xe[e.toLowerCase()]||G[e.toLowerCase()]||e.toUpperCase().charCodeAt(0),Kr=e=>Object.keys(xe).find(t=>xe[t]===e),Yr=e=>Object.keys(G).find(t=>G[t]===e);function on(e){nn=e||"all"}function Ee(){return nn||"all"}function Hr(){return N.slice(0)}function Xr(){return N.map(e=>Kr(e)||Yr(e)||String.fromCharCode(e))}function Fr(){const e=[];return Object.keys(_).forEach(t=>{_[t].forEach(n=>{let{key:o,scope:r,mods:i,shortcut:s}=n;e.push({scope:r,shortcut:s,mods:i,keys:o.split("+").map(a=>ke(a))})})}),e}function zr(e){const t=e.target||e.srcElement,{tagName:n}=t;let o=!0;const r=n==="INPUT"&&!["checkbox","radio","range","button","file","reset","submit","color"].includes(t.type);return(t.isContentEditable||(r||n==="TEXTAREA"||n==="SELECT")&&!t.readOnly)&&(o=!1),o}function qr(e){return typeof e=="string"&&(e=ke(e)),N.indexOf(e)!==-1}function Wr(e,t){let n,o;e||(e=Ee());for(const r in _)if(Object.prototype.hasOwnProperty.call(_,r))for(n=_[r],o=0;o<n.length;)n[o].scope===e?n.splice(o,1).forEach(i=>{let{element:s}=i;return ut(s)}):o++;Ee()===e&&on(t||"all")}function Gr(e){let t=e.keyCode||e.which||e.charCode;const n=N.indexOf(t);if(n>=0&&N.splice(n,1),e.key&&e.key.toLowerCase()==="meta"&&N.splice(0,N.length),(t===93||t===224)&&(t=91),t in Y){Y[t]=!1;for(const o in G)G[o]===t&&(F[o]=!1)}}function rn(e){if(typeof e>"u")Object.keys(_).forEach(r=>{Array.isArray(_[r])&&_[r].forEach(i=>Ne(i)),delete _[r]}),ut(null);else if(Array.isArray(e))e.forEach(r=>{r.key&&Ne(r)});else if(typeof e=="object")e.key&&Ne(e);else if(typeof e=="string"){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];let[r,i]=n;typeof r=="function"&&(i=r,r=""),Ne({key:e,scope:r,method:i,splitKey:"+"})}}const Ne=e=>{let{key:t,scope:n,method:o,splitKey:r="+"}=e;tn(t).forEach(i=>{const s=i.split(r),a=s.length,l=s[a-1],c=l==="*"?"*":ke(l);if(!_[c])return;n||(n=Ee());const f=a>1?en(G,s):[],d=[];_[c]=_[c].filter(p=>{const h=(o?p.method===o:!0)&&p.scope===n&&Dr(p.mods,f);return h&&d.push(p.element),!h}),d.forEach(p=>ut(p))})};function Rt(e,t,n,o){if(t.element!==o)return;let r;if(t.scope===n||t.scope==="all"){r=t.mods.length>0;for(const i in Y)Object.prototype.hasOwnProperty.call(Y,i)&&(!Y[i]&&t.mods.indexOf(+i)>-1||Y[i]&&t.mods.indexOf(+i)===-1)&&(r=!1);(t.mods.length===0&&!Y[16]&&!Y[18]&&!Y[17]&&!Y[91]||r||t.shortcut==="*")&&(t.keys=[],t.keys=t.keys.concat(N),t.method(e,t)===!1&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0)))}}function Mt(e,t){const n=_["*"];let o=e.keyCode||e.which||e.charCode;if(!F.filter.call(this,e))return;if((o===93||o===224)&&(o=91),N.indexOf(o)===-1&&o!==229&&N.push(o),["ctrlKey","altKey","shiftKey","metaKey"].forEach(a=>{const l=st[a];e[a]&&N.indexOf(l)===-1?N.push(l):!e[a]&&N.indexOf(l)>-1?N.splice(N.indexOf(l),1):a==="metaKey"&&e[a]&&N.length===3&&(e.ctrlKey||e.shiftKey||e.altKey||(N=N.slice(N.indexOf(l))))}),o in Y){Y[o]=!0;for(const a in G)G[a]===o&&(F[a]=!0);if(!n)return}for(const a in Y)Object.prototype.hasOwnProperty.call(Y,a)&&(Y[a]=e[st[a]]);e.getModifierState&&!(e.altKey&&!e.ctrlKey)&&e.getModifierState("AltGraph")&&(N.indexOf(17)===-1&&N.push(17),N.indexOf(18)===-1&&N.push(18),Y[17]=!0,Y[18]=!0);const r=Ee();if(n)for(let a=0;a<n.length;a++)n[a].scope===r&&(e.type==="keydown"&&n[a].keydown||e.type==="keyup"&&n[a].keyup)&&Rt(e,n[a],r,t);if(!(o in _))return;const i=_[o],s=i.length;for(let a=0;a<s;a++)if((e.type==="keydown"&&i[a].keydown||e.type==="keyup"&&i[a].keyup)&&i[a].key){const l=i[a],{splitKey:c}=l,f=l.key.split(c),d=[];for(let p=0;p<f.length;p++)d.push(ke(f[p]));d.sort().join("")===N.sort().join("")&&Rt(e,l,r,t)}}function F(e,t,n){N=[];const o=tn(e);let r=[],i="all",s=document,a=0,l=!1,c=!0,f="+",d=!1,p=!1;for(n===void 0&&typeof t=="function"&&(n=t),Object.prototype.toString.call(t)==="[object Object]"&&(t.scope&&(i=t.scope),t.element&&(s=t.element),t.keyup&&(l=t.keyup),t.keydown!==void 0&&(c=t.keydown),t.capture!==void 0&&(d=t.capture),typeof t.splitKey=="string"&&(f=t.splitKey),t.single===!0&&(p=!0)),typeof t=="string"&&(i=t),p&&rn(e,i);a<o.length;a++)e=o[a].split(f),r=[],e.length>1&&(r=en(G,e)),e=e[e.length-1],e=e==="*"?"*":ke(e),e in _||(_[e]=[]),_[e].push({keyup:l,keydown:c,scope:i,mods:r,shortcut:o[a],method:n,key:o[a],splitKey:f,element:s});if(typeof s<"u"&&window){if(!Z.has(s)){const h=function(){let g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;return Mt(g,s)},y=function(){let g=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;Mt(g,s),Gr(g)};Z.set(s,{keydownListener:h,keyupListenr:y,capture:d}),et(s,"keydown",h,d),et(s,"keyup",y,d)}if(!we){const h=()=>{N=[]};we={listener:h,capture:d},et(window,"focus",h,d)}}}function Jr(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"all";Object.keys(_).forEach(n=>{_[n].filter(o=>o.scope===t&&o.shortcut===e).forEach(o=>{o&&o.method&&o.method()})})}function ut(e){const t=Object.values(_).flat();if(t.findIndex(n=>{let{element:o}=n;return o===e})<0){const{keydownListener:n,keyupListenr:o,capture:r}=Z.get(e)||{};n&&o&&(fe(e,"keyup",o,r),fe(e,"keydown",n,r),Z.delete(e))}if((t.length<=0||Z.size<=0)&&(Object.keys(Z).forEach(n=>{const{keydownListener:o,keyupListenr:r,capture:i}=Z.get(n)||{};o&&r&&(fe(n,"keyup",r,i),fe(n,"keydown",o,i),Z.delete(n))}),Z.clear(),Object.keys(_).forEach(n=>delete _[n]),we)){const{listener:n,capture:o}=we;fe(window,"focus",n,o),we=null}}const tt={getPressedKeyString:Xr,setScope:on,getScope:Ee,deleteScope:Wr,getPressedKeyCodes:Hr,getAllKeyCodes:Fr,isPressed:qr,filter:zr,trigger:Jr,unbind:rn,keyMap:xe,modifier:G,modifierMap:st};for(const e in tt)Object.prototype.hasOwnProperty.call(tt,e)&&(F[e]=tt[e]);if(typeof window<"u"){const e=window.hotkeys;F.noConflict=t=>(t&&window.hotkeys===F&&(window.hotkeys=e),F),window.hotkeys=F}const Nt=300,sn=["up","down","left","right"],an=co?"⌘+a":"ctrl+a",Qr=[...sn.map(e=>`shift+${e}`),an],Zr=(e,t,n)=>{let o;const{annotatingEnabled:r,offsetReferenceSelector:i,selectionMode:s}=n,a=C=>o=C;let l;const c=C=>l=C,{store:f,selection:d}=t;let p,h,y;const g=C=>{h!==!1&&(p=he(C.target)?void 0:{annotation:Gt(),selector:[],creator:o,created:new Date})},w=lt(C=>{const I=document.getSelection();if(!(I!=null&&I.anchorNode))return;if(he(I.anchorNode)){p=void 0;return}const v=C.timeStamp-(y?.timeStamp||C.timeStamp);if(y?.type==="pointerdown"&&(v<1e3&&!p||I.isCollapsed&&v<Nt)&&g(y||C),!p)return;if(I.isCollapsed){f.getAnnotation(p.annotation)&&(d.clear(),f.deleteAnnotation(p.annotation));return}const x=I.getRangeAt(0),A=Ao(x,e);if(mo(A))return;const S=ho(A.cloneRange());(S.length!==p.selector.length||S.some((L,O)=>{var R;return L.toString()!==((R=p.selector[O])==null?void 0:R.quote)}))&&(p={...p,selector:S.map(L=>vo(L,e,i)),updated:new Date},f.getAnnotation(p.annotation)?f.updateTarget(p,T.LOCAL):d.clear())}),m=C=>{he(C.target)||(y=De(C),h=y.button===0)},u=C=>{if(he(C.target)||!h)return;const I=()=>{const{x,y:A}=e.getBoundingClientRect(),S=C.target instanceof Node&&e.contains(C.target)&&f.getAt(C.clientX-x,C.clientY-A,s==="all",l);if(S){const{selected:L}=d,O=new Set(L.map(q=>q.id)),R=Array.isArray(S)?S.map(q=>q.id):[S.id];(O.size!==R.length||!R.every(q=>O.has(q)))&&d.userSelect(R,C)}else d.clear()},v=C.timeStamp-y.timeStamp;setTimeout(()=>{const x=document.getSelection();x!=null&&x.isCollapsed&&v<Nt?(p=void 0,I()):p&&p.selector.length>0&&(j(),d.userSelect(p.annotation,De(C)))})},b=C=>{const I=document.getSelection();I!=null&&I.isCollapsed||((!p||p.selector.length===0)&&w(C),j(),d.userSelect(p.annotation,De(C)))},E=C=>{C.key==="Shift"&&p&&(document.getSelection().isCollapsed||(j(),d.userSelect(p.annotation,Oe(C))))},k=C=>{const I=()=>setTimeout(()=>{p?.selector.length>0&&(d.clear(),f.addAnnotation({id:p.annotation,bodies:[],target:p}),d.userSelect(p.annotation,Oe(C))),document.removeEventListener("selectionchange",I)},100);document.addEventListener("selectionchange",I),g(C)};F(Qr.join(","),{element:e,keydown:!0,keyup:!1},C=>{C.repeat||(y=Oe(C))}),F(an,{keydown:!0,keyup:!1},C=>{y=Oe(C),k(C)});const $=C=>{C.repeat||C.target!==e&&C.target!==document.body||(p=void 0,d.clear())};F(sn.join(","),{keydown:!0,keyup:!1},$);const j=()=>{const C=f.getAnnotation(p.annotation);if(!C){f.addAnnotation({id:p.annotation,bodies:[],target:p});return}const{target:{updated:I}}=C,{updated:v}=p;(!I||!v||I<v)&&f.updateTarget(p)};return e.addEventListener("pointerdown",m),document.addEventListener("pointerup",u),document.addEventListener("contextmenu",b),r&&(e.addEventListener("keyup",E),e.addEventListener("selectstart",g),document.addEventListener("selectionchange",w)),{destroy:()=>{e.removeEventListener("pointerdown",m),document.removeEventListener("pointerup",u),document.removeEventListener("contextmenu",b),e.removeEventListener("keyup",E),e.removeEventListener("selectstart",g),document.removeEventListener("selectionchange",w),F.unbind()},setFilter:c,setUser:a}},ei=(e,t)=>({...e,annotatingEnabled:e.annotatingEnabled??t.annotatingEnabled,user:e.user||t.user}),It="SPANS",ti=(e,t={})=>{lo(e),uo(e);const n=ei(t,{annotatingEnabled:!0,user:Ar()}),o=$r(e,n.userSelectAction),{selection:r,viewport:i}=o,s=o.store,a=ur(s),l=hr(o,a,n.adapter);let c=n.user;const f=n.renderer==="CSS_HIGHLIGHTS"?CSS.highlights?"CSS_HIGHLIGHTS":It:n.renderer||It,d=f==="SPANS"?Ko(e,o,i):f==="CSS_HIGHLIGHTS"?Uo(e,o,i):f==="CANVAS"?To(e,o,i):void 0;if(!d)throw`Unknown renderer implementation: ${f}`;console.debug(`Using ${f} renderer`),n.style&&d.setStyle(n.style);const p=Zr(e,o,n);return p.setUser(c),{...gr(o,a,n.adapter),destroy:()=>{d.destroy(),p.destroy(),a.destroy()},element:e,getUser:()=>c,setFilter:h=>{d.setFilter(h),p.setFilter(h)},setStyle:h=>d.setStyle(h),setUser:h=>{c=h,p.setUser(h)},setSelected:h=>{h?r.setSelected(h):r.clear()},setPresenceProvider:h=>{h&&(d.setPainter(Pr(h,n.presence)),h.on("selectionChange",()=>d.redraw()))},setVisible:h=>d.setVisible(h),on:l.on,off:l.off,scrollIntoView:xo(e,s),state:o}},ni=e=>{const t=V.useRef(null),{className:n,children:o,...r}=e,{style:i,filter:s,user:a}=r,{anno:l,setAnno:c}=V.useContext(un);return V.useEffect(()=>{if(!c)return;const f=typeof r.adapter=="function"?r.adapter(t.current):r.adapter,d=ti(t.current,{...r,adapter:f});return c(d),()=>d.destroy()},[c]),V.useEffect(()=>l?.setStyle(i),[l,i]),V.useEffect(()=>l?.setFilter(s),[l,s]),V.useEffect(()=>l?.setUser(a),[l,a]),Mn.jsx("div",{ref:t,className:n,children:o})},oi=()=>{const[e,t]=V.useState();return V.useEffect(()=>{fetch("../../thesaurus/narratives.json").then(n=>n.json()).then(n=>{const o=n.map(r=>r.uri?.trim()).filter(Boolean);t(new Set(o))})},[]),e},ri=["#0fb5ae","#4046ca","#f68511","#de3d82","#7e84fa","#72e06a"],ii=e=>{const[t,n]=V.useState(),[o,r]=V.useState(!1),{refs:i,floatingStyles:s}=fn({placement:"bottom",open:o,onOpenChange:r,middleware:[mn(4),yn(),bn(),wn({crossAxis:!0,padding:{top:5,bottom:5}})],whileElementsMounted:vn});return V.useEffect(()=>{if(e.annotation){const a=e.annotation.target.selector,l=Array.isArray(a)?a[0].range:a.range;l&&!l.collapsed&&(i.setReference({getBoundingClientRect:()=>l.getBoundingClientRect(),getClientRects:()=>{const c=t?hn(l.getClientRects(),t):l.getClientRects()[0];return pn(c)}}),r(!0))}else r(!1)},[e.annotation,t]),V.useEffect(()=>{const a=l=>{const{clientX:c,clientY:f}=l;n({x:c,y:f})};return window.document.addEventListener("pointerup",a),()=>{window.document.removeEventListener("pointerup",a)}},[]),e.annotation&&o&&H.jsx("div",{className:"text-annotation-popup not-annotatable",ref:i.setFloating,style:s,children:H.jsx(gn,{type:"VERSE",annotation:e.annotation,relatedImages:e.relatedImages||[],relatedVerses:e.relatedVerses||[],onClickImages:e.onClickImages,onClickVerses:e.onClickVerses})})},si=e=>({fill:"#000",fillOpacity:.05,underlineThickness:1.5,underlineColor:ri[e||0],underlineOffset:3*(e||0)+1}),ai=e=>({fill:"#ff5e5e",fillOpacity:.4,underlineThickness:2,underlineColor:"#e05252",underlineOffset:3*(e||0)+1}),li=e=>{const{searchResults:t,highlightedSearchResult:n}=e,o=An(),r=xn(),{images:i,verses:s}=En(r),a=oi(),l=V.useCallback((c,f,d)=>{const h=c.bodies.find(y=>y.id&&a.has(y.id))?si(d):ai(d);return t.length===0?h:new Set(t.map(g=>g.id)).has(c.id)?{...h,fill:"#fff800",underlineColor:"#caca2b"}:h},[a,t,n]);return V.useEffect(()=>{o&&o.setAnnotations(e.annotations)},[o,e.annotations]),V.useEffect(()=>{e.highlightedSearchResult&&(o.setSelected(e.highlightedSearchResult.id),o.scrollIntoView(e.highlightedSearchResult))},[e.highlightedSearchResult]),V.useEffect(()=>{e.onSelect({annotation:r,relatedImages:i,relatedVerses:s})},[r,i,s]),a&&H.jsxs(ni,{adapter:c=>kr("5db80aa5-8a27-4539-aeb3-bddf3abc0098",c),annotatingEnabled:!1,style:l,children:[H.jsx("div",{className:"annotated-text",children:e.verse}),H.jsx(ii,{annotation:r,relatedImages:i,relatedVerses:s,onClickImages:e.onOpenRelatedImages,onClickVerses:e.onOpenRelatedVerses})]})},fi=e=>{const[t,n]=V.useState(),o=Sn(`annotations/verse/${e.verse.slug}.json`),[r,i]=V.useState(),[s,a]=ft("diga.images.open",!1),[l,c]=ft("diga.verses.open",!1),[f,d]=V.useState([]),[p,h]=V.useState();V.useEffect(()=>{fetch(`../../verses/${e.verse.slug}.txt`).then(g=>g.text()).then(n)},[]);const y=V.useCallback((g,w)=>{const m=g.target.selector[0].start,u=w.target.selector[0].start;return m-u},[]);return H.jsxs(kn,{children:[H.jsx(Cn,{loaded:!!o}),H.jsx(On,{backToTab:"verses",isRelatedImagesOpen:s,isRelatedVersesOpen:l,searchSorter:y,onToggleRelatedImages:()=>a(g=>!g),onToggleRelatedVerses:()=>c(g=>!g),onClearSearch:()=>d([]),onHighlightSearchResult:g=>h(g),onSearch:d}),H.jsxs("div",{className:"flex-wrapper",children:[H.jsx("main",{children:H.jsxs("div",{className:"page",children:[H.jsx("h1",{children:e.verse.title}),t&&o&&H.jsx(li,{annotations:o,verse:t,searchResults:f,highlightedSearchResult:p,onSelect:i,onOpenRelatedImages:()=>a(!0),onOpenRelatedVerses:()=>c(!0)})]})}),H.jsx(Ln,{annotation:r?.annotation,currentSlug:e.verse.slug,open:l,related:r?.relatedVerses,onClose:()=>c(!1)}),H.jsx(Tn,{annotation:r?.annotation,currentSlug:e.verse.slug,open:s,related:r?.relatedImages,onClose:()=>a(!1)})]})]})};export{fi as VerseView};

import{j as V}from"./jsx-runtime.DHyoM1g7.js";import{R as lt,r as R}from"./index.BLZuVVrN.js";import{o as dt,u as ct,g as ut,t as ft,A as ht,a as pt,i as gt,f as mt,s as bt,b as yt,F as vt,c as At,d as wt,e as xt,h as Le,B as Et,j as St,P as Tt,R as Ct,k as Nt}from"./floating-ui.react.D49uLDwx.js";var Pe={exports:{}},W={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Oe;function Lt(){if(Oe)return W;Oe=1;var e=lt,t=Symbol.for("react.element"),n=Symbol.for("react.fragment"),o=Object.prototype.hasOwnProperty,r=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,i={key:!0,ref:!0,__self:!0,__source:!0};function s(a,l,d){var g,u={},v=null,c=null;d!==void 0&&(v=""+d),l.key!==void 0&&(v=""+l.key),l.ref!==void 0&&(c=l.ref);for(g in l)o.call(l,g)&&!i.hasOwnProperty(g)&&(u[g]=l[g]);if(a&&a.defaultProps)for(g in l=a.defaultProps,l)u[g]===void 0&&(u[g]=l[g]);return{$$typeof:t,type:a,key:v,ref:c,props:u,_owner:r.current}}return W.Fragment=n,W.jsx=s,W.jsxs=s,W}Pe.exports=Lt();var Ot=Pe.exports;const Rt={namespaces:{tei:"http://www.tei-c.org/ns/1.0",teieg:"http://www.tei-c.org/ns/Examples",rng:"http://relaxng.org/ns/structure/1.0"},tei:{eg:["<pre>","</pre>"],ptr:['<a href="$rw@target">$@target</a>'],ref:[["[target]",['<a href="$rw@target">',"</a>"]]],graphic:function(e){let t=new Image;return t.src=this.rw(e.getAttribute("url")),e.hasAttribute("width")&&t.setAttribute("width",e.getAttribute("width")),e.hasAttribute("height")&&t.setAttribute("height",e.getAttribute("height")),t},list:[["[type=gloss]",function(e){const t=e.ownerDocument;let n=t.createElement("dl");for(let o of Array.from(e.children))if(o.nodeType==1){if(o.localName=="tei-label"){let r=t.createElement("dt");r.innerHTML=o.innerHTML,n.appendChild(r)}if(o.localName=="tei-item"){let r=t.createElement("dd");r.innerHTML=o.innerHTML,n.appendChild(r)}}return n}]],note:[["[place=end]",function(e){const t=e.ownerDocument;this.noteIndex?this.noteIndex++:this.noteIndex=1;let n="_note_"+this.noteIndex,o=t.createElement("a");o.setAttribute("id","src"+n),o.setAttribute("href","#"+n),o.innerHTML=this.noteIndex;let r=t.createElement("sup");r.appendChild(o);let i=t.querySelector("ol.notes");i||(i=t.createElement("ol"),i.setAttribute("class","notes"),this.dom.appendChild(i));let s=t.createElement("li");return s.id=n,s.innerHTML=e.innerHTML,i.appendChild(s),r}],["_",["(",")"]]],teiHeader:function(e){this.hideContent(e,!1)},title:[["tei-titlestmt>tei-title",function(e){const t=e.ownerDocument;let n=t.createElement("title");n.innerHTML=e.innerText,t.querySelector("head").appendChild(n)}]]},teieg:{egXML:function(e){const t=e.ownerDocument;let n=t.createElement("pre"),o=t.createElement("code");n.appendChild(o);let r=this.serialize(e,!0).replace(/</g,"&lt;"),i=r.match(/^[\t ]+/);return i&&(r=r.replace(new RegExp("^"+i[0],"mg"),"")),o.innerHTML=r,n}}};function Mt(e,t){let n=1,o=e;for(;o&&o.previousElementSibling!==null&&(!t||o.previousElementSibling.localName==t)&&(n++,o=o.previousElementSibling,!!o.previousElementSibling););return n}function Fe(e){const t=e.ownerDocument;let n=o=>{let r;switch(o.nodeType){case 1:r=t.createElement(o.nodeName);break;case 9:r=t.implementation.createDocument();break;case 11:r=t.createDocumentFragment();break;default:r=o.cloneNode(!0)}if(o.attributes)for(let i of Array.from(o.attributes))i.name!=="data-processed"&&r.setAttribute(i.name,i.value);for(let i of Array.from(o.childNodes))if(i.nodeType==1)if(i.hasAttribute("data-original")){for(let s of Array.from(i.childNodes)){let a=r.appendChild(n(s));a.nodeType===1&&a.hasAttribute("data-origid")&&(a.setAttribute("id",a.getAttribute("data-origid")),a.removeAttribute("data-origid"))}return r}else i.hasAttribute("data-origname")&&r.appendChild(n(i));else r.appendChild(i.cloneNode());return r};return n(e)}function ze(e){return e.replace(/ .*$/,"")}function qe(e,t=!0){const n=e.ownerDocument;if(e.childNodes.length>0){let o=n.createElement("cetei-original");e.appendChild(o),o.setAttribute("hidden",""),o.setAttribute("data-original","");for(let r of Array.from(e.childNodes))if(r!==o){if(r.nodeType===1){r.setAttribute("data-processed","");for(let i of r.querySelectorAll("*"))i.setAttribute("data-processed","")}o.appendChild(e.removeChild(r))}if(t)for(let r of Array.from(o.querySelectorAll("*")))r.hasAttribute("id")&&(r.setAttribute("data-origid",r.getAttribute("id")),r.removeAttribute("id"))}}function Bt(e){return this.rw(this.first(e))}function It(e,t){let n="";for(let o=0;o<t;o++)n+=e;return n}function kt(e){let t=this.prefixDefs[e.substring(0,e.indexOf(":"))];return e.replace(new RegExp(t.matchPattern),t.replacementPattern)}function Vt(e){return this.prefixDefs[e]}function _t(e){return e.match(/^(?:http|mailto|file|\/|#).*$/)?e:this.base+ze(e)}function Dt(e,t,n){return ie(Fe(e),t,n)}function ie(e,t,n){let o="";const r=i=>!/[^\t\n\r ]/.test(i);if((e.nodeType===9||e.nodeType===11)&&(o+=`<?xml version="1.0" encoding="UTF-8"?>
`),!t&&e.nodeType==1){typeof n=="string"&&n!==""?o+=`
`+n+"<":o+="<",o+=e.getAttribute("data-origname");let i=e.hasAttribute("data-origatts")?e.getAttribute("data-origatts").split(" "):[];for(let s of Array.from(e.attributes))!s.name.startsWith("data-")&&!["id","lang","class"].includes(s.name)&&(o+=" "+i.find(function(a){return a.toLowerCase()==s.name})+'="'+s.value+'"'),s.name=="data-xmlns"&&(o+=' xmlns="'+s.value+'"');e.childNodes.length>0?o+=">":o+="/>"}for(let i of Array.from(e.childNodes))switch(i.nodeType){case 1:typeof n=="string"?o+=ie(i,!1,n+"  "):o+=ie(i,!1,n);break;case 7:o+=`<?${i.nodeName} ${i.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;case 8:o+=`<!--${i.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(o+=`
`);break;default:if(t&&r(i.nodeValue)&&(o+=i.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&r(i.nodeValue))break;o+=i.nodeValue}return!t&&e.nodeType==1&&e.childNodes.length>0&&(typeof n=="string"?o+=`
`+n+"</":o+="</",o+=e.getAttribute("data-origname")+">"),(e.nodeType===9||e.nodeType===11)&&(o+=`
`),o}function xe(e,t,n){const o=["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"];let r="";const i=s=>!/[^\t\n\r ]/.test(s);if(!t&&e.nodeType==1){typeof n=="string"&&n!==""?r+=`
`+n+"<":r+="<",r+=e.nodeName;for(let s of Array.from(e.attributes))r+=" "+s.name+'="'+s.value+'"';r+=">"}for(let s of Array.from(e.childNodes))switch(s.nodeType){case 1:typeof n=="string"?r+=xe(s,!1,n+"  "):r+=xe(s,!1,n);break;case 7:r+=`<?${s.nodeName} ${s.nodeValue}?>`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;case 8:r+=`<!--${s.nodeValue}-->`,(e.nodeType===9||e.nodeType===11)&&(r+=`
`);break;default:if(t&&i(s.nodeValue)&&(r+=s.nodeValue.replace(/^\s*\n/,"")),typeof n=="string"&&i(s.nodeValue))break;r+=s.nodeValue.replace(/</g,"&lt;")}return o.includes(e.nodeName)||!t&&e.nodeType==1&&(typeof n=="string"?r+=`
${n}</`:r+="</",r+=`${e.nodeName}>`),(e.nodeType===9||e.nodeType===11)&&(r+=`
`),r}function $t(e){return e.replace(/&gt;/,">").replace(/&quot;/,'"').replace(/&apos;/,"'").replace(/&amp;/,"&")}function ae(e){return e.includes(":"),e.replace(/:/,"-").toLowerCase()}function We(e,t=null,n=!1){try{window.customElements.define(ae(e),class extends HTMLElement{constructor(){super(),this.matches(":defined")||t&&(t.call(this),this.setAttribute("data-processed",""))}connectedCallback(){this.hasAttribute("data-processed")||t&&(t.call(this),this.setAttribute("data-processed",""))}})}catch(o){n&&(console.log(ae(e)+" couldn't be registered or is already registered."),console.log(o))}}const de=Object.freeze(Object.defineProperty({__proto__:null,copyAndReset:Fe,defineCustomElement:We,first:ze,getOrdinality:Mt,getPrefixDef:Vt,hideContent:qe,normalizeURI:Bt,repeat:It,resetAndSerialize:Dt,resolveURI:kt,rw:_t,serialize:ie,serializeHTML:xe,tagName:ae,unEscapeEntities:$t},Symbol.toStringTag,{value:"Module"}));function Ut(e){if(e.namespaces)for(let t of Object.keys(e.namespaces))!this.namespaces.has(e.namespaces[t])&&!Array.from(this.namespaces.values()).includes(t)&&this.namespaces.set(e.namespaces[t],t);for(let t of this.namespaces.values())if(e[t])for(let n of Object.keys(e[t]))this.behaviors[`${t}:${n}`]=e[t][n];if(e.functions)for(let t of Object.keys(e.functions))this.utilities[t]=e.functions[t].bind(this.utilities);e.handlers&&console.log("Behavior handlers are no longer used."),e.fallbacks&&console.log("Fallback behaviors are no longer used.")}function Ht(e,t,n){let o;if(e===Object(e))for(let r of Object.keys(e))this.namespaces.has(e[r])||(this.namespaces.set(e[r],r),o=r);else o=e;this.behaviors[`${o}:${t}`]=n}function jt(e,t){let n;if(e===Object(e))for(let o of Object.keys(e))this.namespaces.has(e[o])||(this.namespaces.set(e[o],o),n=o);else n=e;delete this.behaviors[`${n}:${t}`]}function Xt(e,t){const n=e.documentElement;let o=1,r=function(s){return t.has(s.namespaceURI?s.namespaceURI:"")||t.set(s.namespaceURI,"ns"+o++),t.get(s.namespaceURI?s.namespaceURI:"")+":"+s.localName};const i=new Set(Array.from(n.querySelectorAll("*"),r));return i.add(r(n)),i}function Yt(e){return new Set(Array.from(e.querySelectorAll("*[data-origname]"),t=>t.localName.replace(/(\w+)-.+/,"$1:")+t.getAttribute("data-origname")))}class Z{constructor(t){this.options=t||{},this.document=this.options.documentObject?this.options.documentObject:void 0,this.document===void 0&&(typeof window<"u"&&window.document?this.document=window.document:typeof global<"u"&&global.document&&(this.document=global.document)),this.addBehaviors=Ut.bind(this),this.addBehavior=Ht.bind(this),this.removeBehavior=jt.bind(this),this.utilities={};for(const n of Object.keys(de))["getPrefixDef","rw","resolveURI"].includes(n)?this.utilities[n]=de[n].bind(this):this.utilities[n]=de[n];if(this.els=[],this.namespaces=new Map,this.behaviors={},this.hasStyle=!1,this.prefixDefs=[],this.debug=this.options.debug===!0,this.discardContent=this.options.discardContent===!0,this.options.base)this.base=this.options.base;else try{window&&(this.base=window.location.href.replace(/\/[^\/]*$/,"/"))}catch{this.base=""}this.options.omitDefaultBehaviors||this.addBehaviors(Rt),this.options.ignoreFragmentId&&window&&window.removeEventListener("ceteiceanload",Z.restorePosition)}async getHTML5(t,n,o){window&&window.location.href.startsWith(this.base)&&t.indexOf("/")>=0&&(this.base=t.replace(/\/[^\/]*$/,"/"));try{const r=await fetch(t);if(r.ok){const i=await r.text();return this.makeHTML5(i,n,o)}else console.log(`Could not get XML file ${t}.
Server returned ${r.status}: ${r.statusText}`)}catch(r){console.log(r)}}makeHTML5(t,n,o){return this.XML_dom=new DOMParser().parseFromString(t,"text/xml"),this.domToHTML5(this.XML_dom,n,o)}preprocess(t,n,o){this.els=Xt(t,this.namespaces);let r=i=>{let s;if(this.namespaces.has(i.namespaceURI?i.namespaceURI:"")){let a=this.namespaces.get(i.namespaceURI?i.namespaceURI:"");s=this.document.createElement(`${a}-${i.localName.toLowerCase()}`)}else s=this.document.importNode(i,!1);for(let a of Array.from(i.attributes))a.name=="xmlns"?s.setAttribute("data-xmlns",a.value):s.setAttribute(a.name,a.value),a.name=="xml:id"&&s.setAttribute("id",a.value),a.name=="xml:lang"&&s.setAttribute("lang",a.value),a.name=="rendition"&&s.setAttribute("class",a.value.replace(/#/g,""));if(s.setAttribute("data-origname",i.localName),i.hasAttributes()&&s.setAttribute("data-origatts",i.getAttributeNames().join(" ")),i.childNodes.length==0&&s.setAttribute("data-empty",""),i.localName=="head"){let a=t.evaluate("count(ancestor::*[tei:head])",i,function(l){if(l=="tei")return"http://www.tei-c.org/ns/1.0"},1,null);s.setAttribute("data-level",a.numberValue)}if(i.localName=="tagsDecl"){let a=this.document.createElement("style");for(let l of Array.from(i.childNodes))if(l.nodeType==1&&l.localName=="rendition"&&l.getAttribute("scheme")=="css"){let d="";l.hasAttribute("selector")?(d+=l.getAttribute("selector").replace(/([^#, >]+\w*)/g,"tei-$1").replace(/#tei-/g,"#")+`{
`,d+=l.textContent):(d+="."+l.getAttribute("xml:id")+`{
`,d+=l.textContent),d+=`
}
`,a.appendChild(this.document.createTextNode(d))}a.childNodes.length>0&&(s.appendChild(a),this.hasStyle=!0)}i.localName=="prefixDef"&&(this.prefixDefs.push(i.getAttribute("ident")),this.prefixDefs[i.getAttribute("ident")]={matchPattern:i.getAttribute("matchPattern"),replacementPattern:i.getAttribute("replacementPattern")});for(let a of Array.from(i.childNodes))a.nodeType==1?s.appendChild(r(a)):s.appendChild(a.cloneNode());return o&&o(s,i),s};this.dom=this.document.createDocumentFragment();for(let i of Array.from(t.childNodes))i.nodeType==1&&this.dom.appendChild(r(i)),i.nodeType==7&&this.dom.appendChild(this.document.importNode(i,!0)),i.nodeType==8&&this.dom.appendChild(this.document.importNode(i,!0));if(this.utilities.dom=this.dom.firstElementChild,n)n(this.dom,this),window&&window.dispatchEvent(G);else return typeof window<"u"&&window.dispatchEvent(G),this.dom}domToHTML5(t,n,o){if(this.preprocess(t,null,o),this.applyBehaviors(),this.done=!0,n)n(this.dom,this),window&&window.dispatchEvent(G);else return typeof window<"u"&&window.dispatchEvent(G),this.dom}processPage(){this.els=Yt(this.document),this.applyBehaviors(),window&&window.dispatchEvent(G)}unsetNamespace(t){this.namespaces.delete(t)}setBaseUrl(t){this.base=t}append(t,n){let o=this;if(n&&!n.hasAttribute("data-processed")){let r=t.call(o.utilities,n);r&&o.appendBasic(n,r)}else return function(){if(!this.hasAttribute("data-processed")){let r=t.call(o.utilities,this);r&&o.appendBasic(this,r)}}}appendBasic(t,n){this.discardContent?t.innerHTML="":qe(t,!0),t.appendChild(n)}bName(t){return t.tagName.substring(0,t.tagName.indexOf("-")).toLowerCase()+":"+t.getAttribute("data-origname")}childExists(t,n){return t&&t.nodeName==n?!0:t&&t.nextElementSibling&&this.childExists(t.nextElementSibling,n)}decorator(t){if(Array.isArray(t)&&t.length==0)return function(o){};if(Array.isArray(t)&&!Array.isArray(t[0]))return this.applyDecorator(t);let n=this;return function(o){for(let r of t)if(o.matches(r[0])||r[0]==="_")return Array.isArray(r[1])?n.decorator(r[1]).call(this,o):r[1].call(this,o)}}applyDecorator(t){let n=this;return function(o){let r=[];for(let i=0;i<t.length;i++)r.push(n.template(t[i],o));return n.insert(o,r)}}getFallback(t,n){if(t[n])return t[n]instanceof Function?t[n]:this.decorator(t[n])}getHandler(t,n){if(t[n])return t[n]instanceof Function?this.append(t[n]):this.append(this.decorator(t[n]))}insert(t,n){let o=this.document.createElement("cetei-content");for(let r of Array.from(t.childNodes))r.nodeType===1&&!r.hasAttribute("data-processed")&&this.processElement(r);if(n[0].match("<[^>]+>")&&n[1]&&n[1].match("<[^>]+>"))o.innerHTML=n[0]+t.innerHTML+(n[1]?n[1]:"");else{o.innerHTML=n[0],o.setAttribute("data-before",n[0].replace(/<[^>]+>/g,"").length);for(let r of Array.from(t.childNodes))o.appendChild(r.cloneNode(!0));n.length>1&&(o.innerHTML+=n[1],o.setAttribute("data-after",n[1].replace(/<[^>]+>/g,"").length))}return o.childNodes.length<2?o.firstChild:o}processElement(t){if(t.hasAttribute("data-origname")&&!t.hasAttribute("data-processed")){let n=this.getFallback(this.bName(t));n&&(this.append(n,t),t.setAttribute("data-processed",""))}for(let n of Array.from(t.childNodes))n.nodeType===1&&this.processElement(n)}template(t,n){let o=t;if(t.search(/\$(\w*)(@([a-zA-Z:]+))/)){let r=/\$(\w*)@([a-zA-Z:]+)/g,i;for(;i=r.exec(t);)n.hasAttribute(i[2])?i[1]&&this.utilities[i[1]]?o=o.replace(i[0],this.utilities[i[1]](n.getAttribute(i[2]))):o=o.replace(i[0],n.getAttribute(i[2])):o=o.replace(i[0],"")}return o}applyBehaviors(){typeof window<"u"&&window.customElements?this.define.call(this,this.els):this.fallback.call(this,this.els)}define(t){for(let n of t){const o=this.getHandler(this.behaviors,n);We(n,o,this.debug)}}fallback(t){for(let n of t){let o=this.getFallback(this.behaviors,n);if(o)for(let r of Array.from((this.dom&&!this.done?this.dom:this.document).querySelectorAll(ae(n))))r.hasAttribute("data-processed")||(this.append(o,r),r.setAttribute("data-processed",""))}}static savePosition(){window.sessionStorage.setItem(window.location+"-scroll",window.scrollY)}static restorePosition(){if(window.location.hash)setTimeout(function(){let t=this.document.querySelector(window.decodeURI(window.location.hash));t&&t.scrollIntoView()},100);else{let t;(t=window.sessionStorage.getItem(window.location+"-scroll"))&&(window.sessionStorage.removeItem(window.location+"-scroll"),setTimeout(function(){window.scrollTo(0,t)},100))}}}try{if(typeof window<"u"){window.CETEI=Z,window.addEventListener("beforeunload",Z.savePosition);var G=new Event("ceteiceanload");window.addEventListener("ceteiceanload",Z.restorePosition)}}catch(e){console.log(e)}var Pt=[];for(var ce=0;ce<256;++ce)Pt.push((ce+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var Ft=[];for(var ue=0;ue<256;++ue)Ft.push((ue+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const zt="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let qt=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=zt[n[e]&63];return t};qt();const X={fill:"rgb(0, 128, 255)",fillOpacity:.18},se={fill:"rgb(0, 128, 255)",fillOpacity:.45},Wt=(e,t,n,o,r)=>{var i,s;const a=n?typeof n=="function"?n(e.annotation,e.state,r)||((i=e.state)!=null&&i.selected?se:X):n:(s=e.state)!=null&&s.selected?se:X;return o&&o.paint(e,t)||a},Ge="not-annotatable",H=`.${Ge}`,Gt=e=>{var t;const n=e.commonAncestorContainer;return n instanceof HTMLElement?!n.closest(H):!((t=n.parentElement)!=null&&t.closest(H))},Jt=function*(e){const t=document.createNodeIterator(e.commonAncestorContainer,NodeFilter.SHOW_ELEMENT,o=>o instanceof HTMLElement&&o.classList.contains(Ge)&&!o.parentElement.closest(H)&&e.intersectsNode(o)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_SKIP);let n;for(;n=t.nextNode();)n instanceof HTMLElement&&(yield n)},Kt=e=>{if(!Gt(e))return[];const t=[];let n=null;for(const o of Jt(e)){let r;n?(r=document.createRange(),r.setStartAfter(n),r.setEndBefore(o)):(r=e.cloneRange(),r.setEndBefore(o)),r.collapsed||t.push(r),n=o}if(n){const o=e.cloneRange();o.setStartAfter(n),o.collapsed||t.push(o)}return t.length>0?t:[e]},Ee=e=>{const t=e.cloneContents();return t.querySelectorAll(H).forEach(n=>n.remove()),t},Qt=e=>{e.addEventListener("click",t=>{!t.target.closest(H)&&!t.target.closest("a")&&t.preventDefault()})},Te=(e,t=10)=>{let n;return(...o)=>{clearTimeout(n),n=setTimeout(()=>e.apply(void 0,o),t)}},Zt=(e,t,n=10,o)=>{const r=t,i=document.createRange();i.setStart(r,0),i.setEnd(e.startContainer,e.startOffset);const s=Ee(i).textContent,a=document.createRange();a.setStart(e.endContainer,e.endOffset),r===document.body?a.setEnd(r,r.childNodes.length):a.setEndAfter(r);const l=Ee(a).textContent;return{prefix:s.substring(s.length-n),suffix:l.substring(0,n)}},j=e=>e.every(t=>t.range instanceof Range&&!t.range.collapsed),en=(e,t)=>{const n=i=>Math.round(i*10)/10,o={top:n(e.top),bottom:n(e.bottom),left:n(e.left),right:n(e.right)},r={top:n(t.top),bottom:n(t.bottom),left:n(t.left),right:n(t.right)};if(Math.abs(o.top-r.top)<.5&&Math.abs(o.bottom-r.bottom)<.5){if(Math.abs(o.left-r.right)<.5||Math.abs(o.right-r.left)<.5)return"inline-adjacent";if(o.left>=r.left&&o.right<=r.right)return"inline-is-contained";if(o.left<=r.left&&o.right>=r.right)return"inline-contains"}else if(o.top<=r.top&&o.bottom>=r.bottom){if(o.left<=r.left&&o.right>=r.right)return"block-contains"}else if(o.top>=r.top&&o.bottom<=r.bottom&&o.left>=r.left&&o.right<=r.right)return"block-is-contained"},tn=(e,t)=>{const n=Math.min(e.left,t.left),o=Math.max(e.right,t.right),r=Math.min(e.top,t.top),i=Math.max(e.bottom,t.bottom);return new DOMRect(n,r,o-n,i-r)},nn=e=>e.reduce((t,n)=>{if(n.width===0||n.height===0)return t;let o=[...t],r=!1;for(const i of t){const s=en(n,i);if(s==="inline-adjacent"){o=o.map(a=>a===i?tn(n,i):a),r=!0;break}else if(s==="inline-contains"){o=o.map(a=>a===i?n:a),r=!0;break}else if(s==="inline-is-contained"){r=!0;break}else if(s==="block-contains"||s==="block-is-contained"){n.width<i.width&&(o=o.map(a=>a===i?n:a)),r=!0;break}}return r?o:[...o,n]},[]),on=(e,t,n)=>{const o=document.createRange(),r=n?e.startContainer.parentElement.closest(n):t;o.setStart(r,0),o.setEnd(e.startContainer,e.startOffset);const i=Ee(o).textContent,s=e.toString(),a=i.length||0,l=a+s.length;return n?{quote:s,start:a,end:l,range:e,offsetReference:r}:{quote:s,start:a,end:l,range:e}},Je=(e,t)=>{var n,o;const{start:r,end:i}=e,s=e.offsetReference||t,a=document.createNodeIterator(t,NodeFilter.SHOW_TEXT,v=>{var c;return(c=v.parentElement)!=null&&c.closest(H)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let l=0;const d=document.createRange();let g=a.nextNode();g===null&&console.error("Could not revive annotation target. Content missing.");let u=!s;for(;g!==null;){if(u||(u=s?.contains(g)),u){const v=((n=g.textContent)==null?void 0:n.length)||0;if(l+v>r){d.setStart(g,r-l);break}l+=v}g=a.nextNode()}for(;g!==null;){const v=((o=g.textContent)==null?void 0:o.length)||0;if(l+v>=i){d.setEnd(g,i-l);break}l+=v,g=a.nextNode()}return{...e,range:d}},le=(e,t)=>j(e.selector)?e:{...e,selector:e.selector.map(n=>n.range instanceof Range&&!n.range.collapsed?n:Je(n,t))},fe=(e,t)=>j(e.target.selector)?e:{...e,target:le(e.target,t)},rn=e=>{var t;const{startContainer:n,endContainer:o}=e;if(n.nodeType===Node.TEXT_NODE&&o.nodeType===Node.TEXT_NODE)return e;if(n.nodeType!==Node.TEXT_NODE){const r=n.nextSibling||n.parentNode,i=r?.nodeType===Node.TEXT_NODE?r:Array.from(r.childNodes).filter(s=>s.nodeType===Node.TEXT_NODE).shift();e.setEnd(i,0)}if(o.nodeType!==Node.TEXT_NODE){const r=o.previousSibling||o.parentNode,i=r?.nodeType===Node.TEXT_NODE?r:Array.from(r.childNodes).filter(s=>s.nodeType===Node.TEXT_NODE).pop();e.setEnd(i,((t=i?.textContent)==null?void 0:t.length)||0)}return e},an=e=>{const{top:t,left:n}=e.getBoundingClientRect(),{innerWidth:o,innerHeight:r}=window,i=-n,s=-t,a=o-n,l=r-t;return{top:t,left:n,minX:i,minY:s,maxX:a,maxY:l}},sn=e=>{let t=new Set;return n=>{const o=n.map(r=>r.id);(t.size!==o.length||o.some(r=>!t.has(r)))&&e.set(o),t=new Set(o)}},Ce=(e,t,n,o)=>{const{store:r,selection:i,hover:s}=t;let a,l,d;const g=sn(n),u=O=>{const{x:_,y:Y}=e.getBoundingClientRect(),y=r.getAt(O.clientX-_,O.clientY-Y);y&&(!l||l(y))?s.current!==y.id&&(e.classList.add("hovered"),s.set(y.id)):s.current&&(e.classList.remove("hovered"),s.set(null))};e.addEventListener("pointermove",u);const v=(O=!1)=>{d&&d.clear();const _=an(e),{minX:Y,minY:y,maxX:x,maxY:w}=_,E=l?r.getIntersecting(Y,y,x,w).filter(({annotation:k})=>l(k)):r.getIntersecting(Y,y,x,w),C=i.selected.map(({id:k})=>k),M=E.map(({annotation:k,rects:it})=>{const at=C.includes(k.id),st=k.id===s.current;return{annotation:k,rects:it,state:{selected:at,hover:st}}});o.redraw(M,_,a,d,O),setTimeout(()=>g(E.map(({annotation:k})=>k)),1)},c=O=>{d=O,v()},b=O=>{a=O,v()},f=O=>{l=O,v(!1)},h=()=>v();r.observe(h);const m=i.subscribe(()=>v()),p=()=>v(!0);document.addEventListener("scroll",p,{capture:!0,passive:!0});const A=Te(()=>{r.recalculatePositions(),d&&d.reset(),v()});window.addEventListener("resize",A);const S=new ResizeObserver(A);S.observe(e);const T={attributes:!0,childList:!0,subtree:!0},L=new MutationObserver(O=>{O.every(_=>_.target===e||e.contains(_.target))||v(!0)});return L.observe(document.body,T),{destroy:()=>{e.removeEventListener("pointermove",u),o.destroy(),r.unobserve(h),m(),document.removeEventListener("scroll",p),window.removeEventListener("resize",A),S.disconnect(),L.disconnect()},redraw:v,setStyle:b,setFilter:f,setPainter:c,setVisible:o.setVisible}},ln=()=>{const e=document.createElement("canvas");return e.width=window.innerWidth,e.height=window.innerHeight,e.className="r6o-highlight-layer bg",e},dn=(e,t)=>{e.width=window.innerWidth,e.height=window.innerHeight},cn=e=>{e.classList.add("r6o-annotatable");const t=ln(),n=t.getContext("2d");e.insertBefore(t,e.firstChild);const o=(i,s,a,l)=>requestAnimationFrame(()=>{const{width:d,height:g}=t;n.clearRect(-.5,-.5,d+1,g+1),l&&l.clear();const{top:u,left:v}=s;[...i].sort((c,b)=>{const{annotation:{target:{created:f}}}=c,{annotation:{target:{created:h}}}=b;return f.getTime()-h.getTime()}).forEach(c=>{var b;const f=a?typeof a=="function"?a(c.annotation,c.state):a:(b=c.state)!=null&&b.selected?se:X,h=l&&l.paint(c,s)||f,m=c.rects.map(({x:A,y:S,width:T,height:L})=>({x:A+v,y:S+u,width:T,height:L}));n.fillStyle=h.fill,n.globalAlpha=h.fillOpacity||1;const p=5;if(m.forEach(({x:A,y:S,width:T,height:L})=>n.fillRect(A,S-p/2,T,L+p)),h.underlineColor){n.globalAlpha=1,n.strokeStyle=h.underlineColor,n.lineWidth=h.underlineThickness??1;const A=p/2+(h.underlineOffset??0);m.forEach(({x:S,y:T,width:L,height:O})=>{n.beginPath(),n.moveTo(S,T+O+A),n.lineTo(S+L,T+O+A),n.stroke()})}})}),r=Te(()=>{dn(t)});return window.addEventListener("resize",r),{destroy:()=>{e.removeChild(t),window.removeEventListener("resize",r)},setVisible:i=>{console.log("setVisible not implemented on Canvas renderer")},redraw:o}},un=(e,t,n)=>Ce(e,t,n,cn(e));var fn={grad:.9,turn:360,rad:360/(2*Math.PI)},U=function(e){return typeof e=="string"?e.length>0:typeof e=="number"},B=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=Math.pow(10,t)),Math.round(n*e)/n+0},D=function(e,t,n){return t===void 0&&(t=0),n===void 0&&(n=1),e>n?n:e>t?e:t},Ke=function(e){return(e=isFinite(e)?e%360:0)>0?e:e+360},Re=function(e){return{r:D(e.r,0,255),g:D(e.g,0,255),b:D(e.b,0,255),a:D(e.a)}},he=function(e){return{r:B(e.r),g:B(e.g),b:B(e.b),a:B(e.a,3)}},hn=/^#([0-9a-f]{3,8})$/i,te=function(e){var t=e.toString(16);return t.length<2?"0"+t:t},Qe=function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=Math.max(t,n,o),s=i-Math.min(t,n,o),a=s?i===t?(n-o)/s:i===n?2+(o-t)/s:4+(t-n)/s:0;return{h:60*(a<0?a+6:a),s:i?s/i*100:0,v:i/255*100,a:r}},Ze=function(e){var t=e.h,n=e.s,o=e.v,r=e.a;t=t/360*6,n/=100,o/=100;var i=Math.floor(t),s=o*(1-n),a=o*(1-(t-i)*n),l=o*(1-(1-t+i)*n),d=i%6;return{r:255*[o,a,s,s,l,o][d],g:255*[l,o,o,a,s,s][d],b:255*[s,s,l,o,o,a][d],a:r}},Me=function(e){return{h:Ke(e.h),s:D(e.s,0,100),l:D(e.l,0,100),a:D(e.a)}},Be=function(e){return{h:B(e.h),s:B(e.s),l:B(e.l),a:B(e.a,3)}},Ie=function(e){return Ze((n=(t=e).s,{h:t.h,s:(n*=((o=t.l)<50?o:100-o)/100)>0?2*n/(o+n)*100:0,v:o+n,a:t.a}));var t,n,o},ee=function(e){return{h:(t=Qe(e)).h,s:(r=(200-(n=t.s))*(o=t.v)/100)>0&&r<200?n*o/100/(r<=100?r:200-r)*100:0,l:r/2,a:t.a};var t,n,o,r},pn=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s*,\s*([+-]?\d*\.?\d+)%\s*,\s*([+-]?\d*\.?\d+)%\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,gn=/^hsla?\(\s*([+-]?\d*\.?\d+)(deg|rad|grad|turn)?\s+([+-]?\d*\.?\d+)%\s+([+-]?\d*\.?\d+)%\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,mn=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*,\s*([+-]?\d*\.?\d+)(%)?\s*(?:,\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,bn=/^rgba?\(\s*([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s+([+-]?\d*\.?\d+)(%)?\s*(?:\/\s*([+-]?\d*\.?\d+)(%)?\s*)?\)$/i,ke={string:[[function(e){var t=hn.exec(e);return t?(e=t[1]).length<=4?{r:parseInt(e[0]+e[0],16),g:parseInt(e[1]+e[1],16),b:parseInt(e[2]+e[2],16),a:e.length===4?B(parseInt(e[3]+e[3],16)/255,2):1}:e.length===6||e.length===8?{r:parseInt(e.substr(0,2),16),g:parseInt(e.substr(2,2),16),b:parseInt(e.substr(4,2),16),a:e.length===8?B(parseInt(e.substr(6,2),16)/255,2):1}:null:null},"hex"],[function(e){var t=mn.exec(e)||bn.exec(e);return t?t[2]!==t[4]||t[4]!==t[6]?null:Re({r:Number(t[1])/(t[2]?100/255:1),g:Number(t[3])/(t[4]?100/255:1),b:Number(t[5])/(t[6]?100/255:1),a:t[7]===void 0?1:Number(t[7])/(t[8]?100:1)}):null},"rgb"],[function(e){var t=pn.exec(e)||gn.exec(e);if(!t)return null;var n,o,r=Me({h:(n=t[1],o=t[2],o===void 0&&(o="deg"),Number(n)*(fn[o]||1)),s:Number(t[3]),l:Number(t[4]),a:t[5]===void 0?1:Number(t[5])/(t[6]?100:1)});return Ie(r)},"hsl"]],object:[[function(e){var t=e.r,n=e.g,o=e.b,r=e.a,i=r===void 0?1:r;return U(t)&&U(n)&&U(o)?Re({r:Number(t),g:Number(n),b:Number(o),a:Number(i)}):null},"rgb"],[function(e){var t=e.h,n=e.s,o=e.l,r=e.a,i=r===void 0?1:r;if(!U(t)||!U(n)||!U(o))return null;var s=Me({h:Number(t),s:Number(n),l:Number(o),a:Number(i)});return Ie(s)},"hsl"],[function(e){var t=e.h,n=e.s,o=e.v,r=e.a,i=r===void 0?1:r;if(!U(t)||!U(n)||!U(o))return null;var s=function(a){return{h:Ke(a.h),s:D(a.s,0,100),v:D(a.v,0,100),a:D(a.a)}}({h:Number(t),s:Number(n),v:Number(o),a:Number(i)});return Ze(s)},"hsv"]]},Ve=function(e,t){for(var n=0;n<t.length;n++){var o=t[n][0](e);if(o)return[o,t[n][1]]}return[null,void 0]},yn=function(e){return typeof e=="string"?Ve(e.trim(),ke.string):typeof e=="object"&&e!==null?Ve(e,ke.object):[null,void 0]},pe=function(e,t){var n=ee(e);return{h:n.h,s:D(n.s+100*t,0,100),l:n.l,a:n.a}},ge=function(e){return(299*e.r+587*e.g+114*e.b)/1e3/255},_e=function(e,t){var n=ee(e);return{h:n.h,s:n.s,l:D(n.l+100*t,0,100),a:n.a}},De=function(){function e(t){this.parsed=yn(t)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return e.prototype.isValid=function(){return this.parsed!==null},e.prototype.brightness=function(){return B(ge(this.rgba),2)},e.prototype.isDark=function(){return ge(this.rgba)<.5},e.prototype.isLight=function(){return ge(this.rgba)>=.5},e.prototype.toHex=function(){return t=he(this.rgba),n=t.r,o=t.g,r=t.b,s=(i=t.a)<1?te(B(255*i)):"","#"+te(n)+te(o)+te(r)+s;var t,n,o,r,i,s},e.prototype.toRgb=function(){return he(this.rgba)},e.prototype.toRgbString=function(){return t=he(this.rgba),n=t.r,o=t.g,r=t.b,(i=t.a)<1?"rgba("+n+", "+o+", "+r+", "+i+")":"rgb("+n+", "+o+", "+r+")";var t,n,o,r,i},e.prototype.toHsl=function(){return Be(ee(this.rgba))},e.prototype.toHslString=function(){return t=Be(ee(this.rgba)),n=t.h,o=t.s,r=t.l,(i=t.a)<1?"hsla("+n+", "+o+"%, "+r+"%, "+i+")":"hsl("+n+", "+o+"%, "+r+"%)";var t,n,o,r,i},e.prototype.toHsv=function(){return t=Qe(this.rgba),{h:B(t.h),s:B(t.s),v:B(t.v),a:B(t.a,3)};var t},e.prototype.invert=function(){return $({r:255-(t=this.rgba).r,g:255-t.g,b:255-t.b,a:t.a});var t},e.prototype.saturate=function(t){return t===void 0&&(t=.1),$(pe(this.rgba,t))},e.prototype.desaturate=function(t){return t===void 0&&(t=.1),$(pe(this.rgba,-t))},e.prototype.grayscale=function(){return $(pe(this.rgba,-1))},e.prototype.lighten=function(t){return t===void 0&&(t=.1),$(_e(this.rgba,t))},e.prototype.darken=function(t){return t===void 0&&(t=.1),$(_e(this.rgba,-t))},e.prototype.rotate=function(t){return t===void 0&&(t=15),this.hue(this.hue()+t)},e.prototype.alpha=function(t){return typeof t=="number"?$({r:(n=this.rgba).r,g:n.g,b:n.b,a:t}):B(this.rgba.a,3);var n},e.prototype.hue=function(t){var n=ee(this.rgba);return typeof t=="number"?$({h:t,s:n.s,l:n.l,a:n.a}):B(n.h)},e.prototype.isEqual=function(t){return this.toHex()===$(t).toHex()},e}(),$=function(e){return e instanceof De?e:new De(e)};const vn=e=>[`background-color:${$(e?.fill||X.fill).alpha(e?.fillOpacity===void 0?X.fillOpacity:e.fillOpacity).toHex()}`,e!=null&&e.underlineThickness?"text-decoration:underline":void 0,e!=null&&e.underlineColor?`text-decoration-color:${e.underlineColor}`:void 0,e!=null&&e.underlineOffset?`text-underline-offset:${e.underlineOffset}px`:void 0,e!=null&&e.underlineThickness?`text-decoration-thickness:${e.underlineThickness}px`:void 0].filter(Boolean).join(";"),An=()=>{const e=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(e);let t=new Set;return{destroy:()=>{CSS.highlights.clear(),e.remove()},setVisible:n=>{console.log("setVisible not implemented on CSS Custom Highlights renderer")},redraw:(n,o,r,i)=>{i&&i.clear();const s=new Set(n.map(l=>l.annotation.id));Array.from(t).filter(l=>!s.has(l));const a=n.map(l=>{var d;const g=r?typeof r=="function"?r(l.annotation,l.state):r:(d=l.state)!=null&&d.selected?se:X,u=i&&i.paint(l,o)||g;return`::highlight(_${l.annotation.id}) { ${vn(u)} }`});e.innerHTML=a.join(`
`),CSS.highlights.clear(),n.forEach(({annotation:l})=>{const d=l.target.selector.map(u=>u.range),g=new Highlight(...d);CSS.highlights.set(`_${l.id}`,g)}),t=s}}},wn=(e,t,n)=>Ce(e,t,n,An());var $e=Object.prototype.hasOwnProperty;function Se(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&Se(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if($e.call(e,n)&&++o&&!$e.call(t,n)||!(n in t)||!Se(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}const xn=(e,t)=>{const n=(o,r)=>o.x<=r.x+r.width&&o.x+o.width>=r.x&&o.y<=r.y+r.height&&o.y+o.height>=r.y;return t.filter(o=>e!==o&&n(e,o)&&o.width>e.width).length},En=e=>{e.classList.add("r6o-annotatable");const t=document.createElement("div");t.className="r6o-span-highlight-layer",e.insertBefore(t,e.firstChild);let n=[];return{destroy:()=>{t.remove()},redraw:(o,r,i,s,a)=>{const l=!(Se(n,o)&&a);if(!s&&!l)return;l&&(t.innerHTML="");const d=o.reduce((g,{rects:u})=>[...g,...u],[]);o.forEach(g=>{g.rects.map(u=>{const v=xn(u,d),c=Wt(g,r,i,s,v);if(l){const b=document.createElement("span");b.className="r6o-annotation",b.dataset.annotation=g.annotation.id,b.style.left=`${u.x}px`,b.style.top=`${u.y}px`,b.style.width=`${u.width}px`,b.style.height=`${u.height}px`;const f=$(c?.fill||X.fill).alpha(c?.fillOpacity===void 0?X.fillOpacity:c.fillOpacity).toHex();b.style.backgroundColor=f,c.underlineStyle&&(b.style.borderStyle=c.underlineStyle),c.underlineColor&&(b.style.borderColor=c.underlineColor),c.underlineThickness&&(b.style.borderBottomWidth=`${c.underlineThickness}px`),c.underlineOffset&&(b.style.paddingBottom=`${c.underlineOffset}px`),t.appendChild(b)}})}),n=o},setVisible:o=>{o?t.classList.remove("hidden"):t.classList.add("hidden")}}},Sn=(e,t,n)=>Ce(e,t,n,En(e));var I=[];for(var me=0;me<256;++me)I.push((me+256).toString(16).slice(1));function Tn(e,t=0){return(I[e[t+0]]+I[e[t+1]]+I[e[t+2]]+I[e[t+3]]+"-"+I[e[t+4]]+I[e[t+5]]+"-"+I[e[t+6]]+I[e[t+7]]+"-"+I[e[t+8]]+I[e[t+9]]+"-"+I[e[t+10]]+I[e[t+11]]+I[e[t+12]]+I[e[t+13]]+I[e[t+14]]+I[e[t+15]]).toLowerCase()}var ne,Cn=new Uint8Array(16);function Nn(){if(!ne&&(ne=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ne))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ne(Cn)}var Ln=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Ue={randomUUID:Ln};function et(e,t,n){if(Ue.randomUUID&&!t&&!e)return Ue.randomUUID();e=e||{};var o=e.random||(e.rng||Nn)();return o[6]=o[6]&15|64,o[8]=o[8]&63|128,Tn(o)}var He=Object.prototype.hasOwnProperty;function q(e,t){var n,o;if(e===t)return!0;if(e&&t&&(n=e.constructor)===t.constructor){if(n===Date)return e.getTime()===t.getTime();if(n===RegExp)return e.toString()===t.toString();if(n===Array){if((o=e.length)===t.length)for(;o--&&q(e[o],t[o]););return o===-1}if(!n||typeof e=="object"){o=0;for(n in e)if(He.call(e,n)&&++o&&!He.call(t,n)||!(n in t)||!q(e[n],t[n]))return!1;return Object.keys(t).length===o}}return e!==e&&t!==t}function be(){}function On(e,t){return e!=e?t==t:e!==t||e&&typeof e=="object"||typeof e=="function"}const P=[];function Ne(e,t=be){let n;const o=new Set;function r(a){if(On(e,a)&&(e=a,n)){const l=!P.length;for(const d of o)d[1](),P.push(d,e);if(l){for(let d=0;d<P.length;d+=2)P[d][0](P[d+1]);P.length=0}}}function i(a){r(a(e))}function s(a,l=be){const d=[a,l];return o.add(d),o.size===1&&(n=t(r,i)||be),a(e),()=>{o.delete(d),o.size===0&&n&&(n(),n=null)}}return{set:r,update:i,subscribe:s}}const Rn=e=>{const{subscribe:t,set:n}=Ne();let o;return t(r=>o=r),e.observe(({changes:r})=>{if(o){(r.deleted||[]).some(s=>s.id===o)&&n(void 0);const i=(r.updated||[]).find(({oldValue:s})=>s.id===o);i&&n(i.newValue.id)}}),{get current(){return o},subscribe:t,set:n}},ye={selected:[]},Mn=(e,t="EDIT")=>{const{subscribe:n,set:o}=Ne(ye);let r=ye;n(u=>r=u);const i=()=>o(ye),s=()=>{var u;return((u=r.selected)==null?void 0:u.length)===0},a=u=>{if(r.selected.length===0)return!1;const v=typeof u=="string"?u:u.id;return r.selected.some(c=>c.id===v)},l=(u,v)=>{const c=e.getAnnotation(u);if(c){const b=je(c,t);o(b==="EDIT"?{selected:[{id:u,editable:!0}],pointerEvent:v}:b==="SELECT"?{selected:[{id:u}],pointerEvent:v}:{selected:[],pointerEvent:v})}else console.warn("Invalid selection: "+u)},d=(u,v)=>{const c=Array.isArray(u)?u:[u],b=c.map(f=>e.getAnnotation(f)).filter(Boolean);o({selected:b.map(f=>{const h=v===void 0?je(f,t)==="EDIT":v;return{id:f.id,editable:h}})}),b.length!==c.length&&console.warn("Invalid selection",u)},g=u=>{if(r.selected.length===0)return!1;const{selected:v}=r;v.filter(({id:c})=>u.includes(c)).length>0&&o({selected:v.filter(({id:c})=>!u.includes(c))})};return e.observe(({changes:u})=>g((u.deleted||[]).map(v=>v.id))),{clear:i,clickSelect:l,get selected(){return r?[...r.selected]:null},get pointerEvent(){return r?r.pointerEvent:null},isEmpty:s,isSelected:a,setSelected:d,subscribe:n}},je=(e,t)=>typeof t=="function"?t(e)||"EDIT":t||"EDIT";var Bn=[];for(var ve=0;ve<256;++ve)Bn.push((ve+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const In=(e,t)=>{const n=new Set(e.bodies.map(o=>o.id));return t.bodies.filter(o=>!n.has(o.id))},kn=(e,t)=>{const n=new Set(t.bodies.map(o=>o.id));return e.bodies.filter(o=>!n.has(o.id))},Vn=(e,t)=>t.bodies.map(n=>{const o=e.bodies.find(r=>r.id===n.id);return{newBody:n,oldBody:o&&!q(o,n)?o:void 0}}).filter(({oldBody:n})=>n).map(({oldBody:n,newBody:o})=>({oldBody:n,newBody:o})),_n=(e,t)=>!q(e.target,t.target),tt=(e,t)=>{const n=In(e,t),o=kn(e,t),r=Vn(e,t);return{oldValue:e,newValue:t,bodiesCreated:n.length>0?n:void 0,bodiesDeleted:o.length>0?o:void 0,bodiesUpdated:r.length>0?r:void 0,targetUpdated:_n(e,t)?{oldTarget:e.target,newTarget:t.target}:void 0}};var N=(e=>(e.LOCAL="LOCAL",e.REMOTE="REMOTE",e))(N||{});const Dn=(e,t)=>{var n,o;const{changes:r,origin:i}=t;if(!(!e.options.origin||e.options.origin===i))return!1;if(e.options.ignore){const{ignore:s}=e.options,a=l=>l&&l.length>0;if(!(a(r.created)||a(r.deleted))){const l=(n=r.updated)==null?void 0:n.some(g=>a(g.bodiesCreated)||a(g.bodiesDeleted)||a(g.bodiesUpdated)),d=(o=r.updated)==null?void 0:o.some(g=>g.targetUpdated);if(s==="BODY_ONLY"&&l&&!d||s==="TARGET_ONLY"&&d&&!l)return!1}}if(e.options.annotations){const s=new Set([...(r.created||[]).map(a=>a.id),...(r.deleted||[]).map(a=>a.id),...(r.updated||[]).map(({oldValue:a})=>a.id)]);return!!(Array.isArray(e.options.annotations)?e.options.annotations:[e.options.annotations]).find(a=>s.has(a))}else return!0},$n=(e,t)=>{const n=new Set((e.created||[]).map(u=>u.id)),o=new Set((e.updated||[]).map(({newValue:u})=>u.id)),r=new Set((t.created||[]).map(u=>u.id)),i=new Set((t.deleted||[]).map(u=>u.id)),s=new Set((t.updated||[]).map(({oldValue:u})=>u.id)),a=new Set((t.updated||[]).filter(({oldValue:u})=>n.has(u.id)||o.has(u.id)).map(({oldValue:u})=>u.id)),l=[...(e.created||[]).filter(u=>!i.has(u.id)).map(u=>s.has(u.id)?t.updated.find(({oldValue:v})=>v.id===u.id).newValue:u),...t.created||[]],d=[...(e.deleted||[]).filter(u=>!r.has(u.id)),...(t.deleted||[]).filter(u=>!n.has(u.id))],g=[...(e.updated||[]).filter(({newValue:u})=>!i.has(u.id)).map(u=>{const{oldValue:v,newValue:c}=u;if(s.has(c.id)){const b=t.updated.find(f=>f.oldValue.id===c.id).newValue;return tt(v,b)}else return u}),...(t.updated||[]).filter(({oldValue:u})=>!a.has(u.id))];return{created:l,deleted:d,updated:g}},Un=e=>e.id!==void 0,Hn=()=>{const e=new Map,t=new Map,n=[],o=(y,x={})=>n.push({onChange:y,options:x}),r=y=>{const x=n.findIndex(w=>w.onChange==y);x>-1&&n.splice(x,1)},i=(y,x)=>{const w={origin:y,changes:{created:x.created||[],updated:x.updated||[],deleted:x.deleted||[]},state:[...e.values()]};n.forEach(E=>{Dn(E,w)&&E.onChange(w)})},s=(y,x=N.LOCAL)=>{if(e.get(y.id))throw Error(`Cannot add annotation ${y.id} - exists already`);e.set(y.id,y),y.bodies.forEach(w=>t.set(w.id,y.id)),i(x,{created:[y]})},a=(y,x)=>{const w=typeof y=="string"?x:y,E=typeof y=="string"?y:y.id,C=e.get(E);if(C){const M=tt(C,w);return E===w.id?e.set(E,w):(e.delete(E),e.set(w.id,w)),C.bodies.forEach(k=>t.delete(k.id)),w.bodies.forEach(k=>t.set(k.id,w.id)),M}else console.warn(`Cannot update annotation ${E} - does not exist`)},l=(y,x=N.LOCAL,w=N.LOCAL)=>{const E=Un(x)?w:x,C=a(y,x);C&&i(E,{updated:[C]})},d=(y,x=N.LOCAL)=>{const w=y.reduce((E,C)=>{const M=a(C);return M?[...E,M]:E},[]);w.length>0&&i(x,{updated:w})},g=(y,x=N.LOCAL)=>{const w=e.get(y.annotation);if(w){const E={...w,bodies:[...w.bodies,y]};e.set(w.id,E),t.set(y.id,E.id),i(x,{updated:[{oldValue:w,newValue:E,bodiesCreated:[y]}]})}else console.warn(`Attempt to add body to missing annotation: ${y.annotation}`)},u=()=>[...e.values()],v=(y=N.LOCAL)=>{const x=[...e.values()];e.clear(),t.clear(),i(y,{deleted:x})},c=(y,x=!0,w=N.LOCAL)=>{if(x){const E=[...e.values()];e.clear(),t.clear(),y.forEach(C=>{e.set(C.id,C),C.bodies.forEach(M=>t.set(M.id,C.id))}),i(w,{created:y,deleted:E})}else{const E=y.reduce((C,M)=>{const k=e.get(M.id);return k?[...C,k]:C},[]);if(E.length>0)throw Error(`Bulk insert would overwrite the following annotations: ${E.map(C=>C.id).join(", ")}`);y.forEach(C=>{e.set(C.id,C),C.bodies.forEach(M=>t.set(M.id,C.id))}),i(w,{created:y})}},b=y=>{const x=typeof y=="string"?y:y.id,w=e.get(x);if(w)return e.delete(x),w.bodies.forEach(E=>t.delete(E.id)),w;console.warn(`Attempt to delete missing annotation: ${x}`)},f=(y,x=N.LOCAL)=>{const w=b(y);w&&i(x,{deleted:[w]})},h=(y,x=N.LOCAL)=>{const w=y.reduce((E,C)=>{const M=b(C);return M?[...E,M]:E},[]);w.length>0&&i(x,{deleted:w})},m=y=>{const x=e.get(y.annotation);if(x){const w=x.bodies.find(E=>E.id===y.id);if(w){t.delete(w.id);const E={...x,bodies:x.bodies.filter(C=>C.id!==y.id)};return e.set(x.id,E),{oldValue:x,newValue:E,bodiesDeleted:[w]}}else console.warn(`Attempt to delete missing body ${y.id} from annotation ${y.annotation}`)}else console.warn(`Attempt to delete body from missing annotation ${y.annotation}`)},p=(y,x=N.LOCAL)=>{const w=m(y);w&&i(x,{updated:[w]})},A=(y,x=N.LOCAL)=>{const w=y.map(E=>m(E)).filter(Boolean);w.length>0&&i(x,{updated:w})},S=y=>{const x=e.get(y);return x?{...x}:void 0},T=y=>{const x=t.get(y);if(x){const w=S(x).bodies.find(E=>E.id===y);if(w)return w;console.error(`Store integrity error: body ${y} in index, but not in annotation`)}else console.warn(`Attempt to retrieve missing body: ${y}`)},L=(y,x)=>{if(y.annotation!==x.annotation)throw"Annotation integrity violation: annotation ID must be the same when updating bodies";const w=e.get(y.annotation);if(w){const E=w.bodies.find(M=>M.id===y.id),C={...w,bodies:w.bodies.map(M=>M.id===E.id?x:M)};return e.set(w.id,C),E.id!==x.id&&(t.delete(E.id),t.set(x.id,C.id)),{oldValue:w,newValue:C,bodiesUpdated:[{oldBody:E,newBody:x}]}}else console.warn(`Attempt to add body to missing annotation ${y.annotation}`)},O=(y,x,w=N.LOCAL)=>{const E=L(y,x);E&&i(w,{updated:[E]})},_=(y,x=N.LOCAL)=>{const w=y.map(E=>L({id:E.id,annotation:E.annotation},E)).filter(Boolean);i(x,{updated:w})},Y=y=>{const x=e.get(y.annotation);if(x){const w={...x,target:{...x.target,...y}};return e.set(x.id,w),{oldValue:x,newValue:w,targetUpdated:{oldTarget:x.target,newTarget:y}}}else console.warn(`Attempt to update target on missing annotation: ${y.annotation}`)};return{addAnnotation:s,addBody:g,all:u,bulkAddAnnotation:c,bulkDeleteAnnotation:h,bulkDeleteBodies:A,bulkUpdateAnnotation:d,bulkUpdateBodies:_,bulkUpdateTargets:(y,x=N.LOCAL)=>{const w=y.map(E=>Y(E)).filter(Boolean);w.length>0&&i(x,{updated:w})},clear:v,deleteAnnotation:f,deleteBody:p,getAnnotation:S,getBody:T,observe:o,unobserve:r,updateAnnotation:l,updateBody:O,updateTarget:(y,x=N.LOCAL)=>{const w=Y(y);w&&i(x,{updated:[w]})}}};let jn=()=>({emit(e,...t){for(let n=0,o=this.events[e]||[],r=o.length;n<r;n++)o[n](...t)},events:{},on(e,t){var n;return((n=this.events)[e]||(n[e]=[])).push(t),()=>{var o;this.events[e]=(o=this.events[e])==null?void 0:o.filter(r=>t!==r)}}});const Xn=250,Yn=e=>{const t=jn(),n=[];let o=-1,r=!1,i=0;const s=c=>{if(!r){const{changes:b}=c,f=performance.now();if(f-i>Xn)n.splice(o+1),n.push(b),o=n.length-1;else{const h=n.length-1;n[h]=$n(n[h],b)}i=f}r=!1};e.observe(s,{origin:N.LOCAL});const a=c=>c&&c.length>0&&e.bulkDeleteAnnotation(c),l=c=>c&&c.length>0&&e.bulkAddAnnotation(c,!1),d=c=>c&&c.length>0&&e.bulkUpdateAnnotation(c.map(({oldValue:b})=>b)),g=c=>c&&c.length>0&&e.bulkUpdateAnnotation(c.map(({newValue:b})=>b)),u=c=>c&&c.length>0&&e.bulkAddAnnotation(c,!1),v=c=>c&&c.length>0&&e.bulkDeleteAnnotation(c);return{canRedo:()=>n.length-1>o,canUndo:()=>o>-1,destroy:()=>e.unobserve(s),on:(c,b)=>t.on(c,b),redo:()=>{if(n.length-1>o){r=!0;const{created:c,updated:b,deleted:f}=n[o+1];l(c),g(b),v(f),t.emit("redo",n[o+1]),o+=1}},undo:()=>{if(o>-1){r=!0;const{created:c,updated:b,deleted:f}=n[o];a(c),d(b),u(f),t.emit("undo",n[o]),o-=1}}}},Pn=()=>{const{subscribe:e,set:t}=Ne([]);return{subscribe:e,set:t}},Fn=(e,t,n,o)=>{const{store:r,selection:i,hover:s,viewport:a}=e,l=new Map;let d=[],g;const u=(f,h)=>{l.has(f)?l.get(f).push(h):l.set(f,[h])},v=(f,h)=>{const m=l.get(f);m&&m.indexOf(h)>0&&m.splice(m.indexOf(h),1)},c=(f,h,m)=>{l.has(f)&&setTimeout(()=>{l.get(f).forEach(p=>{if(n){const A=Array.isArray(h)?h.map(T=>n.serialize(T)):n.serialize(h),S=m?m instanceof PointerEvent?m:n.serialize(m):void 0;p(A,S)}else p(h,m)})},1)};i.subscribe(({selected:f})=>{if(!(d.length===0&&f.length===0)){if(d.length===0&&f.length>0)d=f.map(({id:h})=>r.getAnnotation(h));else if(d.length>0&&f.length===0)d.forEach(h=>{const m=r.getAnnotation(h.id);m&&!q(m,h)&&c("updateAnnotation",m,h)}),d=[];else{const h=new Set(d.map(p=>p.id)),m=new Set(f.map(({id:p})=>p));d.filter(p=>!m.has(p.id)).forEach(p=>{const A=r.getAnnotation(p.id);A&&!q(A,p)&&c("updateAnnotation",A,p)}),d=[...d.filter(p=>m.has(p.id)),...f.filter(({id:p})=>!h.has(p)).map(({id:p})=>r.getAnnotation(p))]}c("selectionChanged",d)}}),s.subscribe(f=>{!g&&f?c("mouseEnterAnnotation",r.getAnnotation(f)):g&&!f?c("mouseLeaveAnnotation",r.getAnnotation(g)):g&&f&&(c("mouseLeaveAnnotation",r.getAnnotation(g)),c("mouseEnterAnnotation",r.getAnnotation(f))),g=f}),a?.subscribe(f=>c("viewportIntersect",f.map(h=>r.getAnnotation(h)))),r.observe(f=>{const{created:h,deleted:m}=f.changes;(h||[]).forEach(p=>c("createAnnotation",p)),(m||[]).forEach(p=>c("deleteAnnotation",p)),(f.changes.updated||[]).filter(p=>[...p.bodiesCreated||[],...p.bodiesDeleted||[],...p.bodiesUpdated||[]].length>0).forEach(({oldValue:p,newValue:A})=>{const S=d.find(T=>T.id===p.id)||p;d=d.map(T=>T.id===p.id?A:T),c("updateAnnotation",A,S)})},{origin:N.LOCAL}),r.observe(f=>{if(d){const h=new Set(d.map(p=>p.id)),m=(f.changes.updated||[]).filter(({newValue:p})=>h.has(p.id)).map(({newValue:p})=>p);m.length>0&&(d=d.map(p=>m.find(A=>A.id===p.id)||p))}},{origin:N.REMOTE});const b=f=>h=>{const{updated:m}=h;f?(m||[]).forEach(p=>c("updateAnnotation",p.oldValue,p.newValue)):(m||[]).forEach(p=>c("updateAnnotation",p.newValue,p.oldValue))};return t.on("undo",b(!0)),t.on("redo",b(!1)),{on:u,off:v,emit:c}},zn=e=>t=>t.reduce((n,o)=>{const{parsed:r,error:i}=e.parse(o);return i?{parsed:n.parsed,failed:[...n.failed,o]}:r?{parsed:[...n.parsed,r],failed:n.failed}:{...n}},{parsed:[],failed:[]}),qn=(e,t,n)=>{const{store:o,selection:r}=e,i=h=>{if(n){const{parsed:m,error:p}=n.parse(h);m?o.addAnnotation(m,N.REMOTE):console.error(p)}else o.addAnnotation(h,N.REMOTE)},s=()=>r.clear(),a=()=>o.clear(),l=h=>{const m=o.getAnnotation(h);return n&&m?n.serialize(m):m},d=()=>n?o.all().map(n.serialize):o.all(),g=()=>{var h;const m=(((h=r.selected)==null?void 0:h.map(p=>p.id))||[]).map(p=>o.getAnnotation(p)).filter(Boolean);return n?m.map(n.serialize):m},u=(h,m=!0)=>fetch(h).then(p=>p.json()).then(p=>(c(p,m),p)),v=h=>{if(typeof h=="string"){const m=o.getAnnotation(h);if(o.deleteAnnotation(h),m)return n?n.serialize(m):m}else{const m=n?n.parse(h).parsed:h;if(m)return o.deleteAnnotation(m),h}},c=(h,m=!0)=>{if(n){const{parsed:p,failed:A}=zn(n)(h);A.length>0&&console.warn(`Discarded ${A.length} invalid annotations`,A),o.bulkAddAnnotation(p,m,N.REMOTE)}else o.bulkAddAnnotation(h,m,N.REMOTE)},b=(h,m)=>{h?r.setSelected(h,m):r.clear()},f=h=>{if(n){const m=n.parse(h).parsed,p=n.serialize(o.getAnnotation(m.id));return o.updateAnnotation(m),p}else{const m=o.getAnnotation(h.id);return o.updateAnnotation(h),m}};return{addAnnotation:i,cancelSelected:s,canRedo:t.canRedo,canUndo:t.canUndo,clearAnnotations:a,getAnnotationById:l,getAnnotations:d,getSelected:g,loadAnnotations:u,redo:t.redo,removeAnnotation:v,setAnnotations:c,setSelected:b,undo:t.undo,updateAnnotation:f}},Wn="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";let Gn=e=>crypto.getRandomValues(new Uint8Array(e)),Jn=(e,t,n)=>{let o=(2<<Math.log(e.length-1)/Math.LN2)-1,r=-~(1.6*o*t/e.length);return(i=t)=>{let s="";for(;;){let a=n(r),l=r;for(;l--;)if(s+=e[a[l]&o]||"",s.length===i)return s}}},Kn=(e,t=21)=>Jn(e,t,Gn),Qn=(e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e));for(;e--;)t+=Wn[n[e]&63];return t};const Zn=()=>({isGuest:!0,id:Kn("1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",20)()}),eo=e=>{const t=JSON.stringify(e);let n=0;for(let o=0,r=t.length;o<r;o++){let i=t.charCodeAt(o);n=(n<<5)-n+i,n|=0}return`${n}`},nt=e=>e?typeof e=="object"?{...e}:e:void 0,to=(e,t)=>(Array.isArray(e)?e:[e]).map(n=>{const{id:o,type:r,purpose:i,value:s,created:a,modified:l,creator:d,...g}=n;return{id:o||`temp-${eo(n)}`,annotation:t,type:r,purpose:i,value:s,creator:nt(d),created:a?new Date(a):void 0,updated:l?new Date(l):void 0,...g}}),no=e=>e.map(t=>{var n;const{annotation:o,created:r,updated:i,...s}=t,a={...s,created:r?.toISOString(),modified:i?.toISOString()};return(n=a.id)!=null&&n.startsWith("temp-")&&delete a.id,a});Qn();const oo=(e,t)=>({parse:n=>ao(n),serialize:n=>so(n,e,t)}),ro=e=>e.quote!==void 0&&e.start!==void 0&&e.end!==void 0,io=e=>{const{id:t,creator:n,created:o,modified:r,target:i}=e,s=Array.isArray(i)?i:[i],a={creator:nt(n),created:o?new Date(o):void 0,updated:r?new Date(r):void 0,annotation:t,selector:[]};for(const l of s){const d=(Array.isArray(l.selector)?l.selector:[l.selector]).reduce((g,u)=>{switch(u.type){case"TextQuoteSelector":g.quote=u.exact;break;case"TextPositionSelector":g.start=u.start,g.end=u.end;break}return g},{});if(ro(d))a.selector.push({id:l.id,...d});else{const g=[d.start?void 0:"TextPositionSelector",d.quote?void 0:"TextQuoteSelector"].filter(Boolean);return{error:Error(`Missing selector types: ${g.join(" and ")} for annotation: ${e.id}`)}}}return{parsed:a}},ao=e=>{const t=e.id||et(),{creator:n,created:o,modified:r,body:i,...s}=e,a=to(i,t),l=io(e);return"error"in l?{error:l.error}:{parsed:{...s,id:t,bodies:a,target:l.parsed}}},so=(e,t,n)=>{const{bodies:o,target:r,...i}=e,{selector:s,creator:a,created:l,updated:d,...g}=r,u=s.map(v=>{const{quote:c,start:b,end:f,range:h}=v,{prefix:m,suffix:p}=Zt(h,n),A=[{type:"TextQuoteSelector",exact:c,prefix:m,suffix:p},{type:"TextPositionSelector",start:b,end:f}];return{...g,id:v.id,source:t,selector:A}});return{...i,"@context":"http://www.w3.org/ns/anno.jsonld",id:e.id,type:"Annotation",body:no(e.bodies),creator:a,created:l?.toISOString(),modified:d?.toISOString(),target:u}};function lo(e,t,n,o,r){ot(e,t,n||0,o||e.length-1,r||co)}function ot(e,t,n,o,r){for(;o>n;){if(o-n>600){var i=o-n+1,s=t-n+1,a=Math.log(i),l=.5*Math.exp(2*a/3),d=.5*Math.sqrt(a*l*(i-l)/i)*(s-i/2<0?-1:1),g=Math.max(n,Math.floor(t-s*l/i+d)),u=Math.min(o,Math.floor(t+(i-s)*l/i+d));ot(e,t,g,u,r)}var v=e[t],c=n,b=o;for(J(e,n,t),r(e[o],v)>0&&J(e,n,o);c<b;){for(J(e,c,b),c++,b--;r(e[c],v)<0;)c++;for(;r(e[b],v)>0;)b--}r(e[n],v)===0?J(e,n,b):(b++,J(e,b,o)),b<=t&&(n=b+1),t<=b&&(o=b-1)}}function J(e,t,n){var o=e[t];e[t]=e[n],e[n]=o}function co(e,t){return e<t?-1:e>t?1:0}class uo{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let n=this.data;const o=[];if(!re(t,n))return o;const r=this.toBBox,i=[];for(;n;){for(let s=0;s<n.children.length;s++){const a=n.children[s],l=n.leaf?r(a):a;re(t,l)&&(n.leaf?o.push(a):we(t,l)?this._all(a,o):i.push(a))}n=i.pop()}return o}collides(t){let n=this.data;if(!re(t,n))return!1;const o=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],s=n.leaf?this.toBBox(i):i;if(re(t,s)){if(n.leaf||we(t,s))return!0;o.push(i)}}n=o.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let o=0;o<t.length;o++)this.insert(t[o]);return this}let n=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){const o=this.data;this.data=n,n=o}this._insert(n,this.data.height-n.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=z([]),this}remove(t,n){if(!t)return this;let o=this.data;const r=this.toBBox(t),i=[],s=[];let a,l,d;for(;o||i.length;){if(o||(o=i.pop(),l=i[i.length-1],a=s.pop(),d=!0),o.leaf){const g=fo(t,o.children,n);if(g!==-1)return o.children.splice(g,1),i.push(o),this._condense(i),this}!d&&!o.leaf&&we(o,r)?(i.push(o),s.push(a),a=0,l=o,o=o.children[0]):l?(a++,o=l.children[a],d=!1):o=null}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,n){const o=[];for(;t;)t.leaf?n.push(...t.children):o.push(...t.children),t=o.pop();return n}_build(t,n,o,r){const i=o-n+1;let s=this._maxEntries,a;if(i<=s)return a=z(t.slice(n,o+1)),F(a,this.toBBox),a;r||(r=Math.ceil(Math.log(i)/Math.log(s)),s=Math.ceil(i/Math.pow(s,r-1))),a=z([]),a.leaf=!1,a.height=r;const l=Math.ceil(i/s),d=l*Math.ceil(Math.sqrt(s));Xe(t,n,o,d,this.compareMinX);for(let g=n;g<=o;g+=d){const u=Math.min(g+d-1,o);Xe(t,g,u,l,this.compareMinY);for(let v=g;v<=u;v+=l){const c=Math.min(v+l-1,u);a.children.push(this._build(t,v,c,r-1))}}return F(a,this.toBBox),a}_chooseSubtree(t,n,o,r){for(;r.push(n),!(n.leaf||r.length-1===o);){let i=1/0,s=1/0,a;for(let l=0;l<n.children.length;l++){const d=n.children[l],g=Ae(d),u=go(t,d)-g;u<s?(s=u,i=g<i?g:i,a=d):u===s&&g<i&&(i=g,a=d)}n=a||n.children[0]}return n}_insert(t,n,o){const r=o?t:this.toBBox(t),i=[],s=this._chooseSubtree(r,this.data,n,i);for(s.children.push(t),Q(s,r);n>=0&&i[n].children.length>this._maxEntries;)this._split(i,n),n--;this._adjustParentBBoxes(r,i,n)}_split(t,n){const o=t[n],r=o.children.length,i=this._minEntries;this._chooseSplitAxis(o,i,r);const s=this._chooseSplitIndex(o,i,r),a=z(o.children.splice(s,o.children.length-s));a.height=o.height,a.leaf=o.leaf,F(o,this.toBBox),F(a,this.toBBox),n?t[n-1].children.push(a):this._splitRoot(o,a)}_splitRoot(t,n){this.data=z([t,n]),this.data.height=t.height+1,this.data.leaf=!1,F(this.data,this.toBBox)}_chooseSplitIndex(t,n,o){let r,i=1/0,s=1/0;for(let a=n;a<=o-n;a++){const l=K(t,0,a,this.toBBox),d=K(t,a,o,this.toBBox),g=mo(l,d),u=Ae(l)+Ae(d);g<i?(i=g,r=a,s=u<s?u:s):g===i&&u<s&&(s=u,r=a)}return r||o-n}_chooseSplitAxis(t,n,o){const r=t.leaf?this.compareMinX:ho,i=t.leaf?this.compareMinY:po,s=this._allDistMargin(t,n,o,r),a=this._allDistMargin(t,n,o,i);s<a&&t.children.sort(r)}_allDistMargin(t,n,o,r){t.children.sort(r);const i=this.toBBox,s=K(t,0,n,i),a=K(t,o-n,o,i);let l=oe(s)+oe(a);for(let d=n;d<o-n;d++){const g=t.children[d];Q(s,t.leaf?i(g):g),l+=oe(s)}for(let d=o-n-1;d>=n;d--){const g=t.children[d];Q(a,t.leaf?i(g):g),l+=oe(a)}return l}_adjustParentBBoxes(t,n,o){for(let r=o;r>=0;r--)Q(n[r],t)}_condense(t){for(let n=t.length-1,o;n>=0;n--)t[n].children.length===0?n>0?(o=t[n-1].children,o.splice(o.indexOf(t[n]),1)):this.clear():F(t[n],this.toBBox)}}function fo(e,t,n){if(!n)return t.indexOf(e);for(let o=0;o<t.length;o++)if(n(e,t[o]))return o;return-1}function F(e,t){K(e,0,e.children.length,t,e)}function K(e,t,n,o,r){r||(r=z(null)),r.minX=1/0,r.minY=1/0,r.maxX=-1/0,r.maxY=-1/0;for(let i=t;i<n;i++){const s=e.children[i];Q(r,e.leaf?o(s):s)}return r}function Q(e,t){return e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),e}function ho(e,t){return e.minX-t.minX}function po(e,t){return e.minY-t.minY}function Ae(e){return(e.maxX-e.minX)*(e.maxY-e.minY)}function oe(e){return e.maxX-e.minX+(e.maxY-e.minY)}function go(e,t){return(Math.max(t.maxX,e.maxX)-Math.min(t.minX,e.minX))*(Math.max(t.maxY,e.maxY)-Math.min(t.minY,e.minY))}function mo(e,t){const n=Math.max(e.minX,t.minX),o=Math.max(e.minY,t.minY),r=Math.min(e.maxX,t.maxX),i=Math.min(e.maxY,t.maxY);return Math.max(0,r-n)*Math.max(0,i-o)}function we(e,t){return e.minX<=t.minX&&e.minY<=t.minY&&t.maxX<=e.maxX&&t.maxY<=e.maxY}function re(e,t){return t.minX<=e.maxX&&t.minY<=e.maxY&&t.maxX>=e.minX&&t.maxY>=e.minY}function z(e){return{children:e,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Xe(e,t,n,o,r){const i=[t,n];for(;i.length;){if(n=i.pop(),t=i.pop(),n-t<=o)continue;const s=t+Math.ceil((n-t)/o/2)*o;lo(e,s,t,n,r),i.push(t,s,s,n)}}const bo=(e,t)=>{const n=new uo,o=new Map,r=(b,f)=>{const h=b.selector.flatMap(p=>{const A=p.range instanceof Range&&!p.range.collapsed&&p.range.startContainer.nodeType===Node.TEXT_NODE&&p.range.endContainer.nodeType===Node.TEXT_NODE?p.range:Je(p,t).range;return Array.from(A.getClientRects())}),m=nn(h).map(({left:p,top:A,right:S,bottom:T})=>new DOMRect(p-f.left,A-f.top,S-p,T-A));return m.map(p=>{const{x:A,y:S,width:T,height:L}=p;return{minX:A,minY:S,maxX:A+T,maxY:S+L,annotation:{id:b.annotation,rects:m}}})},i=()=>[...o.values()],s=()=>{n.clear(),o.clear()},a=b=>{const f=r(b,t.getBoundingClientRect());f.forEach(h=>n.insert(h)),o.set(b.annotation,f)},l=b=>{const f=o.get(b.annotation);f&&(f.forEach(h=>n.remove(h)),o.delete(b.annotation))},d=b=>{l(b),a(b)},g=(b,f=!0)=>{f&&s();const h=t.getBoundingClientRect(),m=b.map(A=>({target:A,rects:r(A,h)}));m.forEach(({target:A,rects:S})=>o.set(A.annotation,S));const p=m.reduce((A,{rects:S})=>[...A,...S],[]);n.load(p)},u=(b,f)=>{const h=n.search({minX:b,minY:f,maxX:b,maxY:f}),m=p=>p.annotation.rects.reduce((A,S)=>A+S.width*S.height,0);if(h.length>0)return h.sort((p,A)=>m(p)-m(A)),h[0].annotation.id},v=b=>{const f=c(b);if(f.length===0)return;let h=f[0].left,m=f[0].top,p=f[0].right,A=f[0].bottom;for(let S=1;S<f.length;S++){const T=f[S];h=Math.min(h,T.left),m=Math.min(m,T.top),p=Math.max(p,T.right),A=Math.max(A,T.bottom)}return new DOMRect(h,m,p-h,A-m)},c=b=>{const f=o.get(b);return f?f[0].annotation.rects:[]};return{all:i,clear:s,getAt:u,getAnnotationBounds:v,getAnnotationRects:c,getIntersecting:(b,f,h,m)=>{const p=n.search({minX:b,minY:f,maxX:h,maxY:m}),A=new Set(p.reduce((S,T)=>[...S,T.annotation.id],[]));return Array.from(A).map(S=>({annotation:e.getAnnotation(S),rects:c(S)})).filter(S=>!!S.annotation)},insert:a,recalculate:()=>g(e.all().map(b=>b.target),!0),remove:l,set:g,size:()=>n.all().length,update:d}},yo=(e,t)=>{const n=Hn(),o=bo(n,e),r=Mn(n,t),i=Rn(n),s=Pn(),a=(f,h=N.LOCAL)=>{const m=fe(f,e),p=j(m.target.selector);return p&&n.addAnnotation(m,h),p},l=(f,h=!0,m=N.LOCAL)=>{const p=f.map(S=>fe(S,e)),A=p.filter(S=>!j(S.target.selector));return A.length>0?(console.warn("Could not revive all targets for these annotations:",A),n.bulkAddAnnotation(p,h,m),A):(n.bulkAddAnnotation(p,h,m),[])},d=(f,h=N.LOCAL)=>{const m=f.map(A=>fe(A,e)),p=m.filter(A=>!j(A.target.selector));return p.length>0&&console.warn("Could not revive all targets for these annotations:",p),m.forEach(A=>{n.getAnnotation(A.id)?n.updateAnnotation(A,h):n.addAnnotation(A,h)}),p},g=(f,h=N.LOCAL)=>{const m=le(f,e);n.updateTarget(m,h)},u=(f,h=N.LOCAL)=>{const m=f.map(p=>le(p,e));n.bulkUpdateTargets(m,h)},v=(f,h)=>{const m=o.getAt(f,h);return m?n.getAnnotation(m):void 0},c=(f,h,m,p=5)=>{const A=o.getAnnotationRects(f);if(A.length!==0){if(h&&m){const S=A.find(({top:T,right:L,bottom:O,left:_})=>h>=_-p&&h<=L+p&&m>=T-p&&m<=O+p);if(S)return S}return o.getAnnotationBounds(f)}},b=()=>o.recalculate();return n.observe(({changes:f})=>{const h=(f.created||[]).filter(A=>j(A.target.selector)),m=(f.deleted||[]).filter(A=>j(A.target.selector)),p=(f.updated||[]).filter(A=>j(A.newValue.target.selector));h.length>0&&o.set(h.map(A=>A.target),!1),m?.length>0&&m.forEach(A=>o.remove(A.target)),p?.length>0&&p.forEach(({newValue:A})=>o.update(A.target))}),{store:{...n,addAnnotation:a,bulkAddAnnotation:l,bulkUpdateTargets:u,bulkUpsertAnnotations:d,getAnnotationBounds:c,getAt:v,getIntersecting:o.getIntersecting,recalculatePositions:b,updateTarget:g},selection:r,hover:i,viewport:s}},vo=()=>{const e=document.createElement("canvas");e.width=2*window.innerWidth,e.height=2*window.innerHeight,e.className="r6o-highlight-layer presence";const t=e.getContext("2d");return t.scale(2,2),t.translate(.5,.5),e},Ao=(e,t,n={})=>{const o=vo(),r=o.getContext("2d");e.appendChild(o);const i=new Map,s=a=>Array.from(i.entries()).filter(([l,d])=>d.presenceKey===a.presenceKey).map(([l,d])=>l);return t.on("selectionChange",(a,l)=>{s(a).forEach(d=>i.delete(d)),l&&l.forEach(d=>i.set(d,a))}),{clear:()=>{const{width:a,height:l}=o;r.clearRect(-.5,-.5,a+1,l+1)},destroy:()=>{o.remove()},paint:(a,l,d)=>{n.font&&(r.font=n.font);const g=i.get(a.annotation.id);if(g){const{height:u}=a.rects[0],v=a.rects[0].x+l.left,c=a.rects[0].y+l.top;r.fillStyle=g.appearance.color,r.fillRect(v-2,c-2.5,2,u+5);const b=r.measureText(g.appearance.label),f=b.width+6,h=b.actualBoundingBoxAscent+b.actualBoundingBoxDescent+8,m=b.fontBoundingBoxAscent?8:6.5;return r.fillRect(v-2,c-2.5-h,f,h),r.fillStyle="#fff",r.fillText(g.appearance.label,v+1,c-m),{fill:g.appearance.color,fillOpacity:d?.45:.18}}},reset:()=>{o.width=2*window.innerWidth,o.height=2*window.innerHeight;const a=o.getContext("2d");a.scale(2,2),a.translate(.5,.5)}}},rt=e=>{if(e===null)return document.scrollingElement;const{overflowY:t}=window.getComputedStyle(e);return t!=="visible"&&t!=="hidden"&&e.scrollHeight>e.clientHeight?e:rt(e.parentElement)},wo=(e,t)=>n=>{const o=typeof n=="string"?n:n.id,r=s=>{const a=i.getBoundingClientRect(),l=i.clientHeight,d=i.clientWidth,g=s.selector[0].range.getBoundingClientRect(),{width:u,height:v}=t.getAnnotationBounds(o),c=g.top-a.top,b=g.left-a.left,f=i.parentElement?i.scrollTop:0,h=i.parentElement?i.scrollLeft:0,m=c+f-(l-v)/2,p=b+h-(d-u)/2;i.scroll({top:m,left:p,behavior:"smooth"})},i=rt(e);if(i){const s=t.getAnnotation(o),{range:a}=s.target.selector[0];if(a&&!a.collapsed)return r(s.target),!0;{const l=le(s.target,e),{range:d}=l.selector[0];if(d&&!d.collapsed)return r(l),!0}}return!1},xo=(e,t)=>({...e,annotationEnabled:e.annotationEnabled===void 0?t.annotationEnabled:e.annotationEnabled}),Eo=(e,t,n,o)=>{const{store:r,selection:i}=t;let s,a;const l=f=>s=f;let d=!1,g;const u=f=>{var h;d&&((h=f.target.parentElement)!=null&&h.closest(H)?a=void 0:a={annotation:et(),selector:[],creator:s,created:new Date})};n&&e.addEventListener("selectstart",u);const v=Te(f=>{var h,m;const p=document.getSelection();if((m=(h=p.anchorNode)==null?void 0:h.parentElement)!=null&&m.closest(H)){a=void 0;return}if(f.timeStamp-(g?.timeStamp||f.timeStamp)<1e3&&!a&&u(g),p.isCollapsed||!d||!a)return;const A=p.getRangeAt(0),S=rn(A.cloneRange()),T=Kt(S);(T.length!==a.selector.length||T.some((L,O)=>{var _;return L.toString()!==((_=a.selector[O])==null?void 0:_.quote)}))&&(a={...a,selector:T.map(L=>on(L,e,o)),updated:new Date},r.getAnnotation(a.annotation)?r.updateTarget(a,N.LOCAL):(r.addAnnotation({id:a.annotation,bodies:[],target:a}),i.clickSelect(a.annotation,g)))});n&&document.addEventListener("selectionchange",v);const c=f=>{const{target:h,timeStamp:m,offsetX:p,offsetY:A,type:S}=f;g={...f,target:h,timeStamp:m,offsetX:p,offsetY:A,type:S},d=f.button===0};e.addEventListener("pointerdown",c);const b=f=>{var h;if((h=f.target.parentElement)!=null&&h.closest(H)||!d)return;const m=()=>{const{x:A,y:S}=e.getBoundingClientRect(),T=r.getAt(f.clientX-A,f.clientY-S);if(T){const{selected:L}=i;(L.length!==1||L[0].id!==T.id)&&i.clickSelect(T.id,f)}else i.isEmpty()||i.clear()},p=f.timeStamp-g.timeStamp;document.getSelection().isCollapsed&&p<300?(a=void 0,m()):a&&i.clickSelect(a.annotation,f)};return document.addEventListener("pointerup",b),{destroy:()=>{e.removeEventListener("selectstart",u),document.removeEventListener("selectionchange",v),e.removeEventListener("pointerdown",c),document.removeEventListener("pointerup",b)},setUser:l}},Ye="SPANS",So=(e,t={})=>{Qt(e);const n=xo(t,{annotationEnabled:!0}),o=yo(e,n.pointerAction),{selection:r,viewport:i}=o,s=o.store,a=Yn(s),l=Fn(o,a,n.adapter);let d=Zn();const g=n.renderer==="CSS_HIGHLIGHTS"?CSS.highlights?"CSS_HIGHLIGHTS":Ye:n.renderer||Ye,u=g==="SPANS"?Sn(e,o,i):g==="CSS_HIGHLIGHTS"?wn(e,o,i):g==="CANVAS"?un(e,o,i):void 0;if(!u)throw`Unknown renderer implementation: ${g}`;console.debug(`Using ${g} renderer`),n.style&&u.setStyle(n.style);const v=Eo(e,o,n.annotationEnabled,n.offsetReferenceSelector);return v.setUser(d),{...qn(o,a,n.adapter),destroy:()=>{u.destroy(),v.destroy(),a.destroy()},element:e,getUser:()=>d,setFilter:c=>u.setFilter(c),setStyle:c=>u.setStyle(c),setUser:c=>{d=c,v.setUser(c)},setSelected:c=>{c?r.setSelected(c):r.clear()},setPresenceProvider:c=>{c&&(u.setPainter(Ao(e,c,n.presence)),c.on("selectionChange",()=>u.redraw()))},setVisible:c=>u.setVisible(c),on:l.on,off:l.off,scrollIntoView:wo(e,s),state:o}},To=e=>{const t=R.useRef(null),{className:n,children:o,...r}=e,{anno:i,setAnno:s}=R.useContext(dt);return R.useEffect(()=>{if(!s)return;const a=typeof r.adapter=="function"?r.adapter(t.current):r.adapter,l=So(t.current,{...r,adapter:a});return s(l),()=>l.destroy()},[s]),R.useEffect(()=>{i&&i.setStyle(e.style)},[i,e.style]),R.useEffect(()=>{i&&i.setFilter(e.filter)},[i,e.filter]),Ot.jsx("div",{ref:t,className:n,children:o})},Co=()=>{const[e,t]=R.useState();return R.useEffect(()=>{fetch("../../thesaurus/narratives.json").then(n=>n.json()).then(n=>{const o=n.map(r=>r.prefLabel?.trim()).filter(Boolean);t(new Set(o))})},[]),e},No=e=>{const[t,n]=R.useState(),[o,r]=R.useState(!1),{refs:i,floatingStyles:s}=ct({placement:"bottom",open:o,onOpenChange:r,middleware:[pt(4),gt(),mt(),bt({crossAxis:!0,padding:{top:5,bottom:5}})],whileElementsMounted:yt});return R.useEffect(()=>{if(e.annotation){const a=e.annotation.target.selector,l=Array.isArray(a)?a[0].range:a.range;l&&!l.collapsed&&(i.setReference({getBoundingClientRect:()=>l.getBoundingClientRect(),getClientRects:()=>{const d=t?ut(l.getClientRects(),t):l.getClientRects()[0];return ft(d)}}),r(!0))}else r(!1)},[e.annotation,t]),R.useEffect(()=>{const a=l=>{const{clientX:d,clientY:g}=l;n({x:d,y:g})};return window.document.addEventListener("pointerup",a),()=>{window.document.removeEventListener("pointerup",a)}},[]),e.annotation&&o&&V.jsx("div",{className:"text-annotation-popup not-annotatable",ref:i.setFloating,style:s,children:V.jsx(ht,{type:"VERSE",annotation:e.annotation,relatedImages:e.relatedImages||[],relatedVerses:e.relatedVerses||[],onClickImages:e.onClickImages,onClickVerses:e.onClickVerses})})},Lo=e=>{const{searchResults:t,highlightedSearchResult:n}=e,o=vt(),r=At(),{images:i,verses:s}=wt(r),a=Co(),l=R.useCallback(d=>{const u=d.bodies.find(v=>v.value&&a.has(v.value))?{fill:"#000",fillOpacity:.05}:{fill:"#ff5e5e",fillOpacity:.4,underlineThickness:2,underlineColor:"#e05252"};return t.length===0?u:d.id===n?.id?{...u,fill:"#ff9100",underlineColor:"#ca852b"}:new Set(t.map(c=>c.id)).has(d.id)?{...u,fill:"#fff800",underlineColor:"#caca2b"}:u},[a,t,n]);return R.useEffect(()=>{o&&o.setAnnotations(e.annotations)},[o,e.annotations]),R.useEffect(()=>{e.highlightedSearchResult&&o.scrollIntoView(e.highlightedSearchResult)},[e.highlightedSearchResult]),R.useEffect(()=>{e.onSelect({annotation:r,relatedImages:i,relatedVerses:s})},[r,i,s]),a&&V.jsxs(To,{adapter:d=>oo("5db80aa5-8a27-4539-aeb3-bddf3abc0098",d),annotationEnabled:!1,style:l,children:[V.jsx("div",{className:"annotated-text",children:e.verse}),V.jsx(No,{annotation:r,relatedImages:i,relatedVerses:s,onClickImages:e.onOpenRelatedImages,onClickVerses:e.onOpenRelatedVerses})]})},Bo=e=>{const[t,n]=R.useState(),o=xt(`annotations/verse/${e.verse.slug}.json`),[r,i]=R.useState(),[s,a]=Le("diga.images.open",!1),[l,d]=Le("diga.verses.open",!1),[g,u]=R.useState([]),[v,c]=R.useState(),b=R.useCallback((f,h)=>{const m=f.target.selector[0].start,p=h.target.selector[0].start;return m-p},[]);return R.useEffect(()=>{fetch(`../../verses/${e.verse.slug}.txt`).then(f=>f.text()).then(n)},[]),V.jsxs(Et,{children:[V.jsx(St,{loaded:!!o}),V.jsx(Tt,{isRelatedImagesOpen:s,isRelatedVersesOpen:l,searchSorter:b,onToggleRelatedImages:()=>a(f=>!f),onToggleRelatedVerses:()=>d(f=>!f),onClearSearch:()=>u([]),onHighlightSearchResult:f=>c(f),onSearch:u}),V.jsxs("div",{className:"flex-wrapper",children:[V.jsx("main",{children:V.jsxs("div",{className:"page",children:[V.jsx("h1",{children:e.verse.title}),t&&o&&V.jsx(Lo,{annotations:o,verse:t,searchResults:g,highlightedSearchResult:v,onSelect:i,onOpenRelatedImages:()=>a(!0),onOpenRelatedVerses:()=>d(!0)})]})}),V.jsx(Ct,{annotation:r?.annotation,currentSlug:e.verse.slug,open:l,related:r?.relatedVerses,onClose:()=>d(!1)}),V.jsx(Nt,{annotation:r?.annotation,currentSlug:e.verse.slug,open:s,related:r?.relatedImages,onClose:()=>a(!1)})]})]})};export{Bo as VerseView};
